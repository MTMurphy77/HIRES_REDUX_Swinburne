<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.1//EN"
     "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<!-- This file was generated by make_html_help.pro -->
<head>
<title>IDL Help for IDLSPEC2D</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>
<body>
<h1>IDL Help for IDLSPEC2D</h1>
<h2>Overview</h2>
<p>This page was created by the IDL library routine 
<code>make_html_help</code>.  For more information on 
this routine, refer to the IDL Online Help Navigator 
or type: </p>
<pre>     ? make_html_help</pre>
<p>at the IDL command line prompt.</p>
<p><strong>Last modified: </strong>Mon Nov  7 16:44:48 2011.</p>
<hr />
<h2 id="ROUTINELIST">List of Routines</h2>
<ul>
<li><a href="#AESTHETICS">AESTHETICS</a>-- 
Fill in bad values in spectra with something that looks nice.</li>
<li><a href="#ALIGN_REST">ALIGN_REST</a>-- 
Align spectra in rest wavelength given redshift.</li>
<li><a href="#APOALL">APOALL</a>-- Run APOREDUCE on one or many nights of data.
</li>
<li><a href="#APOFIX">APOFIX</a>-- 
Add line to sdHdrFix file to denote change in FITS header for sdR files.</li>
<li><a href="#APOFLUXCALIB">APOFLUXCALIB</a>-- 
Generate the flux-calibration vectors for use by APOPLOT.</li>
<li><a href="#APOHEADER">APOHEADER</a>-- 
Print the subset of interesting header keywords from the raw sdR files.</li>
<li><a href="#APOPLOT">APOPLOT</a>-- 
Routine for plotting spectra from the Son-of-Spectro outputs at APO.</li>
<li><a href="#APOPLOTARC">APOPLOTARC</a>-- 
Routine for plotting arc spectra from the Son-of-Spectro outputs at APO.</li>
<li><a href="#APOPLOTGEOM">APOPLOTGEOM</a>-- 
Routine for plotting arc geometry from the Son-of-Spectro outputs at APO.</li>
<li><a href="#APOPLOTSKY">APOPLOTSKY</a>-- 
Routine for plotting sky spectra from the Son-of-Spectro outputs at APO.</li>
<li><a href="#APOREDUCE">APOREDUCE</a>-- 
Quick on-the-mountain reduction pipeline for 1 file at a time.</li>
<li><a href="#APO_APPENDLOG">APO_APPENDLOG</a>-- 
Append to logfile as written by APOREDUCE.</li>
<li><a href="#APO_CHECKLIMITS()">APO_CHECKLIMITS()</a>-- 
Convert output FITS file from APOREDUCE to HTML format.</li>
<li><a href="#APO_LOG2HTML">APO_LOG2HTML</a>-- 
Convert output FITS file from APOREDUCE to HTML format.</li>
<li><a href="#APO_PLOTBIAS">APO_PLOTBIAS</a>-- 
Plot the histogram of bias values for all 4 cameras of a single exposure</li>
<li><a href="#APO_PLOTSN">APO_PLOTSN</a>-- 
Generate S/N plot for one plate from a FITS logfile written by APOREDUCE.</li>
<li><a href="#APO_REFRAC">APO_REFRAC</a>-- 
Take RA and DEC and apply refraction at APO for a specific LST</li>
<li><a href="#ARCFIT_GUESS">ARCFIT_GUESS</a>-- 
Determine initial wavelength solution by comparing spectrum to arc spectrum</li>
<li><a href="#ATMDISP_COR">ATMDISP_COR</a>-- 
Atmospheric dispersion causes wavelength dependent lightloss from</li>
<li><a href="#ATVRAWSPEC">ATVRAWSPEC</a>-- 
Display a 2D spectroscopic image with bad columns marked in red.</li>
<li><a href="#ATVSPEC">ATVSPEC</a>-- 
Display cutouts of all raw images around specified wavelengths</li>
<li><a href="#BADFMAGS">BADFMAGS</a>-- 
Find any F stars where the magnitudes in the calibObj files are grossly</li>
<li><a href="#BADFSTARS">BADFSTARS</a>-- 
Find bad F stars used for spectro-photometry in the Spectro-2D reductions</li>
<li><a href="#BAD_BOSSFORMAT">BAD_BOSSFORMAT</a>-- 
Search for electronics problems in the raw spectro images</li>
<li><a href="#BANDPASSFILTER">BANDPASSFILTER</a>-- </li>
<li><a href="#BANDPASSINFO">BANDPASSINFO</a>-- 
Return information about SDSS bandpasses u,g,r,i,z.</li>
<li><a href="#BATCHPBS">BATCHPBS</a>-- 
Batch process Spectro-2D and Spectro-1D reductions based upon</li>
<li><a href="#BBSPEC_EXTRACT">BBSPEC_EXTRACT</a>-- Run bbspec 2D extraction code
</li>
<li><a href="#BBSPEC_TEST">BBSPEC_TEST</a>-- </li>
<li><a href="#BESTFOCUS">BESTFOCUS</a>-- 
Compute the offset from Hartmann images of different focus ring positions</li>
<li><a href="#BIN_SPECTRA">BIN_SPECTRA</a>-- 
Make binned spectra for the purposes of fitting for the</li>
<li><a href="#BOLTON_BIASGEN">BOLTON_BIASGEN</a>-- 
Generate BOSS 4-amp master bias frames given an input file list.</li>
<li><a href="#BOLTON_BIASSUB">BOLTON_BIASSUB</a>-- 
Perform BOSS 4-amp bias subtraction using master pixel bias.</li>
<li><a href="#BOLTON_MLPCA">BOLTON_MLPCA</a>-- </li>
<li><a href="#BOLTON_SN_FIT">BOLTON_SN_FIT</a>-- </li>
<li><a href="#BOLTON_STD_THROUGHPUT">BOLTON_STD_THROUGHPUT</a>-- 
Compute BOSS end-to-end throughput estimate from</li>
<li><a href="#BOSS_GAIN">BOSS_GAIN</a>-- 
Compute the gain in all amplifiers from a pair of flat-field exposures.</li>
<li><a href="#BOSS_GALAXY_SELECT.PRO">BOSS_GALAXY_SELECT.PRO</a>-- 
Version 0.00001 of the galaxy selection algorithm for BOSS</li>
<li><a href="#BUNDLETHRU">BUNDLETHRU</a>-- 
Measure relative throughput of fiber bundles from flat-fields</li>
<li><a href="#CALCSCATIMAGE">CALCSCATIMAGE</a>-- 
Just return smoothed scattered light image</li>
<li><a href="#CATPLOT">CATPLOT</a>-- 
Modified version of SPLOT by Tremonti for inspecting spectra.</li>
<li><a href="#CCDTILT">CCDTILT</a>-- 
Compute the CCD tilts from a series of Hartmann mask exposures.</li>
<li><a href="#CHUNKINFO">CHUNKINFO</a>-- 
Return chunk information for a given plate number.</li>
<li><a href="#COLLIMATE">COLLIMATE</a>-- 
Compute the spectrograph collimation focus from Hartmann mask exposures.</li>
<li><a href="#COMBINE1FIBER">COMBINE1FIBER</a>-- 
Combine several spectra of the same object, or resample a single spectrum.</li>
<li><a href="#COMBINEBPM">COMBINEBPM</a>-- 
Takes a set of darks (preferably at least 5 to reduce cosmics)</li>
<li><a href="#COMBSMALLCOLLIMATE">COMBSMALLCOLLIMATE</a>-- 
Compute the spectrograph collimation focus from Hartmann mask exposures.</li>
<li><a href="#CORRECT_CROSSTALK">CORRECT_CROSSTALK</a>-- 
If there is keyword_set(image) is true this procedure corrects an image for crosstalk.  The input image is overwritten by the corrected image.
</li>
<li><a href="#CORRECT_DLAM">CORRECT_DLAM</a>-- 
Correct ADU/pixel to ADU/d(log-lambda)</li>
<li><a href="#CO_REFRACT()">CO_REFRACT()</a>-- 
Calculate correction to altitude due to atmospheric refraction.</li>
<li><a href="#DAYTIME_TEST">DAYTIME_TEST</a>-- 
Look for spectro exposures taken during the day and not marked as test.</li>
<li><a href="#DESIGN_MULTIPLATE">DESIGN_MULTIPLATE</a>-- 
Routine to design a plate with several pointings.</li>
<li><a href="#DESIGN_PLATE">DESIGN_PLATE</a>-- Routine to design a single plate.
</li>
<li><a href="#DESIGN_SDSS3TEST">DESIGN_SDSS3TEST</a>-- 
Design test plates for SDSS-3</li>
<li><a href="#DIVIDEFLAT">DIVIDEFLAT</a>-- 
Divide an extracted image with a fiber-flat</li>
<li><a href="#DJS_ITER_SFIT">DJS_ITER_SFIT</a>-- 
Surface-fitting code to tabulated data (with iterateive rejection).</li>
<li><a href="#DJS_POLYFIT">DJS_POLYFIT</a>-- 
Version of POLYFITW that uses SVD fitting</li>
<li><a href="#DR1LIST_BEST">DR1LIST_BEST</a>-- 
Determine which plates *should* have been in DR1 that match the tiles</li>
<li><a href="#ELODIE_BEST">ELODIE_BEST</a>-- 
Find the best-fit Elodie spectrum to a set of spectra.</li>
<li><a href="#ELODIE_FILELIST">ELODIE_FILELIST</a>-- 
Get a listing of all valid Elodie filenames.</li>
<li><a href="#EXTRACT_ASYMBOX2">EXTRACT_ASYMBOX2</a>-- 
Extract the total flux within a boxcar window at many positions.</li>
<li><a href="#EXTRACT_BOXCAR">EXTRACT_BOXCAR</a>-- 
Extract the total flux within a boxcar window at many positions.</li>
<li><a href="#EXTRACT_BUNDLE_IMAGE">EXTRACT_BUNDLE_IMAGE</a>-- 
Extract the fiber profile flux for an entire image, using</li>
<li><a href="#EXTRACT_BUNDLE_ROW">EXTRACT_BUNDLE_ROW</a>-- 
Fit the fiber profiles and background in a single row with least</li>
<li><a href="#EXTRACT_IMAGE">EXTRACT_IMAGE</a>-- 
Extract the fiber profile flux for an entire image</li>
<li><a href="#EXTRACT_OBJECT">EXTRACT_OBJECT</a>-- </li>
<li><a href="#EXTRACT_PROFILE">EXTRACT_PROFILE</a>-- 
Extract the flux with profile weighting at centroid positions.</li>
<li><a href="#EXTRACT_ROW">EXTRACT_ROW</a>-- 
Fit the fiber profiles and background in a single row with least squares</li>
<li><a href="#FCALIB_DEFAULT">FCALIB_DEFAULT</a>-- 
Return a default flux-calibration vector</li>
<li><a href="#FIBERFLAT">FIBERFLAT</a>-- 
Construct the flat-field vectors from an extracted flat-field image.</li>
<li><a href="#FIBERMASK_BITS">FIBERMASK_BITS</a>-- 
Return mask value corresponding to a mask condition for FIBERMASK.</li>
<li><a href="#FIBER_ROLLCALL">FIBER_ROLLCALL</a>-- 
Print the &quot;roll call&quot; of how many plug-map bits are set.</li>
<li><a href="#FILTER_CHECK">FILTER_CHECK</a>-- </li>
<li><a href="#FILTER_CHECK_CHI2">FILTER_CHECK_CHI2</a>-- </li>
<li><a href="#FILTER_SELECT">FILTER_SELECT</a>-- </li>
<li><a href="#FILTER_SOLVE">FILTER_SOLVE</a>-- </li>
<li><a href="#FILTER_THRU">FILTER_THRU</a>-- Compute throughput in SDSS filters
</li>
<li><a href="#FINDSPEC">FINDSPEC</a>-- 
Routine for finding SDSS spectra that match a given RA, DEC.</li>
<li><a href="#FIND_NMINIMA">FIND_NMINIMA</a>-- 
Find one or several minima in a vector of chi^2 values.</li>
<li><a href="#FIND_UNPLUGGED">FIND_UNPLUGGED</a>-- 
Find all unplugged fibers that still seemed to get a spectrum</li>
<li><a href="#FIND_WHOPPING">FIND_WHOPPING</a>-- 
Use simple medians to detect whopping fibers</li>
<li><a href="#FITANSIMAGE">FITANSIMAGE</a>-- 
Convert output from extract_image (ansimage) into a smooth</li>
<li><a href="#FITARCIMAGE">FITARCIMAGE</a>-- 
Determine wavelength calibration from arclines</li>
<li><a href="#FITDISPERSION">FITDISPERSION</a>-- 
Fit polynomials to the line width (dispersion axis) for each fiber bundle</li>
<li><a href="#FITMEANX">FITMEANX</a>-- 
Return the position where the wavelength should fall (MX) plus</li>
<li><a href="#FITREDSHIFT">FITREDSHIFT</a>-- 
Find the most significant correlation peak (soon to be peaks)</li>
<li><a href="#FITSN">FITSN</a>-- 
Perform a simple parameter fit to log S/N vs magnitude</li>
<li><a href="#FITVACSET">FITVACSET</a>-- 
Re-fit the wavelength solution in vacuum wavelengths, and applying shifts</li>
<li><a href="#FLATFIELD">FLATFIELD</a>-- 
This takes an LED flatfield and compares pixel by pixel the value</li>
<li><a href="#FLUX2MAGGIE">FLUX2MAGGIE</a>-- 
Integrate a spectrum under filter curves to get maggies or magnitudes</li>
<li><a href="#FLUXCORR_NEW">FLUXCORR_NEW</a>-- 
Compute the frame-by-frame relative scaling for each object on a plate.</li>
<li><a href="#FLUX_DISTORTION">FLUX_DISTORTION</a>-- 
Compute the flux-distortion image for an entire plate.</li>
<li><a href="#FOCUSHISTORY">FOCUSHISTORY</a>-- 
Plot the history of wavelength focus based upon the reduced spPlate files.</li>
<li><a href="#FOURIER_DIFFERENCE">FOURIER_DIFFERENCE</a>-- 
Perform a chi2 fit to the fourier difference between a single</li>
<li><a href="#FOURIER_QUOTIENT">FOURIER_QUOTIENT</a>-- 
Perform a chi2 fit to the fourier quotient of a single</li>
<li><a href="#FRAME_FLUX_CALIB">FRAME_FLUX_CALIB</a>-- 
To derive the flux calibration appropriate to one frame.  This routine</li>
<li><a href="#FRAME_FLUX_TWEAK">FRAME_FLUX_TWEAK</a>-- 
To genreate low order correctons to each red-blue exposure pair which</li>
<li><a href="#FSTARS_PLOT">FSTARS_PLOT</a>-- 
Make color-color plots of spectro-photometric stars as compared</li>
<li><a href="#FUNDAMENTAL_LINE">FUNDAMENTAL_LINE</a>-- 
Crush the fundamental plane to a measly line.</li>
<li><a href="#GAUSSPIX">GAUSSPIX</a>-- </li>
<li><a href="#GENFLATMASK">GENFLATMASK</a>-- 
Read or generate a mask for pixels to ignore when generating flat-fields.</li>
<li><a href="#GET_MJD_DIR">GET_MJD_DIR</a>-- 
Get directory list of matching MJD directories.</li>
<li><a href="#GUIDERMONFILE">GUIDERMONFILE</a>-- 
Create guiderMon file using proc-gimg files.</li>
<li><a href="#GUIDERMOVIE">GUIDERMOVIE</a>-- 
Plot the guider images for an entire night using ATV.</li>
<li><a href="#GUIDERMPEG">GUIDERMPEG</a>-- Create an MPEG guider movie.</li>
<li><a href="#GUIDERPLAY">GUIDERPLAY</a>-- Replay guider images from a night
</li>
<li><a href="#HOGG_EXTINCTION">HOGG_EXTINCTION</a>-- </li>
<li><a href="#HOLESIZE">HOLESIZE</a>-- 
Returns size in deg of a hole in an SDSS plate</li>
<li><a href="#IDLSPEC2D_VERSION">IDLSPEC2D_VERSION</a>-- 
Return the version name for the idlspec2d product</li>
<li><a href="#INSPECTFILES[1]">INSPECTFILES[1]</a>-- 
Create empty spInspect file(s) for manual inspection of classifications</li>
<li><a href="#INSPECTFILES[2]">INSPECTFILES[2]</a>-- 
Create empty spInspect file(s) for manual inspection of classifications</li>
<li><a href="#INSPECT_VERIFY">INSPECT_VERIFY</a>-- 
Verify the data format of spInspect files</li>
<li><a href="#JEG_SPHOTO_COEF">JEG_SPHOTO_COEF</a>-- 
Compute coefficients which can be used to correct the spectrophotometry</li>
<li><a href="#K-CORRECT">K-CORRECT</a>-- 
Take 5-band photometry and redshift and return k-corrected magnitude.</li>
<li><a href="#KURUCZ_FITSFILE">KURUCZ_FITSFILE</a>-- 
Generate a single FITS file from a list of ASCII-formatted Kurucz models</li>
<li><a href="#KURUCZ_RESTORE">KURUCZ_RESTORE</a>-- 
Read back Kurucz models from FITS and apply an empirical correction</li>
<li><a href="#LEDFLAT">LEDFLAT</a>-- 
Compute pixel-flats from LED flat-field images</li>
<li><a href="#LINEBACKFIT">LINEBACKFIT</a>-- 
Fit emission lines and background terms to a spectrum.</li>
<li><a href="#LISTCHI">LISTCHI</a>-- 
List the extraction chi of all individual spectro frames</li>
<li><a href="#LISTEXPTIME">LISTEXPTIME</a>-- 
List the exposure times of all (reduced) spectroscopic frames.</li>
<li><a href="#LOCATESKYLINES">LOCATESKYLINES</a>-- 
Compute shifts for arc lines used in wavelength calibration.</li>
<li><a href="#LOGSHEET">LOGSHEET</a>-- 
Make a summary of header keywords in a directory of raw SDSS spectro files.</li>
<li><a href="#LRGMODEL_ERRORS">LRGMODEL_ERRORS</a>-- 
Make plots of photo-z's where we increase the errors.</li>
<li><a href="#LRGMODEL_PHOTOZ">LRGMODEL_PHOTOZ</a>-- 
Simple photo-z finder for LRGs using Bruzual-Charlot models.</li>
<li><a href="#LRGMODEL_PLOTS">LRGMODEL_PLOTS</a>-- 
Generate goodness-of-fit plots from the LRG model photo-z fits.</li>
<li><a href="#LRGMODEL_TRAIN">LRGMODEL_TRAIN</a>-- 
Calling script for LRGMODEL_TWEAK_TEMPLATE for training the Bruzual-</li>
<li><a href="#LRGMODEL_TWEAK_TEMPLATE">LRGMODEL_TWEAK_TEMPLATE</a>-- 
Compute the corrections to the input LRG template used for LRG_PHOTOZ().</li>
<li><a href="#LRG_PHOTOZ">LRG_PHOTOZ</a>-- 
Very simple photo-z finder for LRGs using a single template.</li>
<li><a href="#LRG_TWEAK_TEMPLATE">LRG_TWEAK_TEMPLATE</a>-- 
Compute the corrections to the input LRG template used for LRG_PHOTOZ().</li>
<li><a href="#MAKE_REGRESS1D">MAKE_REGRESS1D</a>-- 
Generate a regression table from spectro 1-D from Chicago-1D outputs files.</li>
<li><a href="#MAKE_SKYINVVAR">MAKE_SKYINVVAR</a>-- 
To reconstruct the contribution of the sky and detector background</li>
<li><a href="#MATCH_TRACE">MATCH_TRACE</a>-- 
Tweak flat field trace to match object trace</li>
<li><a href="#MJD_MATCH">MJD_MATCH</a>-- 
Decide if any of these MJD's are within the bounds specified by</li>
<li><a href="#MLPCA_CVSTAR">MLPCA_CVSTAR</a>-- 
Generate ML-PCA templates for CV stars</li>
<li><a href="#MLPCA_STAR">MLPCA_STAR</a>-- Generate ML-PCA templates for stars
</li>
<li><a href="#MULTISYNTHSPEC">MULTISYNTHSPEC</a>-- 
Construct synthetic spectrum from eigen-templates.</li>
<li><a href="#MYSQL_WRITE">MYSQL_WRITE</a>-- 
Write an IDL structure to a MySQL-readable file</li>
<li><a href="#NEWSPCOMBINE">NEWSPCOMBINE</a>-- 
Flux calibrates and combines exposures with a common plugmap.</li>
<li><a href="#OPFIBER_GENERATE">OPFIBER_GENERATE</a>-- 
Generate or append entries to the opFibers.par file</li>
<li><a href="#PCA_FLUX_STANDARD">PCA_FLUX_STANDARD</a>-- 
Solve for the mean flux-calibration vector of one camera + spectrograph</li>
<li><a href="#PCA_GAL">PCA_GAL</a>-- Wrapper on pca_solve.pro</li>
<li><a href="#PCA_GAL_DEV">PCA_GAL_DEV</a>-- </li>
<li><a href="#PCA_LRGTEST">PCA_LRGTEST</a>-- 
Build PCA templates for LRGs within a specified redshift range.</li>
<li><a href="#PCA_QSO">PCA_QSO</a>-- Wrapper on pca_solve.pro</li>
<li><a href="#PCA_QSO_DEV">PCA_QSO_DEV</a>-- </li>
<li><a href="#PCA_SOLVE">PCA_SOLVE</a>-- 
Iteratively find PCA solution for noisy or gappy spectra.</li>
<li><a href="#PHOTO_LOADER">PHOTO_LOADER</a>-- 
Write PHOTO outputs from SDSS_READOBJ() to an ASCII stream for direct input</li>
<li><a href="#PIXELMASK_BITS">PIXELMASK_BITS</a>-- 
Return mask value corresponding to a mask condition for either FIBERMASK</li>
<li><a href="#PLATECEN_TEST">PLATECEN_TEST</a>-- 
Find where RA,DEC and RADEG,DECDEG disagree in the spPlate headers.</li>
<li><a href="#PLATECOMPARE">PLATECOMPARE</a>-- 
Interactive comparison of descrepant redshifts for the same objects.</li>
<li><a href="#PLATELINKS">PLATELINKS</a>-- 
Build links from another directory to the spectroscopic output files.</li>
<li><a href="#PLATELIST">PLATELIST</a>-- Make list of reduced plates</li>
<li><a href="#PLATEMERGE">PLATEMERGE</a>-- 
Merge all Spectro-1D outputs with photoPosPlate,spInspect files</li>
<li><a href="#PLATESN">PLATESN</a>-- Generate S/N plots for an entire plate.
</li>
<li><a href="#PLATE_NEWCENTER">PLATE_NEWCENTER</a>-- 
Find the new plate center when trying to put an object at the same</li>
<li><a href="#PLATE_ROTATE">PLATE_ROTATE</a>-- 
Rotate (RA, dec) positions for one plate center to another plate center</li>
<li><a href="#PLATE_SPEC_IMAGE">PLATE_SPEC_IMAGE</a>-- 
Create spectroscopic images for a plate</li>
<li><a href="#PLOTSIGNAL">PLOTSIGNAL</a>-- 
Plot the signal (not S/N) seen on each plate+exposure+CCD.</li>
<li><a href="#PLOTSN">PLOTSN</a>-- Plot S/N and residuals in up to 3 bands</li>
<li><a href="#PLOTSPEC">PLOTSPEC</a>-- 
Routine for plotting spectra from Princeton-1D spectro outputs.</li>
<li><a href="#PLOTSPECQA">PLOTSPECQA</a>-- 
Wrapper for PLOTSPEC to plot standard stars and/or sky spectra.</li>
<li><a href="#PLOTSPEC_IMAGE">PLOTSPEC_IMAGE</a>-- 
Procedure to display an image, launched from PLOTSPEC</li>
<li><a href="#PLUG2TSOBJ">PLUG2TSOBJ</a>-- 
Read photoPosPlate structure of imaging data for a plate</li>
<li><a href="#PLUGFILE_DIFF">PLUGFILE_DIFF</a>-- 
Find instances where the plPlugMapM file in the speclog file differs</li>
<li><a href="#PLUGFILE_RELABEL">PLUGFILE_RELABEL</a>-- 
Relabel the OBJTYPE's for specified objects in all plPlugMapM files.</li>
<li><a href="#PLUGFILE_UNMAPPED">PLUGFILE_UNMAPPED</a>-- 
List which fibers in a plPlugMapM file are unmapped, and the info</li>
<li><a href="#PLUGHISTORY">PLUGHISTORY</a>-- 
Plot the history of unplugged fibers based upon plPlugMapM files.</li>
<li><a href="#PLUGMAP_REPLACE">PLUGMAP_REPLACE</a>-- 
Replace plPlugMapM files in the speclog product with new files</li>
<li><a href="#PLUGMAP_TYCHO">PLUGMAP_TYCHO</a>-- 
Plot bright Tycho stars on a plate</li>
<li><a href="#PLUGMAP_VERIFY">PLUGMAP_VERIFY</a>-- 
Sanity checks for BOSS plPlugMapP files</li>
<li><a href="#POSTGRES_WRITE">POSTGRES_WRITE</a>-- 
Write an IDL structure to a Postgres-readable file</li>
<li><a href="#QAPLOT_ARCLINE">QAPLOT_ARCLINE</a>-- 
Generate QA plot for arcline fits</li>
<li><a href="#QAPLOT_FCALIBVEC">QAPLOT_FCALIBVEC</a>-- 
Generate QA plot: apparent flux-calibration errors</li>
<li><a href="#QAPLOT_FFLAT">QAPLOT_FFLAT</a>-- Generate QA plot for fiber-flats
</li>
<li><a href="#QAPLOT_SCATLIGHT">QAPLOT_SCATLIGHT</a>-- 
Generate QA plots for scattered light</li>
<li><a href="#QAPLOT_SKYDEV">QAPLOT_SKYDEV</a>-- 
Generate QA plot: scatter in sky line positions</li>
<li><a href="#QAPLOT_SKYLINE">QAPLOT_SKYLINE</a>-- 
Generate QA plots for flux in particular skylines</li>
<li><a href="#QAPLOT_SKYSHIFT">QAPLOT_SKYSHIFT</a>-- 
Generate QA plot: scatter in sky line positions</li>
<li><a href="#QAPLOT_SKYSUB">QAPLOT_SKYSUB</a>-- 
Generate QA plots for sky-subtraction</li>
<li><a href="#QUICKEXTRACT">QUICKEXTRACT</a>-- 
Science frame extraction with scattered light removal and sky subtraction.</li>
<li><a href="#QUICKTRACE">QUICKTRACE</a>-- 
Trace and boxcar extract an SDSS flat field image</li>
<li><a href="#QUICKWAVE">QUICKWAVE</a>-- 
Perform full wavelength calibration with boxcar extraction</li>
<li><a href="#RADEC_TO_XYFOCAL">RADEC_TO_XYFOCAL</a>-- 
Take RA and DEC values and return XFOCAL and YFOCAL for a plate</li>
<li><a href="#RANDOM_DECOLLIDE[1]">RANDOM_DECOLLIDE[1]</a>-- 
Take a set of RAs and DECs and find a random, decollided set</li>
<li><a href="#RANDOM_DECOLLIDE[2]">RANDOM_DECOLLIDE[2]</a>-- 
Take a set of RAs and DECs and find a random, decollided set</li>
<li><a href="#RDNOISE_HISTORY">RDNOISE_HISTORY</a>-- 
Compute the noise history for the BOSS CCDs</li>
<li><a href="#READONESPEC">READONESPEC</a>-- 
Routine for reading single exposure spectra from Spectro-2D outputs</li>
<li><a href="#READPLUGMAP">READPLUGMAP</a>-- 
Read plugmap file and append tags as requested</li>
<li><a href="#READSPEC">READSPEC</a>-- 
Routine for reading SDSS/BOSS Spectro-2D and Spectro-1D files</li>
<li><a href="#READSPEC_FOOTPRINT">READSPEC_FOOTPRINT</a>-- 
Routine for reading 1D spectro outputs on a given plate footprint</li>
<li><a href="#RECTIFY">RECTIFY</a>-- Rectify spectra using a sliding median</li>
<li><a href="#REDMONSTER">REDMONSTER</a>-- 
Search for the Red Monster (contiguous region of bad sky residuals),</li>
<li><a href="#REJECT_ARC">REJECT_ARC</a>-- Decide whether an arc is bad.</li>
<li><a href="#REJECT_FLAT">REJECT_FLAT</a>-- Decide whether a flat is bad.</li>
<li><a href="#REJECT_SCIENCE">REJECT_SCIENCE</a>-- 
Decide whether a science exposure is bad.</li>
<li><a href="#REMOVE2REDO">REMOVE2REDO</a>-- 
Removed specified exposures from the SOS log files and re-reduce them.</li>
<li><a href="#RLINE_FINDPEAKS">RLINE_FINDPEAKS</a>-- 
Given a two dimensional array for Equivalent Width (EW) and</li>
<li><a href="#RUN_SDSSPROC">RUN_SDSSPROC</a>-- 
run SDSSPROC over many raw sdR files and write image and invvar files.</li>
<li><a href="#SDSSGUIDE">SDSSGUIDE</a>-- Sloan telescope guider code</li>
<li><a href="#SDSSHEAD">SDSSHEAD</a>-- Read in header from raw SDSS file.</li>
<li><a href="#SDSSPROC">SDSSPROC</a>-- 
Read in raw SDSS files, and process with opConfig, opECalib, opBC par files.
</li>
<li><a href="#SDSS_PLATE_SORT">SDSS_PLATE_SORT</a>-- 
Resort the photoPlate files to the fiber numbering of a plugmap</li>
<li><a href="#SDSS_SPEC_BLOCK">SDSS_SPEC_BLOCK</a>-- 
take a set of sdss spectra and output as a big block</li>
<li><a href="#SDSS_SPEC_IMAGE">SDSS_SPEC_IMAGE</a>-- 
Create an image of a spectrum</li>
<li><a href="#SELECT_ARC">SELECT_ARC</a>-- 
Select best arc from an arc structure produced with SPCALIB.</li>
<li><a href="#SELECT_FLAT">SELECT_FLAT</a>-- 
Select best flat from a flat-field structure produced with SPCALIB.</li>
<li><a href="#SIMPLE_PLATE">SIMPLE_PLATE</a>-- Routine to design a single plate.
</li>
<li><a href="#SKYLINE_DISPERSION">SKYLINE_DISPERSION</a>-- 
Measure and apply broadening to dispersion solution from an arc traceset</li>
<li><a href="#SKYMASK">SKYMASK</a>-- 
Mask regions in spectra where sky-subtraction errors are expected to</li>
<li><a href="#SKYSPEC_PARANAL">SKYSPEC_PARANAL</a>-- 
Return the sky spectrum at Paranal</li>
<li><a href="#SKYSUBTRACT">SKYSUBTRACT</a>-- 
Sky-subtract an image and modify the variance</li>
<li><a href="#SLITHISTORY">SLITHISTORY</a>-- 
Plot the history of spectro slit-head positions based upon plSlitpos files.</li>
<li><a href="#SMALLCOLLIMATE">SMALLCOLLIMATE</a>-- 
Compute the spectrograph collimation focus from Hartmann mask exposures.</li>
<li><a href="#SMEARTIMES">SMEARTIMES</a>-- 
List the TAI timestamps of 'smear' exposures in a log file.</li>
<li><a href="#SMEAR_COMPARE">SMEAR_COMPARE</a>-- 
Ratio calibrated smear and science spectra and fit with a 3rd order</li>
<li><a href="#SMOOTH_HALO[1]">SMOOTH_HALO[1]</a>-- 
Given a model image of the CCD, smooth and return a halo image</li>
<li><a href="#SMOOTH_HALO[2]">SMOOTH_HALO[2]</a>-- 
Given a model image of the CCD, smooth and return a halo image</li>
<li><a href="#SMOOTH_SUPERFLAT">SMOOTH_SUPERFLAT</a>-- 
Take the superflat fit and target wavelengths and filter superflat</li>
<li><a href="#SN_MEDIAN">SN_MEDIAN</a>-- 
Compute median spectroscopic S/N in the SDSS filters</li>
<li><a href="#SOLVEFILTER">SOLVEFILTER</a>-- 
Solve for the 2.5-m imaging filter curves by using the spectra.</li>
<li><a href="#SPADD_GUIDERINFO">SPADD_GUIDERINFO</a>-- 
Add seeing and RMS offset header cards by parsing guiderMon-$MJD.par</li>
<li><a href="#SPALLFLAT">SPALLFLAT</a>-- 
Calling script for SPFLATTEN that generates pixel flats as specified in</li>
<li><a href="#SPBIASAVE">SPBIASAVE</a>-- 
Average together a set (or all!) 2D pixel biases.</li>
<li><a href="#SPBIASGEN">SPBIASGEN</a>-- 
Routine to generate mean biases for a night.</li>
<li><a href="#SPCALIB">SPCALIB</a>-- Extract calibration frames.</li>
<li><a href="#SPCOADD_FLUXED_FRAMES">SPCOADD_FLUXED_FRAMES</a>-- 
Combine reduced frames with the same plugmap and spectrophotometrically</li>
<li><a href="#SPCOADD_V5">SPCOADD_V5</a>-- 
Combine several reduced frames of the same objects</li>
<li><a href="#SPCOMBINE_V5">SPCOMBINE_V5</a>-- 
Calling script for SPCOADD_FRAMES.</li>
<li><a href="#SPDATA2MODEL_RATIO">SPDATA2MODEL_RATIO</a>-- 
Construct flux correction vectors by ratioing the observed spectra of</li>
<li><a href="#SPECDB_CREATE">SPECDB_CREATE</a>-- Create spectro database.</li>
<li><a href="#SPECHEADERS">SPECHEADERS</a>-- 
Consolodate all of the raw spectro files headers into a single FITS file</li>
<li><a href="#SPECLINEFIT">SPECLINEFIT</a>-- 
Line-fitting calling script for entire plate(s)</li>
<li><a href="#SPEC_PARAM_STR">SPEC_PARAM_STR</a>-- 
Build structure SPEC_PARAM for parameters derived from analysis of</li>
<li><a href="#SPFLATAVE">SPFLATAVE</a>-- 
Average together a set (or all!) 2D pixel flats.</li>
<li><a href="#SPFLATGEN">SPFLATGEN</a>-- 
Wrapper for SPFLATTEN2 for generating pixel-to-pixel flat-fields.</li>
<li><a href="#SPFLATTEN">SPFLATTEN</a>-- 
Create pixel-to-pixel flat-field from a stack of SDSS spectral flats.</li>
<li><a href="#SPFLATTEN2">SPFLATTEN2</a>-- 
Create pixel-to-pixel flat-field from a stack of SDSS spectral flats.</li>
<li><a href="#SPFLUXCORR_V5">SPFLUXCORR_V5</a>-- 
Compute flux-correction vectors for each CCD+exposure</li>
<li><a href="#SPFLUX_READ_KURUCZ">SPFLUX_READ_KURUCZ</a>-- 
Read the Kurucz models at the specified log-lambda and resolution</li>
<li><a href="#SPFLUX_V5">SPFLUX_V5</a>-- 
Compute flux-calibration vectors for each CCD+exposure from std stars</li>
<li><a href="#SPFRAME_READ">SPFRAME_READ</a>-- 
Read data from either an spFrame or spCFrame file.</li>
<li><a href="#SPGAIN">SPGAIN</a>-- 
Measure the gain + read noise for SDSS spectroscopic images</li>
<li><a href="#SPHDRFIX">SPHDRFIX</a>-- 
Fix header cards in raw SDSS spectroscopic data.</li>
<li><a href="#SPHOTO_CALIB">SPHOTO_CALIB</a>-- 
Derive spectrophotometric calibration for a group of exposures from</li>
<li><a href="#SPLOT_TILES">SPLOT_TILES</a>-- 
plot circular tiles from a given file</li>
<li><a href="#SPMANUAL">SPMANUAL</a>-- 
Read manual inspection files (spInspect) for redshifts</li>
<li><a href="#SPMEDIAN_REBIN">SPMEDIAN_REBIN</a>-- 
Coarsely rebin the data using medians to reject outliers</li>
<li><a href="#SPPLAN1D">SPPLAN1D</a>-- 
Create plan file(s) for combining Spectro-2D outputs into one plate.</li>
<li><a href="#SPPLAN2D">SPPLAN2D</a>-- 
Create plan file(s) for running the Spectro-2D pipeline.</li>
<li><a href="#SPREAD_FRAMES">SPREAD_FRAMES</a>-- 
Read in multiple frame files produced by spectro2d and pass back arrays</li>
<li><a href="#SPREDUCE">SPREDUCE</a>-- 
Extract, wavelength-calibrate, and flatten SDSS spectral frame(s).</li>
<li><a href="#SPREDUCE1D">SPREDUCE1D</a>-- 1-D reduction of spectra from 1 plate
</li>
<li><a href="#SPREDUCE2D">SPREDUCE2D</a>-- 
Calling script for SPREDUCE that reduces a night of data according</li>
<li><a href="#SPTEMPLATE_REBIN">SPTEMPLATE_REBIN</a>-- 
Read and optionally rebin spectral templates</li>
<li><a href="#SPTHROUGHPUT">SPTHROUGHPUT</a>-- 
Return the throughput and efficiency for a given plate+camera+exposure</li>
<li><a href="#SSHIFTVEC">SSHIFTVEC</a>-- 
Shift vector or image (line-at-a-time) using a damped sinc function.</li>
<li><a href="#STAR_DVELOCITY">STAR_DVELOCITY</a>-- 
Solve for velocity shifts between multiple exposures.</li>
<li><a href="#STYPE_STANDARD">STYPE_STANDARD</a>-- 
Spectral type the standard stars and store the result as a structure.</li>
<li><a href="#SUPERFLAT">SUPERFLAT</a>-- 
Create a &quot;superflat&quot; from an extracted flat-field image</li>
<li><a href="#SYNTHSPEC">SYNTHSPEC</a>-- 
Construct synthetic spectrum from eigen-templates.</li>
<li><a href="#TELLURIC_CORR">TELLURIC_CORR</a>-- 
Use SPECTROPHOTO and REDDEN_STD's to fit telluric features.</li>
<li><a href="#THROUGHPUT_CALIB">THROUGHPUT_CALIB</a>-- 
Calculate spectroscopic throughput with fluxcalib files</li>
<li><a href="#TRACE320CEN">TRACE320CEN</a>-- 
Find the 320 fiber positions for the central row of an image.</li>
<li><a href="#TRACE320CRUDE">TRACE320CRUDE</a>-- 
Calling script to return 320 full traces using TRACE_CRUDE.</li>
<li><a href="#TRACE_CEN">TRACE_CEN</a>-- 
Find the fiber positions for the central row of an image.</li>
<li><a href="#TRACE_FIX">TRACE_FIX</a>-- 
Fix a set of trace centers by replacing traces that converge.</li>
<li><a href="#TRACE_SPARSE_CRUDE">TRACE_SPARSE_CRUDE</a>-- 
Semi-crude, semi-robust tracing of sparse flats.</li>
<li><a href="#TRIAL_LRG_CAT">TRIAL_LRG_CAT</a>-- 
make trial LRG catalog for APO-LSS testing purposes</li>
<li><a href="#TWEAKTRACE">TWEAKTRACE</a>-- Use fitans to tweak trace and sigma
</li>
<li><a href="#UPDATE_PLATELIST">UPDATE_PLATELIST</a>-- 
Update the plate list file found in the speclog product.</li>
<li><a href="#UPDATE_PLATE_RELEASE">UPDATE_PLATE_RELEASE</a>-- 
Update the plate list file found in this idlspec2d product</li>
<li><a href="#UUBATCHPBS">UUBATCHPBS</a>-- 
Batch process Spectro-2D and Spectro-1D reductions based upon</li>
<li><a href="#UUPLOTSPEC">UUPLOTSPEC</a>-- 
Based on D. Schlegel's plotspec routine for plotting spectra from Princeton-1D spectro outputs,
</li>
<li><a href="#VDISPFIT">VDISPFIT</a>-- 
Compute velocity dispersions for galaxy spectra.</li>
<li><a href="#VELDISP">VELDISP</a>-- 
Fit a series of galaxy spectrum with a single stellar template.</li>
<li><a href="#WARN_DAYTIME">WARN_DAYTIME</a>-- 
Print a warning if an excellent-quality exposure taken with the Sun up.</li>
<li><a href="#WRITESPEC">WRITESPEC</a>-- 
Routine for writing Princeton-1D spectro outputs to an ASCII file</li>
<li><a href="#WRITE_UROS">WRITE_UROS</a>-- 
Generate ASCII files of individual exposures on spectra for Uros Seljak</li>
<li><a href="#ZCOMPUTE">ZCOMPUTE</a>-- 
Compute relative redshift of object(s) vs. eigen-templates.</li>
<li><a href="#ZCOMPUTE_QSO">ZCOMPUTE_QSO</a>-- 
Compute relative redshift of object(s) vs. eigen-templates.</li>
<li><a href="#ZFIND">ZFIND</a>-- 
Find possible redshift matches for a set of spectra using a set of</li>
<li><a href="#ZPLOT_PIE">ZPLOT_PIE</a>-- Plot pie diagram</li>
<li><a href="#ZREFIND">ZREFIND</a>-- 
Re-fit redshifts from a previous call to ZFIND(), but doing a local</li>
<li><a href="#ZTWEAK">ZTWEAK</a>-- Tweak redshifts</li>
<li><a href="#ZTWEAK2">ZTWEAK2</a>-- Tweak redshifts</li>
<li><a href="#ZTWEAK_GAL">ZTWEAK_GAL</a>-- Tweak galaxy redshifts</li>
<li><a href="#ZTWEAK_STAR">ZTWEAK_STAR</a>-- 
Find the best-fit Elodie spectrum to a set of spectra.</li>
</ul>
<hr />
<h2>Routine Descriptions</h2>
<h3 id="AESTHETICS">AESTHETICS</h3>
<p><a href="#ALIGN_REST">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   aesthetics

 PURPOSE:
   Fill in bad values in spectra with something that looks nice.

 CALLING SEQUENCE:
   newflux = aesthetics(flux,invvar, [method=method])

 INPUTS:
   flux   - A 1D spectrum
   invvar - Inverse variance of flux

 OPTIONAL INPUTS:
   method - A string describing the method for replacing bad values.  The
            default value is 'traditional' (see COMMENTS).  method may
            take the values:
            'traditional' - the default
            'noconst'     - like traditional but without setting the /const
                            flag on djs_maskinterp()
            'mean'        - bad values are replaced by the mean value of
                            the good values of flux.
            'nothing'     - Make no changes at all.

 OUTPUTS:
   newflux - flux with bad values replaced by something more reasonable

 COMMENTS:
   This function is intended to modularize the replacement of bad values in
   spectra created by combine1fiber.  Traditionally bad values were replaced
   by calling djs_maskinterp() with the /const flag.  This performs poorly on
   the edges of the spectra because /const forces values on the edges to
   take on the last non-bad value, which in some cases could be a large
   fluctuation.

   The default behaviour of this function is the traditional method
   described above.

 PROCEDURES CALLED:
   djs_maskinterp()

 REVISION HISTORY:
   2010-06-11 Written by B. A. Weaver

 VERSION:
   $Id: aesthetics.pro 115251 2010-07-29 18:32:42Z weaver $

</pre>
<p><strong>(See pro/spec2d/aesthetics.pro)</strong></p>
<hr />
<h3 id="ALIGN_REST">ALIGN_REST</h3>
<p><a href="#AESTHETICS">[Previous Routine]</a></p>
<p><a href="#APOALL">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>

 NAME: align_rest

 PURPOSE:
  Align spectra in rest wavelength given redshift.

 COMMENTS:
  Assumes constant log-lam binning, rounds to nearest pixel.

 WRITTEN:
  bolton@utah 2010may

</pre>
<p><strong>(See pro/templates/align_rest.pro)</strong></p>
<hr />
<h3 id="APOALL">APOALL</h3>
<p><a href="#ALIGN_REST">[Previous Routine]</a></p>
<p><a href="#APOFIX">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   apoall

 PURPOSE:
   Run APOREDUCE on one or many nights of data.

 CALLING SEQUENCE:
   apoall, [ mjd=, mjstart=, mjend=, minexp=, copydir= ]

 INPUTS:

 OPTIONAL INPUTS:
   mjd        - Look for raw data files in RAWDIR/MJD; default to '*' to
                search all subdirectories.  Note that this need not be
                integer-valued, but could be for example '51441_test'.
   mjstart    - Starting MJD.
   mjend      - Ending MJD.
   minexp     - Minimum exposure time for science frames; default to 0 sec.
   copydir    - Copy the output log files to this directory; default to none.

 OUTPUT:

 COMMENTS:
   The files are sorted before being sent to APOREDUCE.  For each plate,
   reduce all the biases/darks, then all the flats, then all the arcs,
   and finally all of the science/smear frames.

   Look for the raw sdR files in $BOSS_SPECTRO_DATA/$MJD, the plPlugMapM files
   in $SPECLOG_DIR/$MJD, and put the outputs in $SPECTROLOG_DIR/$MJD.
   If that last environment variable is not set, then put the outputs
   in the same directory as the sdR files.

 EXAMPLES:
   Rerun the SOS code on the spectro data from MJD 53682, putting
   the results in the current directory:
     IDL&gt; setenv, 'BOSS_SPECTRO_DATA=.'
     IDL&gt; apoall, mjd=53682

 BUGS:

 PROCEDURES CALLED:
   aporeduce
   djs_filepath()
   get_mjd_dir()
   sdsshead()
   sxpar()

 REVISION HISTORY:
   27-May-2000  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/apo2d/apoall.pro)</strong></p>
<hr />
<h3 id="APOFIX">APOFIX</h3>
<p><a href="#APOALL">[Previous Routine]</a></p>
<p><a href="#APOFLUXCALIB">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   apofix

 PURPOSE:
   Add line to sdHdrFix file to denote change in FITS header for sdR files.

 CALLING SEQUENCE:
   apofix, expnum, [ card, value, camera=, copydir=, /bad, /test, /excellent, /not_sos ]

 INPUTS:
   expnum     - Exposure number

 OPTIONAL INPUTS:
   card       - FITS header keyword to change; this is case-insensitive,
                so that 'exptime' is the same as 'EXPTIME'.
   value      - New value for FITS header keyword.
   camera     - Camera name in which to change values, e.g. 'b1', 'r1',
                'b2' or 'r2'.  A '?' can be used as a wildcard, for example
                '?2' to denote a change to both 'b2' and 'r2'.  Default to
                '??' to denote a change to sdR files for all 4 cameras.
   copydir    - If set, then copy the output log files to this directory, default is
                to copy to /data/boss/sos/combined
   bad        - If set, then declare the specified exposure number to be bad.
                This is equivalent to setting QUALITY='bad'.
   test       - If set, then declare the specified exposure number to be test.
                This is equivalent to setting QUALITY='test'.
   excellent  - If set, then declare the specified exposure number to be excellent.
                This is equivalent to setting QUALITY='excellent'.
   not_sos    - This keyword can be set to run this proc on a machine
                that is not named &quot;sos&quot; or &quot;sos3&quot;.  This would only be done for
                testing purposes, or if Son-of-Spectro has been moved
                to another machine.
   sos_dir    - This keyword sets the location of the sos output files

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Only the following keywords can be modified with this procedure:
     CAMERAS, FLAVOR, PLATEID, NAME, EXPTIME, TAI-BEG, TAI-END, TAI,
     FFS, FF, NE, HGCD, OBSCOMM, QUALITY
   The AIRMASS is not read from the header, but computed from RADEG,DECDEG
   and the TAI-BEG,TAI-END keywords.
   Refer to the Son-of-Spectro documentation for the specifics of
   valid values for each keyword.

   Note that string values must be enclosed in single- or double-quotes.
   Numeric values should not be in quotes.  Double-precision numbers should
   be written with &quot;d&quot; notation, for example 3.14d7 instead of 3.14e7.

 EXAMPLES:
   Fix the exposure time for exposure #1234 to be 900 sec:
     IDL&gt; apofix, 1234, 'exptime', 900

   Fix the TAI time for exposure #1234 to be 4.443852968d+09
   (use the &quot;d&quot; notation for double-precision, even though it
   will appear in the sdHdrFix file with an &quot;e&quot;):
     IDL&gt; apofix, 1234, 'TAI', 4.443852968d+09

   Declare exposure #1234 as bad:
     IDL&gt; apofix, 1234, /bad
   or equivalently:
     IDL&gt; apofix, 1234, 'quality', 'bad'

   Only declare the 'b1' camera bad for exposure number 1234:
     IDL&gt; apofix, 1234, /bad, camera='b1'

   The wrong NAME is in the header, which is necessary to identify
   the proper plug-map file.  If the correct plug-map file
   is plPlugMapM-0328-52277-01, then edit as follows:
     IDL&gt; apofix, 1234, 'name', '0328-52277-01'

 BUGS:

 PROCEDURES CALLED:
   djs_lockfile()
   djs_modfits
   djs_unlockfile
   fileandpath()
   fits_wait
   headfits()
   struct_append
   sxpar()
   yanny_read

 REVISION HISTORY:
   22-Apr-2002  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/apo2d/apofix.pro)</strong></p>
<hr />
<h3 id="APOFLUXCALIB">APOFLUXCALIB</h3>
<p><a href="#APOFIX">[Previous Routine]</a></p>
<p><a href="#APOHEADER">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   apofluxcalib

 PURPOSE:
   Generate the flux-calibration vectors for use by APOPLOT.

 CALLING SEQUENCE:
   apofluxcalib, [ platenum, mjd= ]

 INPUTS:
   platenum - Plate number for obtaining the fluxing vectors; default to 406
   mjd      - Modified Julian Date for above plate; default to plate 406
              on MJD 51817 if neither is specified

 OPTIONAL INPUTS:

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The output files spFluxcalib-$CAMERA.fits should be moved to
   the directory $IDLSPEC2D_DIR/examples for use by APOPLOT.

   For reference (excerpted from PR #6766):
     Here is the list of 10 main-survey plates with the
     highest S/N per minute in all cameras (where I've looked
     up to plate 650 in the Spectro-2D v5 beta reductions):
              398       51789
              402       51793
              406       51817
              406       51900
              411       51817
              416       51811
              418       51817
              431       51877
              436       51883
              439       51877

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   bspline_iterfit()
   bspline_valu()
   headfits()
   mrdfits()
   mwrfits
   readspec
   traceset2xy

 REVISION HISTORY:
   04-Dec-2001  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/apo2d/apofluxcalib.pro)</strong></p>
<hr />
<h3 id="APOHEADER">APOHEADER</h3>
<p><a href="#APOFLUXCALIB">[Previous Routine]</a></p>
<p><a href="#APOPLOT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   apoheader

 PURPOSE:
   Print the subset of interesting header keywords from the raw sdR files.

 CALLING SEQUENCE:
   apoheader, expnum, [ mjd= ]

 INPUTS:
   expnum     - Exposure number

 OPTIONAL INPUTS:
   mjd        - Optionally specify the MJD for the subdirectory in which
                to search for the file.  This will greatly speed things up.

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:
   Print out all FITS header keywords of interest for exposure # 14728
   (assuming that exposure is still on disk somewhere under $BOSS_SPECTRO_DATA):
     IDL&gt; apoheader, 14728

 BUGS:

 PROCEDURES CALLED:
   fileandpath()
   fits_wait
   sdsshead()
   sxpar()

 REVISION HISTORY:
   24-Apr-2002  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/apo2d/apoheader.pro)</strong></p>
<hr />
<h3 id="APOPLOT">APOPLOT</h3>
<p><a href="#APOHEADER">[Previous Routine]</a></p>
<p><a href="#APOPLOTARC">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   apoplot

 PURPOSE:
   Routine for plotting spectra from the Son-of-Spectro outputs at APO.

 CALLING SEQUENCE:
   apoplot, plate, [ fiberid, mjd=, expnum=, nsmooth=, nmed=, psfile=, $
    /magsort, /netimage, _EXTRA= ]

 INPUTS:
   plate      - Plate number

 OPTIONAL INPUTS:
   fiberid    - Fiber number(s); if not set, then plot all fibers for plate.
   mjd        - MJD number; if not set, then select the most recent MJD
                in the $SPECTROLOG_DIR directory.
   expnum     - If set, then plot only these exposure numbers for this plate
                rather than all exposure numbers for this plate.
   nsmooth    - If set, then boxcar smooth the object spectra with a
                width equal to NSMOOTH.
   nmed       - If set, then median filter the object spectra with a
                width equal to NMED.
   psfile     - If set, then send plot to a PostScript file instead of
                to the SPLOT interactive widget.  The PostScript file name
                can be set explicitly, e.g. with PSFILE='test.ps'.  Or if
                you simply set this as a flag, e.g. with /PSFILE, then the
                default file name is spec-pppp-mmmmm-fff.ps,
                where pppp=plate number, mmmmm=MJD, fff=fiber ID.
   magsort    - If set and FIBERID is not, then plot all fibers from
                the brightest object to the faintest.
   netimage   - If set, then launch a Netscape browser with the object
                image from Steve Kent's web site.  This only works if
                Netscape is running and has permissions at the site
                &quot;http://sdssmosaic.fnal.gov:8015&quot;.
                This is disabled if PSFILE is set.
   _EXTRA     - Kewords for SPLOT, such as XRANGE, YRANGE, THICK.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The Son-of-Spectro outputs are first read from the file:
     $SPECTROLOG_DIR/$MJD/logsheet-$MJD.fits
   This then points to the other files that are read:
     $SPECTROLOG_DIR/$MJD/fflat-$MJD-$PLATE-$EXPNUM-$CAMERA.fits
     $SPECTROLOG_DIR/$MJD/wset-$MJD-$PLATE-$EXPNUM-$CAMERA.fits
     $SPECTROLOG_DIR/$MJD/sci-$PLATE-$CAMERA-$EXPNUM.fits

   If $SPECTROLOG_DIR is not set, then it is assumed to be
     /data/spectro/spectrologs

   The plotting range is set by the 5th and 95th percentiles of the data.
   Note that there are a horrendous amount of cosmic rays in the data
   as extracted by Son-of-Spectro.

   The flux-calibration is very rudimentary, always using the same
   four curves for the four cameras.

 EXAMPLES:
   Plot the spectrum of plate 401, fiber #100 using the SPLOT plotting tool:
     IDL&gt; apoplot, 401, 100
   The spectra from the first exposure (blue and red) are shown as white.
   Other exposures are shown in other colors, and are labelled as such.
   The mouse buttons will zoom in (left), recenter (center), or zoom out
   (right).  The frame can be saved as a PostScript file by selecting
   File-&gt;WriteEPS from the left-hand corner. 

   Make the same plot, but boxcar-smooth the spectrum and limit the
   wavelength range to [4000,5000] Angstroms:
     IDL&gt; apoplot, 401, 100, nsmooth=10, xrange=[5000,6000]

   Some plates are observed on multiple nights. To select one of the two
   observations of plate 306: 
     IDL&gt; apoplot, 306, 20, mjd=51690
   This will only work if you have the Son-of-Spectro outputs for that
   date on your disk.

   Loop through all the spectra for plate 401, interactively:
     IDL&gt; apoplot, 401

   Plot all the spectra from plate 401 to a single PostScript file:
     IDL&gt; apoplot, 401, /psfile

 BUGS:

 DATA FILES:
   $IDLSPEC2D_DIR/examples/spFluxcalib-$CAMERA.fits

 PROCEDURES CALLED:
   djs_maskinterp()
   djs_median()
   djs_oplot
   djs_plot
   fcalib_default()
   get_mjd_dir()
   soplot
   splot
   sdss_flagname()
   sxyouts

 INTERNAL SUPPORT ROUTINES:
   apoplot1

 REVISION HISTORY:
   04-Dec-2001  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/apo2d/apoplot.pro)</strong></p>
<hr />
<h3 id="APOPLOTARC">APOPLOTARC</h3>
<p><a href="#APOPLOT">[Previous Routine]</a></p>
<p><a href="#APOPLOTGEOM">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   apoplotarc

 PURPOSE:
   Routine for plotting arc spectra from the Son-of-Spectro outputs at APO.

 CALLING SEQUENCE:
   apoplotarc, expnum, [ camname=, mjd=, everyn=, psfile=, _EXTRA= ]

 INPUTS:
   expnum     - Exposure number

 OPTIONAL INPUTS:
   camname    - Camera name; default to 'r1'
   mjd        - MJD; must be set if this exposure is not in the most
                recent MJD directory
   everyn     - Plot every EVERYN-th spectrum; default to 40, which will
                plot fiber numbers 1, 41, 81, ...281.
   psfile     - If set, then send plot to a PostScript file instead of
                to the SPLOT interactive widget.  The PostScript file name
                can be set explicitly, e.g. with PSFILE='test.ps'.  Or if
                you simply set this as a flag, e.g. with /PSFILE, then the
                default file name is arc-pppp-cc-eeeeeeee.ps,
                where pppp=plate number, cc=camname, eeeeeeee=exposure number.
   _EXTRA     - Kewords for SPLOT, such as XRANGE, YRANGE, THICK.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The arc spectrum is plotted as a red line.  The individual
   arc values at each pixel in the arc fibers are plotted as points.

   The Son-of-Spectro outputs are first read from the file:
     $SPECTROLOG_DIR/$MJD/logsheet-$MJD.fits
   This then points to the other files that are read:
     $SPECTROLOG_DIR/$MJD/fflat-$MJD-$PLATE-$EXPNUM-$CAMERA.fits
     $SPECTROLOG_DIR/$MJD/wset-$MJD-$PLATE-$EXPNUM-$CAMERA.fits
     $SPECTROLOG_DIR/$MJD/sci-$PLATE-$CAMERA-$EXPNUM.fits

   If $SPECTROLOG_DIR is not set, then it is assumed to be
     /data/spectro/spectrologs

 EXAMPLES:
   Plot the arc spectrum for exposure number 9437 taken in the most
   recent night's data in the r1-camera, using the SPLOT plotting tool:
     IDL&gt; apoplotarc, 9437
   The mouse buttons will zoom in (left), recenter (center), or zoom out
   (right).  The frame can be saved as a PostScript file by selecting
   File-&gt;WriteEPS from the left-hand corner. 

   Make the same plot, but change the Y limits and write a PostScript file:
     IDL&gt; apoplotarc, 9437, yrange=[0,1000], /psfile

 BUGS:

 PROCEDURES CALLED:
   djs_oplot
   djs_plot
   get_mjd_dir()
   soplot
   splot

 REVISION HISTORY:
   20-Nov-2002  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/apo2d/apoplotarc.pro)</strong></p>
<hr />
<h3 id="APOPLOTGEOM">APOPLOTGEOM</h3>
<p><a href="#APOPLOTARC">[Previous Routine]</a></p>
<p><a href="#APOPLOTSKY">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   apoplotgeom

 PURPOSE:
   Routine for plotting arc geometry from the Son-of-Spectro outputs at APO.

 CALLING SEQUENCE:
   apoplotgeom, plate, [ camname=, mjd=, psfile=, _EXTRA= ]

 INPUTS:
   plate      - Plate number

 OPTIONAL INPUTS:
   camname    - Camera name; default to 'r1'
   mjd        - MJD; must be set if this exposure is not in the most
                recent MJD directory
   psfile     - If set, then send plot to a PostScript file instead of
                to the SPLOT interactive widget.  The PostScript file name
                can be set explicitly, e.g. with PSFILE='test.ps'.  Or if
                you simply set this as a flag, e.g. with /PSFILE, then the
                default file name is arc-pppp-cc-eeeeeeee.ps,
                where pppp=plate number, cc=camname, eeeeeeee=exposure number.
   _EXTRA     - Kewords for SPLOT, such as XRANGE, YRANGE, THICK.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The arc spectrum is plotted as a red line.  The individual
   arc values at each pixel in the arc fibers are plotted as points.

   The Son-of-Spectro outputs are first read from the file:
     $SPECTROLOG_DIR/$MJD/logsheet-$MJD.fits
   This then points to the other files that are read:
     $SPECTROLOG_DIR/$MJD/fflat-$MJD-$PLATE-$EXPNUM-$CAMERA.fits
     $SPECTROLOG_DIR/$MJD/wset-$MJD-$PLATE-$EXPNUM-$CAMERA.fits
     $SPECTROLOG_DIR/$MJD/sci-$PLATE-$CAMERA-$EXPNUM.fits

   If $SPECTROLOG_DIR is not set, then it is assumed to be
     /data/spectro/spectrologs

 EXAMPLES:
   Plot the arc spectrum for exposure number 9425 taken in the most
   recent night's data in the r1-camera, using the SPLOT plotting tool:
     IDL&gt; apoplotgeom, 9425
   The mouse buttons will zoom in (left), recenter (center), or zoom out
   (right).  The frame can be saved as a PostScript file by selecting
   File-&gt;WriteEPS from the left-hand corner. 

   Make the same plot, but change the Y limits and write a PostScript file:
     IDL&gt; apoplotgeom, 9425, yrange=[0,1000], /psfile

 BUGS:

 PROCEDURES CALLED:
   djs_oplot
   djs_plot
   get_mjd_dir()
   soplot
   splot

 REVISION HISTORY:
   20-Nov-2002  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/apo2d/apoplotgeom.pro)</strong></p>
<hr />
<h3 id="APOPLOTSKY">APOPLOTSKY</h3>
<p><a href="#APOPLOTGEOM">[Previous Routine]</a></p>
<p><a href="#APOREDUCE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   apoplotsky

 PURPOSE:
   Routine for plotting sky spectra from the Son-of-Spectro outputs at APO.

 CALLING SEQUENCE:
   apoplotsky, expnum, [ camname=, mjd=, psfile=, _EXTRA= ]

 INPUTS:
   expnum     - Exposure number

 OPTIONAL INPUTS:
   camname    - Camera name; default to 'r1'
   mjd        - MJD; must be set if this exposure is not in the most
                recent MJD directory
   psfile     - If set, then send plot to a PostScript file instead of
                to the SPLOT interactive widget.  The PostScript file name
                can be set explicitly, e.g. with PSFILE='test.ps'.  Or if
                you simply set this as a flag, e.g. with /PSFILE, then the
                default file name is sky-pppp-cc-eeeeeeee.ps,
                where pppp=plate number, cc=camname, eeeeeeee=exposure number.
   _EXTRA     - Kewords for SPLOT, such as XRANGE, YRANGE, THICK.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The supersky spectrum is plotted as a red line.  The individual
   sky values at each pixel in the sky fibers are plotted as points.

   The Son-of-Spectro outputs are first read from the file:
     $SPECTROLOG_DIR/$MJD/logsheet-$MJD.fits
   This then points to the other files that are read:
     $SPECTROLOG_DIR/$MJD/fflat-$MJD-$PLATE-$EXPNUM-$CAMERA.fits
     $SPECTROLOG_DIR/$MJD/wset-$MJD-$PLATE-$EXPNUM-$CAMERA.fits
     $SPECTROLOG_DIR/$MJD/sci-$PLATE-$CAMERA-$EXPNUM.fits

   If $SPECTROLOG_DIR is not set, then it is assumed to be
     /data/spectro/spectrologs

 EXAMPLES:
   Plot the sky spectrum for exposure number 9425 taken in the most
   recent night's data in the r1-camera, using the SPLOT plotting tool:
     IDL&gt; apoplotsky, 9425
   The mouse buttons will zoom in (left), recenter (center), or zoom out
   (right).  The frame can be saved as a PostScript file by selecting
   File-&gt;WriteEPS from the left-hand corner. 

   Make the same plot, but change the Y limits and write a PostScript file:
     IDL&gt; apoplotsky, 9425, yrange=[0,1000], /psfile

 BUGS:

 PROCEDURES CALLED:
   djs_oplot
   djs_plot
   get_mjd_dir()
   soplot
   splot

 REVISION HISTORY:
   20-Nov-2002  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/apo2d/apoplotsky.pro)</strong></p>
<hr />
<h3 id="APOREDUCE">APOREDUCE</h3>
<p><a href="#APOPLOTSKY">[Previous Routine]</a></p>
<p><a href="#APO_APPENDLOG">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   aporeduce

 PURPOSE:
   Quick on-the-mountain reduction pipeline for 1 file at a time.

 CALLING SEQUENCE:
   aporeduce, filename, [ indir=, outdir=, $
    plugfile=, plugdir=, minexp=, $
    copydir=, /no_diskcheck, /no_lock ]

 INPUTS:
   filename   - Raw spectroscopic image file name(s) of any flavor; this
                can be an array of file names, but cannot include wildcards

 OPTIONAL INPUTS:
   indir      - Input directory for FILENAME; default to './';
                conventionally will explicitly contain $MJD in the name
   outdir     - Output directory for reduced data and log files;
                default to INDIR
   plugfile   - Name of plugmap file (Yanny parameter file); default to
                'plPlugMapM-'+NAME+'.par', where NAME is taken from that
                keyword in the file FILENAME
   plugdir    - Input directory for PLUGFILE; default to INDIR
   minexp     - Minimum exposure time for science frames; default to 0 sec
                so that any frame with a non-negative exposure time is
                reduced.
   copydir    - If set, then copy the output log files to this directory using
                &quot;scp&quot; copy (not &quot;scp1&quot; any longer).  Make an additional copy
                of the HTML file called 'logsheet-current.html'.
   no_diskcheck- If set, then do not do the check for filling input or
                output disks.  (This option is always set by the APOALL proc).
   no_lock    - If set, then do not create lock files for the input files;
                this option is useful for calls from APOALL.

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:
   After reducing any 'r2' frame, we re-generate the HTML file and optionally
   copy it to the file specified by COPYDIR.

   The copy of the file &quot;logsheet-current.html&quot; also has a line of Java-script
   added that does an auto-refresh every 60 seconds.

 EXAMPLES:

 BUGS:
   scp1 does not exist on sos.apo.nmsu.edu, reverted to scp

 INTERNAL SUPPORT ROUTINES:
   apo_diskcheck

 PROCEDURES CALLED:
   apo_appendlog
   apo_log2html
   apo_plotsn
   djs_filepath()
   fits_wait()
   get_tai
   idlspec2d_version()
   idlutils_version()
   quickbias()
   quickextract()
   quicktrace()
   quickwave()
   splog
   tai2airmass()

 REVISION HISTORY:
   30-Apr-2000  Written by D. Schlegel &amp; S. Burles, APO
</pre>
<p><strong>(See pro/apo2d/aporeduce.pro)</strong></p>
<hr />
<h3 id="APO_APPENDLOG">APO_APPENDLOG</h3>
<p><a href="#APOREDUCE">[Previous Routine]</a></p>
<p><a href="#APO_CHECKLIMITS()">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   apo_appendlog

 PURPOSE:
   Append to logfile as written by APOREDUCE.

 CALLING SEQUENCE:
   apo_appendlog, logfile, rstruct, tstruct

 INPUTS:
   logfile    - FITS logfile as written by APOREDUCE.
   rstruct    - Structure to append to the log file with reduced data info
   tstruct    - Structure to append to the log file with WARNING/ABORT strings

 OPTIONAL INPUTS:

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_lockfile()
   djs_modfits
   djs_unlockfile
   headfits()
   idlutils_version()
   idlspec2d_version()
   modfits
   mrdfits()
   mwrfits
   splog
   sxaddpar
   struct_append()

 REVISION HISTORY:
   02-Dec-2000  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/apo2d/apo_appendlog.pro)</strong></p>
<hr />
<h3 id="APO_CHECKLIMITS()">APO_CHECKLIMITS()</h3>
<p><a href="#APO_APPENDLOG">[Previous Routine]</a></p>
<p><a href="#APO_LOG2HTML">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   apo_checklimits()

 PURPOSE:
   Convert output FITS file from APOREDUCE to HTML format.

 CALLING SEQUENCE:
   markstring = apo_checklimits(flavor, field, camera, value, [ /html ] )

 INPUTS:
   flavor     - FLAVOR to match in the opLimits file.
   field      - FIELD to match in the opLimits file.
   camera     - CAMERA to match in the opLimits file.
   value      - Value to test in the opLimits file.  If this is a
                string value, then one matches to STRVAL in that file.
                Otherwise, test for values within [LOVALUE,HIVALUE].

 OPTIONAL INPUTS:
   html       - If set, then convert the color name in MARKSTRING into
                an HTML string.  For example, a return value of 'red'
                becomes '&lt;B&gt;&lt;FONT COLOR=&quot;#FF0000&quot;&gt;'.

 OUTPUT:
   markstring - Return the COLOR from the opLimits file.

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:

 DATA FILES:
   $IDLSPEC2D_DIR/examples/opLimits.par

 REVISION HISTORY:
   30-Apr-2000  Written by D. Schlegel, APO
</pre>
<p><strong>(See pro/apo2d/apo_checklimits.pro)</strong></p>
<hr />
<h3 id="APO_LOG2HTML">APO_LOG2HTML</h3>
<p><a href="#APO_CHECKLIMITS()">[Previous Routine]</a></p>
<p><a href="#APO_PLOTBIAS">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   apo_log2html

 PURPOSE:
   Convert output FITS file from APOREDUCE to HTML format.

 CALLING SEQUENCE:
   apo_log2html, logfile, [ htmlfile ]

 INPUTS:
   logfile    - Input log file as a FITS binary file with an extension
                for each frame reduced; this file is written by APOREDUCE.

 OPTIONAL INPUTS:
   htmlfile   - Output log file in HTML format; default to the same name
                as LOGFILE, replacing the '.fits' extension with '.html'

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   apo_checklimits()
   copy_struct_inx
   djs_filepath()
   djs_findfile()
   djs_lockfile()
   djs_unlockfile
   fileandpath()
   headfits()
   mrdfits
   repstr()
   sxpar()

 INTERNAL SUPPORT ROUTINES:
   apo_color2hex()
   apo_log_header()
   apo_log_endfile()
   apo_log_tableline()
   apo_log_beginplate()
   apo_log_endplate()
   apo_log_fields()

 REVISION HISTORY:
   30-Apr-2000  Written by D. Schlegel, APO
</pre>
<p><strong>(See pro/apo2d/apo_log2html.pro)</strong></p>
<hr />
<h3 id="APO_PLOTBIAS">APO_PLOTBIAS</h3>
<p><a href="#APO_LOG2HTML">[Previous Routine]</a></p>
<p><a href="#APO_PLOTSN">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   apo_plotbias

 PURPOSE:
   Plot the histogram of bias values for all 4 cameras of a single exposure

 CALLING SEQUENCE:
   apo_plotbias, expnum, [ plotfile= ]

 INPUTS:
   expnum     - Exposure number

 OPTIONAL INPUTS:
   plotfile   - Plot file; if set, then send plot to this PostScript file
                rather than to the default (X) display.

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The histogram of bias values is plotted for all (4) camera files that
   match the given exposure number.

   A fiducial line is drawn as a thick blue line.  This line approximates
   what we expect to see for each camera.

   If $BOSS_SPECTRO_DATA is not set, then it is assumed to be
     /data/spectro

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   dfpsclose
   dfpsplot
   djs_filepath()
   djs_icolor()
   djs_xyouts
   fileandpath()
   headfits()
   plothist
   quickbias
   sdssproc
   struct_append()
   sxpar()

 REVISION HISTORY:
   06-Dec-2000  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/apo2d/apo_plotbias.pro)</strong></p>
<hr />
<h3 id="APO_PLOTSN">APO_PLOTSN</h3>
<p><a href="#APO_PLOTBIAS">[Previous Routine]</a></p>
<p><a href="#APO_REFRAC">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   apo_plotsn

 PURPOSE:
   Generate S/N plot for one plate from a FITS logfile written by APOREDUCE.

 CALLING SEQUENCE:
   apo_plotsn, logfile, plate, [ expnum=, plugdir=, plotfile= ]

 INPUTS:
   logfile    - Logfile as written by APOREDUCE.  This is a FITS file
                with an HDU of information for each reduced frame.
   plate      - Plate number to plot.

 OPTIONAL KEYWORDS:
   expnum     - If set, then make plot with S/N from exposures matching
                this value (which can be an array of exposure numbers)
   plugdir    - Input directory for PLUGFILE; default to '.'
                The name of the plugmap file is taken from the first
                structure in the LOGFILE.
   plotfile   - Name of plot file; if not specified then send plot to
                current device.

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   apo_checklimits()
   djs_lockfile()
   djs_unlockfile
   mrdfits
   plotsn
   splog
   readplugmap()

 REVISION HISTORY:
   02-May-2000  Written by D. Schlegel, APO
</pre>
<p><strong>(See pro/apo2d/apo_plotsn.pro)</strong></p>
<hr />
<h3 id="APO_REFRAC">APO_REFRAC</h3>
<p><a href="#APO_PLOTSN">[Previous Routine]</a></p>
<p><a href="#ARCFIT_GUESS">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   apo_refrac
 PURPOSE:
   Take RA and DEC and apply refraction at APO for a specific LST
 CALLING SEQUENCE:
   apo_refrac, ra, dec, racen, deccen, ra_refrac, dec_refrac [, $
      lst=, airtemp= ]
 INPUTS:
   ra,dec     - [N] arrays of true locations (J2000 deg)
   racen      - RA center for tile (J2000 deg)
   deccen     - DEC center for tile (J2000 deg)
 OPTIONAL INPUTS:
   lst        - anticipated LST of observation (in deg; default to racen)
   airtemp    - air temperature (in C; default to 5)
 OUTPUTS:
   ra_refrac,dec_refrac - [N] arrays of observed locations (J2000 deg)
 COMMENTS:
   Without setting LST explicitly, it assumes that you will observe
   at an hour angle of 0. 
   Uses Lat=32.7803 deg, and Height=2788 m (relevant for APO)
 REVISION HISTORY:
   26-Oct-2006  Written by MRB, NYU (cribbed from PRIMUS code by Burles)
</pre>
<p><strong>(See pro/plate/apo_refrac.pro)</strong></p>
<hr />
<h3 id="ARCFIT_GUESS">ARCFIT_GUESS</h3>
<p><a href="#APO_REFRAC">[Previous Routine]</a></p>
<p><a href="#ATMDISP_COR">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   arcfit_guess

 PURPOSE:
   Determine initial wavelength solution by comparing spectrum to arc spectrum

 CALLING SEQUENCE:
   wset = arcfit_guess( spec, loglam, intensity, color=color, $
    [ func=func, bestcorr=bestcorr, acoeff=, dcoeff=, nsteps= ] )

 INPUTS:
   spec       - 1-D spectrum
   loglam     - Log-lambda of arc lines
   intensity  - Intensity of arc lines

 REQUIRED KEYWORDS:
   color      - 'red' or 'blue'

 OPTIONAL KEYWORDS:
   func       - Name of fitting function; default to 'legendre'
   acoeff     - central values of coefficents to explore
   dcoeff     - range (-.5*dcoeff to .5*dcoeff) of values to explore
   nsteps     - array of steps to use

 OUTPUTS:
   wset       - traceset (pix -&gt; lambda)

 OPTIONAL OUTPUTS:
   bestcorr   - Correlation coefficient with simulated arc spectrum

 COMMENTS:

 EXAMPLES:

 BUGS:

 INTERNAL SUPPORT PROCEDURES:
   tset_struc()
   arcfit_iter()

 PROCEDURES CALLED:
   traceset2xy()
   xy2traceset

 REVISION HISTORY:
   18-Nov-1999  Written by D. Schlegel, Princeton.
                Excised code from FITARCIMAGE.
   01-Dec-2000  added acoeff, dcoeff, nsteps keywords
</pre>
<p><strong>(See pro/spec2d/arcfit_guess.pro)</strong></p>
<hr />
<h3 id="ATMDISP_COR">ATMDISP_COR</h3>
<p><a href="#ARCFIT_GUESS">[Previous Routine]</a></p>
<p><a href="#ATVRAWSPEC">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   atmdisp_cor
 
 PURPOSE:
   Atmospheric dispersion causes wavelength dependent lightloss from 
   fiber spectra.  The mean atmospheric dispersion experienced by the 
   standard stars on each plate is automatically corrected for as part of
   the flux calibration.  However, any shift in the centering of the 
   spectroscopic targets in the fibers across the plate will result in 
   differences in atmospheric dispersion as a function of plate position.
   These centering errors -- caused by small errors in the plate scale or
   rotation -- can produce flux calibration errors of up to 20%.  This
   procedure is designed to correct for these.

   Synthetic magnitudes are computed from the spectra on 1 half-plate and
   compared to the photo fiber magnitudes.  The residuals are fit as a 
   function of plate x/y position with a 3rd order polynomial. The (g-r) 
   offsets of this fit are then mapped into an atmospheric dispersion 
   correction.  This mapping makes use of models of the atmospheric dispersion
   of point sources observed with 2&quot; seeing through 3&quot; fibers at a variety
   of airmasses.  The absolute light loss is mapped using the r-band mag
   residuals.  A vector of wavelength dependent corrections is returned.

 CALLING SEQUENCE:

   atm_model = atmdisp_cor(loglam, flux, plugtag, hdr, title = title, $
                           surfgr_sig = surfgr_sig)

 INPUTS:
   loglam  - wavelength array of input spectra in log10(Angstroms) [npix]
   flux    - flux array from 1 half plate [npix, nfiber] (nfiber~320)
   plugtag - plugmap [nfiber] -- used for mags, plate x/y, sky &amp; standard ID
   hdr     - image header -- used for aquiring airmass info (maybe also
             seeing and guiding in the future)

 OUTPUT:
   A model of the atmospheric dispersion correction for each fiber is
   returned [npix, nfiber].  (To correct: flux_cor = flux / atm_model)
   Plots are generated showing the (g-r) and r mag offsets as a function 
   of plate x/y before and after the correction.  Histograms are produced
   as well.
 
 KEYWORDS:
   title     -  title of output plots (usually plate/mjd/specid)
   surfgr_sig - sigma of 2d fit to the (g-r) offsets -- this is a good
                indicator of how big the correction is.

 COMMENTS:
   This function requires an external source of info about the effects
   of atmospheric dispersion as a function of wavelength.  This info is
   stored in structures in IDLSPEC2D_DIR/etc/.  They are named 
   'atmdisp_vec_am' + airmass + 'see2.0.fit' where airmass is a value from
   1.1 - 1.5.

 BUGS:
   Galaxies and stars respond differently to atmospheric dispersion beause
   of thier different spatial extent.  The mean correction which is 
   derived here is really that appropriate for the average galaxy -- 
   so corrections for point sources are likely to be underestimated a bit.
   To do this right the spatial profile of each object should be taken into
   account.

 EXAMPLES:

 PROCEDURES CALLED:
   djs_icolor()
   djs_iterstat()
   djs_oplot
   djs_sfit_iter()
   filter_thru()
   gaussfit()
   legend
   linterp
   mrdfits
   plothist
   traceset2xy
   
 INTERNAL SUPPORT ROUTINES:
   sphoto_xy

 REVISION HISTORY:
   Created 12-Aug-2003 by C. Tremonti, Steward Observatory
</pre>
<p><strong>(See pro/fluxfix/atmdisp_cor.pro)</strong></p>
<hr />
<h3 id="ATVRAWSPEC">ATVRAWSPEC</h3>
<p><a href="#ATMDISP_COR">[Previous Routine]</a></p>
<p><a href="#ATVSPEC">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   atvrawspec

 PURPOSE:
   Display a 2D spectroscopic image with bad columns marked in red.

 CALLING SEQUENCE:
   atvrawspec, filename, _EXTRA=KeywordsForATV

 INPUTS:
   filename   - Either a raw SDSS file name, or a 2D pixel flat or 2D bias

 OPTIONAL KEYWORDS:
   _EXTRA     - Extra keywords for ATV, such as MIN,MAX

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:
   Display a 2D pixel flat with a reasonable display stretch:
   IDL&gt; atvrawspec, 'pixflat-52069-b1.fits', min=0.9, max=1.1

   Display a 2D bias with a reasonable display stretch:
   IDL&gt; atvrawspec, 'pixbias-52069-b1.fits', min=-5, max=10

 BUGS:

 PROCEDURES CALLED:
   atv
   atvplot
   djs_filepath()
   findopfile()
   headfits()
   sdssproc
   yanny_free
   yanny_read

 DATA FILES:
   $IDLSPEC2D_DIR/examples/opBC*par

 REVISION HISTORY:
   26-Feb-2002  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/apo2d/atvrawspec.pro)</strong></p>
<hr />
<h3 id="ATVSPEC">ATVSPEC</h3>
<p><a href="#ATVRAWSPEC">[Previous Routine]</a></p>
<p><a href="#BADFMAGS">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   atvspec

 PURPOSE:
   Display cutouts of all raw images around specified wavelengths

 CALLING SEQUENCE:
   atvspec, plate, fiberid, wave=, [ mjd=, xsize=, ysize=, $
    psym=, symsize=, color=, _EXTRA=, /verbose ]

 INPUTS:
   plate      - Plate (scalar)
   fiberid    - Fiber ID (scalar)
   wave       - Wavelength(s) at which to display raw images (vacuum Ang)

 OPTIONAL INPUTS:
   mjd        - MJD (scalar)
   xsize      - X dimension of cutout of raw images; default to 50 pix
   ysize      - Y dimension of cutout of raw images; default to 50 pix
   psym       - PSYM keyword for ATVPLOT; default to 6 (squares)
   symsize    - SYMSIZE keyword for ATVPLOT; default to 3
   color      - COLOR keyword for ATVPLOT; default to 'red'
   verbose    - If set, then print X,Y locations on CCD
   _EXTRA     - Keywords for ATV, such as /ALIGN or /STRETCH

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Display cutouts from the raw images, with each row of cutouts
   corresponding to each WAVE and each column corresponding to the
   exposure numbers.  Assume wavelengths &lt; 6000 Ang should display
   the blue images, and &gt; 6000 Ang should dislpay the red images.

 EXAMPLES:
   Display raw images around two bright sky lines
     IDL&gt; atvspec, 3686, 1, mjd=55268, wave=[5578.8876,6302.0466]

 BUGS:

 REVISION HISTORY:
   08-Jul-2010  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/spec2d/atvspec.pro)</strong></p>
<hr />
<h3 id="BADFMAGS">BADFMAGS</h3>
<p><a href="#ATVSPEC">[Previous Routine]</a></p>
<p><a href="#BADFSTARS">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   badfmags

 PURPOSE:
   Find any F stars where the magnitudes in the calibObj files are grossly
   discrepent from the plug-map files.

 CALLING SEQUENCE:
   badfmags, [ maxdiff= ]

 INPUTS:

 OPTIONAL INPUTS:
   maxdiff - Maximum r-band magnitude difference; default to 0.4

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   This routine looks for calibration F stars that have very
   discrepent magnitudes in the plug-map file vs. the calibObj files.
   Only the r-band magnitudes are compared, and they must differ by
   at least MAXDIFF in order to trigger a warning.

   Before comparing the magnitudes, first offset all the F star
   magnitudes by their median difference.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   platelist
   readspec
   splog

 REVISION HISTORY:
   10-Feb-2004  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/plan/badfmags.pro)</strong></p>
<hr />
<h3 id="BADFSTARS">BADFSTARS</h3>
<p><a href="#BADFMAGS">[Previous Routine]</a></p>
<p><a href="#BAD_BOSSFORMAT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   badfstars

 PURPOSE:
   Find bad F stars used for spectro-photometry in the Spectro-2D reductions

 CALLING SEQUENCE:
   badfstars, [ /doplot ]

 INPUTS:

 OPTIONAL INPUTS:
   doplot     - If set, then use PLOTSPEC to plot all the bad spectra

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   This procedure looks at all the objects labelled as either
   OBJTYPE='SPECTROPHOTO_STD' or 'REDDEN_STD' in the spAll.fits file.
   These are considered to be bad F stars if the following conditions
   are satisfied:
     WCOVERAGE &gt; 0.10
     (|cz| &gt; 500 km/sec) OR (not an B,A,F,G-type star)
   These objects are then listed in the file 'badfstars.log', and then
   plotted if /DOPLOT is set.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   hogg_mrdfits()
   plotspec

 REVISION HISTORY:
   06-Feb-2004  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/plan/badfstars.pro)</strong></p>
<hr />
<h3 id="BAD_BOSSFORMAT">BAD_BOSSFORMAT</h3>
<p><a href="#BADFSTARS">[Previous Routine]</a></p>
<p><a href="#BANDPASSFILTER">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   bad_bossformat

 PURPOSE:
   Search for electronics problems in the raw spectro images

 CALLING SEQUENCE:
   bad_bossformat, [docams=, mjd= ]

 INPUTS:

 REQUIRED KEYWORDS:

 OPTIONAL KEYWORDS:
   docams     - Camera(s); default to ['b1','b2','r1','r2']
   mjd        - Search for all files in $BOSS_SPECTRO_DATA/MJD;
                default to '55???'

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   fileandpath()
   sdssproc
   splog

 REVISION HISTORY:
   14-Dec-2009  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/plan/bad_bossformat.pro)</strong></p>
<hr />
<h3 id="BANDPASSFILTER">BANDPASSFILTER</h3>
<p><a href="#BAD_BOSSFORMAT">[Previous Routine]</a></p>
<p><a href="#BANDPASSINFO">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   bandpassfilter

 PURPOSE:

 CALLING SEQUENCE:
   newdata = bandpassfilter( datafft, [ klo_cut=, khi_cut= ] )

 INPUTS:
   datafft    - Vector of Fourier-transformed data

 OPTIONAL KEYWORDS:
   klo_cut    - Low-frequency cutoff
   khi_cut    - High-frequency cutoff

 OUTPUTS:
   newdata    - Filtered version of DATAFFT

 OPTIONAL OUTPUTS:

 COMMENTS:
   Units???

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:

 REVISION HISTORY:
   30-Mar-2000  Written by D. Schlegel, APO
</pre>
<p><strong>(See pro/spec1d/bandpassfilter.pro)</strong></p>
<hr />
<h3 id="BANDPASSINFO">BANDPASSINFO</h3>
<p><a href="#BANDPASSFILTER">[Previous Routine]</a></p>
<p><a href="#BATCHPBS">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   bandpassinfo
 PURPOSE:
   Return information about SDSS bandpasses u,g,r,i,z.
 COMMENTS:
   This routine can be used to convert filternames into numbers and back.
   If band is passed as a string, it gets whitespace-trimmed before use.
 CALLING SEQUENCE:
   bandpassinfo, band,index=index,name=name,wave=wave,fwhm=fwhm,zero=zero
 INPUTS:
   band    - a name (ugriz) or index (01234), or a vector of them
 OPTIONAL KEYWORDS:
 OUTPUTS:
 OPTIONAL OUTPUTS:
   index     - the band's index number (0-4)
   name      - name ('u' through 'z')
   wave      - central wavelength in Angstroms
   fwhm      - width of the bandpass in Angstroms
   zero      - the flux in Jy of a zero-magnitude source
   blueindex - the index (0-3) of the blue bandpass of the k-correction color
   redindex  - the index (1-4) of the red bandpass of the k-correction color
   colorname - the name of the color ('(u-g)' through '(i-z)')
 BUGS:
   Returns 0's (u's) or 4's (z's) where the input is wacky.
   Computes even unnecessary things (this could be fixed with some calls to
     keyword_set().
 PROCEDURES CALLED:
 REVISION HISTORY:
   2000-Jun-28  Written by Hogg (IAS)
</pre>
<p><strong>(See pro/science/bandpassinfo.pro)</strong></p>
<hr />
<h3 id="BATCHPBS">BATCHPBS</h3>
<p><a href="#BANDPASSINFO">[Previous Routine]</a></p>
<p><a href="#BBSPEC_EXTRACT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   batchpbs

 PURPOSE:
   Batch process Spectro-2D and Spectro-1D reductions based upon
   already-built plan files.

 CALLING SEQUENCE:
   batchpbs, [ platenums, topdir=, run2d=, run1d=, platestart=, plateend=, $
    mjd=, mjstart=, mjend=, upsvers2d=, upsvers1d=, /zcode, queue=, /skip2d, $
     /clobber, /nosubmit ]

 INPUTS:

 OPTIONAL INPUTS:
   platenums  - Plate numbers to reduce; default to '*'
   topdir     - Optional override value for the environment
                variable $BOSS_SPECTRO_REDUX.
   run2d      - Optional override value for the environment variable $RUN2D
   run1d      - Optional override value for the environment variable $RUN1D
   platestart - Starting plate number.
   plateend   - Ending plate number.
   mjd        - MJD dates to reduce; default to all.
                Select based upon the MJD of the combine plan file, and
                reduce data from all nights needed for that combined plate+MJD.
   mjstart    - Starting MJD dates to reduce.
   mjend      - Ending MJD dates to reduce.
   upsvers2d  - If set, then do a &quot;setup idlspec2d $UPSVERS2D&quot; on the
                remote machine before executing Spectro-2D.  This allows
                you to batch jobs using a version other than that which
                is declared current under UPS.
   upsvers1d  - If set, then do a &quot;setup idlspec2d $UPSVERS2D&quot; on the
                remote machine before executing Spectro-1D.  This allows
                you to batch jobs using a version other than that which
                is declared current under UPS.
   zcode      - If set, run Zcode in auto mode.
   queue      - If set, sets the submit queue.
   skip2d     - If set, then skip the Spectro-2D reductions.
   clobber    - If set, then reduce all specified plates.  The default is
                to not reduce plates where the script file already exists.
   nosubmit   - If set, generate script file but don't submit to queue

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:
   This is currently written to batch all Spectro-2D and Spectro-1D
   reductions, without the option of doing only one or the other.

   Script files are generated for partial reductions of a plate,
   although those jobs are not submitted.  It would be less confusing
   to not make those script files.

 REVISION HISTORY:
   17-Jan-2010  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/spec2d/batchpbs.pro)</strong></p>
<hr />
<h3 id="BBSPEC_EXTRACT">BBSPEC_EXTRACT</h3>
<p><a href="#BATCHPBS">[Previous Routine]</a></p>
<p><a href="#BBSPEC_TEST">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   bbspec_extract

 PURPOSE:
   Run bbspec 2D extraction code

 CALLING SEQUENCE:
   bbspec_extract, image, invvar, flux, fluxivar, basisfile=, $
    [ ximg=, frange=, yrange=, ymodel=, tmproot=, outfile=, /batch ]

 INPUTS:
   image      - Image [NX,NY]
   innvar     - Inverse variance image corresponding to IMAGE [NX,NY]
   basisfile  - File with PSF model for bbspec

 OPTIONAL INPUTS:
   ximg       - X centroids of fibers on IMAGE, to replace those entries
                in the PSF file [NY,NFIBER]
   frange     - Fiber number range (0-indexed); default to all fibers
                represented in the PSF file; extract all 20-fiber bundles
                spanned by this range, so specifying [25,30] would extract
                fiber numbers [20,39]
   yrange     - 0-indexed ange of rows to extract; default to all rows
                that contain any unmasked pixels
   tmproot    - Root file name for temporary files; default to 'tmp-';
                necessary to be a unique string identifier if multiple
                instances of this procedure running in the same directory,
                for example those spawned by BBSPECT_TEST.
   outfile    - If set, then output FITS file with 3 HDUs containing FLUX,
                FLUXIVAR, YMODEL
   batch      - If set, then batch each bundle of 20 fibers to a different
                PBS job; FRANGE keyword cannot also be set

 OUTPUTS:
   flux       - Extracted flux vectors [NY,NFIBER]
   fluxivar   - Extracted inverse variance vectors [NY,NFIBER]

 OPTIONAL OUTPUTS:
   ymodel     - Model-fit image

 COMMENTS:
   Currently hard-wired to extract in chunks of 20 fibers by 100 rows,
   with the 15 rows on the top and bottom to be used as padding and
   discarded.

 EXAMPLES:

 BUGS:

 DATA FILES:

 PROCEDURES CALLED:
   splog

 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   24-May-2011  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/spec2d/bbspec_extract.pro)</strong></p>
<hr />
<h3 id="BBSPEC_TEST">BBSPEC_TEST</h3>
<p><a href="#BBSPEC_EXTRACT">[Previous Routine]</a></p>
<p><a href="#BESTFOCUS">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   bbspec_test

 PURPOSE:;
   Run bbspec 2D extraction code as an after-burner to existing reductions

 CALLING SEQUENCE:
   bbspec_test, scifile, [ outfile=, /clobber, /batch, _EXTRA= ]

 INPUTS:
   scifile    - spFrame file name

 OPTIONAL INPUTS:
   outfile    - Output FITS file with 2D image model; default to
                'ymodel-test.fits'
   clobber    - If set, then clobber any existing PSF and re-generate it
   batch      - If set, then batch each bundle of 20 fibers to a different
                PBS job; FRANGE keyword cannot also be set
   _EXTRA     - Keywords for BBSPEC_EXTRACT, such as FRANGE,YRANGE

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   This routine calls the bbspec PSF-construction and 2D extraction
   code as an afterburner to the pipeline, assuming that there already
   exists an spFrame, spArc, spFlat.  Existing spBasisPSF files are not
   over-written unless /CLOBBER is set.

   If the spBasisPSF file cotains only the first N fibers, then only
   those N fibers are extracted.  If /BATCH is set, then N must be
   a multiple of 20 since the code is then called in explicit batches
   of 20 fibers.

   The output file contains 3 HDUs with the 2-D model image,
   extracted fluxes, and extracted inverse variances.

 EXAMPLES:

 BUGS:

 REVISION HISTORY:
   24-May-2011  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/spec2d/bbspec_test.pro)</strong></p>
<hr />
<h3 id="BESTFOCUS">BESTFOCUS</h3>
<p><a href="#BBSPEC_TEST">[Previous Routine]</a></p>
<p><a href="#BIN_SPECTRA">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
     bestfocus

 PURPOSE:
   Compute the offset from Hartmann images of different focus ring positions

 CALLING SEQUENCE:
   pro bestfocus  expstart=,expend=,red_focus1=, blue_focus1=, red_focus2=, blue_focus2=,camname=,indir=,skipcollimate=,viewplots=


 INPUTS:
   expstart    - First exposure number of raw sdR file.
   expend      - Last exposure number of raw sdR file
 OPTIONAL KEYWORDS
   red_focus1  - The different red 1 focus ring positions; default to
                 [-50.,-25.,0.,25.,50.,0.]
   red_focus2  - The different red 2 focus ring positions; default to
                red_focus1
   blue_focus1  - The different blue 1 focus ring positions; default to
                 red_focus1
   blue_focus2  - The different blue 2 focus ring positions; default to
                 red_focus1

   camname    - Cameras to analyze; default to ['b1','b2','r1','r2'].
   indir      - Input directory for files; default to searching for
                files in $BOSS_SPECTRO_DATA/*.  If $BOSS_SPECTRO_DATA is not set,
                then it is assumed to be /data/spectro.
  
   skipcollimate - If the Collimate*.log files already exist in the
                  current directory, then you can skip collimate by
                  setting skipcollimate=1.  By default, collimate
                  will run

   viewplots  - To look at each plot individually to determine what
                data points to throw away, set viewplots=1.  By
                default, you will not view each plot individually

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   
   If required, Collimate is run on all files between expstart and expstop that go
   in the sequence 'Left   ' 'Right   '.  The offsets in Collimate*.log files
   are then used to figure out the offset in microns of the ccd as a
   function of the focus ring position.  Since there is low number
   statistics, the plots need to be looked at to see if the data is
   good, many times the first and last focus ring position (very far
   out of focus) is not a good fit.  The screen output is the out of
   focus position from the mean for each subsection.  Going from left
   to right is the focus offset in microns in the spatial direction
   and top to bottom is the focus offset in microns in the spectral direction



 EXAMPLES:
   Check for tilt on b2 with Hartmanns from 55218 
    (assuming the files exist in /data/spectro/55218):
     IDL&gt; bestfocus, expstart=00107910,expend=00107921,camname='b2',red_focus1= [-50.,-25.,0.,25.,50.,0.]

 BUGS:

 PROCEDURES CALLED:
   collimate
   sdssproc
   splog
   sxpar()

 INTERNAL SUPPORT ROUTINES:
   collimate_obscomm()
   collimate_bad_hdr()

 REVISION HISTORY:

   01-Sep-2009  K. Dawson, Utah
   22-Jan-2010  M. Olmstead, Utah
</pre>
<p><strong>(See pro/apo2d/bestfocus.pro)</strong></p>
<hr />
<h3 id="BIN_SPECTRA">BIN_SPECTRA</h3>
<p><a href="#BESTFOCUS">[Previous Routine]</a></p>
<p><a href="#BOLTON_BIASGEN">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   bin_spectra

 PURPOSE:
   Make binned spectra for the purposes of fitting for the 
   bandpasses 

 CALLING SEQUENCE:
   bin_spectra, flux, binbounds

 INPUTS:
   flux   - flux in a set of spectra [NPIX,NSPEC]
   invvar   - inverse variance in a set of spectra [NPIX,NSPEC]
   binbounds   - boundaries of desired bins

 OPTIONAL INPUTS:

 OPTIONAL KEYWORDS:

 OUTPUTS:
   binflux  - binned flux

 COMMENTS:
   Not currently binning the variances. Sorry.

 EXAMPLES:

 PROCEDURES CALLED:

 DATA FILES:

 REVISION HISTORY:
   05-APr-2000  Written by M. Blanton, Fermiland
</pre>
<p><strong>(See pro/spec1d/bin_spectra.pro)</strong></p>
<hr />
<h3 id="BOLTON_BIASGEN">BOLTON_BIASGEN</h3>
<p><a href="#BIN_SPECTRA">[Previous Routine]</a></p>
<p><a href="#BOLTON_BIASSUB">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>

 NAME:
  bolton_biasgen

 PURPOSE:
  Generate BOSS 4-amp master bias frames given an input file list.

 USAGE:
  bolton_biasgen, bias_files [, outfile=, niter=, sigthresh=, outbias=]

 ARGUMENTS:
   bias_files: list of full path qualified sdR files to use
   outfile: output filename, default is, e.g., 'boss_pixbias-r1-55300.fits'
     where the camera ID and MJD are taken from the header of the
     first file in the list of inputs.
   niter: number of modeling iterations, default is 10
   sigthresh: sigma theshold for mask rejection, default is 5 (sigmas)

 OUTPUTS:
   outbias (optional): the master bias image (also written to outfile)

 NOTES:
   This routine builds a bias model given by
     c_ijk = b_ij + d_k,
   where c_ijk are the counts in pixel i,j of bias image k,
   b_ij is the master bias, and d_k is the offset of image k.
   The model is built independently in each of the four amp
   quadrants, and the b_ij image is written out including overscan.

   The model is iteratively optimized in a minimum chi^2 sense,
   weighting by the estimated readnoise and doing model-based
   masking of significantly discrepant pixels.

   The output is intended to work with BOLTON_BIASSUB, which
   determines d_k for arbitrary frames by analogous minimum chi^2
   modeling with rejection in the overscan region for each amp.

 WRITTEN:
  A. Bolton, U. of Utah, 2011aug

</pre>
<p><strong>(See pro/spec2d/bolton_biasgen.pro)</strong></p>
<hr />
<h3 id="BOLTON_BIASSUB">BOLTON_BIASSUB</h3>
<p><a href="#BOLTON_BIASGEN">[Previous Routine]</a></p>
<p><a href="#BOLTON_MLPCA">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>

 NAME:
  bolton_biassub

 PURPOSE:
  Perform BOSS 4-amp bias subtraction using master pixel bias.
  also trim off overscan.

 USAGE:
  img = bolton_biassub(rawdata, biasname [, cam=cam, $
         sigthresh=sigthresh, rnoise=rnoise, notrim=notrim])

 ARGUMENTS:
   rawdata: raw (sdssproc_badformat-corrected) image frame
   biasname: name of bias file to subtract.
   sigthresh (optional) # of sigmas threshold for pixel masking in
     the overscan region used to solve for offset relative to pixbias.
     (default is 4.0).
   notrim: set this keyword to skip trimming of overscan regions.
   cam: camera (one of 'b1', 'b2', 'r1', or 'r2').
        (Will attempt to determine from biasname if not supplied)

 OUTPUTS:
   img: bias-subtracted and (normally) overscan-trimmed image
   rnoise (optional): 2 x 2 array of estimated RMS readnoise in ADU,
     one value for each quadrant, in the arrangement you'd expect.

 NOTES:
   Applied bias file should be output from BOLTON_BIASGEN,
   with name like 'boss_pixbias-MJDXX-r1.fits.gz'

   See algorithmic notes in BOLTON_BIASGEN.

   Currently handles sub-frame readout cases by testing for
   data value of zero and not doing any bias offest determination
   or subtraction with those pixels.

 WRITTEN:
  A. Bolton, U. of Utah, 2011 aug.

</pre>
<p><strong>(See pro/spec2d/bolton_biassub.pro)</strong></p>
<hr />
<h3 id="BOLTON_MLPCA">BOLTON_MLPCA</h3>
<p><a href="#BOLTON_BIASSUB">[Previous Routine]</a></p>
<p><a href="#BOLTON_SN_FIT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>

 NAME: bolton_mlpca

 PURPOSE: Bolton's maximum-likelihood PCA implementation for astronomy

 USAGE:
  tempset = bolton_mlpca(objflux=objflux, objivar=objivar [, $
             nbasis=nbasis , convtest=convtest, maxiter=maxiter, $
             coeffs=coeffs])

 ARGUMENTS:
  objflux: NPIX x NOBJ array of REST-FRAME ALIGNED object spectra
  objivar: NPIX x NOBJ inverse variance array for objflux

 OPTIONAL INPUTS:
  nbasis: number of basis spectra to compute (default is 5)
  convtest: convergence param. to test for completion (default 1.d-10)
  maxiter: maximum number of iterations (default is 10000)

 RETURNS:
  tempset: an NPIX x NBASIS array of object template basis spectra
  coeffs: the best-fit coeffs of the input pectrum sample,
          such that tempset # coeffs gives the minimum chi2 model
          describing objflux

 WRITTEN:
  A. Bolton, U. of Utah, 2010 May

 COMMENTS:
  Implements the iterative Maximum-Likelihood PCA algorithm
  (no intercepts, uncorrelated errors) described by
  Wentzell et al. 1997, Journal of Chemometrics, 11, 339

</pre>
<p><strong>(See pro/spec1d/bolton_mlpca.pro)</strong></p>
<hr />
<h3 id="BOLTON_SN_FIT">BOLTON_SN_FIT</h3>
<p><a href="#BOLTON_MLPCA">[Previous Routine]</a></p>
<p><a href="#BOLTON_STD_THROUGHPUT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>

 NAME: bolton_sn_fit

 PURPOSE: robust fit to SN^2 versus fibermag

 USAGE:
   sn2ref = bolton_sn_fit(fibermag, sn2vector [, $
    lims=lims, refmag=refmag, quantile=quantile, doplot=doplot])

 ARGUMENTS:
   fibermag: x coordinate for fit
   sn2vector: y coordinate, log10'ed before fitting

 OPTIONAL ARGUMENTS:
   lims: 2-element vector giving low-to-high (i.e.,
    bright-to-faint) fibermag limit over which to fit.
    (default = [20., 22])
   refmag: reference fibermag at which to eval final fit
    (default = 21.)
   quantile: reject points beyond this quantile in terms
    of absolute deviation from first-pass fit.
    (default = 0.8 -- i.e., reject most deviant 20%)
   doplot: set keyword for simple splot diagnostic.

 COMMENTS:
   Does LADFIT, rejects outliers, does LADFIT again!

  ** CURRENT DEFAULTS ARE FOR BOSS R-CHANNEL!! **
  ** FOR B-CHANNEL, OVERRIDE DEFAULTS!! **

  So far, only spot-tested, but seems fairly robust.

 WRITTEN:
   Bolton @ Utah 2010 May, with pair-coding by Olmstead.

</pre>
<p><strong>(See pro/spec2d/bolton_sn_fit.pro)</strong></p>
<hr />
<h3 id="BOLTON_STD_THROUGHPUT">BOLTON_STD_THROUGHPUT</h3>
<p><a href="#BOLTON_SN_FIT">[Previous Routine]</a></p>
<p><a href="#BOSS_GAIN">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>

 NAME:
  bolton_std_throughput

 PURPOSE:
  Compute BOSS end-to-end throughput estimate from
  spectrophotometric standard stars

 USAGE:
   tput_struc = bolton_std_throughput(fileid, $
    plate=plate, mjd=mjd [, radius=radius, plug=plug])

 ARGUMENTS:
  Required:
   fileid: a file identifier of the 'b1-00124616' variety
           (no 'sdR-', no '.fit*') for a science frame.
 (one of the following two is mandatory:)
   plate: plate, to give subdir of spCFrame file
   mjd: mjd, to give subdir of sdR file
  Optional:
   radius: pixel radius for boxcar extraction

 RETURNS:
  a structure containing wavelength and end-to-end
  throughput information calculated for all standard stars
  in the observation.

 Optional output:
  plug: plugmap structure for the standard stars.

 NOTES:
  This procedure uses sdR files and spCFrame files.
  It needs to find them via the environment variables
    $BOSS_SPECTRO_DATA
    $BOSS_SPECTRO_REDUX
    $RUN2D

  Calculated throughput is total end-to-end, incl. atmosphere
  through CCD QE, also including any seeing-related fiber loss.
  Telescope is 2.5m with central area of 27% obscured.

 WRITTEN:
  A. Bolton, U. of Utah, 2011 Feb.

</pre>
<p><strong>(See pro/spec2d/bolton_std_throughput.pro)</strong></p>
<hr />
<h3 id="BOSS_GAIN">BOSS_GAIN</h3>
<p><a href="#BOLTON_STD_THROUGHPUT">[Previous Routine]</a></p>
<p><a href="#BOSS_GALAXY_SELECT.PRO">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   boss_gain

 PURPOSE:
   Compute the gain in all amplifiers from a pair of flat-field exposures.

 CALLING SEQUENCE:
   boss_gain, expnum1, [ expnum2, docams=, indir=, $
    gain_range=, thresh=, /doplot ]

 INPUTS:
   expnum1    - First exposure number of raw sdR file.

 OPTIONAL KEYWORDS:
   expnum2    - Second exposure number; default to EXPNUM1+1.
   docams     - Cameras to analyze; default to ['b1','b2','r1','r2'].
   indir      - Input directory for files; default to searching for
                files in $BOSS_SPECTRO_DATA/*.  If $BOSS_SPECTRO_DATA is not set,
                then it is assumed to be /data/spectro.
   gain_range - Range of gain values to test; default to [0.5,2.0,0.002]
                to test the range [0.5,2.0] spaced every 0.002
   thresh     - Threshold of pixel values to use; if a scalar, then this is
                a lower limit only; if this is a 2-element vector, then it
                is a lower and upper bound; default to [500,10000]
   doplot     - If set, then generate a plot with the chi distributions

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   A number of gain values are explicitly tested, with the correct
   gain assumed to be that which gives a Gaussian normal distribution.
   That test is simply that if we difference the two flat-field images,
   68.3% of the points fall within one standard deviation.

   Only use pixels where the value in the first image is above THRESH counts.

   A multiplicative scaling between each flat-field image is computed
   in each row for each amplifier.  This is to account for the lamp
   temperature or brightness changing.

   If these are flats:
   An X shift of the image (flexure) is also measured and reported
   for each amplifier region.  The reported gains shouldn't be trusted
   if the flexure is any more than a tiny fraction of a pixel.
   Flexure is only tested in the range [-0.1,0.1] pix.

 EXAMPLES:
   Solve for the gain of all 4 CCD's from exposures 101702+101703
   on MJD 55093 (assuming the files exist in /data/spectro/55093):
     IDL&gt; boss_gain, 101702

 BUGS:
   This routine will also attempt to compute the gain from warm darks,
   but that appears to give very different answers.  From MJD 55106:
     IDL&gt; boss_gain, 102134, docams=['b2','r2']

 PROCEDURES CALLED:
   dfpsclose
   dfpsplot
   djs_filepath()
   djs_iterstat
   djs_oplot
   djs_plot
   hogg_iter_linfit
   splog
   mrdfits
   sshift2d()
   sxpar()

 INTERNAL SUPPORT ROUTINES:
   boss_gain_flexure()

 REVISION HISTORY:
   10-Oct-2009  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/spec2d/boss_gain.pro)</strong></p>
<hr />
<h3 id="BOSS_GALAXY_SELECT.PRO">BOSS_GALAXY_SELECT.PRO</h3>
<p><a href="#BOSS_GAIN">[Previous Routine]</a></p>
<p><a href="#BUNDLETHRU">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   boss_galaxy_select.pro
 PURPOSE:
   Version 0.00001 of the galaxy selection algorithm for BOSS
 CALLING SEQUENCE:
   ilist=boss_galaxy_select(obj)
 INPUTS:
   obj   : A calibObj structure
 OPTIONAL INPUTS:
   
 KEYWORDS:
   
 OUTPUTS:
   ilist : A mask array
     ilist AND 2  : Cut I
     ilist AND 4  : Cut II
     ilist AND 8  : Cut III
 OPTIONAL OUTPUTS:
   
 RESTRICTIONS:
   
 EXAMPLES:
   
 COMMENTS:
   
 REVISION HISTORY:
  Written by Nikhil Padmanabhan, LBL
</pre>
<p><strong>(See pro/plate/boss_galaxy_select.pro)</strong></p>
<hr />
<h3 id="BUNDLETHRU">BUNDLETHRU</h3>
<p><a href="#BOSS_GALAXY_SELECT.PRO">[Previous Routine]</a></p>
<p><a href="#CALCSCATIMAGE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   bundlethru

 PURPOSE:
   Measure relative throughput of fiber bundles from flat-fields

 CALLING SEQUENCE:
   bundlethru, [ wrange=, mjdrange=, /first ]

 INPUTS:
   wrange     - Wavelength range; default to [5000,5100] Ang
   mjdrange   - If set, then limit to this MJD range
   first      - If set, then use the first rather than last good observation
                of each plate

 OPTIONAL INPUTS:

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   This routine relies upon the platelist file to find good plates
   for each cartridge.  Then the spPlate, spCFrame, spFlat, spArc files
   are read.

   A plot file and a data file are output with names bundlethru-$MJD.ps
   and bundlethru-$MJD.dat .  The MJD in the name is the lowest MJD used.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   splog

 REVISION HISTORY:
   26-Aug-2011  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/plan/bundlethru.pro)</strong></p>
<hr />
<h3 id="CALCSCATIMAGE">CALCSCATIMAGE</h3>
<p><a href="#BUNDLETHRU">[Previous Routine]</a></p>
<p><a href="#CATPLOT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   calcscatimage

 PURPOSE:
   Just return smoothed scattered light image

 CALLING SEQUENCE:
   scatfit = calcscatimage(ansimage, yrow, [ nscatbkpts= , nx=, ny= ] )

 INPUTS:
     ansimage  -  Keyword Output from extract_image
     yrow      -  Array of rows extracted in first pass 

 OPTIONAL KEYWORDS:
     nscatbkpts- Number of break points in B-spline; default to 16
     nx        - X dimension of output image
     ny        - Y dimension of output image

 OUTPUTS:
    scatfit    - Image of scattered light from smoothing polynomials

 OPTIONAL OUTPUTS:

 COMMENTS:
   Chebyshev background terms defined over a domain [0,NX-1]
   mapped to [-1,1]

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   bspline_valu()
   bspline_iterfit()
   fchebyshev()

 REVISION HISTORY:
   29-Sep-2000  Written by S. Burles, FNAL, adopted from fitansimage
</pre>
<p><strong>(See pro/spec2d/calcscatimage.pro)</strong></p>
<hr />
<h3 id="CATPLOT">CATPLOT</h3>
<p><a href="#CALCSCATIMAGE">[Previous Routine]</a></p>
<p><a href="#CCDTILT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   catplot

 PURPOSE:
   Modified version of SPLOT by Tremonti for inspecting spectra.

 CALLING SEQUENCE:
   catplot, [x], y, $
    [color=, psym=, symsize=, thick= ]

   soplot, [x], y, [/autoscale], $
    [color=, psym=, symsize=, thick= ]

   sxyouts, x, y, string, [alignment=, charsize=, charthick=, color=, $
    font=, orientation= ]

   serase, [nerase, /norefresh]

 INPUTS:

 OUTPUT:

 COMMENTS:
   This code is based upon Aaron Barth's ATV procedure.

   SpInspect added to menu bar.  &quot;Open SpInspect File&quot; brings up a
   dialogue box.  The spInspect File must have the format 
   spInspect-pppp-mmmmm-inspector.par.  Upon loading this file, plotspec
   is called to loop through the fibers on the specified plate.  No
   changes are written to the spInspect File until &quot;Update SpInspect File&quot;
   is selected from the menu bar.

 EXAMPLES:

 BUGS:
   Doesn't use the passed XRANGE, YRANGE properly yet...
   Move around widgets to be more compact above plotting window.
   Write splot_readfits.
   Make POSITION= changeable based upon CHARSIZE.
   Gaussian fitting or integrated gaussian fitting.
   Allow one to step through an image row at a time? Or link to ATV?
   Use the WCS in splot_gettrack.
   Add widget button option to fix Y range or let it float, or fix YMIN=0.
   Include options for plotting contours, etc?
   Options for XLOG, YLOG
   For FITS files, take XTITLE, YTITLE from header
   Option to pass header as param in SPLOT
   SpInspect only reads the 1st of semi-colon separated variables in
     the manual_comments field.  (Writes them just fine!) 

 PROCEDURES CALLED:
   fits_read

 INTERNAL SUPPORT ROUTINES:
   splot_gausspix
   splot_startup
   splot_clearkeylist
   splot_displayall
   splot_readfits
   splot_writeeps
   splot_cleartext
   splot_zoom
   splot_gettrack
   splot_event
   splot_shutdown
   splot_resize
   splot_icolor()
   splot_setheader
   splot_headinfo
   splot_headinfo_event
   splot_plot1plot
   splot_plot1text
   splot_plotwindow
   splot_plotall
   sxyouts
   splot_move_cursor
   splot_set_minmax
   splot_get_minmax
   splot_refresh
   splot_help
   splot_help_event
   splot_plotparam_refresh
   splot_plotparam
   splot_plotparam_event
   serase
   splot_autoscale
   soplot
   splot
   splot_spinspect_new
   splot_spinspect_update
   splot_spinspect_event
   splot_spinspect

 REVISION HISTORY:
   28-Sep-1999  Written by David Schlegel, Princeton.
   19-Jun-2001  Gaussfit amplitude was wrong - fixed - D. Finkbeiner
   17-Jun-2002  Added spInspect procedures - C. Tremonti
                Modified splot_startup, splot_events
</pre>
<p><strong>(See pro/spec1d/catplot.pro)</strong></p>
<hr />
<h3 id="CCDTILT">CCDTILT</h3>
<p><a href="#CATPLOT">[Previous Routine]</a></p>
<p><a href="#CHUNKINFO">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   ccdtilt

 PURPOSE:
   Compute the CCD tilts from a series of Hartmann mask exposures.

 CALLING SEQUENCE:
   ccdtilt, expnum1, piston=, [ expnum2, docams=, indir=, nregx=, nregy=, $
    dy=, maxshift=, /nocheck, /doplot ]

 INPUTS:
   expnum1    - Hartmann-left exposure numbers
   piston     - Piston position of focus ring in microns; if known in degrees,
                then multiply by 793./360

 OPTIONAL KEYWORDS:
   expnum2    - Hartmnann-right exposure numbers; default to EXPNUM1+1.
   docams     - Cameras to analyze; default to ['b1','b2','r1','r2'].
   indir      - Input directory for files; default to searching for
                files in $BOSS_SPECTRO_DATA/*.  If $BOSS_SPECTRO_DATA is not set,
                then it is assumed to be /data/spectro.
   nregx      - Number of sub-regions in the X dimension; default to 8.
   nregy      - Number of sub-regions in the Y dimension; default to 8.
   dy         - Sampling of shift when comparing Hartmann-L and Hartmann-R
                images; default to 0.05 pix.
   maxshift   - Maximum pixel shift to search in both X and Y; default to 3.
   nocheck    - If set, then assume that the 1st exposure is Hartmann-l,
                and the 2nd exposure is Hartmann-r, rather than looking at
                the OBSCOMM header keyword.  This correct keywords are
                added by the SOP goSpecFocus command, but will not be if
                you simply move the collimator and shutters yourself.
                (Deprecated to never do this check, since BOSS has
                no header keywords.)
   doplot     - If set, then compute the offsets in different regions
                of the CCD and generate a contour plot.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The focus of the collimator is measured by comparing two Hartmann
   exposures of arc lamps, and looking for shifts in the arc line positions.
   The required piston of the collimator mirrors is assumed to be
   linearly related to the offset in arc lines in the wavelength direction.

   If /DOPLOT is set, then the arc-line shifts are computed in NREGX
   by NREGY regions on each CCD, and a plot is made.

   The following files are output for each camera:
     Collimate-$MJD-$CAMERA-$EXPNUM1.log
     Collimate-$MJD-$CAMERA-$EXPNUM1.ps

   The position of the Hartmann shutters is read from the OBSCOMM header
   keywords for SDSS-I.  It is expected to be '{focus, hartmann l}'
   for one exposure and '{focus, hartmann r}' for the other (in either
   order).  For BOSS, the HARTMANN keyword is read and must be either
   'Left' or 'Right'.
   It is assumed that the collimator position is identical for both exposures.

   The sense of the pixel shifts reported is what one would have to shift
   the Hartmann-r exposure by in Y to agree with the Hartmann-l exposure.

 EXAMPLES:
   Solve for the tilt of the r1 CCD from Hartmann data on MJD 55218:
    expnum1 = [107910,107912,107908,107916,107918]
    piston = [-50,-25,0,25,50] * 793./360.
    ccdtilt, expnum1, piston=piston, docams='r1'

 BUGS:

 PROCEDURES CALLED:
   dfpsclose
   dfpsplot
   djs_filepath()
   djs_icolor()
   sdssproc
   splog
   sxpar()

 INTERNAL SUPPORT ROUTINES:
   collimate_obscomm()
   collimate_xcorr()

 REVISION HISTORY:
   03-Feb-2010  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/apo2d/ccdtilt.pro)</strong></p>
<hr />
<h3 id="CHUNKINFO">CHUNKINFO</h3>
<p><a href="#CCDTILT">[Previous Routine]</a></p>
<p><a href="#COLLIMATE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   chunkinfo

 PURPOSE:
   Return chunk information for a given plate number.

 CALLING SEQUENCE:
   cinfo = chunkinfo(plateid)

 INPUTS:

 OPTIONAL INPUTS:
   plateid     - Plate ID number; scalar or array of integers

 OUTPUTS:
   cinfo       - Structure with chunk information for each plate

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 DATA FILES:
   $PLATELIST_DIR/platePlans.par

 PROCEDURES CALLED:
   yanny_readone()

 REVISION HISTORY:
   08-Feb-2001  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/chunkinfo.pro)</strong></p>
<hr />
<h3 id="COLLIMATE">COLLIMATE</h3>
<p><a href="#CHUNKINFO">[Previous Routine]</a></p>
<p><a href="#COMBINE1FIBER">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   collimate

 PURPOSE:
   Compute the spectrograph collimation focus from Hartmann mask exposures.

 CALLING SEQUENCE:
   collimate, expnum1, [ expnum2, docams=, indir=, nregx=, nregy=, $
    maxshift=, /nocheck, /debug, /test ]

 INPUTS:
   expnum1    - First exposure number of raw sdR file.

 OPTIONAL KEYWORDS:
   expnum2    - Second exposure number; default to EXPNUM1+1.
   docams     - Cameras to analyze; default to ['b1','b2','r1','r2'].
   indir      - Input directory for files; default to searching for
                files in $BOSS_SPECTRO_DATA/*.  If $BOSS_SPECTRO_DATA is not set,
                then it is assumed to be /data/spectro.
   nregx      - Number of sub-regions in the X dimension; default to 8.
   nregy      - Number of sub-regions in the Y dimension; default to 8.
   maxshift   - Maximum pixel shift to search in both X and Y; default to 3.
   nocheck    - If set, then assume that the 1st exposure is Hartmann-l,
                and the 2nd exposure is Hartmann-r, rather than looking at
                the OBSCOMM header keyword.  This correct keywords are
                added by the SOP goSpecFocus command, but will not be if
                you simply move the collimator and shutters yourself.
                (Deprecated to never do this check, since BOSS has
                no header keywords.)
   debug      - flag to remove hardwired subregions and fits and instead
                process all of the data in the array.  Much slower than the
                nominal routine but informative for tests of focus variation
                across full illuminated area
   test       - flag that prints out 1 line for comparison with smallcollimate

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The focus of the collimator is measured by comparing two Hartmann
   exposures of arc lamps, and looking for shifts in the arc line positions.
   A linear correlation coefficient is computed independently in NREGX
   by NREGY regions on each CCD as a function of pixel shifts of the 2nd
   image in both X and Y.  The best-focus value is found in each region
   by maximizing the linear correlation in the Y (wavelength) direction.
   Now that we have another routine that calls the images with subarray reads,
   the routine looks for the subarray header keyword and calls the other
   collimate routine if need be.
   
   The following files are output for each camera:
     Collimate-$MJD-$CAMERA-$EXPNUM1.log
     Collimate-$MJD-$CAMERA-$EXPNUM1.ps

   The position of the Hartmann shutters is read from the OBSCOMM header
   keywords for SDSS-I.  It is expected to be '{focus, hartmann l}'
   for one exposure and '{focus, hartmann r}' for the other (in either
   order).  For BOSS, the HARTMANN keyword is read and must be either
   'Left' or 'Right'.
   It is assumed that the collimator position is identical for both exposures.

   The sense of the pixel shifts reported is what one would have to shift
   the Hartmann-r exposure by in Y to agree with the Hartmann-l exposure.

 EXAMPLES:
   Solve for the focus of all 4 CCD's from exposures 10812+10813
   on MJD 52161 (assuming the files exist in /data/spectro/52161):
     IDL&gt; collimate, 10812

 BUGS:

 PROCEDURES CALLED:
   dfpsclose
   dfpsplot
   djs_filepath()
   djs_icolor()
   sdssproc
   splog
   sxpar()

 INTERNAL SUPPORT ROUTINES:
   collimate_obscomm()
   collimate_bad_hdr()

 REVISION HISTORY:
   28-Mar-2002  Written by D. Schlegel, Princeton
   01-Sep-2009  K. Dawson, Utah
</pre>
<p><strong>(See pro/apo2d/collimate.pro)</strong></p>
<hr />
<h3 id="COMBINE1FIBER">COMBINE1FIBER</h3>
<p><a href="#COLLIMATE">[Previous Routine]</a></p>
<p><a href="#COMBINEBPM">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   combine1fiber

 PURPOSE:
   Combine several spectra of the same object, or resample a single spectrum.

 CALLING SEQUENCE:
   combine1fiber, inloglam, objflux, [ objivar, finalmask=, indisp=, skyflux=,$
    newloglam=, newflux=, newivar=, andmask=, ormask=, newdisp=, newsky=, $
    nord=, binsz=, bkptbin=, maxsep=, _EXTRA=KeywordsForReject, /verbose ]

 INPUTS:
   inloglam       - Wavelengths in log10-Angstroms [NPIX,NSPEC]
   objflux        - Flux [NPIX,NSPEC]

 REQUIRED KEYWORDS:
   newloglam      - Wavelengths for output evaluation, also in log10-Angstroms
                    [NNEWPIX]

 OPTIONAL INPUTS:
   objivar        - Inverse variance [NPIX,NSPEC]
   finalmask      - Pixel mask [NPIX,NSPEC]
   indisp         - Dispersion values [NPIX,NSPEC]
   skyflux        - Sky flux vectors [NPIX,NSPEC]
   binsz          - Bin separation for INLOGLAM; if not set, then default
                    to INLOGLAM[1]-INLOGLAM[0].
   nord           - Order of spline fit; default to 3.
   bkptbin        - Break point binning; default to 1.2 * BINSZ.
   maxsep         - Maximum separation between input wavelengths.  The spline
                    fit is split into pieces, with the breaks wherever this
                    spacing is exceeded.  Default to 2.0 * BINSZ.
   _EXTRA         - Keywords for DJS_REJECT().
   verbose        - If set, then output messages about bad break points and
                    masked data points.

 OUTPUTS:

 OPTIONAL OUTPUTS:
   finalmask      - Modified from its input by setting the COMBINEREJ bit
                    for deviant pixels in individual spectra that have
                    been rejected.
   objivar        - Modified from itts input by setting to zero wherever
                    the COMBINEREJ bit has been set in FINALMASK.
   newflux        - Resampled flux [NNEWPIX].
   newivar        - Resampled inverse variance [NNEWPIX].
   andmask        - Resampled mask. For each mask bit, set that bit only if
                    every input spectrum at this wavelength has that bit set
                    (e.g., this is a logical AND) [NNEWPIX].
   ormask         - Resampled mask. For each mask bit, set that bit if any
                    of the input spectra at this wavelength has that bit set
                    (e.g., this is a logical OR) [NNEWPIX].
   newdisp        - Resampled dispersion values [NNEWPIX].
   newsky         - Resampled sky flux [NNEWPIX].

 COMMENTS:
   One can pass this routine a single spectrum to be fit by a spline and
   re-sampled, in which case all the inputs (such as FLUX) are 1-dimensional
   arrays.  Or, one can pass it several spectra, in which case these inputs
   are 2-dimensional arrays.

   There's also some code in here to grow masked regions by another pixel
   on either end if the region is more than 3 pixels wide.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   aesthetics()
   bspline_iterfit()
   bspline_valu()
   djs_laxisgen()
   djs_median()
   pixelmask_bits()
   splog

 REVISION HISTORY:
   02-Jan-2000  Written by D. Schlegel; modified from COMBINE2DOUT
</pre>
<p><strong>(See pro/spec2d/combine1fiber.pro)</strong></p>
<hr />
<h3 id="COMBINEBPM">COMBINEBPM</h3>
<p><a href="#COMBINE1FIBER">[Previous Routine]</a></p>
<p><a href="#COMBSMALLCOLLIMATE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
    combinebpm

 PURPOSE:
     Takes a set of darks (preferably at least 5 to reduce cosmics)
     and a set of biases; combines them each individually, gets a
     bias subtracted dark, and then makes a bad pixel mask.  Also
     checks the bias for any hot pixels and marks those

 CALLING SEQUENCE:
 combinebpm,docams=,nsig=,ncount=,osx=,osy=,darkstart=,darkend=,biasstart=,biasend=,maxsat=,output=;

 INPUTS:

 docams     - camera to look at  ; default to ['b1','b2','r1','r2']
 darkstart   - first dark exposure; default to 01786
 darkend     - last  dark exposure; default to 01790
 biasstart   - first bias exposure; default to 01768
 biasend     - last  bias exposure; default to 01783
 nsig        - Number of sigma away from median to determine bad
               pixel ;default to 5
 ncount      - Number of counts away from median to determine bad
               pixel; default to 10
 output      - Write the 3 intermediary fits files,
               masterdark, masterbias, and darkminusbias
 maxsat      - Any pixel that has a higher count than this in the averaged
               biases is counted as a bad pixel, default to 1500.
 OPTIONAL KEYWORDS
  
 OUTPUTS:
 
 

      'bpm-sigma.fit'

      'bpm-count.fit'


 OPTIONAL OUTPUTS:

 COMMENTS:
   
  This will combine darks and biases to make a bad pixel mask



 EXAMPLES:
   Create a bad pixel mask for b1 using darks and biases from 55094
   and write out intermediary steps


    (assuming the files exist in /data/spectro/:)
     IDL&gt; combinebpm,docams='b1',nsig=10,ncount=15,osx=200,osy=200,darkstart=01786,darkend=01790,biasstart=01768,biasend=01783,/output

 

 PROCEDURES CALLED:
   sxpar()
   sdssproc()
   djs_iterstat()
 REVISION HISTORY:

   22-Jan-2010  M. Olmstead, Utah
</pre>
<p><strong>(See pro/specflat/combinebpm.pro)</strong></p>
<hr />
<h3 id="COMBSMALLCOLLIMATE">COMBSMALLCOLLIMATE</h3>
<p><a href="#COMBINEBPM">[Previous Routine]</a></p>
<p><a href="#CORRECT_CROSSTALK">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   combsmallcollimate

 PURPOSE:
   Compute the spectrograph collimation focus from Hartmann mask exposures.

 CALLING SEQUENCE:
   smallcollimate, expnum1, [ expnum2, docam1s=,docams2= indir=, nregx=, nregy=, $
    maxshift=, /nocheck, /debug, /simple,spec= ,/test ]

 INPUTS:
   expnum1    - First exposure number of raw sdR file.

 OPTIONAL KEYWORDS:
   expnum2    - Second exposure number; default to EXPNUM1+1.
   docams1     - Cameras to analyze; default to ['b1','r1'].
   docams2     - Cameras to analyze; default to ['b2','r2'].
   indir      - Input directory for files; default to searching for
                files in $BOSS_SPECTRO_DATA/*.  If $BOSS_SPECTRO_DATA is not set,
                then it is assumed to be /data/spectro.
   nregx      - Number of sub-regions in the X dimension; default to 8.
   nregy      - Number of sub-regions in the Y dimension; default to 8.
   maxshift   - Maximum pixel shift to search in both X and Y; default to 3.
   nocheck    - If set, then assume that the 1st exposure is Hartmann-l,
                and the 2nd exposure is Hartmann-r, rather than looking at
                the OBSCOMM header keyword.  This correct keywords are
                added by the SOP goSpecFocus command, but will not be if
                you simply move the collimator and shutters yourself.
                (Deprecated to never do this check, since BOSS has
                no header keywords.)
   debug      - flag to remove hardwired subregions and fits and instead
                process all of the data in the array.  Much slower than the
                nominal routine but informative for tests of focus variation
                across full illuminated area
   simple     - generate simpler output, for the benefit of external
                programs. [SEE NOTES BELOW]

   spec       - to do them by spectrograph, use 'sp1' or 'sp2' or
                ['sp1','sp2'](default)

   badres     - bad residual for blue ring.  Greater than this,
                observers will need to move the ring.  Default to 6
                degrees
   test       - flag that prints out 1 line for comparison with smallcollimate
 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The focus of the collimator is measured by comparing two Hartmann
   exposures of arc lamps, and looking for shifts in the arc line positions.
   A linear correlation coefficient is computed independently in NREGX
   by NREGY regions on each CCD as a function of pixel shifts of the 2nd
   image in both X and Y.  The best-focus value is found in each region
   by maximizing the linear correlation in the Y (wavelength) direction.
   
   The following files are output for each camera:
     Collimate-$MJD-$CAMERA-$EXPNUM1.log
     Collimate-$MJD-$CAMERA-$EXPNUM1.ps

   The position of the Hartmann shutters is read from the OBSCOMM header
   keywords for SDSS-I.  It is expected to be '{focus, hartmann l}'
   for one exposure and '{focus, hartmann r}' for the other (in either
   order).  For BOSS, the HARTMANN keyword is read and must be either
   'Left' or 'Right'.
   It is assumed that the collimator position is identical for both exposures.

   The sense of the pixel shifts reported is what one would have to shift
   the Hartmann-r exposure by in Y to agree with the Hartmann-l exposure.

 /SIMPLE COMMENTS:
   The /simple output is sometimes read by an external program which
   expects or passes on the following output lines, given ${specname}
   in ['sp1', 'sp1'] and ${camname} in ['b1','b2',r1',r2'].

    We will likely turn this output into a .par file, but in the meanwhile:

    ${specname} AverageMove &lt;steps&gt;
      - the move to apply to the ${specname} collimator.
        If this line does not appear, the collimation process fails.

    ${specname} Residuals &lt;steps&gt;,&lt;angle&gt;,&lt;string&gt;
      - the residual error after applying the AverageMove. 
          . steps for red,
          . angle for blue,
          . if the string is &quot;OK&quot; the blue ring position after the
            move is taken to be within spec. Otherwise collimation 
            is treated as failed, and the string is passed on to the humans.
         
    ${camname} MeanOffset &lt;pixelError&gt;
      - For all cameras, the measured pixel error. Not used, but recorded.

    ${camname} PistonMove &lt;steps&gt;
      - For the red cameras, the collimator move required to correct
        MeanOffset. Not used, but recorded.

    ${camname} RingMove &lt;angle&gt;
      - For the blue cameras, the ring rotation required to correct
        MeanOffset. Not used, but recorded.

    Those outputs all generate obvious keywords for the APO archiver,
    etc. Any other outputs on stdout and stderr are passed on as
    warnings. 

 EXAMPLES:
   Solve for the focus of all 4 CCD's from exposures 10812+10813
   on MJD 52161 (assuming the files exist in /data/spectro/52161):
     IDL&gt; collimate, 10812

 BUGS:

 PROCEDURES CALLED:
   dfpsclose
   dfpsplot
   djs_filepath()
   djs_icolor()
   fits_wait()
   sdssproc
   splog
   sxpar()

 INTERNAL SUPPORT ROUTINES:
   collimate_obscomm()
   collimate_bad_hdr()

 REVISION HISTORY:
   28-Mar-2002  Written by D. Schlegel, Princeton
   01-Sep-2009  K. Dawson, Utah
</pre>
<p><strong>(See pro/apo2d/combsmallcollimate.pro)</strong></p>
<hr />
<h3 id="CORRECT_CROSSTALK">CORRECT_CROSSTALK</h3>
<p><a href="#COMBSMALLCOLLIMATE">[Previous Routine]</a></p>
<p><a href="#CORRECT_DLAM">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
 CORRECT_CROSSTALK

 PURPOSE:
 If there is keyword_set(image) is true this procedure corrects an image for crosstalk.  The input image is overwritten by the corrected image.
 If there is keyword_set(invvar) is true this procedure returns the diagonal of the resulting covariance matrix of the crosstalk-corrected
 image.  The input invvar is overwritten by the corrected invvar.  For now covariance matrices are not being used and the current implementation
 assumes this.
 
 The amplifier layout and crosstalk terms are provided.

 CALLING SEQUENCE:
 CORRECT_CROSSTALK, Image, Crosstalk, Ampgrid

 INPUTS:
 Image -   2-dimensional array containing the image to be corrected. Note that this array is overwritten with the OUTPUT
 Crosstalk - An N by N grid containing the amplifier cross-talk.  N is the total number of amplifiers.  If NOT keyword_set(Crosstalk)
 then no correction is applied.
 Ampgrid - A 2-element array describing how the amplifiers are distributed on the chip.  For now, the code only
 knows how to deal with [2,2]

 OPTIONAL INPUTS:
 Invvar - 2-dimensional array containing the inverse variance that corresponds with the input image. This array is
 overwritten with the output

 KEYWORD PARAMETERS:

 OUTPUTS:
 Image - The cross-talk corrected image.  The input image is overwritten

 OPTIONAL OUTPUTS:

 COMMON BLOCKS:

 SIDE EFFECTS:
 The input image is overwritten

 EXAMPLE:
  infile='/Users/akim/Work/sdss3/testData/realdata/rawdata/55089/sdR-r1-00101369.fit'
  sdssproc, infile, image, indir=indir, /applybias, /silent
  configuration=obj_new('configuration', 55120)
  correct_crosstalk,image, configuration-&gt;crosstalk_crosstalk('r1'), configuration-&gt;crosstalk_ampgrid('r1')

 MODIFICATION HISTORY:
   Written by: Alex Kim, Oct 16, 2009
</pre>
<p><strong>(See pro/spec2d/correct_crosstalk.pro)</strong></p>
<hr />
<h3 id="CORRECT_DLAM">CORRECT_DLAM</h3>
<p><a href="#CORRECT_CROSSTALK">[Previous Routine]</a></p>
<p><a href="#CO_REFRACT()">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   correct_dlam

 PURPOSE:
   Correct ADU/pixel to ADU/d(log-lambda)

 CALLING SEQUENCE:
   correct_dlam, flux, fluxivar, wset, dlam=dlam

 INPUTS:
   flux       - Flux
   fluxivar   - Flux inverse variance
   wset       - Wavelength coefficient trace-set

 OPTIONAL KEYWORDS:
   dlam       - Log-lambda pixel size to convert to; default to 1.0d-4

 OUTPUTS:
   flux       - (Modified.)
   fluxivar   - (Modified.)

 OPTIONAL OUTPUTS:

 COMMENTS:
   Make a map of the size of each pixel in delta-(log10-Angstroms),
   and re-normalize the flux to ADU/d(log10-Angstroms).

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   divideflat
   traceset2xy

 REVISION HISTORY:
   04-Oct-2000  Written by S. Burles, FNAL
</pre>
<p><strong>(See pro/spec2d/correct_dlam.pro)</strong></p>
<hr />
<h3 id="CO_REFRACT()">CO_REFRACT()</h3>
<p><a href="#CORRECT_DLAM">[Previous Routine]</a></p>
<p><a href="#DAYTIME_TEST">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   CO_REFRACT()      

 PURPOSE:
   Calculate correction to altitude due to atmospheric refraction.

 DESCRIPTION:
   CO_REFRACT can calculate both apparent altitude from observed altitude and 
   vice-versa.

 CALLING SEQUENCE:
   new_alt  = CO_REFRACT_LIST(old_alt, [ ALTITUDE= , PRESSURE= , $
                                  TEMPERATURE= , /TO_OBSERVED , EPSILON= ])

 INPUT:
   old_alt - Observed (apparent) altitude, in DEGREES.  (apparent if keyword 
             /TO_OBSERVED set).    May be scalar or vector.

 OUTPUT: 
     Function returns apparent (observed) altitude, in DEGREES. (observed if 
         keyword /TO_OBSERVED set).    Will be of same type as input 
         altitude(s).

 OPTIONAL KEYWORD INPUTS:
      ALTITUDE :  The height of the observing location, in meters.  This is 
             only used to determine an approximate temperature and pressure, 
             if these are not specified separately. [default=0, i.e. sea level]
      PRESSURE :  The pressure at the observing location, in millibars.
      TEMPERATURE:    The temperature at the observing location, in Kelvin.
      EPSILON:  When keyword /TO_OBSERVED has been set, this is the accuracy 
               to  obtain via the iteration, in arcseconds [default = 0.25 
                arcseconds].
      /TO_OBSERVED:  Set this keyword to go from Apparent-&gt;Observed altitude, 
                 using the iterative technique.

       Note, if altitude is set, but temperature or pressure are not, the 
       program will make an intelligent guess for the temperature and pressure.

 DESCRIPTION:

   Because the index of refraction of air is not precisely 1.0, the atmosphere
   bends all incoming light, making a star or other celestial object appear at
   a slightly different altitude (or elevation) than it really is.  It is 
   important to understand the following definitions:

   Observed Altitude:  The altitude that a star is SEEN to BE, with a telescope.
                       This is where it appears in the sky.  This is always 
                       GREATER than the apparent altitude.

   Apparent Altitude:  The altitude that a star would be at, if *there were no
                     atmosphere* (sometimes called &quot;true&quot; altitude). This is 
                     usually calculated from an object's celestial coordinates.
                     Apparent altitude is always LOWER than the observed 
                     altitude.

   Thus, for example, the Sun's apparent altitude when you see it right on the
   horizon is actually -34 arcminutes.

   This program uses couple simple formulae to estimate the effect for most 
   optical and radio wavelengths.  Typically, you know your observed altitude 
   (from an observation), and want the apparent altitude.  To go the other way,
   this program uses an iterative approach.

 EXAMPLE:
    The lower limb of the Sun is observed to have altitude of 0d 30'.   
    Calculate the the true (=apparent) altitude of the Sun's lower limb using 
    mean  conditions of air pressure and temperature

    IDL&gt; print, co_refract(0.5)     ===&gt;  0.025degrees (1.55')
 WAVELENGTH DEPENDENCE:
    This correction is 0 at zenith, about 1 arcminute at 45 degrees, and 34 
    arcminutes at the horizon FOR OPTICAL WAVELENGTHS.  The correction is 
    NON-NEGLIGIBLE at all wavelengths, but is not very easily calculable.  
    These formulae assume a wavelength of 550 nm, and will be accurate to 
    about 4 arcseconds for all visible wavelengths, for elevations of 10 
    degrees and higher.    Amazingly, they are also ACCURATE FOR RADIO 
    FREQUENCIES LESS THAN ~ 100 GHz.

    It is important to understand that these formulae really can't do better 
    than about 30 arcseconds of accuracy very close to the horizon, as 
    variable atmospheric effects become very important.

 REFERENCES:
    1.  Meeus, Astronomical Algorithms, Chapter 15.
    2.  Explanatory Supplement to the Astronomical Almanac, 1992.
    3.  Methods of Experimental Physics, Vol 12 Part B, Astrophysics, 
        Radio Telescopes, Chapter 2.5, &quot;Refraction Effects in the Neutral 
        Atmosphere&quot;, by R.K. Crane.


 DEPENDENCIES:
    CO_REFRACT_FORWARD (contained in this file and automatically compiled).

 AUTHOR:
   Chris O'Dell
       Univ. of Wisconsin-Madison
   Observational Cosmology Laboratory
   Email: odell@cmb.physics.wisc.edu

 REVISION HISTORY:
    version 1 (May 31, 2002)
    Update iteration formula,   W. Landsman    June 2002
    Corrected slight bug associated with scalar vs. vector temperature and 
               pressure inputs. 6/10/2002
    Changed to iterate on a vector of angles to_observed, S. Burles, Jan 2006
</pre>
<p><strong>(See pro/plate/co_refract_list.pro)</strong></p>
<hr />
<h3 id="DAYTIME_TEST">DAYTIME_TEST</h3>
<p><a href="#CO_REFRACT()">[Previous Routine]</a></p>
<p><a href="#DESIGN_MULTIPLATE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   daytime_test

 PURPOSE:
   Look for spectro exposures taken during the day and not marked as test.

 CALLING SEQUENCE:
   daytime_test

 INPUTS:

 OPTIONAL INPUTS:

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Find all the files matching '$BOSS_SPECTRO_DATA/$MJD/sdR-b1-????????.fit*',
   and print a warning message for any science, flat, or arc exposures
   that are not marked as test exposures, and were taken during the
   daytime.  The warnings are also printed to the file 'daytime.log'.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_diff_angle()
   get_mjd_dir()
   get_tai
   headfits()
   sdsshead()
   splog
   sunpos
   sxpar()
   zenpos

 INTERNAL SUPPORT PROCEDURES:
   daytime_test1

 REVISION HISTORY:
   27-Apr-2003  Written by David Schlegel, Princeton (not checked in then)
</pre>
<p><strong>(See pro/plan/daytime_test.pro)</strong></p>
<hr />
<h3 id="DESIGN_MULTIPLATE">DESIGN_MULTIPLATE</h3>
<p><a href="#DAYTIME_TEST">[Previous Routine]</a></p>
<p><a href="#DESIGN_PLATE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   design_multiplate

 PURPOSE:
   Routine to design a plate with several pointings.

 CALLING SEQUENCE:
   design_multiplate, stardata, [ tilenums=, platenums=, racen=, deccen=, $
    guidetiles=, apotemperature=apotemperature, /addfund, /norename ]

 INPUTS:
   stardata   - Structure with data for each star; must contain the
                fields RA, DEC, MAG[5], PRIORITY, HOLETYPE, TILENUM.
                HOLETYPE can be either 'OBJECT' or 'GUIDE'; objects with
                other values are ignored.  Other elements in the structure
                will be copied into the output plug-map files.
                If OBJTYPE is not passed in this structure, then it is set to
                'SERENDIPITY_MANUAL' for all HOLETYPE='OBJECT'.
                Stars with TILENUM=0 can only be used as guide stars.
   racen      - RA center for each tile
   deccen     - DEC center for each tile

 OPTIONAL INPUTS:
   tilenums   - Array of tile numbers; default to the unique list of
                tile numbers in STARDATA.TILENUM, but exclude the number zero.
   platenums  - Array of plate numbers; default to the same as TILENUMS.
   guidetiles - Tile number for each of the 11 guide fibers.  There exist
                default values for the cases 1,2,3 or 4 tiles.
   apotemperature - Design temperature for APO; default to 5 deg C.
   addfund    - If set, then add one more tile+plate with 9 or 10 holes
                in a line of declination from guide fiber #11 for the
                nearest of the 5 SDSS fundamental standard stars.
                We try to place 10 of these holes, spaced by 1 arcmin, but
                one can be knocked out by the guide-fiber alignment hole.
                This tile is given the TILEID=max(TILEID)+1, PLATEID=0.
   norename   - The default is to rename the output plugMapP files to
                plate names like 800,800B,800C,... if the first plate
                number is 800.  Set this keyword to keep the names as
                they are passed in PLATENUMS.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   There is no attempt to move plate centers such that a guide fiber
   can be re-used in another pointing.

   Objects are assigned according to their priority.  If none are specified
   with STARDATA.PRIORITY, then random priorities between 1 and 100 are
   assigned.  We reserve priorities of 0 and [2^31-2,2^31] for internal
   purposes.

 EXAMPLES:

 BUGS:
   These SDSS primary standards coordinates were not quite correct
   in the design of the initial set of special plates.  See the comments
   in the code.

 PROCEDURES CALLED:
   concat_dir()
   cpbackup
   current_mjd()
   djs_diff_angle()
   djs_laxisgen()
   plate_rotate
   yanny_free
   yanny_par()
   yanny_read
   yanny_write

 INTERNAL SUPPORT ROUTINES:
   design_append()

 REVISION HISTORY:
   21-Nov-2001  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/plate/design_multiplate.pro)</strong></p>
<hr />
<h3 id="DESIGN_PLATE">DESIGN_PLATE</h3>
<p><a href="#DESIGN_MULTIPLATE">[Previous Routine]</a></p>
<p><a href="#DESIGN_SDSS3TEST">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   design_plate

 PURPOSE:
   Routine to design a single plate.

 CALLING SEQUENCE:
   design_plate, stardata, [ racen=, deccen=, tilenum=, platenum=, $
    airtemp=, nstd=, nminsky=, lst=, ntotal=, /southern ]

 INPUTS:
   stardata   - Structure with data for each star; must contain the
                fields RA, DEC, MAG[5], HOLETYPE, OBJTYPE.
                HOLETYPE should be either 'OBJECT' or 'GUIDE'.
                Special values of OBJTYPE are 'SKY', 'SPECTROPHOTO_STD',
                and 'REDDEN_STD'.
                Other elements in the structure (such as PRIMTARGET,...)
                will be copied into the output plug-map files.
   racen      - RA center for tile
   deccen     - DEC center for tile

 OPTIONAL INPUTS:
   tilenum    - Tile number; default to 1.
   platenum   - Plate number; default to the same as TILENUMS.
   airtemp    - Design temperature for APO; default to 5 deg C.
   nstd       - Number of spectro-photo standards; default to 16.
                This will be split with NSTD/2 standards on the North
                half of the plate, and the same number on the South.
   nminsky    - Minimum number of sky fibers; default to 32.
   lst        - Local sidereal time (LST) for plate design; default to
                setting this equal to RACEN, which means observing at transit.
   ntotal     - Number of object fibers; default to 640.
   southern   - If set, then set the SOUTHERN targetting bits in both
                the PRIMTARGET and SECTARGET output flags.

 COMMENTS:
   All non-SKY and non-SPECTROPHOTO_STD/REDDEN_STD objects will be put on the
   plate. This routine will choose which of the given SKY,
   SPECTROPHOTO_STD, and REDDEN_STD targets to put on the plate.

   If non-SKY and non-SPECTROPHOTO_STD/REDDEN_STD objects collide with one
   another at all (are &lt; 55'' apart) this routine will halt and
   report an error.

   If non-SKY and non-SPECTROPHOTO_STD/REDDEN_STD objects are within 68 arcsec
   of the center, or are outside 1.49 deg, this routine will halt and
   report an error.

   We always assign then objects, then guide stars, then
   spectro-photo standards, then skies.  

   This script generates the following files:
     plObs.par
     plPlan.par
     plPlugMapP-$PLATE.par
   The commands from the SDSS &quot;plate&quot; product generate the following files:
     makeFanuc - Generate plFanuc-$PLATE.par
     makeDrillPos - Generate plMeas-$PLATE.par, plDrillPos-$PLATE.par
     use_cs3 - Generates no files.  Simply reports fiber collisions.
     makePlots - Generate plOverlay-$PLATE.ps

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   concat_dir()
   current_mjd()
   djs_diff_angle()
   splog
   yanny_readone()
   yanny_write

 INTERNAL SUPPORT ROUTINES:
   design_append()
   design_groupfibers()

 REVISION HISTORY:
   14-Jan-2002  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/plate/design_plate.pro)</strong></p>
<hr />
<h3 id="DESIGN_SDSS3TEST">DESIGN_SDSS3TEST</h3>
<p><a href="#DESIGN_PLATE">[Previous Routine]</a></p>
<p><a href="#DIVIDEFLAT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   design_sdss3test

 PURPOSE:
   Design test plates for SDSS-3

 CALLING SEQUENCE:
   design_sdss3test, platenum, [ nminsky=, nstd= ]

 INPUTS:
   platenum   - Plate number

 OPTIONAL INPUTS:
   nminsky    - Minimum number of sky fibers per plate; default to 64
   nstd       - Number of F star standards per plate; default to 16

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:
   Design our test plates for the Oct 2006 drill run at Princeton:
     setenv,'PHOTO_REDUX=/u/dss/redux'
     setenv,'PHOTO_RESOLVE=/u/dss/redux/resolve/full_02apr06'
     setenv,'PHOTO_CALIB=/u/dss/redux/resolve/full_02apr06/calib/default0'
     setenv,'BOSS_SPECTRO_REDUX=/u/dss/spectro_v5'
     design_sdss3test, 2634
     design_sdss3test, 2638

 BUGS:

 DATA FILES:

 PROCEDURES CALLED:

 INTERNAL SUPPORT ROUTINES:
   design_struct()

 REVISION HISTORY:
   29-Oct-2006  Written by D. Schlegel and N. Padmanabhan, LBL
</pre>
<p><strong>(See pro/plate/design_sdss3test.pro)</strong></p>
<hr />
<h3 id="DIVIDEFLAT">DIVIDEFLAT</h3>
<p><a href="#DESIGN_SDSS3TEST">[Previous Routine]</a></p>
<p><a href="#DJS_ITER_SFIT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   divideflat

 PURPOSE:
   Divide an extracted image with a fiber-flat

 CALLING SEQUENCE:
   divideflat, flux, fflat, [ invvar=, minval=, /quiet ]

 INPUTS:
   flux       - Array of extracted flux from a flat-field image [Nrow,Ntrace]
   fflat      - Array of flat-field flat-field vectors [Nrow,Ntrace]

 OPTIONAL KEYWORDS:
   invvar     - Inverse variance map for FLUX [Nrow,Ntrace]
   minval     - Minimum value to consider good for flat-field;
                default to 0.03.
   quiet      - don't print to splog?

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   We no longer utilize or set FIBERMASK 
   Wherever the fiber is denoted bad in FIBERMASK, or wherever FFLAT is
   &lt;= MINVAL, we set FLUX=FLUXIVAR=0.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   splog

 REVISION HISTORY:
   17-Nov-1999  Written by S. Burles, Chicago
   23-Nov-1999  Modified by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/divideflat.pro)</strong></p>
<hr />
<h3 id="DJS_ITER_SFIT">DJS_ITER_SFIT</h3>
<p><a href="#DIVIDEFLAT">[Previous Routine]</a></p>
<p><a href="#DJS_POLYFIT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   djs_iter_sfit

 PURPOSE:
   Surface-fitting code to tabulated data (with iterateive rejection).

 CALLING SEQUENCE:
   acoeff = djs_sfit_iter(fval, xval, yval, degreex, degreey, $
            sqivar=, yfit=, mask=, maxdev=, maxrej=, $
            upper=, lower=, maxiter=, freeiter=, outmask=)

 INPUTS:
   fval      - Function values at XVAL,YVAL.
   xval      - X coordinate values
   yval      - Y coordinate values
   degreex   - Degree of polynomial fit in X; 1 for linear, 2 for quadratic
   degreey   - Degree of polynomial fit in Y; 1 for linear, 2 for quadratic

 OPTIONAL INPUTS:
   sqivar    - Inverse sigma, which are the weights
   mask      - Input mask for fitting and rejection (1=good, 0=bad)
   maxdev    - Rejcet pts w/ abs(data - model) &gt; maxdev (passed to djs_reject)
   upper     - Rejcet pts w/ data &gt; model + upper*sigma (passed to djs_reject)
   lower     - Rejcet pts w/ data &gt; model + lower*sigma (passed to djs_reject)
   maxiter   - Maximum # of rejection iterations 
   freeiter  - Rejected points accumulate for this # of iterations,
               then the mask is reset to the input mask

 OUTPUTS:
   acoeff    - Fit coefficients as [DEGREEX+1,DEGREEY+1] array

 OPTIONAL OUTPUTS:
   yfit      - Fit values
   outmask   - Masked points used in final iteration (1=used, 0=rejected)

 COMMENTS:

 EXAMPLES:

 BUGS:
   Doesn't like NaNs

 PROCEDURES CALLED:
   djs_reject
   splog

 REVISION HISTORY:
   12-Aug-2003  Adapted from djs_sfit by C. Tremonti, Steward Observatory
</pre>
<p><strong>(See pro/fluxfix/djs_sfit_iter.pro)</strong></p>
<hr />
<h3 id="DJS_POLYFIT">DJS_POLYFIT</h3>
<p><a href="#DJS_ITER_SFIT">[Previous Routine]</a></p>
<p><a href="#DR1LIST_BEST">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   djs_polyfit

 PURPOSE:
   Version of POLYFITW that uses SVD fitting

 CALLING SEQUENCE:
   res = djs_polyfit(x, y, ndegree, [ variance=, yfit= ] )

 INPUTS:
   x -
   y -
   ndegree - Degree of polynomial fit, where NDEGREE+1 terms are fit

 OPTIONAL INPUTS:

 OUTPUTS:
   res - Polynominal coefficients [NDEGREE+1]

 OPTIONAL OUTPUTS:

 COMMENTS:
   Perform polynomial fits using SVD.  If the fit is singular, then
   redo the fit with fewer terms until it is not singular.

 EXAMPLES:

 BUGS:

 DATA FILES:

 PROCEDURES CALLED:

 REVISION HISTORY:
   16-Feb-2011  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/spec2d/djs_polyfit.pro)</strong></p>
<hr />
<h3 id="DR1LIST_BEST">DR1LIST_BEST</h3>
<p><a href="#DJS_POLYFIT">[Previous Routine]</a></p>
<p><a href="#ELODIE_BEST">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   dr1list_best

 PURPOSE:
   Determine which plates *should* have been in DR1 that match the tiles
   of those actually chosen.

 CALLING SEQUENCE:
   dr1list_best

 INPUTS:

 OPTIONAL INPUTS:

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Outputs are written to the file 'jill.out'.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   platelist
   struct_print

 REVISION HISTORY:
   22-Aug-2002  Written by David Schlegel, Princeton (not checked in then)
</pre>
<p><strong>(See pro/plan/dr1list_best.pro)</strong></p>
<hr />
<h3 id="ELODIE_BEST">ELODIE_BEST</h3>
<p><a href="#DR1LIST_BEST">[Previous Routine]</a></p>
<p><a href="#ELODIE_FILELIST">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   elodie_best

 PURPOSE:
   Find the best-fit Elodie spectrum to a set of spectra.

 CALLING SEQUENCE:
   res = elodie_best(objflux, objivar, $
    hdr=, objloglam0=, objdloglam=, zmin=, zmax=, fitindx= ])

 INPUTS:
   objflux    - Flux for spectra [NPIX,NOBJECT]
   objivar    - Inverse variance of flux [NPIX,NOBJECT]

 OPTIONAL INPUTS:
   hdr        - FITS header for objects, used to construct the wavelengths
                from the following keywords: COEFF0, COEFF1.
                Must be specified if OBJLOGLAM0,OBJDLOGLAM are not set.
   objloglam0 - Zero-pint of log-10(Angstrom) wavelength mapping of OBJFLUX.
   objdloglam - Wavelength spacing for OBJFLUX in log-10(Angstrom).
   zmin       - Minimum redshift to consider; default to -0.00333
                (-1000 km/sec).
   zmax       - Minimum redshift to consider; default to +0.00333
                (+1000 km/sec).
   fitindx    - If set, then only fit for the objects specified by
                these indices.  Set to -1 to not fit any objects (but
                return empty output structures); default to fitting all.

 OUTPUTS:
   res        - Output structure with result for each object [NOBJECT].
                The following elements are from the FITS header of the
                best-fit Elodie spectrum:
                  ELODIE_FILENAME   - Filename
                  ELODIE_OBJECT     - Object name
                  ELODIE_SPTYPE     - Spectral type
                  ELODIE_BV         - (B-V) color
                  ELODIE_TEFF       - T_effective
                  ELODIE_LOGG       - Log10(gravity)
                  ELODIE_FEH        - [Fe/H]
                  ELODIE_Z_MODELERR - The standard deviation in redshift
                                      amongst the 12 best-fit stars
                The following elements are from the ZFIND() function:
                  ELODIE_Z          - Redshift
                  ELODIE_Z_ERR      - Redshift error
                  ELODIE_RCHI2      - Reduced chi^2
                  ELODIE_DOF        - Degrees of freedom for fit

 OPTIONAL OUTPUTS:

 COMMENTS:
   Any stars labelled as possible binary or triple stars are ignored.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_maskinterp()
   read_elodie()
   splog
   sxpar()
   zfind()

 INTERNAL SUPPORT ROUTINES:
   elodie_struct()

 REVISION HISTORY:
   11-Mar-2002  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/elodie_best.pro)</strong></p>
<hr />
<h3 id="ELODIE_FILELIST">ELODIE_FILELIST</h3>
<p><a href="#ELODIE_BEST">[Previous Routine]</a></p>
<p><a href="#EXTRACT_ASYMBOX2">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   elodie_filelist

 PURPOSE:
   Get a listing of all valid Elodie filenames.

 CALLING SEQUENCE:
   res = elodie_filelist(minwave=)

 INPUTS:

 OPTIONAL INPUTS:

 OUTPUTS:
   res      - list of full filenames for all unmasked Elodie spectra

 OPTIONAL OUTPUTS:
   minwave  - if the filter.par file exists and contains a minwave
              keyword, its value. Else returns 1.0

 COMMENTS:
   If the filter.par file does not exist, all files in the
   $ELODIE_DIR/LL_ELODIE/ directory are returned, and minwave is set
   to 0

 EXAMPLES:

 BUGS:
   The masking logic should be inverted: only listed files should be matched.

 PROCEDURES CALLED:
   yanny_read()
</pre>
<p><strong>(See pro/spec1d/elodie_filelist.pro)</strong></p>
<hr />
<h3 id="EXTRACT_ASYMBOX2">EXTRACT_ASYMBOX2</h3>
<p><a href="#ELODIE_FILELIST">[Previous Routine]</a></p>
<p><a href="#EXTRACT_BOXCAR">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   extract_asymbox2

 PURPOSE:
   Extract the total flux within a boxcar window at many positions.
   This routine will accept an asymmetric/variable window
   Traces are expected to run vertically to be consistent with other
    extract_  routines

   MODIFIED MODEL WEIGHTING

 CALLING SEQUENCE:
   fextract = extract_asymbox2( image, left, right, $
                 [ycen, weight_image=weight_image, f_ivar=f_ivar, model=model])

 INPUTS:
   image     - Image
   left      - Lower boundary of boxcar window (given as floating pt pixels)
   right     - Upper boundary of boxcar window (given as floating pt pixels)

 OPTIONAL KEYWORDS:
   ycen      - Y positions corresponding to &quot;left&quot; (expected as integers)
   weight_image -  Weights to be applied to image before boxcar

 OUTPUTS:
   fextract - Extracted flux at positions specified by (left&lt;--&gt;right, ycen)

 OPTIONAL OUTPUTS:
   f_ivar    - the boxcar summed weights, weights=1 if weight_image is missing
   model     - A model image (of size image)

 COMMENTS:

 EXAMPLES:

 PROCEDURES CALLED:

 REVISION HISTORY:
   24-Mar-1999  Written by David Schlegel, Princeton.
   17-Feb-2003  Written with slow IDL routine, S. Burles, MIT
   27-Jan-2004  Adopted to do asymmetric/varying boxcar
</pre>
<p><strong>(See pro/spec2d/extract_asymbox2.pro)</strong></p>
<hr />
<h3 id="EXTRACT_BOXCAR">EXTRACT_BOXCAR</h3>
<p><a href="#EXTRACT_ASYMBOX2">[Previous Routine]</a></p>
<p><a href="#EXTRACT_BUNDLE_IMAGE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   extract_boxcar

 PURPOSE:
   Extract the total flux within a boxcar window at many positions.

 CALLING SEQUENCE:
   fextract = extract_boxcar( fimage, xcen, ycen, [radius=radius] )

 INPUTS:
   fimage     - Image
   xcen       - Initial guesses for X centers
   ycen       - Y positions corresponding to &quot;xcen&quot; (expected as integers)

 OPTIONAL KEYWORDS:
   radius     - Radius of extraction; default to 3.0

 OUTPUTS:
   fextract   - Extracted flux at each position specified by (xcen, ycen)

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 PROCEDURES CALLED:
   Dynamic link to extract_boxcar.c

 REVISION HISTORY:
   24-Mar-1999  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/spec2d/extract_boxcar.pro)</strong></p>
<hr />
<h3 id="EXTRACT_BUNDLE_IMAGE">EXTRACT_BUNDLE_IMAGE</h3>
<p><a href="#EXTRACT_BOXCAR">[Previous Routine]</a></p>
<p><a href="#EXTRACT_BUNDLE_ROW">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   extract_bundle_image

 PURPOSE:
   Extract the fiber profile flux for an entire image, using
   extract_bundle_row to chunk it up over bundles.

   Modified from extract_image, which called extract_row.

 **SEE DETAILED DOCUMENTATION COMMENTS IN EXTRACT_BUNDLE_ROW.PRO**
 **FOR MORE INFO ON THE CONVERSION FROM EXTRACT_IMAGE/ROW**

 CALLING SEQUENCE:
   extract_bundle_image, fimage, invvar, xcen, sigma, flux, [finv, yrow=,
              ymodel=, fscat=, proftype=, ansimage=,
              wfixed=, mask=mask, pixelmask=,  reject=, wsigma=, 
              nPoly=, maxIter=, highrej=, lowrej=,
              fitans=, whopping=, /relative, 
              nband= ])

 INPUTS:
   fimage     - Image [NCOL,NROW]
   invvar     - Inverse variance [NCOL,NROW]
   xcen       - Initial guesses for X centers [NROW,NFIBER]
   sigma      - Input sigma of gaussian profile; default to 1.0 pixels.
                This can be a scalar, an [NFIBER] vector, or
                an [NROW,NFIBER] array.

 OPTIONAL KEYWORDS (retained):
   yrow       - List of row numbers (0-indexed) to extract; default to all.
   mask       - byte mask: 1 is good and 0 is bad [NCOL,NROW] 
   pixelmask  - bits set due to extraction rejection [NROW,NFIBER]
   reject     - Array setting rejection threshholds; defaults are set
                in EXTRACT_BUNDLE_ROW().
   nPoly      - order of polynomial background, default to 2
   maxIter    - maximum number of profile fitting iterations; default to 20
   highrej    - positive sigma deviation to be rejected (default 10.0)
   lowrej     - negative sigma deviation to be rejected (default 10.0)
   relative   - Scale rejection thresholds by reduced chi-squared (default 0)
   oldreject  - ???

 OPTIONAL KEYWORDS (deprecated):
   proftype   - currently, one can only use 1: Gaussian (scalar)
              - or                          2: Exp Cubic
              - or                          3: Double Gaussian
              - or              4: Exp Cubic with doublewide Gaussian
   wfixed     - array of 1's and zero's which set which parameters are fixed.
                e.g. [1] just gaussian's with fixed width sigma
                     [1, 1] fit gaussian + sigma correction
                     [1, 0, 1] fit gaussian + center correction
                     [1, 1, 1] fit gaussian + sigma and center corrections.   
   nband      - band-width of full covariance fiber profile matrix;
                default to 1.
   fitans     - ratio of profiles to do in single profile fitting
   whopping   - traces which have WHOPPINGingly high counts, and need extra
                background terms
   wsigma     - sigma width of whopping profile (exponential, default 25)

 OUTPUTS:
   flux       - Total extracted flux in each profile [nRowExtract,NFIBER]

 OPTIONAL OUTPUTS (retained):
   ansimage   - Coefficients of fit for each row [nCoeff,nRow]
   mask       - Modified by setting the values of bad pixels to 0
   finv       - Estimated inverse variance each profile [nRowExtract,NFIBER]
   ymodel     - Model best fit of row [NCOL,NROW]
   pimage     - ???
   chisq      - Chi^2 of each row [NROW]

 OPTIONAL OUTPUTS (deprecated):
   ansimage   - Coefficients of fit for each row [nCoeff,nRow]
   fscat      - Scattered light contribution in each fiber [NROW,NFIBER]

 COMMENTS:

 EXAMPLES:

 PROCEDURES CALLED:
   calcflux
   extract_row()
   pixelmask_bits()
   splog

 REVISION HISTORY:
   08-Aug-1999  Written by Scott Burles, Chicago 
   22-Aug-2000  Added banded-matrix possibility 
   2010 Modified to _bundle_ form by A. Bolton, U. of Utah.
   2011 Aug: documentation cleanup by A. Bolton, U. of Utah.
</pre>
<p><strong>(See pro/spec2d/extract_bundle_image.pro)</strong></p>
<hr />
<h3 id="EXTRACT_BUNDLE_ROW">EXTRACT_BUNDLE_ROW</h3>
<p><a href="#EXTRACT_BUNDLE_IMAGE">[Previous Routine]</a></p>
<p><a href="#EXTRACT_IMAGE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   extract_bundle_row

 PURPOSE:
   Fit the fiber profiles and background in a single row with least
   squares, chunking it up by bundle, using Gaussians plus polynomial
   background.

   Based upon extract_row.pro, which was a call to extract_row.c

 NOTES ON CONVERSION TO EXTRACT_BUNDLE_ROW (A. Bolton, Utah, 2011Aug):
   The extraction guts of this program are entirely new,
   written in pure IDL rather than in IDL-wrapped C.
   However, I have attempted (1) to preserve most of the same
   outward functionality in terms of inputs and outputs, at least
   those that are relevant to the BOSS case, and (2) to retain
   the same rejection-iteration behavior, so that the same sorts
   of cases trigger rejection as before.  I did not parse all
   the details of the rejection logic.  One thing I know is that
   the rejection in current form would be more efficient if it were
   done on each bundle separately, rather than on the entire row.
   But that would require a fine-grained refactoring that would risk
   breaking the rejection logic, so I didn't attempt it.

   Some deprecated (and even retained) keyword input/output variables
   may have unexpected behavior is used in a context other than the
   current BOSS-implementation calls in EXTRACT_IMAGE.

   I have retained a fair bit of the original code in commented-out
   form, for forensic purposes.  Anything removed during the
   conversion to bundle form is commented out with a &quot;;#&quot;.

 CALLING SEQUENCE:
; First four positional arguments inherited from extract_row:
   ans = extract_row( fimage, invvar, xcen, sigma,
; Next keyword arguments new to extract_bundle_row:
; (skew and kurt not currently enabled)
              [nperbun=, buffsize=, skew=, kurt=,
; Next keyword retained but reinterpreted:
              npoly=, 
; Next keywords retained in more or less the same role (I think):
              maxiter=, lowrej=, highrej=, niter=, reducedChi=, xvar=,
              mask=, relative=, diagonal=, pixelmask=, reject=,, ymodel=
; Next keyword arguments deprecated:
              fscat=, proftype=, wfixed=, inputans=, iback=, bfixarr=,
              fullcovar=, wfixarr=, squashprofile=, whopping=,
              wsigma=, nBand=  ])

 INPUTS:
   fimage     - Vector [nCol]
   invvar     - Inverse variance [nCol]
   xcen       - Initial guesses for X centers [nFiber]
   sigma      - Sigma of gaussian profile; (scalar or [nFiber])

 OPTIONAL KEYWORDS (new):
   nperbun    - Number of fibers per bundle (default is 20).
   buffsize   - Pixel buffer size on the very outside of the image
                (default is 8)
   npoly      - order of polynomial background in bundle, default=2 (linear).

 OPTIONAL KEYWORDS (retained):
   maxiter    - Maximum number of profile fitting iterations; default to 10
   lowrej     - Negative sigma deviation to be rejected; default to 5
   highrej    - Positive sigma deviation to be rejected; default to 5
   reject     - Three-element array setting partial and full rejection
                thresholds for profiles; default [0.2, 0.6, 0.6].
                When there is less than REJECT[2] of the area is left,
                  then drop fitting of all higher-order terms.
                When there is less than REJECT[1] of the area is left,
                  then the pixel is rejected (inverse variance is set to 0).
                When there is less than REJECT[0] of the area is left,
                  then assume that there's no fiber there, and don't fit
                  for that fiber at all.
   relative   - Set to use reduced chi-square to scale rejection threshold

 DEPRECATED KEYWORDS:
   inputans   - Input fit, excluding background and whopping terms
                [ncoeff*nFiber]
                The array is sorted as follows:
                  [ncoeff] values for fiber #0
                   ...
                  [ncoeff] values for fiber #(nFiber-1)
   squashprofile - ???
   nband      - Band-width of covariance matrix of fiber profiles: default 1
   whopping   - X locations to center additional &quot;whopping&quot; terms to describe
                the exponentail tails of flux near bright fibers; default
                to -1, which means not to use any such terms.
   wsigma     - Sigma width for exponential whopping profiles; default to 25

 MODIFIED INPUTS (OPTIONAL, retained):
   xvar       - X values of fimage and invvar; default is findgen(NX).
   mask       - Image mask: 1=good, 0=bad [NX]
   pixelmask  - Bits set for each fiber due to extraction rejection
                [nFiber]

 MODIFIED INPUTS (OPTIONAL, deprecated):
   wfixed     - Array to describe which parameters to fix in the profile;
                0=fixed, 1=float; default to [1].
                The number of parameters to fit per fiber is determined
                this way; e.g. nCoeff = n_elements(wfixed), so the default
                is to fit only 1 parameter per fiber.  For the (default)
                Gaussian profile, this is the height of the Gaussian.
                Note that WFIXED is used to build the array WFIXARR.
   iback      - 1D array of input background coeff 
                (needed if fixed parameters are non-zero)
   bfixarr    - 1D integer array to specify which terms of the background
                coefficients to fix; 0=fixed, 1=float.
   wfixarr    - 1D integer array to specify which parameters in the full fit
                to fix; 0=fixed, 1=float.
                The array is sorted as follows:
                  [ncoeff] values for fiber #0
                   ...
                  [ncoeff] values for fiber #(nFiber-1)
                  [npoly] values for the background polynomial terms
                  [whoppingct] values for the whopping terms

 OUTPUTS (reinterpreted):
   ans        - Output fit [nFiber]
                (extracted Gaussian profile amplitudes)

 OPTIONAL OUTPUTS (retained):
   ymodel     - Evaluation of best fit [nCol]
   diagonal   - 1D diagonal of covariance matrix
   niter      - Number of rejection iterations performed
   reducedChi - Reduced chi ???

 OPTIONAL OUTPUTS (deprecated):
   fscat      - Scattered light contribution in each fiber [nFiber]
   fullcovar  - 2D covariance matrix.  This is a symmetric matrix, and we
                only fill the lower triangle.  Computing this increases CPU
                time by a factor of 2 or 3.

 REVISION HISTORY:
    8-Aug-1999  extract_row Written by Scott Burles, Chicago 
    Sep 2010    converted to extract_bundle_row by Adam S. Bolton, Utah
    Aug 2011    attempted documentation cleanup, Adam S. Bolton, Utah
</pre>
<p><strong>(See pro/spec2d/extract_bundle_row.pro)</strong></p>
<hr />
<h3 id="EXTRACT_IMAGE">EXTRACT_IMAGE</h3>
<p><a href="#EXTRACT_BUNDLE_ROW">[Previous Routine]</a></p>
<p><a href="#EXTRACT_OBJECT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   extract_image

 PURPOSE:
   Extract the fiber profile flux for an entire image

 CALLING SEQUENCE:
   extract_image(fimage, invvar, xcen, sigma, flux, [finv, yrow=,
              ymodel=, fscat=, proftype=, ansimage=,
              wfixed=, mask=mask, pixelmask=,  reject=, wsigma=, 
              nPoly=, maxIter=, highrej=, lowrej=,
              fitans=, whopping=, /relative, 
              nband= ])

 INPUTS:
   fimage     - Image [NCOL,NROW]
   invvar     - Inverse variance [NCOL,NROW]
   xcen       - Initial guesses for X centers [NROW,NFIBER]
   sigma      - Input sigma of gaussian profile; default to 1.0 pixels.
                This can be a scalar, an [NFIBER] vector, or
                an [NROW,NFIBER] array.

 OPTIONAL KEYWORDS:
   yrow       - List of row numbers (0-indexed) to extract; default to all.
   proftype   - currently, one can only use 1: Gaussian (scalar)
              - or                          2: Exp Cubic
              - or                          3: Double Gaussian
              - or              4: Exp Cubic with doublewide Gaussian
   wfixed     - array of 1's and zero's which set which parameters are fixed.
                e.g. [1] just gaussian's with fixed width sigma
                     [1, 1] fit gaussian + sigma correction
                     [1, 0, 1] fit gaussian + center correction
                     [1, 1, 1] fit gaussian + sigma and center corrections.   
   mask       - byte mask: 1 is good and 0 is bad [NCOL,NROW] 
   pixelmask  - bits set due to extraction rejection [NROW,NFIBER]
   reject     - Array setting rejection threshholds; defaults are set
                in EXTRACT_ROW().
   nPoly      - order of chebyshev scattered light background; default to 4
   nband      - band-width of full covariance fiber profile matrix;
                default to 1.
   maxIter    - maximum number of profile fitting iterations; default to 20
   highrej    - positive sigma deviation to be rejected (default 10.0)
   lowrej     - negative sigma deviation to be rejected (default 10.0)
   fitans     - ratio of profiles to do in single profile fitting
   relative   - Scale rejection thresholds by reduced chi-squared (default 0)
   whopping   - traces which have WHOPPINGingly high counts, and need extra
                background terms
   wsigma     - sigma width of whopping profile (exponential, default 25)
   oldreject  - ???

 OUTPUTS:
   flux       - Total extracted flux in each profile [nRowExtract,NFIBER]

 OPTIONAL OUTPUTS:
   ansimage   - Coefficients of fit for each row [nCoeff,nRow]
   mask       - Modified by setting the values of bad pixels to 0
   finv       - Estimated inverse variance each profile [nRowExtract,NFIBER]
   ymodel     - Model best fit of row [NCOL,NROW]
   fscat      - Scattered light contribution in each fiber [NROW,NFIBER]
   pimage     - ???
   chisq      - Chi^2 of each row [NROW]

 COMMENTS:

 EXAMPLES:

 PROCEDURES CALLED:
   calcflux
   extract_row()
   pixelmask_bits()
   splog

 REVISION HISTORY:
   08-Aug-1999  Written by Scott Burles, Chicago 
   22-Aug-2000  Added banded-matrix possibility 
</pre>
<p><strong>(See pro/spec2d/extract_image.pro)</strong></p>
<hr />
<h3 id="EXTRACT_OBJECT">EXTRACT_OBJECT</h3>
<p><a href="#EXTRACT_IMAGE">[Previous Routine]</a></p>
<p><a href="#EXTRACT_PROFILE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   extract_object

 PURPOSE:

   Performs all object extraction tasks
      0) Locate bright fibers, and test image background
      1) 4 Step Optimal extraction
      2) Tweak to sky lines
      3) Sky subtraction
      4) Flux calibration
      5) Telluric correction

 CALLING SEQUENCE:
   extract_object, outname, objhdr, image, invvar, plugsort, wset, $
    xarc, lambda, xtrace, fflat, fibermask, proftype=, color=, $
    [ widthset=, dispset=, skylinefile=, plottitle=, superflatset=, $
    /do_telluric, /bbspec, /splitsky, ccdmask= ]

 INPUTS:
   outname    - Name of outputs FITS file
   objhdr     - Header cards from object image
   image      - Object image [nx,ny]
   invvar     - Inverse Variance of object image [nx,ny]
   plugsort   - Plugmap structure for [ntrace] spectra
   wset       - Wavelength solution from arc line spectra
   xarc       - centroids measured in arc line spectra
   lambda     - air wavelengths corresponding to xarc
   xtrace     - spatial traces from flat field
   fflat      - 1d flat field vectors
   fibermask  - Fiber status bits, set nonzero for bad status [NFIBER]
   proftype   - Which type of profile should we use, (default=1 Gaussian)
   superflatset- If present, then divide by median superflat! ???
   color      - ???
   widthset   - ???
   dispset    - ???
   skylinefile- ???
   bbspec         - use bbspec extraction code
   splitsky   - split sky subtraction between (spatial) halves of CCD.

 REQUIRED KEYWORDS:
   color      - camera color (red or blue)

 OPTIONAL KEYWORDS:
   plottitle  - Prefix for titles in QA plots.
   do_telluric- If set, then perform telluric-corrections for the red CCDs;
                the default is to no longer do this, because the v5 code
                does this in the later flux-calibration steps
   ccdmask    - If set, then use this to set some pixel values in pixmask

 OUTPUTS:
   A fits file is output in outname, which contains
      FLOAT flambda [NX,NTRACE]
      FLOAT flambda_invvar [NX,NTRACE]
      LONG finalmask [NX,NTRACE]
      STRUCT vacuum wavelengths
      STRUCT wavelength dispersion
      STRUCT plugmap [NTRACE]

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   calcscatimage()
   divideflat
   djs_median()
   djs_oplot
   djs_plot
   extract_boxcar()
   extract_image
   fibermask_bits()
   fitsn()
   fitvacset()
   get_tai
   heliocentric()
   locateskylines
   mwrfits
   pixelmask_bits()
   qaplot_scatlight
   qaplot_skydev
   qaplot_skyline
   qaplot_skyshift
   qaplot_skysub
   skyline_dispersion()
   skysubtract
   spadd_guiderinfo
   splog
   sxaddpar
   sxpar()
   telluric_corr
   traceset2xy
   find_whopping()

 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   24-Jan-2000  Written by S. Burles, Chicago
   26-Jul-2001  Also pass proftype and superflatset
   29-Mar-2011  Switching to pure IDL bundle-wise extraction (A. Bolton, U. Utah)
   15-Aug-2011  Enabling split sky model across halves of CCD. (A. Bolton, U. Utah)
</pre>
<p><strong>(See pro/spec2d/extract_object.pro)</strong></p>
<hr />
<h3 id="EXTRACT_PROFILE">EXTRACT_PROFILE</h3>
<p><a href="#EXTRACT_OBJECT">[Previous Routine]</a></p>
<p><a href="#EXTRACT_ROW">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   extract_profile

 PURPOSE:
   Extract the flux with profile weighting at centroid positions.

 CALLING SEQUENCE:
   fextract = extract_profile( fimage, invvar, xcen, ycen, 
                  [ferror=ferror, fscattered=fscattered, fwidth=fwidth, 
                   sigma=sigma, nPoly=nPoly, maxIter=maxIter,
                   refit=refit, highrej=highrej, lowrej=lowrej, boxap=boxap])

 INPUTS:
   fimage     - Image[nCol,nRow]
   invvar     - Inverse Variance[nCol,nRow]
   xcen       - Initial guesses for X centers[nFibers,nRow]
   ycen       - Y positions corresponding to &quot;xcen[nFibers]&quot; [nRow]

 OPTIONAL KEYWORDS:
   ferror     - error array (-1 if bad pixel)
   fscattered - scattered light contribution 
   fwidth     - final profile width used

   sigma      - sigma of gaussian profile; default to 1.0
   nPoly      - order of chebyshev scattered light background; default to 5
   maxIter    - maximum number of profile fitting iterations; default to 5
   refit      - order of chebyshev to fit to profile widths vs. row,
			default is 0, which does no refitting
   highrej    - positive sigma deviation to be rejected (default 5.0)
   lowrej     - negative sigma deviation to be rejected (default 5.0)
   boxap      - boxcar aperture size in pixels 
			default is 0, which does no boxcar extraction

 OUTPUTS:
   fextract   -  Extracted flux at each position specified by (xcen, ycen)
                  [nFibers,nRow]
		2: Scattered light estimate
		3: Final profile width 
		4: Boxcar extracted flux

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 PROCEDURES CALLED:
   Dynamic link to extract_profile.c

 REVISION HISTORY:
   24-Mar-1999  David Schlegel, Princeton.
   24-Jun-1999  Stolen and modified by Scott Burles, Chicago.
</pre>
<p><strong>(See pro/spec2d/extract_profile.pro)</strong></p>
<hr />
<h3 id="EXTRACT_ROW">EXTRACT_ROW</h3>
<p><a href="#EXTRACT_PROFILE">[Previous Routine]</a></p>
<p><a href="#FCALIB_DEFAULT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   extract_row

 PURPOSE:
   Fit the fiber profiles and background in a single row with least squares

 CALLING SEQUENCE:
   ans = extract_row( fimage, invvar, xcen, sigma, [ymodel=, fscat=, 
              proftype=, wfixed=, inputans=, iback=, bfixarr=, xvar=,
              mask=, relative=, diagonal=, fullcovar=, wfixarr=, npoly=,
              maxiter=, lowrej=, highrej=, niter=, squashprofile=,
              whopping=, wsigma=, pixelmask=, reject=, reducedChi=,
              nBand=  ])

 INPUTS:
   fimage     - Vector [nCol]
   invvar     - Inverse variance [nCol]
   xcen       - Initial guesses for X centers [nFiber]
   sigma      - Sigma of gaussian profile; (scalar or [nFiber])

 OPTIONAL KEYWORDS:
   proftype   - Select profile type:
                  1: Gaussian
                  2: (exponential)^3
                  3: (exponential)^2.5
                Default to 1.
   inputans   - Input fit, excluding background and whopping terms
                [ncoeff*nFiber]
                The array is sorted as follows:
                  [ncoeff] values for fiber #0
                   ...
                  [ncoeff] values for fiber #(nFiber-1)
   relative   - Set to use reduced chi-square to scale rejection threshold
   squashprofile - ???
   npoly      - Order of chebyshev scattered light background; default to 5
   nband      - Band-width of covariance matrix of fiber profiles: default 1
   maxiter    - Maximum number of profile fitting iterations; default to 10
   lowrej     - Negative sigma deviation to be rejected; default to 5
   highrej    - Positive sigma deviation to be rejected; default to 5
   whopping   - X locations to center additional &quot;whopping&quot; terms to describe
                the exponentail tails of flux near bright fibers; default
                to -1, which means not to use any such terms.
   wsigma     - Sigma width for exponential whopping profiles; default to 25
   reject     - Three-element array setting partial and full rejection
                thresholds for profiles; default [0.2, 0.6, 0.6].
                When there is less than REJECT[2] of the area is left,
                  then drop fitting of all higher-order terms.
                When there is less than REJECT[1] of the area is left,
                  then the pixel is rejected (inverse variance is set to 0).
                When there is less than REJECT[0] of the area is left,
                  then assume that there's no fiber there, and don't fit
                  for that fiber at all.

 MODIFIED INPUTS (OPTIONAL):
   wfixed     - Array to describe which parameters to fix in the profile;
                0=fixed, 1=float; default to [1].
                The number of parameters to fit per fiber is determined
                this way; e.g. nCoeff = n_elements(wfixed), so the default
                is to fit only 1 parameter per fiber.  For the (default)
                Gaussian profile, this is the height of the Gaussian.
                Note that WFIXED is used to build the array WFIXARR.
   iback      - 1D array of input background coeff 
                (needed if fixed parameters are non-zero)
   bfixarr    - 1D integer array to specify which terms of the background
                coefficients to fix; 0=fixed, 1=float.
   wfixarr    - 1D integer array to specify which parameters in the full fit
                to fix; 0=fixed, 1=float.
                The array is sorted as follows:
                  [ncoeff] values for fiber #0
                   ...
                  [ncoeff] values for fiber #(nFiber-1)
                  [npoly] values for the background polynomial terms
                  [whoppingct] values for the whopping terms
   xvar       - X values of fimage and invvar; default is findgen(NX).
   mask       - Image mask: 1=good, 0=bad [NX]
   pixelmask  - Bits set for each fiber due to extraction rejection [nFiber]

 OUTPUTS:
   ans        - Output fit [ncoeff*nFiber+npoly+whoppingct]
                The array is sorted as follows:
                  [nFiber] values for coefficient #0
                   ...
                  [nFiber] values for coefficient #(nCoeff-1)
                  [npoly] values for the background polynomial terms
                  [whoppingct] values for the whopping terms
                Note this array is **not** sorted as INPUTANS or WFIXARR!

 OPTIONAL OUTPUTS:
   ymodel     - Evaluation of best fit [nCol]
   fscat      - Scattered light contribution in each fiber [nFiber]
   diagonal   - 1D diagonal of covariance matrix.  Currently, this is
                the diagonal from the Cholesky decompostion, which is
                1/error[j].  [ncoeff*nFiber+npoly+whoppingct]
   fullcovar  - 2D covariance matrix.  This is a symmetric matrix, and we
                only fill the lower triangle.  Computing this increases CPU
                time by a factor of 2 or 3.
   niter      - Number of rejection iterations performed
   reducedChi - Reduced chi ???

 COMMENTS:

 BUGS:
    Still need to do:
       limits on chebyshev polynomial are assumed to be 0.0 &lt;--&gt; nx
       these may need to be optional if only partial rows are being fit

       Error codes need to be returned, currently no such codes are returned

 EXAMPLES:

 PROCEDURES CALLED:
   Dynamic link to extract_row.c

 REVISION HISTORY:
    8-Aug-1999  Written by Scott Burles, Chicago 
</pre>
<p><strong>(See pro/spec2d/extract_row.pro)</strong></p>
<hr />
<h3 id="FCALIB_DEFAULT">FCALIB_DEFAULT</h3>
<p><a href="#EXTRACT_ROW">[Previous Routine]</a></p>
<p><a href="#FIBERFLAT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   fcalib_default

 PURPOSE:
   Return a default flux-calibration vector

 CALLING SEQUENCE:
   calibfac = fcalib_default(camname, loglam, [exptime] )

 INPUTS:
   camname    - Camera name; 'b1', 'b2', 'r1' or 'r2'
   loglam     - Wavelengths [log-10 Angstroms]

 OPTIONAL INPUTS:
   exptime    - Rescale the fluxing vector to this exposure time [sec];
                default to the value in the spFluxcalib file header
                (probably 900 sec)

 OUTPUTS:
   calibfac   - Flux-calibration values in units of
                electrons/(e-17 erg/cm^2/Ang); set to 0 if outside
                the knonwn wavelengths; the spectra in electrons (not ADU)
                should be divided by this; note that this calibration vector
                is for the specified exposure time, so there is not time unit

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 DATA FILES:
   $IDLSPEC2D_DIR/examples/spFluxcalib-$CAMERA.fits

 PROCEDURES CALLED:
   bspline_valu()
   headfits()
   mrdfits()
   sxpar()

 REVISION HISTORY:
   17-Dec-2005  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/spec2d/fcalib_default.pro)</strong></p>
<hr />
<h3 id="FIBERFLAT">FIBERFLAT</h3>
<p><a href="#FCALIB_DEFAULT">[Previous Routine]</a></p>
<p><a href="#FIBERMASK_BITS">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   fiberflat

 PURPOSE:
   Construct the flat-field vectors from an extracted flat-field image.

 CALLING SEQUENCE:
   fflat = fiberflat( flux, fluxivar, wset, [ fibermask=fibermask, $
    minval=, ncoeff=, pixspace=, /dospline, nord=, lower=, upper=,
    /dospline, /nonorm, plottitle=, badflatfracthresh= ])

 INPUTS:
   flux       - Array of extracted flux from a flat-field image [Nrow,Ntrace]
   fluxivar   - Inverse variance map for FLUX.
   wset       - Wavelength solution

 OPTIONAL KEYWORDS:
   fibermask  - Fiber status bits, set nonzero for bad status [NFIBER]
   minval     - Minimum value to use in fits to flat-field vectors;
                default to 3% of the median of FLUX.
   ncoeff     - Number of coefficients used in constructing FFLAT;
                default to 3 (cubic)
   pixspace   - Approximate spacing in pixels for break points in the
                spline fits to individual fibers; default to 10 pixels.
   dospline   - If this keyword is set, then fit the flat-field vectors
                to splines (using PIXSPACE) rather than to a Legendre
                polynomial (using NCOEFF).
                This is now what we use?
   plottitle  - Title for QA plot; if not set, then do not plot.
   nonorm     - Do not normalize the fluxes in FFLAT by the super-flat.
   superflatset-Bspline set to reconstruct superflat
   badflatfracthresh - the fraction of bad flat pixels to decide if
                       the flat is bad

 PARAMETERS FOR SLATEC_SPLINEFIT:
   nord
   lower
   upper

 OUTPUTS:
   fflat      - Array of flat-field flat-field vectors for each fiber
                that remove relative flat-field variations as a function
                of wavelength between fibers [Nrow, Ntrace]

 OPTIONAL OUTPUTS:
   fibermask  - (Modified)

 COMMENTS:
   The user should first &quot;flat-field&quot; the input array to take out
   pixel-to-pixel variations.

   The parameters for SLATEC_SPLINEFIT are only used when generating the
   &quot;superflat&quot;.

   The 'BADFLAT' bit is set in FIBERMASK if the mean throughput for
   a fiber is less than 0.7 times the median of all good-fiber throughputs.

   In any given fiber, set FFLAT=0 wherever there are at least 5 contiguous
   bad pixels.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   fibermask_bits()
   bspline_valu()
   bspline_iterfit()
   splog
   superflat()
   traceset2xy
   xy2traceset

 REVISION HISTORY:
   14-Oct-1999  Written by D. Schlegel, APO
    3-Oct-2000  Changed over to IDL bspline routines
</pre>
<p><strong>(See pro/spec2d/fiberflat.pro)</strong></p>
<hr />
<h3 id="FIBERMASK_BITS">FIBERMASK_BITS</h3>
<p><a href="#FIBERFLAT">[Previous Routine]</a></p>
<p><a href="#FIBER_ROLLCALL">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   fibermask_bits

 PURPOSE:
   Return mask value corresponding to a mask condition for FIBERMASK.

 CALLING SEQUENCE:
   mask = fibermask_bits(label)

 INPUTS:
   label      - String name specifying bit

 OUTPUTS:
   mask       - Signed long set to 2^BIT, with BIT specified by LABEL.

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:
   mask = fibermask_bits('NOPLUG') 

 BUGS:

 PROCEDURES CALLED:
   pixelmask_bits()

 REVISION HISTORY:
   23-Jan-2000 Written by S. Burles, Chicago
   14-Jul-2000 Combine with PIXELMASK_BITS() (DJS).
</pre>
<p><strong>(See pro/spec2d/fibermask_bits.pro)</strong></p>
<hr />
<h3 id="FIBER_ROLLCALL">FIBER_ROLLCALL</h3>
<p><a href="#FIBERMASK_BITS">[Previous Routine]</a></p>
<p><a href="#FILTER_CHECK">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   fiber_rollcall

 PURPOSE:
   Print the &quot;roll call&quot; of how many plug-map bits are set.

 CALLING SEQUENCE:
   fiber_rollcall, andmask, loglam

 INPUTS:
   andmask    - Bit mask
   loglam     - Wavelength mapping in log10(Ang)

 OPTIONAL INPUTS:

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 DATA FILES:

 PROCEDURES CALLED:
   splog
   sdss_flagname()

 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   17-Feb-2004  Written by D. Schlegel &amp; S. Burles; copied from PLATESN.
</pre>
<p><strong>(See pro/spec2d/fiber_rollcall.pro)</strong></p>
<hr />
<h3 id="FILTER_CHECK">FILTER_CHECK</h3>
<p><a href="#FIBER_ROLLCALL">[Previous Routine]</a></p>
<p><a href="#FILTER_CHECK_CHI2">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   filter_check

 PURPOSE:
   
   Fit for the filter curves by comparing photometry and spectrophotometry

 CALLING SEQUENCE:
   
   filter_check,spallfile,binboundsfile

 INPUTS:
   spallfile      - spectro info

 OPTIONAL INPUTS:

   binboundsfile  - bin boundaries 

 OPTIONAL KEYWORDS:

 OUTPUTS:
   binRfile   - file containing output stuff

 COMMENTS:

 BUGS:

 EXAMPLES:

 PROCEDURES CALLED:

 DATA FILES:

 REVISION HISTORY:
   05-APr-2000  Written by M. Blanton, Fermiland
</pre>
<p><strong>(See pro/spec1d/filter_check.pro)</strong></p>
<hr />
<h3 id="FILTER_CHECK_CHI2">FILTER_CHECK_CHI2</h3>
<p><a href="#FILTER_CHECK">[Previous Routine]</a></p>
<p><a href="#FILTER_SELECT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   filter_check_chi2

 PURPOSE:
   
   Calculate the chi^2 for a particular set of bandpass
   residuals. 

 CALLING SEQUENCE:
   chi2 = filter_check_chi2(binflux, binR, photocounts)

 INPUTS:
   binflux  - binned flux
   binR     - parameters to use for flux
   photocounts  - psf_band + (fiber_r-psf_r) (not dereddened)

 OPTIONAL INPUTS:

 OPTIONAL KEYWORDS:

 OUTPUTS:
   chi2  - resulting chi2

 COMMENTS:

 BUGS:

 EXAMPLES:

 PROCEDURES CALLED:

 DATA FILES:

 REVISION HISTORY:
   05-APr-2000  Written by M. Blanton, Fermiland
</pre>
<p><strong>(See pro/spec1d/filter_check_chi2.pro)</strong></p>
<hr />
<h3 id="FILTER_SELECT">FILTER_SELECT</h3>
<p><a href="#FILTER_CHECK_CHI2">[Previous Routine]</a></p>
<p><a href="#FILTER_SOLVE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   filter_select

 PURPOSE:
   
   Gather spectra based on an input file of the form 
   created by platemerge (the spAll file). Calculate the 
   ugriz throughput for each object in the plates, possibly
   putting limits on target type, MJD, or signal-to-noise
   (essentially by requiring survey quality). 

 CALLING SEQUENCE:
   filter_select, spallfile, outfile, [mjdlimits= , primtarget=,
   filter_prefix=, mingisn2=, rpsfmodel=]

 INPUTS:
   spallfile  - spAll.fit file as created by platemerge
   filter_prefix  - Use alternate prefix for filter curves to use
                    (allowed are sdss or doi) 

 OPTIONAL INPUTS:

 OPTIONAL KEYWORDS:
   mjdlimits  - Only look in a certain range of MJDs
   primtarget - Require a certain target type
   mingisn2 - Minimum plate SN^2 in g AND i

 OUTPUTS:
   outfile    - Fits file with all the spAll.fit info, but with
                synthetic ugriz replaced with the desired filter 
                curves

 COMMENTS:

 BUGS:
   Depends on spec_append, internal routine of readspec

 EXAMPLES:

 PROCEDURES CALLED:
   filter_thru()
   spec_append
   readspec
   mrdfits()
   mwrfits

 REVISION HISTORY:
   05-APr-2000  Written by M. Blanton, Fermiland
</pre>
<p><strong>(See pro/spec1d/filter_select.pro)</strong></p>
<hr />
<h3 id="FILTER_SOLVE">FILTER_SOLVE</h3>
<p><a href="#FILTER_SELECT">[Previous Routine]</a></p>
<p><a href="#FILTER_THRU">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   filter_solve

 PURPOSE:
   
   Minimize the chi^2 by varying the filter residuals. Basically
   solve Ax=b.

 CALLING SEQUENCE:
   filter_solve,binflux,photocounts,binR

 INPUTS:
   binflux  - binned flux
   photocounts  - psf_band + (fiber_r-psf_r) (not dereddened)

 OPTIONAL INPUTS:

 OPTIONAL KEYWORDS:

 OUTPUTS:

   binR     - best fit filter parameters

 COMMENTS:

 BUGS:

 EXAMPLES:

 PROCEDURES CALLED:

 DATA FILES:

 REVISION HISTORY:
   05-APr-2000  Written by M. Blanton, Fermiland
</pre>
<p><strong>(See pro/spec1d/filter_solve.pro)</strong></p>
<hr />
<h3 id="FILTER_THRU">FILTER_THRU</h3>
<p><a href="#FILTER_SOLVE">[Previous Routine]</a></p>
<p><a href="#FINDSPEC">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   filter_thru

 PURPOSE:
   Compute throughput in SDSS filters

 CALLING SEQUENCE:
   res = filter_thru( flux, [waveimg=, wset=, mask=, filter_prefix=, /toair ])

 INPUTS:
   flux       - Flux image [NX,NTRACE]

 OPTIONAL INPUTS:

 OPTIONAL KEYWORDS:
   waveimg    - Wavelength image in Angstroms [NX,NTRACE], or this could
                be a single vector if the wavelength mapping is the same
                for all traces (note the latter is faster to compute)
   wset       - Wavelength solution in log-lambda; required if WAVEIMG not set
   mask       - Linearly interpolate over pixels where MASK is nonzero.
                [NX,NTRACE]
   filter_prefix  - Use alternate prefix for filter curves to use
                    (allowed are sdss, doi, sdss_jun2001) [sdss_jun2001]
   toair      - Convert the wavelengths to air from vacuum before computing

 OUTPUTS:
   res        - Integrated response in all 5 SDSS filters, ordered ugriz;
                dimensions are [NTRACE,5] or [5] if NTRACE=1.

 COMMENTS:
   The filter curve files are assumed to be in $IDLUTILS_DIR/data/filters.

 EXAMPLES:

 BUGS:
   Needs waveimg to be equally spaced in log lambda (MRB 4.5.01) ???
    Now calculates pixel size in log lambda to do correct spectrophotometry

 PROCEDURES CALLED:
   vactoair
   djs_maskinterp()
   readcol
   traceset2xy

 REVISION HISTORY:
   10-Mar-2000  Written by D. Schlegel, Princeton
   05-Apr-2001  Modified by Michael Blanton to allow alternate filters
</pre>
<p><strong>(See pro/spec2d/filter_thru.pro)</strong></p>
<hr />
<h3 id="FINDSPEC">FINDSPEC</h3>
<p><a href="#FILTER_THRU">[Previous Routine]</a></p>
<p><a href="#FIND_NMINIMA">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   findspec

 PURPOSE:
   Routine for finding SDSS spectra that match a given RA, DEC.

 CALLING SEQUENCE:
   findspec, [ra, dec, infile=, outfile=, searchrad=, slist=, $
    topdir=, run2d=, run1d=, /best, /print, /sdss ]

 INPUTS:

 OPTIONAL INPUTS:
   ra         - Right ascension; scalar or array in degrees.
   dec        - Declination; scalar or array in degrees.
   infile     - Input file with RA, DEC positions, one per line.
                If set, then this over-rides values passed in RA,DEC.
   outfile    - If set, then print matches to this file.
   searchrad  - Search radius in degrees; default to 3./3600 (3 arcsec).
   topdir     - Optional override value for the environment
                variable $BOSS_SPECTRO_REDUX.
   run2d      - Override environment variable RUN2D, searching only for
                those RUN2D reductions
   run1d      - Override environment variable RUN1D, searching only for
                those RUN1D reductions
   best       - If set, then return the best match for each location, where
                best is defined to be the closest object on the plate with
                the best S/N.
                This also forces the return of one structure element in SLIST
                per position, so that you get exactly a paired list between
                RA,DEC and SLIST.
   print      - If set, then print matches to the terminal.
   sdss       - This is a shortcut option that is exactly equivalent to
                topdir=GETENV('SPECTRO_REDUX'), run2d='26'

 OUTPUTS:

 OPTIONAL OUTPUTS:
   slist      - Structure containing information for each match.

 COMMENTS:
   The search radius is set to within 1.55 degress of a plate center,
   then within 3 arcsec of an object.

   findspec.pro is currently setup to use BOSS data, but it still works
   with SDSS-I,II data with the following procedure:

   findspec, ra, dec, topdir=GETENV('SPECTRO_REDUX'), run2d='26'

   or

   findspec, ra, dec, /sdss

 EXAMPLES:
   Make a file &quot;file.in&quot; with the following two lines:
     218.7478    -0.3745007
     217.7803    -0.8900855

   Then run the command:
     IDL&gt; findspec,infile='file.in',/sdss,/print

   This should print:

PLATE   MJD FIBERID            RA            DEC    MATCHRAD
</pre>
<p><strong>(See pro/spec1d/findspec.pro)</strong></p>
<hr />
<h3 id="FIND_NMINIMA">FIND_NMINIMA</h3>
<p><a href="#FINDSPEC">[Previous Routine]</a></p>
<p><a href="#FIND_UNPLUGGED">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   find_nminima

 PURPOSE:
   Find one or several minima in a vector of chi^2 values.

 CALLING SEQUENCE:
   xpeak = find_nminima( yflux, [ xvec, dofarr=, nfind=, minsep=, $
    width=, ypeak=, xerr=, errcode=, npeak=, plottitle=, /doplot, /debug ]

 INPUTS:
   yflux          - Y values

 OPTIONAL INPUTS:
   xvec           - X values, which must either be sorted in ascending
                    or descending order; default to 0-indexed integers.
   dofarr         - If set, then fit to the minima in the function
                    YFLUX/DOFARR, but avoiding any points where DOFARR
                    is set to zero.
   nfind          - Number of minima to find; default to 1.  It is possible
                    to find fewer than NFIND minima.
   minsep         - Minimum separation between local minima.  If a peak
                    is found closer than MINSEP to an existing peak, then
                    the latter peak is discarded.
   width          - Width to use when selecting the points used in the fit.
                    Only use points where XVEC is within WIDTH of the
                    the lowest-values point (which is used as the initial
                    guess); default to using all points.

 OUTPUTS:
   ypeak          - Fit value for either chi^2 or chi^2/DOF at the minima.
                    If the fit value is less than zero, then change it to zero.

 OPTIONAL OUTPUTS:
   xerr           - Formal errors of XPEAK.
   errcode        - Error codes for each minima; 0 for no errors in the fit.
   npeak          - The number of peaks found, between [0,NFIND].
   plottitle      - Title of plot (if /DOPLOT is set).
   doplot         - If set, then make plots.  Discarded peaks are not plotted.
   debug          - If set, then wait for keystroke after plot.

 COMMENTS:
   This routine calls SVDFIT for fitting quadratics, or MPFIT for
   fitting gaussians.
   
 EXAMPLES:
   
 BUGS:

 PROCEDURES CALLED:
   djs_icolor()
   djs_oplot
   djs_plot
   mpfitpeak
   mpfitpeak_gauss
   textoidl

 INTERNAL SUPPORT ROUTINES:
   zfitmin()
  
 REVISION HISTORY:
   22-Aug-2001  Written by D. Schlegel, Princeton 
   30-Jul-2002  Fixed bug - yrange passed twice to djs_plot
</pre>
<p><strong>(See pro/spec1d/find_nminima.pro)</strong></p>
<hr />
<h3 id="FIND_UNPLUGGED">FIND_UNPLUGGED</h3>
<p><a href="#FIND_NMINIMA">[Previous Routine]</a></p>
<p><a href="#FIND_WHOPPING">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   find_unplugged

 PURPOSE:
   Find all unplugged fibers that still seemed to get a spectrum
   in the reduced data.

 CALLING SEQUENCE:
   find_unplugged, [ mjd_start ]

 INPUTS:

 OPTIONAL INPUTS:
   mjd_start   - If specified, then only search plates with MJDs beyond
                 this date.

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Identify all spectra in the reduced data that are labelled as NOPLUG
   in the plug-map file, but still have a wavelength coverage of
   log(wave) &gt; 0.15 in the reduced spectrum.  These may be fibers that
   were plugged, but missed by the fiber-mapper.

   A companion procedure to this is PLUGFILE_UNMAPPED.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   platelist
   readspec
   splog

 REVISION HISTORY:
   10-Sep-2003  Written by David Schlegel, Princeton (not checked in then)
</pre>
<p><strong>(See pro/plan/find_unplugged.pro)</strong></p>
<hr />
<h3 id="FIND_WHOPPING">FIND_WHOPPING</h3>
<p><a href="#FIND_UNPLUGGED">[Previous Routine]</a></p>
<p><a href="#FITANSIMAGE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   find_whopping

 PURPOSE:
   Use simple medians to detect whopping fibers
   Take care to not choose adjacent fibers

 CALLING SEQUENCE:
   whopping = find_whopping(flux, thresh, whopct)

 INPUTS:
   flux       - Mean/median flux per object [NFIBER]
   thresh     - Minimum threshold for median counts in whopping fiber;
                default 10000.0

 OUTPUTS:
   whopping   - 0-indexed indices of whopping fiber(s)

 OPTIONAL OUTPUTS:
   whopct     - Number of whopping fibers detected

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_median()

 REVISION HISTORY:
   24-Jan-2000  Written by S. Burles, Chicago
    4-Apr-2001  Moved to its own routine for use by SoS
</pre>
<p><strong>(See pro/spec2d/find_whopping.pro)</strong></p>
<hr />
<h3 id="FITANSIMAGE">FITANSIMAGE</h3>
<p><a href="#FIND_WHOPPING">[Previous Routine]</a></p>
<p><a href="#FITARCIMAGE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   fitansimage

 PURPOSE:
   Convert output from extract_image (ansimage) into a smooth
    function of fiber number and row

 CALLING SEQUENCE:
    fitans = fitansimage(ansimage, nterms, ntrace, npoly, nfirst, yrow, $
            tempflux, fluxm = [1,1,0], scatfit=scatfit, $
            smallflux, fluxm=fluxm, nord=nord, nscatbkpts=nscatbkpts, $
            ymin=ymin, ymax=ymax, fullrows=fullrows)

 INPUTS:
     ansimage  -  Keyword Output from extract_image
     nterms    -  number of profile terms
     ntrace    -  Number of fibers (currently hardwired to 320)
     npoly     -  Order of chebyshev polynomial in scattered light
     yrow      -  Array of rows extracted in first pass 
     smallflux -  Flux extracted in first pass

 OPTIONAL KEYWORDS:
     fluxm    -   Factor profile terms contribute to total flux
                   (asymmetric terms are set to zero)

 OUTPUTS:
    fitans    -  Smooth version of ansimage (expanded to 2048 rows)

 OPTIONAL OUTPUTS:
    scatfit   - Image of scattered light from smoothing polynomials

 COMMENTS:
	fitansimage takes the output from extract_image, and smooths
          the corresponding parameters of nfibers and npoly with
	   functions of order nord 

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   traceset2xy
   xy2traceset

 REVISION HISTORY:
   ??-Oct-1999  Written by S. Burles, Chicago
   25-Feb-2000  Modified to be more robust (yeah!)
 		   but requires exactly 320 fibers (boo) ???
</pre>
<p><strong>(See pro/spec2d/fitansimage.pro)</strong></p>
<hr />
<h3 id="FITARCIMAGE">FITARCIMAGE</h3>
<p><a href="#FITANSIMAGE">[Previous Routine]</a></p>
<p><a href="#FITDISPERSION">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   fitarcimage

 PURPOSE:
   Determine wavelength calibration from arclines

 CALLING SEQUENCE:
   fitarcimage, arc, arcivar, xcen, ycen, wset, [wfirst=, $
    color=, lampfile=, fibermask=, func=, aset=, ncoeff=, $
    thresh=, row=, nmed=, maxdev=, /gauss, wrange=, $
    lambda=, rejline=, /twophase, xdif_tset=, $
    bestcorr=, _EXTRA=KeywordsForArcfit_guess

 INPUTS:
   arc        - Extracted arc spectra with dimensions [NY,NFIBER]
   arcivar    - Inverse variance of ARC

 OPTIONAL KEYWORDS:
   color      - 'red' or 'blue'; not required if ANS is set
   lampfile   - Name of file describing arc lamp lines;
                default to the file 'lamphgcdne.dat' in $IDLSPEC2D_DIR/etc.
   fibermask  - Fiber status bits, set nonzero for bad status [NFIBER]
   func       - Name of fitting function; default to 'legendre'
   aset       - Trace set for initial wavelength solution in row number ROW.
   ncoeff     - Number of coefficients in fits.  This may be different than
                the number of coefficients in the initial guess ASET.
                Default to 5.
   thresh     - Threshhold counts for significant lines;
                default to 200 if COLOR='blue' or 500 if COLOR='red'
   row        - Row to use in initial guess of wavelength solution;
                default to NFIBER/2
   nmed       - Number of rows around ROW to median filter for initial
                wavelengths solution; default to 5
   maxdev     - max deviation in log lambda to allow (default 2d-5=13.8 km/s)
   gauss      - Use gaussian profile fitting for final centroid fit
   wrange     - Wavelength range [Ang vacuum] for searching for arc lines and
                for issuing warnings about big wavelength gaps in
                solution
   twophase   - Set this keyword for BOSS red-side 2-phase readout format
   _EXTRA     - Keywords for ARCFIT_GUESS, specifically ACOEFF,DCOEFF

 OUTPUTS:
   aset       - (Modified)
   xcen       - pixel position of lines [nfiber, nlambda]
   ycen       - fiber number [nfiber, nlambda]
   wset       - traceset (pix -&gt; lambda)

 OPTIONAL OUTPUTS:
   lampfile   - Modified from input to include full path name of file
   lambda     - Returns wavelengths of good lamp lines [Angstroms]
   rejline    - String set to non-zero for any rejected arc lines
   fibermask  - (Modified)
   xdif_tset  - Fit residual of lamp lines to fit positions [pixels]
   bestcorr   - Correlation coefficient with simulated arc spectrum
   wfirst     - traceset from first iteration on arc fits

 COMMENTS:
   Return from routine after computing BESTCORR if XCEN, YCEN and WSET
   are not to be returned.

 EXAMPLES:

 BUGS:
   Not making sure that only the same lines are fit for each fiber.
      (Different lines can be rejected in xy2traceset.)
   THRESH is unused.
   TRACESET2PIX maybe returns the transpose of what is natural?
   Check QA stuff at end.
   FIBERMASK not yet modified if an arc is atrociously bad.


 PROCEDURES CALLED:
   arcfit_guess()
   djs_median
   djsig()
   fibermask_bits()
   trace_crude()
   trace_fweight()
   traceset2pix()
   traceset2xy()
   xy2traceset

 DATA FILES:
   $IDLSPEC2D_DIR/etc/lamphgcdne.dat

 REVISION HISTORY:
   15-Oct-1999  Written by S. Burles, D. Finkbeiner, &amp; D. Schlegel, APO.
   09-Nov-1999  Major modifications by D. Schlegel, Ringberg.
   20-Jan-2000  Gone back to very simple procedure: replacement (S. Burles)
   25-Jan-2011  Added &quot;twophase&quot; keyword, A. Bolton, U. of Utah
</pre>
<p><strong>(See pro/spec2d/fitarcimage.pro)</strong></p>
<hr />
<h3 id="FITDISPERSION">FITDISPERSION</h3>
<p><a href="#FITARCIMAGE">[Previous Routine]</a></p>
<p><a href="#FITMEANX">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   fitdispersion

 PURPOSE:
   Fit polynomials to the line width (dispersion axis) for each fiber bundle

 CALLING SEQUENCE:
   dispset = fitdispersion(arc_flux, arc_fluxivar, xcen, $
    [ ncoeff=, sigma=, xmin=, xmax=, medwidth=, numbundles= ] )

 INPUTS:
   arc_flux     - arc image extracted flux
   arc_fluxivar - corresponding inverse variance
   xcen         - xpeaks of arc lines [ntrace,nlines]

 OPTIONAL KEYWORDS:
   ncoeff     - Order of legendre polynomial to apply to width vs. row;
                default to 4.
   sigma      - The SIGMA input to EXTRACT_IMAGE when determining ANSIMAGE;
                default to 1.0 pix.  This can be a scalar, an [NFIBER] vector,
                or an [NLINE,NFIBER] array.
   xmin       - Lowest row number for trace set; default to 0.
   xmax       - Highest row number for trace set; default to 2047.
   numbundles - The number of fiber bundles
   quick      - Flag used during quick reduction on the mountain in
                apo routines using only middle region of ccd

 OUTPUTS:
   dispset   - Traceset structure containing fit coefficients

 OPTIONAL OUTPUTS:
   medwidth  - Median dispersion widths in each of the 4 quadrants
               of the CCD, ordered LL,LR,UL,UR.

 COMMENTS:
   Used to fill arcstruct.dispset, which can then be applied
   to PSF-corrected sky subtraction.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   splog
   xy2traceset

 REVISION HISTORY:
   01-Mar-2000  Written by S. Burles, FNAL
</pre>
<p><strong>(See pro/spec2d/fitdispersion.pro)</strong></p>
<hr />
<h3 id="FITMEANX">FITMEANX</h3>
<p><a href="#FITDISPERSION">[Previous Routine]</a></p>
<p><a href="#FITREDSHIFT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   fitmeanx

 PURPOSE:
   Return the position where the wavelength should fall (MX) plus
   a fitted-function to the deviations from those positions.

 CALLING SEQUENCE:
   xdiff = fitmeanx(wset, lambda, xpos, aveinvvar, $
    nord=, maxdev=, minsdev=, inmask=, mx=)

 INPUTS:
   wset     - Initial wavelength solution for all fibers
   lambda   - Air wavelengths corresponding to XPOS (in log-10 Angstroms)
              [NLINE]
   xpos     - Centroid positoins of sky lines in object image [NFIBER,NLINE]

 OPTIONAL KEYWORDS:
   nord     - Order of fit to delta x positions; default to 4
   maxdev   - Max abs difference (in pix) to reject outlying sky line
              positions; default to 0.4
   minsdev  - Minimum standard deviation for computing AVEINVVAR;
              default to 0.01 pix.
   inmask   - Input mask, set to 1 for good points, 0 for bad points
              [NFIBER,NLINE]

 OUTPUTS:
   xdiff    - Smooth fit to difference between measured sky positions
              and those predicted from arc wavelength solution [NFIBER,NLINE]

 OPTIONAL OUTPUTS:
   aveinvvar- Weights in xpos, set to zero for rejected positions [NLINE]
   mx       - Sky line positions predicted from arc line solution
              [NFIBER,NLINE]

 COMMENTS:

 EXAMPLES:

 PROCEDURES CALLED:
   djs_iterstat

 REVISION HISTORY:
   19-Oct-1999  Written by S. Burles, Chicago
</pre>
<p><strong>(See pro/spec2d/fitmeanx.pro)</strong></p>
<hr />
<h3 id="FITREDSHIFT">FITREDSHIFT</h3>
<p><a href="#FITMEANX">[Previous Routine]</a></p>
<p><a href="#FITSN">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   fitredshift

 PURPOSE:
   Find the most significant correlation peak (soon to be peaks)
     return optional keywords in units of pixels

 CALLING SEQUENCE:
    fitredshift, fluxfft, starfft, $
     [ nsearch=, zfit=, z_err=, veldispfit=, veldisp_err=, /doplot ]

 INPUTS:
   fluxfft    - complex fft of prepared galaxy spectrum
   fluxerr    - error vector for flux (only test if it is zero)
   starfft    - complex fft of stellar template
   starerr    - error vector for flux (only test if it is zero)

 OPTIONAL KEYWORDS:
   nsearch    - number of peaks to search, almost always only 1 is searched
   zmin       - Minimum z (in pixels) to allow (should be &lt; 0)
   doplot     - plot the correlation peak and fits in an xwindow

 OPTIONAL OUTPUTS:
   zfit       - best fit z, this should evolve into an array of z's
                  with accompanying z_errs and z_confidences
   z_err      - centroid errors from gaussfit of correlation peak
   veldisp    - sigma of cross-correlation peak
   veldisp_err- error on sigma

 COMMENTS:

   Use doplot keyword to see how well peak is being fit
   Still need to work on exact selection criteria for MOST significant peak
     or even better: measure all peaks with probability &gt; 1%     

 EXAMPLES:

 BUGS:

 Hardwired exclusion of blueshifts greater than 100 pixels
        this helps the noisiest cases

 PROCEDURES CALLED:
   findmaxarea
   curvefit
   gauss_funct

 REVISION HISTORY:
   25-Mar-2000  Written by S. Burles, FNAL
   26-Jun-2000  D. Finkbeiner - modified to properly weight corr
                                vector for variable overlap
   26-Jun-2000 (v 1.5) altered algorithm to set peak search boundary
       at the half height of the peak, rather than zero.  This fixes
       cases where there is a close double peak. 
</pre>
<p><strong>(See pro/spec1d/fitredshift.pro)</strong></p>
<hr />
<h3 id="FITSN">FITSN</h3>
<p><a href="#FITREDSHIFT">[Previous Routine]</a></p>
<p><a href="#FITVACSET">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   fitsn

 PURPOSE:
   Perform a simple parameter fit to log S/N vs magnitude

 CALLING SEQUENCE:
   coeffs = fitsn(mag, snvec, [ sigrej=, maxiter=, redden=, sncode=, $
    filter=, sigma=, specsnlimit=, sn2=, dered_sn2= ] )

 INPUTS:
   mag        - Fiber magnitudes
   snvec      - S/N vector for fibers
   sncode     - Pipeline code for determining fit range
   filter     - Filter band for determining fit range; only works for
                ugriz filters

 OPTIONAL KEYWORDS:
   sigrej     - Sigma rejection threshold; default to 3
                (only used in computing SIGMA)
   maxiter    - Maximum number of rejection iterations; default to 5
                (no longer used with median-fit line)
   redden     - 5-element array with median extinction in all bands
                for use in computing DERED_SN2

 OUTPUTS:
   coeffs     - Coefficients from fit; return 0 if fit failed;
                log10(S/N) = coeffs[0] - coeffs[1] * mag

 OPTIONAL OUTPUTS:
   sigma      - Standard deviation of residuals
   specsnlimit- Structure with FITMAG,SNMAG,FIDUCIAL_COEFF
   sn2        - Fit value of (S/N)^2 at fiducial magnitude
   dered_sn2  - Extinction corrected (S/N)^2 at fiducial magnitude
                (requires REDDEN as input)

 COMMENTS:
   If there are fewer than 3 points, then return COEFFS=0.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_iterstat

 REVISION HISTORY:
   15-Apr-2000  Written by S. Burles, FNAL
</pre>
<p><strong>(See pro/spec2d/fitsn.pro)</strong></p>
<hr />
<h3 id="FITVACSET">FITVACSET</h3>
<p><a href="#FITSN">[Previous Routine]</a></p>
<p><a href="#FLATFIELD">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   fitvacset

 PURPOSE:
   Re-fit the wavelength solution in vacuum wavelengths, and applying shifts
   to the pixel positions and heliocentric corrections to wavelengths.

 CALLING SEQUENCE:
   vacset = fitvacset(xpeak, lambda, wset, arcshift, helio=helio)

 INPUTS:
   xpeak       - Arc line centroids 
   lambda      - Corresponding wavelengths
   wset        - Initial arc line wavelenthh solution; this is only used
                 to determine the order of the fit (NCOEFF), and the range
                 of the fit in pixel space (XMIN,XMAX).  The vectors XPEAK,
                 LAMBDA are used to re-fit the wavelength solution itself.
   arcshift    - Shifts to apply to arc lines in pix [NROW,NTRACE]

 OPTIONAL KEYWORDS:
   helio       - Heliocentric correction to add to velocities in km/s.

 OUTPUTS:
   vacset      - output wavelength solution which includes shift to
                 sky lines and conversion to vacuum wavelengths

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 PROCEDURES CALLED:
   airtovac
   splog
   xy2traceset

 REVISION HISTORY:
   20-Jan-2000  Written by S. Burles, Chicago
   27-Jul-2011  Added CCD discontinuity handling: A. Bolton, Utah
</pre>
<p><strong>(See pro/spec2d/fitvacset.pro)</strong></p>
<hr />
<h3 id="FLATFIELD">FLATFIELD</h3>
<p><a href="#FITVACSET">[Previous Routine]</a></p>
<p><a href="#FLUX2MAGGIE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
    flatfield

 PURPOSE:
    This takes an LED flatfield and compares pixel by pixel the value
    of that pixel compared to the median in a subregion about it

 CALLING SEQUENCE:
 
flatfield, filename,filenamebias,docams=
 INPUTS:

 docams      - camera to look at  ; default to ['b1','b2','r1','r2']
 filename     - name of flat
 filenamebis  - name of bias
 OPTIONAL KEYWORDS
  
 OUTPUTS:
 
 

      'bpm-sigma.fit'

      'bpm-count.fit'


 OPTIONAL OUTPUTS:

 COMMENTS:
   
  This will take an LED flat and a bias to make a flatfield



 EXAMPLES:
   Create a flatfield using LED flats from 55141/55142


    (assuming the files exist in /data/spectro/:)
     IDL&gt; flatfield,

 

 PROCEDURES CALLED:
   sxpar()


 REVISION HISTORY:

   22-Jan-2010  M. Olmstead, Utah
</pre>
<p><strong>(See pro/specflat/flatfield.pro)</strong></p>
<hr />
<h3 id="FLUX2MAGGIE">FLUX2MAGGIE</h3>
<p><a href="#FLATFIELD">[Previous Routine]</a></p>
<p><a href="#FLUXCORR_NEW">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   flux2maggie

 PURPOSE:
   Integrate a spectrum under filter curves to get maggies or magnitudes

 CALLING SEQUENCE:
   spectroflux = flux2maggie( objflux, waveimg=, _EXTRA=EXTRA, mag=mag )

 INPUTS:
   objflux    - Flux image in units of 10^-17 erg/s/cm^2/Ang [NPIX,NOBJ]
   waveimg    - Wavelength image in Angstroms [NPIX,NOBJ], or this could
                be a single vector if the wavelength mapping is the same
                for all traces (note the latter is faster to compute)

 OPTIONAL INPUTS:

 OPTIONAL KEYWORDS:
   EXTRA      - Keywords for FILTER_THRU()

 OUTPUTS:
   spectroflux- Integrated response in all 5 SDSS filters, ordered ugriz;
                dimensions are [NOBJ,5] or [5] if NOBJ=1

 OPTIONAL OUTPUTS:
   mag        - Magnitudes in all 5 SDSS filters, ordered ugriz;
                dimensions are [NOBJ,5] or [5] if NOBJ=1

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   filter_thru()

 REVISION HISTORY:
   08-Apr-2009  Written by D. Schlegel, LBNL
</pre>
<p><strong>(See pro/spec2d/flux2maggie.pro)</strong></p>
<hr />
<h3 id="FLUXCORR_NEW">FLUXCORR_NEW</h3>
<p><a href="#FLUX2MAGGIE">[Previous Routine]</a></p>
<p><a href="#FLUX_DISTORTION">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   fluxcorr_new

 PURPOSE:
   Compute the frame-by-frame relative scaling for each object on a plate.

 CALLING SEQUENCE:
   fluxcorr_new, bsmearfile, rsmearfile, bscifile, rscifile, corrfile

 INPUTS:
   bsmearfile - spFrame fits file chosen as blue smear image
   rsmearfile - spFrame fits file chosen as red smear image
   bscifile   - spFrame fits file(s) blue science image
   rscifile   - spFrame fits file(s) red science image
   corrfile   - Fits file to output flux correction vectors.

 OPTIONAL KEYWORDS:

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

   fluxcorr_new is used to calculate and write to file a low order
    polynomial function which registers the flux in the science exposures
    to the median flux levels in the smear exposures.

   Based on S/N, the produced function per fiber can be given by one
    of three methods.  For the highest S/N fibers, typically 10\% of the
    fibers including spectrophoto stds, the full 3rd order fit is done.
   For medium S/N fibers, only a one parameter scaling of the best 
     spectrophoto correction is produced.
   For the lowest S/N fibers, the spectrophoto correction is used without
     any scaling.  Beware, this means a stellar spectrophoto correction 
     is applied to all low S/N fibers, even if they are not
     seeing-limited targets.

 EXAMPLES:

 BUGS:
  Blue wavelength region is hardwired: b1 = findgen(60)*4.0e-3 + 3.568
  Red wavelength region is hardwired : r1 = findgen(54)*4.0e-3 + 3.756
  Order of polynomial is hardwired:  3

 PROCEDURES CALLED:
   djs_iterstat
   mrdfits()
   mwrfits
   pixelmask_bits()
   traceset2xy
   xy2traceset

 INTERNAL SUPPORT ROUTINES:
   median_rebin():  Used to rebin spectra in large wavelength blocks
                    passed in parameter range 

 REVISION HISTORY:
   17-Oct-2000  Written by S. Burles
     
</pre>
<p><strong>(See pro/spec2d/fluxcorr_new.pro)</strong></p>
<hr />
<h3 id="FLUX_DISTORTION">FLUX_DISTORTION</h3>
<p><a href="#FLUXCORR_NEW">[Previous Routine]</a></p>
<p><a href="#FOCUSHISTORY">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   flux_distortion

 PURPOSE:
   Compute the flux-distortion image for an entire plate.

 CALLING SEQUENCE:
   corrimg = flux_distortion(objflux, objivar, andmask, ormask, plugmap=, $
    loglam=, [ minflux=, minobj=, maxdelta=, platefile=, plotfile=, hdr=, $
    coeff= ] )

 INPUTS:
   objflux    - Fluxes [NPIX,NFIBER]
   objivar    - Inverse variances [NPIX,NFIBER]
   andmask    - AND pixel mask [NPIX,NFIBER]
   ormask     - OR pixel mask [NPIX,NFIBER]
   plugmap    - Plug-map structure [NFIBER], where CALIBFLUX,CALIBFLUX_IVAR
                will be used in preference over MAG for the photometric fluxes
   loglam     - Wavelength vector in log10(Ang), which must be the same
                for all objects [NPIX]

 OPTIONAL INPUTS:
   minflux    - Minimum flux levels in ugriz-bands for objects to be used
                in the fit; set to zero to ignore a band; default to
                [0,0,2.5,0,0] to limit to r&lt;21.5 objects
                default to 5 nMgy in all three (gri) bands, corresponding
                to 20.7-th mag.
   minobj     - Minimum number of objects that have good fluxes in all
                three gri-bands for computing the corrections; default to 50;
                if fewer than this many, then CORRIMG is returned with all 1's
   maxdelta   - Maximum peak deviation in flux distortion image allowed
                per iteration from a change in any one parameter; default
                to 0.03
   platefile  - If set, then read OBJFLUX and all the other inputs from
                this spPlate file instead of using those inputs;
                also, generate PostScript plots using the PLATESN procedure.
   plotfile   - If set, then make a contour plot of the distortion
                corrections to this PostScript file
   hdr        - If set, then get the PLATE and MJD from this FITS
                header

 OUTPUTS:
   corrimg    - Flux-distortion image by which OBJFLUX should be multiplied
                [NPIX,NFIBER]

 OPTIONAL OUTPUTS:
   coeff      - Best-fit coefficients for the distortion terms

 COMMENTS:
   The the correction vectors are parameterized in terms of magnitude
   (i.e. log-flux) that are achromatic with x, y, x^2, y^2, x*y,
   where those are linear coordinates XFOCAL,YFOCAL from the plug-map.
   There are also chromatic terms that scale as 1-(5070/wavelength)^2,
   since that function gives an equal effect between 3900 and 5070 Ang
   as between 5070 ang 9000 Ang.
   There are also magnitude offsets as a function of spectrograph ID,
   and a chromatic offset as a function of spectrograph ID.

   In detail, the formulae is as follows (with 14 terms):
     NEWFLUX = FLUX * [1 + a0*(SPECID EQ 1) + a1*(SPECID EQ 2)]
               * exp{ a2*x + a3*y + a4*x*y + a5*x^2 + a6*y^2
                + a7*x*LL + a8*y*LL 
                + a9*LL*(SPECID EQ 1) + a10*LL*(SPECID EQ 2) }
                + a11*LL^2*(SPECID EQ 1) + a12*LL^2*(SPECID EQ 2) }
   where x=XFOCAL, y=YFOCAL, LL = 1 - (5100 Ang/wavelength)^2

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   airtovac
   dfpsclose
   dfpsplot
   djs_maskinterp()
   djs_oplot
   djs_plot
   djs_reject()
   flux_distort_corrvec()
   flux_distort_fn()
   linterp
   mpfit
   platesn
   readcol
   splog

 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   17-Feb-2004  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/flux_distortion.pro)</strong></p>
<hr />
<h3 id="FOCUSHISTORY">FOCUSHISTORY</h3>
<p><a href="#FLUX_DISTORTION">[Previous Routine]</a></p>
<p><a href="#FOURIER_DIFFERENCE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   focushistory

 PURPOSE:
   Plot the history of wavelength focus based upon the reduced spPlate files.

 CALLING SEQUENCE:
   focushistory, [ mjdrange= ]

 INPUTS:

 OPTIONAL INPUTS:
   mjdrange   - 2-element vector of plotting range in MJD; default to
                using all MJDs.

 OUTPUT:

 COMMENTS:
   A single PostScript file is created &quot;Focushistory-$MJDSTART-$MJDEND.ps&quot;.
   The plate list must exist for the PLATELIST procedure, and the spPlate
   files should be in $BOSS_SPECTRO_REDUX.

 EXAMPLES:
   Make plots of history of wavelength focus for all time:
     IDL&gt; focushistory

   Make plots of history of wavelength focus between MJD 52000 and MJD 52100:
     IDL&gt; focusistory, mjdrange=[5200,52100]

 BUGS:

 PROCEDURES CALLED:
   dfpsclose
   dfpsplot
   djs_icolor()
   fileandpath()
   mjd2datelist
   platelist
   readspec
   splog
   yanny_free
   yanny_par()
   yanny_read

 REVISION HISTORY:
   21-Mar-2002  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/apo2d/focushistory.pro)</strong></p>
<hr />
<h3 id="FOURIER_DIFFERENCE">FOURIER_DIFFERENCE</h3>
<p><a href="#FOCUSHISTORY">[Previous Routine]</a></p>
<p><a href="#FOURIER_QUOTIENT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   fourier_difference

 PURPOSE:
   Perform a chi2 fit to the fourier difference between a single
   galaxy and a broadened stellar template to calculate velocity dispersion
   and uncertainty on velocity dispersion

 CALLING SEQUENCE:
   answers = fourier_difference(galfft, starfft, galvar0, starvar0, $
          testsigma=, lowlimit=, highlimit=, $
          deltachisq=deltachisq, /doplot)

 INPUTS:
   galfft     - Fourier transform of galaxy
   starfft    - Fourier transform of stellar template
   galvar0    - error in galaxy fft (0th element of galaxy error FFT)
   starvar0   - error in stellar fft (0th element of stellar error FFT)

 OPTIONAL KEYWORDS:
   testsigma  - Array of sigma values to calculate chi2
   lowlimit   - lower boundary of chi2 sum (in knums units)
   highlimit  - upper boundary of chi2 sum (in knums units)
   deltachisq - chi2 difference from minimum to set error on velocity dispersion
   doplot     - Output plots to xwindow

 OUTPUTS:
   answers    - Four element array with:
                [minchi2, minsigma, errsigma, bestalpha]
                bestalpha is the normalization constant between galaxy and star

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:
   Currently, this is very slow, as we have to check 11 normalizations
   for each element in testsigma array

   Need to ensure that confidence level returned as errsigma is proper

 PROCEDURES CALLED:

 REVISION HISTORY:
   25-Mar-2000  Written by S. Burles, FNAL
</pre>
<p><strong>(See pro/spec1d/fourier_difference.pro)</strong></p>
<hr />
<h3 id="FOURIER_QUOTIENT">FOURIER_QUOTIENT</h3>
<p><a href="#FOURIER_DIFFERENCE">[Previous Routine]</a></p>
<p><a href="#FRAME_FLUX_CALIB">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   fourier_quotient

 PURPOSE:
   Perform a chi2 fit to the fourier quotient of a single
    galaxy and a broadened stellar template to calculate velocity dispersion
    and uncertainty on velocity dispersion

 CALLING SEQUENCE:
   answers = fourier_quotient(galfft, starfft, galvar0, starvar0, $
    testsigma=, lowlimit=, highlimit=, $
    deltachisq=, /doplot)

 INPUTS:
   galfft     - Fourier transform of galaxy
   starfft    - Fourier transform of stellar template
   galvar0    - error in galaxy fft (0th element of galaxy error FFT)
   starvar0   - error in stellar fft (0th element of stellar error FFT)

 OPTIONAL KEYWORDS:
   testsigma  - Array of sigma values to calculate chi2
   lowlimit   - lower boundary of chi2 sum (in knums units)
   highlimit  - upper boundary of chi2 sum (in knums units)
   deltachisq - chi2 difference from minimum to set error on velocity dispersion
   doplot     - Output plots to xwindow

 OUTPUTS:
   answers    - Four element array with:
                [minchi2, minsigma, errsigma, bestalpha]
                bestalpha is the normalization constant between galaxy and star

 OPTIONAL OUTPUTS:

 COMMENTS:

	Same inputs and outputs as fourier_difference

 EXAMPLES:

 BUGS:

	Need to ensure that confidence level returned as errsigma is proper

 PROCEDURES CALLED:
   

 REVISION HISTORY:
   25-Mar-2000  Written by S. Burles, FNAL
   27-Jun-2000  Completely rewritten - Finkbeiner &amp; SWAT team
</pre>
<p><strong>(See pro/spec1d/fourier_quotient.pro)</strong></p>
<hr />
<h3 id="FRAME_FLUX_CALIB">FRAME_FLUX_CALIB</h3>
<p><a href="#FOURIER_QUOTIENT">[Previous Routine]</a></p>
<p><a href="#FRAME_FLUX_TWEAK">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   frame_flux_calib

 PURPOSE:
   To derive the flux calibration appropriate to one frame.  This routine
   takes as input a set of &quot;flux correction vectors&quot; which are formed by 
   ratioing each standard with it's best fit model and smoothing the result.
   The average correction vector, created from a PCA of all the frames (of
   one of the CCDs b1/r1/b2/r2) is first divided out.  This gets rid of the
   low order shape.  The residuals are then fit with a 4th order legendere.
   The average low order residual is found by medianing the Legendere 
   coefficients.  High order terms are fit by first dividing out the low order
   terms and then medianing the result.  These are included in the final fit
   if &quot;fit_wiggles&quot; is set.  The flux calibration vecotor for the frame is
   constructed by multiplying the average for all frames, the lower order 
   residual fit to this frame, and the high order residual fit (if desired).  
   This vector is then fit with a bspline and the coefficients are returned.

 CALLING SEQUENCE:
   calibset = frame_flux_calib(loglam, corvector, corvivar, avgcorvset, $
     cormed, framename, fit_wiggles=, fsig=, fcor=, final=, noplot=)

 INPUTS:
   loglam     - wavelength array (log10(Angstroms)) [npix]
   corvector  - array of &quot;flux correction vectors&quot; -- these are
                formed by ratioing each standard with it's best fit model
                and smoothing the result [npix, nstar]
   corvivar   - inverse variance of correction vectors -- used in rejecting
                points from low order fit [npix, nstar]
   avgcorvset - a set of bspline coefficients which describes the average
                flux correction of all frames. Not needed if &quot;final&quot; is set 
   cormed     - The median value of each raw correction vector.  Before being
                fed into this code they are all normalized at 5700 -- 6300 A 
                (see spdata2model) [nstar]

 OUTPUT:
   A structure holding the coefficients of a bspline fit to the average
   flux correction vector for the frame is returned.  Unless &quot;noplot&quot; is set,
   diagnostic plots are created.  If &quot;outfile&quot; is set the structure is stored
   as a FITS binary file.

 KEYWORDS:
   framename   - Name of frame (to be used in plot titles)
   outfile     - Name of output FITS binary file -- if not set no file is 
                 written
   fit_wiggles - if set a fit is done to the high order (as well as low
                 order) residuals.  This should only be set when the S/N
                 is good.  Note that the high order fit is plotted even if 
                 it is not used.
   fsig        - the variance between each of the flux correction vectors
                 and the average -- this is a good measure of the spectro-
                 photometric quality
   fcor        - average flux correction for the frame (not the spline fit)
   final       - if set, the average flux correction from a PCA of all the
                 frames is not used -- this is useful for a final evaluation
                 of the spectrophotometric quality of the combined exposures
   noplot      - toggles plotting

 COMMENTS:

 BUGS:
   Not sure if it is mathematically OK to median the Legendre coeffs! (But
   it seems to work well ...)

 EXAMPLES:

 PROCEDURES CALLED:
   bspline_bkpts
   bspline_iterfit
   bspline_valu
   divideflat
   djs_icolor()
   djs_iterstat()
   djs_median()
   djs_oplot
   djs_plot
   mwrfits
   splot
   sxaddpar
   traceset2xy
   xytraceset

 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   12-Aug-2003 Created by C. Tremonti Steward Observatory
</pre>
<p><strong>(See pro/fluxfix/frame_flux_calib.pro)</strong></p>
<hr />
<h3 id="FRAME_FLUX_TWEAK">FRAME_FLUX_TWEAK</h3>
<p><a href="#FRAME_FLUX_CALIB">[Previous Routine]</a></p>
<p><a href="#FSTARS_PLOT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   frame_flux_tweak

 PURPOSE:
   To genreate low order correctons to each red-blue exposure pair which 
   match the flux (on a fiber-by-fiber basis) to that in a fiducial exposure
   selected to have the best S/N and spectrophotometry. This is necessary 
   so that multiple exposures can be combined with effective cosmic ray 
   rejection.  The flux vectors of each exposure should be multiplied by the 
   resultant 4th order legnedre polynomial.

 CALLING SEQUENCE:
   frame_flux_tweak, bloglam, rloglam, bflux, rflux, bivar, rivar, $
     best_exp, plugtag, corrfile, diag=, title=

 INPUTS:
   bloglam  - blue wavelength array in (log10 Ang.) [nblue_pix, nfiber*nexp]
   rloglam  - red wavelength array in (log10 Ang.) [nred_pix, nfiber*nexp] 
   bflux    - blue flux array (uncalibrated) [nblue_pix, nfiber*nexp]
   rflux    - red flux array (uncalibrated) [nred_pix, nfiber*nexp]
   bivar    - blue inverse variance [nblue_pix, nfiber*nexp]
   rivar    - red inverse variance [nred_pix, nfiber*nexp]
   best_exp - string containing the exposure ID of the &quot;best&quot; exposure --
              this is used as the fiducial exposure against which the 
              others are ratioed
   plugtag  - plugmap-like structure which also contains the exposure ID of 
              each spectrum [nfiber*nexp]
   corrfile - names of output FITS files (1/exposure) [nexp]. The traditional
              names are spFluxcorr-eeeeeeee-s.fits where &quot;eeeeeeee&quot; is the 
              exposure ID and &quot;s&quot; is the spectrograph ID (1/2)

 OPTIONAL KEYWORDS:
   diag  - if set show plots of individual fibers at the 3 S/N levels

 OUTPUTS:  
   FITS files named in &quot;corrfile&quot; are generated containing the 4th order
   legendere coefficients of the ratio of the best exposure and each of 
   the others (on a fiber-to-fiber basis).  Plots are also generated.

 OPTIONAL OUTPUTS:

 COMMENTS:
   Objects with high S/N are fit with a 4th order legendre
   Objects with medium S/N are fit with a 3rd order legendre
   Objects with Low S/N are assigned the median correction of the five nearest
       fibers.  The zeropoint is then fit.
   Bad fits -- those wildly deviant from the others -- are replaced with a 
       zeropoint shift.

 EXAMPLES:

 BUGS:
  The median corrections assigned to low S/N fibers are probably imperfect
  because of the mix of point and extended sources on the plate.  Also
  the shape of the correction may not be well fit by a low order polynomial
  -- particularly if there is a mis-match in the dichroic region.
 
  Mask bits not currently returned!! (no record of hi/med/low S/N correction)
  
 PROCEDURES CALLED:
   djs_iterstat
   djs_oplot
   djs_plot
   legend
   mwrfits
   pixelmask_bits()
   splog
   spmedian_rebin()
   traceset2xy
   xy2traceset

 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   17-Oct-2000  Formerly fluxcorr_new -- written by S. Burles
   09-Oct-2002  Revised by C. Tremonti to calibrate point sources to the 
                smear and galaxies to the calib images.
   12-Aug-2003  Changed by C. Tremonti to work on pairs of science images.
                Split off &quot;spmedian_rebin&quot; &amp; altered handling of medium and 
                low S/N cases
</pre>
<p><strong>(See pro/fluxfix/frame_flux_tweak.pro)</strong></p>
<hr />
<h3 id="FSTARS_PLOT">FSTARS_PLOT</h3>
<p><a href="#FRAME_FLUX_TWEAK">[Previous Routine]</a></p>
<p><a href="#FUNDAMENTAL_LINE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   fstars_plot

 PURPOSE:
   Make color-color plots of spectro-photometric stars as compared
   to the stellar locus and BD+17.

 CALLING SEQUENCE:
   fstars_plot, [ /deredden ]

 INPUTS:

 OPTIONAL INPUTS:
   deredden  - If set, the de-redden the spectroscopic F stars,
               and the stellar locus stars from run 94.  Do not
               de-redden the colors of BD+17.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   For finding colors of stars on the stellar locus, this routine
   reads tsObj files for run 94 rerun 7, which must be on disk.

 EXAMPLES:

 BUGS:

 DATA FILES:
   $BOSS_SPECTRO_REDUX/spAll.fits
   $PHOTO_DATA/94/7/calibChunks/$CAMCOL/tsObj-000094-$CAMCOL-7-$FIELD.fit

 PROCEDURES CALLED:
   dfpsclose
   dfpsplot
   djs_filepath()
   djs_oplot
   djs_plot
   djs_xyouts
   mrdfits()
   objc_select()
   rdss_obj()

 REVISION HISTORY:
   12-Sep-2002  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/plan/fstars_plot.pro)</strong></p>
<hr />
<h3 id="FUNDAMENTAL_LINE">FUNDAMENTAL_LINE</h3>
<p><a href="#FSTARS_PLOT">[Previous Routine]</a></p>
<p><a href="#GAUSSPIX">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   fundamental_line
 PURPOSE:
   Crush the fundamental plane to a measly line.
 CALLING SEQUENCE:
 INPUTS:
 OPTIONAL INPUTS:
 KEYWORDS
 OUTPUTS:
 COMMENTS:
 BUGS:
   Using RA and Dec for matches rather than OBJID because tsObj files
     sometimes busted; search code for &quot;HACK&quot;.
 EXAMPLES:
 PROCEDURES CALLED:
 REVISION HISTORY:
   25-Jun-2000  Written by Hogg (IAS)
</pre>
<p><strong>(See pro/spec1d/fundamental_line.pro)</strong></p>
<hr />
<h3 id="GAUSSPIX">GAUSSPIX</h3>
<p><a href="#FUNDAMENTAL_LINE">[Previous Routine]</a></p>
<p><a href="#GENFLATMASK">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>

 NAME: gausspix

 PURPOSE: pixel-integrated 1D Gaussian.

 USAGE:
  profile = gausspix(x, par [, /skew, /kurt])

 ARGUMENTS:
  x: pixel-centered pixel coordinate over which to evaluate
  par: parameter vector:
   par[0] = centroid, in pixels, same frame as x
   par[1] = sigma value of non-integrated profile,
            in pixels
  *note*: passing &quot;par&quot; of length greater than 2 will
          generate a basis array, using each successive
          pair of par entries to specify each basis row.
   skew: set this keyword to return not the pixel-integrated
         Gaussian, but rather a pixel-integrated skewing term:
         Gaussian times (u^3 - 3*u), where u = (x - xcen) / sigma.
   kurt: set this keyword to return not the pixel-integrated
         Gaussian, but rather a pixel-integrated kurtosis term:
         Gaussian times (u^4-6*u^2+3), where u = (x - xcen) / sigma.

 COMMENTS:
   Amplitude is always (integrated) unity.  If you want to dial
   in fixed amplitudes, wrap this function in something else.

   Skewness and kurtosis bases are pixel-integrated Hermite
   functions, and have no net flux associated with them.

 WRITTEN:
   Adam S. Bolton, U. of Utah, 2010 May

</pre>
<p><strong>(See pro/spec2d/gausspix.pro)</strong></p>
<hr />
<h3 id="GENFLATMASK">GENFLATMASK</h3>
<p><a href="#GAUSSPIX">[Previous Routine]</a></p>
<p><a href="#GET_MJD_DIR">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   genflatmask

 PURPOSE:
   Read or generate a mask for pixels to ignore when generating flat-fields.

 CALLING SEQUENCE:
   maskimg = genflatmask( [ flatname, spectrographid=, color=, indir=, ] )

 OPTIONAL INPUTS:
   flatname   - Name of flat-field image
                Note that many flats from many nights can be combined.

 OPTIONAL KEYWORDS:
   spectrographid - Spectrograph ID (1 or 2); reqired if FLATNAME not set.
   color      - Spectrograph color ('red' or 'blue');
                reqired if FLATNAME not set.
   indir      - Input directory for FLATNAME; default to '.'

 OUTPUTS:
   maskimg    - Mask image with 0=good, 1=bad

 COMMENTS:
   If FLATNAME is specified, then a bad pixel mask is generated from
   that flat-field image assuming it has a mean value approximately equal
   to one.  If not, then read the mask from the distribution of IDLSPEC2D
   in the &quot;etc&quot; subdirectory.

   Mask values =0 for good pixels, =1 for bad.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   mrdfits()
   readfits()

 DATA FILES:
   $IDLSPEC2D_DIR/etc/flatmask-b1.fits.gz
   $IDLSPEC2D_DIR/etc/flatmask-b2.fits.gz
   $IDLSPEC2D_DIR/etc/flatmask-r1.fits.gz
   $IDLSPEC2D_DIR/etc/flatmask-r2.fits.gz

 REVISION HISTORY:
   16-Dec-1999  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/genflatmask.pro)</strong></p>
<hr />
<h3 id="GET_MJD_DIR">GET_MJD_DIR</h3>
<p><a href="#GENFLATMASK">[Previous Routine]</a></p>
<p><a href="#GUIDERMONFILE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   get_mjd_dir

 PURPOSE:
   Get directory list of matching MJD directories.

 CALLING SEQUENCE:
   mjdlist = get_mjd_dir( [topdir, mjd=, mjstart=, mjend= ])

 INPUTS:

 OPTIONAL INPUTS:
   topdir     - Search for MJD directories under this top level directory.
   mjd        - Look for raw data files in TOPINDIR/MJD; default to all
                subdirectories.  Note that this need not be integer-valued,
                but could be for example '51441_test'.  Wildcards are allowed,
                e.g. '514*'.  Leading zeros are significant, so that '1*'
                will not match the directory '0123'.
   mjstart    - Starting MJD.
   mjend      - Ending MJD.

 OUTPUT:
   mjdlist    - List of matching directories (string array).

 COMMENTS:
   Do not include in the output list any empty directories.

 EXAMPLES:
   If the path '/data/rawdata' contains the subdirectories '0123', '0124',
   '0200', 'test0123' and the file '0125', then:
   IDL&gt; print, get_mjd_dir('/data/rawdata')
        0123 0124 0200 test
   IDL&gt; print, get_mjd_dir('/data/rawdata', mjstart=124)
        0124 0200
   IDL&gt; print, get_mjd_dir('/data/rawdata', mjd='012*')
        0123 0124

 BUGS:

 PROCEDURES CALLED:
   fileandpath()

 REVISION HISTORY:
   30-May-2000  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/spec2d/get_mjd_dir.pro)</strong></p>
<hr />
<h3 id="GUIDERMONFILE">GUIDERMONFILE</h3>
<p><a href="#GET_MJD_DIR">[Previous Routine]</a></p>
<p><a href="#GUIDERMOVIE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   guidermonfile

 PURPOSE:
   Create guiderMon file using proc-gimg files.

 CALLING SEQUENCE:
   guidermonfile, [ mjd=, mjstart=, mjend=, /clobber ]

 INPUTS:
   mjd        - MJD(s)
   mjstart    - Starting MJD
   mjend      - Ending MJD

 OPTIONAL INPUTS:
   clobber    - If set, then over-write existing file, otherwise do not.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The GUIDE_DIR, SPECLOG_DIR environment variables must be set.
   Data is input from
     $GUIDE_DIR/$MJD/proc-gimg-????.fits
   Output file is
     $SPECLOG_DIR/$MJD/guiderMon-$MJD.par

 EXAMPLES:

 BUGS:

 REVISION HISTORY:
   13-Jan-2010  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/apo2d/guidermonfile.pro)</strong></p>
<hr />
<h3 id="GUIDERMOVIE">GUIDERMOVIE</h3>
<p><a href="#GUIDERMONFILE">[Previous Routine]</a></p>
<p><a href="#GUIDERMPEG">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   guidermovie

 PURPOSE:
   Plot the guider images for an entire night using ATV.

 CALLING SEQUENCE:
   guidermovie, [ mjd=, plate=, expnum=, _EXTRA=KeywordsForATV ]

 INPUTS:

 OPTIONAL INPUTS:
   mjd        - MJD number; if not set, then select the most recent MJD
                in the $BOSS_SPECTRO_DATA directory.
   plate      - Plate number; if specified, then select all exposures
                within the time frame for the science+smear exposures
                for this plate during the night in question.
   expnum     - Exposure numbers (for the gimg*.fits guider images)
                as an array.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:
   Display the horrendous guider images for plate 889 on MJD=52346:
     IDL&gt; guidermovie, mjd=52346, plate=889

 BUGS:

 DATA FILES:
   $BOSS_SPECTRO_DATA/$MJD/guider/gimg*.fits.gz
   $BOSS_SPECTRO_DATA/$MJD/sdR-b1-????????.fit.gz

 PROCEDURES CALLED:
   atv
   atvxyouts
   djs_filepath()
   fileandpath()
   findopfile()
   get_tai
   jdcnv
   mrdfits()
   splog
   sdsshead()
   sxpar()

 REVISION HISTORY:
   13-May-2002  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/apo2d/guidermovie.pro)</strong></p>
<hr />
<h3 id="GUIDERMPEG">GUIDERMPEG</h3>
<p><a href="#GUIDERMOVIE">[Previous Routine]</a></p>
<p><a href="#GUIDERPLAY">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   guidermpeg

 PURPOSE:
   Create an MPEG guider movie.
   Plot the guider images for an entire night.

 CALLING SEQUENCE:
   guidermovie, [ mjd=, expnum=, _EXTRA=KeywordsForATV ]

 INPUTS:

 OPTIONAL INPUTS:
   mjd        - MJD number; if not set, then select the most recent MJD
                in the $BOSS_SPECTRO_DATA directory.
   expnum     - Exposure numbers as an array

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:
   Make a movie of the horrible guider images while the slit-head
   became unlatched while observing plate 889 on MJD 52346:
     IDL&gt; guidermpeg, mjd=52346, expnum=805+lindgen(25)

 BUGS:

 DATA FILES:
   $BOSS_SPECTRO_DATA/$MJD/guider/gimg*.fits.gz

 PROCEDURES CALLED:
   djs_filepath()
   fileandpath()
   findopfile()
   mrdfits()
   splog
   sxpar()

 REVISION HISTORY:
   13-May-2002  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/apo2d/guidermpeg.pro)</strong></p>
<hr />
<h3 id="GUIDERPLAY">GUIDERPLAY</h3>
<p><a href="#GUIDERMPEG">[Previous Routine]</a></p>
<p><a href="#HOGG_EXTINCTION">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   guiderplay

 PURPOSE:
   Replay guider images from a night

 CALLING SEQUENCE:
   guidermovie, [ mjd=, wtime= ]

 INPUTS:

 OPTIONAL INPUTS:
   mjd        - MJD subdirectory; if not set, then use largest number
                in $GUIDE_DIR directory
   wtime      - Wait time between images; default to 0 sec

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:

 REVISION HISTORY:
   01-May-2010  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/guider/guiderplay.pro)</strong></p>
<hr />
<h3 id="HOGG_EXTINCTION">HOGG_EXTINCTION</h3>
<p><a href="#GUIDERPLAY">[Previous Routine]</a></p>
<p><a href="#HOLESIZE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 COMMENTS:
  - Check out Burki et al, A&amp;ASS, 112, 383 (1995).
 BUGS:
  - Many things hard-coded.
  - No comment header.
</pre>
<p><strong>(See pro/spec1d/hogg_extinction.pro)</strong></p>
<hr />
<h3 id="HOLESIZE">HOLESIZE</h3>
<p><a href="#HOGG_EXTINCTION">[Previous Routine]</a></p>
<p><a href="#IDLSPEC2D_VERSION">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   holesize
 PURPOSE:
   Returns size in deg of a hole in an SDSS plate
 CALLING SEQUENCE:
   sz= holesize([/guide])
 OPTIONAL KEYWORDS:
   guide    - Return value for a guide hole
 COMMENTS:
   Returns 55./3600. for a normal hole, 175/3600. for a guide
 REVISION HISTORY:
   26-Oct-2006  MRB, NYU
</pre>
<p><strong>(See pro/plate/holesize.pro)</strong></p>
<hr />
<h3 id="IDLSPEC2D_VERSION">IDLSPEC2D_VERSION</h3>
<p><a href="#HOLESIZE">[Previous Routine]</a></p>
<p><a href="#INSPECTFILES[1]">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   idlspec2d_version
 PURPOSE:
   Return the version name for the idlspec2d product 
 CALLING SEQUENCE:
   vers = idlspec2d()
 OUTPUTS:
   vers       - Version name for the product idlspec2d 
 COMMENTS:
   Depends on shell script in $IDLSPEC2D_DIR/bin
</pre>
<p><strong>(See pro/spec2d/idlspec2d_version.pro)</strong></p>
<hr />
<h3 id="INSPECTFILES[1]">INSPECTFILES[1]</h3>
<p><a href="#IDLSPEC2D_VERSION">[Previous Routine]</a></p>
<p><a href="#INSPECTFILES[2]">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   inspectfiles

 PURPOSE:
   Create empty spInspect file(s) for manual inspection of classifications

 CALLING SEQUENCE:
   inspectfiles, [ plate, mjd=, inspector=, /clobber ]

 INPUTS:

 OPTIONAL INPUTS:
   plate      - Plate number(s); if not set, then select all plates that
                are reduced according to the platelist file.
   mjd        - MJD number(s); if not set, then select the most recent
                data for each plate (largest MJD).
   inspector  - Name of inspector, which should be a string without
                any whitespace.  If set, then output file is
                &quot;spInspect-$PLATE-$MJD-$INSPECTOR.par&quot;, otherwise it is
                &quot;spInspect-$PLATE-$MJD.par&quot; with inspector='yourname'
                in the inspector fields of this file.
   clobber    - If set, then overwrite any files with the same name
                in the current directory.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:
   Create spInspect files for all reduced plates and write them in
   the current directory:
     IDL&gt; inspectfiles

   Create the file spInspect-0400-51820-knapp.par file for plate 400 observed
   on MJD=51820, filling in the &quot;inspector&quot; fields with the name &quot;knapp&quot;:
     IDL&gt; inspectfiles, 400, mjd=51820, inspector='knapp'

 BUGS:

 PROCEDURES CALLED:
   inspectgen
   platelist
   readspec
   splog
   yanny_write

 REVISION HISTORY:
   20-May-2002  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/inspect/inspectfiles.pro)</strong></p>
<hr />
<h3 id="INSPECTFILES[2]">INSPECTFILES[2]</h3>
<p><a href="#INSPECTFILES[1]">[Previous Routine]</a></p>
<p><a href="#INSPECT_VERIFY">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   inspectfiles

 PURPOSE:
   Create empty spInspect file(s) for manual inspection of classifications

 CALLING SEQUENCE:
   inspectgen, plate, mjd=, [ specinspect=, $
    spectext=, specblend=, hdr=, structs= ]

 INPUTS:
   plate      - Plate number
   MJD        - MJD number

 OPTIONAL INPUTS:

 OUTPUTS:

 OPTIONAL OUTPUTS:
   specinspect- SPECINSPECT structure (640 elements)
   spectext   - SPECTEXT structure, with one empty element with fiberid=0
   specblend  - SPECBLEND structure, with one empty element with fiberid=0
   hdr        - String array with Yanny header
   structs    - String array with Yanny structure definitions

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   readspec
   sdss_flagval()

 REVISION HISTORY:
   20-May-2002  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/inspect/inspectgen.pro)</strong></p>
<hr />
<h3 id="INSPECT_VERIFY">INSPECT_VERIFY</h3>
<p><a href="#INSPECTFILES[2]">[Previous Routine]</a></p>
<p><a href="#JEG_SPHOTO_COEF">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   inspect_verify

 PURPOSE:
   Verify the data format of spInspect files

 CALLING SEQUENCE:
   inspect_verify, [ path= ]

 INPUTS:
   path       - Directory name; default to $SPINSPECT_DIR/data/*

 OPTIONAL INPUTS:

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Issue warnings on the following:
     * File name not matchings spInspect-XXXX-YYYYY.par, where XXXX and YYYYY
       are integers
     * Error reading the file as a Yanny-formatted file
     * Empty data file
     * BOSSOBJECT structure missing
     * Any structure name that does not match a structure name in the template
       file
     * For any structure that does exist, if any of the elements in the
       template are missing (those are all considered required)
     * For any structure that does exist, if any of the elements are a
       different variable type from the template file
     * BOSSOBJECT.FIBERID not in the range [1,1000]
     * BOSSOBJECT.FIBERID has duplicate values
     * BOSSOBJECT.CLASS_PERSON not in the range [0,4]
     * BOSSOBJECT.Z_CONF_PERSON not in the range [0,4]
   The template file is $IDLSPEC2D_DIR/opfiles/spInspect-0000-00000.par

 EXAMPLES:

 BUGS:

 DATA FILES:
   $IDLSPEC2D_DIR/opfiles/spInspect-0000-00000.par

 PROCEDURES CALLED:

 REVISION HISTORY:
   23-Jul-2010  Written by David Schlegel, LBL
</pre>
<p><strong>(See pro/inspect/inspect_verify.pro)</strong></p>
<hr />
<h3 id="JEG_SPHOTO_COEF">JEG_SPHOTO_COEF</h3>
<p><a href="#INSPECT_VERIFY">[Previous Routine]</a></p>
<p><a href="#K-CORRECT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   jeg_sphoto_coef
 
 PURPOSE:
   Compute coefficients which can be used to correct the spectrophotometry

 CALLING SEQUENCE:
   coef = jeg_sphoto_coef(wave, flux, ivar, phot_mag, /plot, $
                          x = x, xavg=xavg, x2avg=x2avg)

 INPUTS:
   wave       - wavelength array [npix]
   flux       - 2d flux array in 10-17 erg/s/cm^2/A [npix, nfiber]
   ivar       - inverse variance [npix, nfiber]
   phot_mag   - photo fiber mag [5, nfiber]

 OUTPUTS:
   an array of coefficients for reconstructing the loss function [3, nfiber]
     loss = 10.0^(-0.4 *(coef[0] + coef[1]*x + coef[2]x^2))
     spec_obs = spec_true * loss 

 OPTIONAL OUTPUTS:
   x      - the array of x values used to compute the loss [npix] (see paper
            by Jim Gunn for full explanation)
   xavg   - array of average x values for the g,r,i filters [3, npix] 
   x2avg  - array of average x^2 values for the g,r,i filters [3, npix] 
   doplot - if set a plot is generated showing the original spectrum in white,
            the corrected spectrum in blue, the loss function in red, and
            the 3 points used to compute the loss function in green

 COMMENTS:
   See paper by Jim Gunn for a full explanation

 BUGS: 
   Not sure what happens when the mags are bad

 PROCEDURES CALLED:
   filter_thru
   linterp
 
 REVISION HISTORY:
   2-Feb-2004  Written by C. Tremonti, U of Az
</pre>
<p><strong>(See pro/fluxfix/jeg_sphoto_coef.pro)</strong></p>
<hr />
<h3 id="K-CORRECT">K-CORRECT</h3>
<p><a href="#JEG_SPHOTO_COEF">[Previous Routine]</a></p>
<p><a href="#KURUCZ_FITSFILE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   k-correct
 PURPOSE:
   Take 5-band photometry and redshift and return k-corrected magnitude.
 COMMENTS:
 CALLING SEQUENCE:
   restphot= k-correct(obsphot,z)
 INPUTS:
   obsphot   - 5xN array of SDSS photometry in observed frame
   z         - N-vector of redshifts
 OPTIONAL INPUTS:
   obserr    - 5xN array of uncertainties in obsphot
 KEYWORDS:
 OUTPUTS:
   restphot  - 5xN array of SDSS photometry in rest frame
 OPTIONAL OUTPUTS:
   resterr   - 5xN array of propagated uncertainties in restphot
 PROCEDURES CALLED:
 BUGS:
   MAKES NO USE OF ERRORS.
   GIVES CRAP WHEN EXTRAPOLATING.
   This uses an incredibly stupid interpolation scheme.
 REVISION HISTORY:
   2000-Jun-28  Written by Hogg (IAS)
</pre>
<p><strong>(See pro/science/k_correct.pro)</strong></p>
<hr />
<h3 id="KURUCZ_FITSFILE">KURUCZ_FITSFILE</h3>
<p><a href="#K-CORRECT">[Previous Routine]</a></p>
<p><a href="#KURUCZ_RESTORE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   kurucz_fitsfile

 PURPOSE:
   Generate a single FITS file from a list of ASCII-formatted Kurucz models

 CALLING SEQUENCE:
   kurucz_fitsfile, [ fileprefix, outfile ]

 INPUTS:

 OPTIONAL INPUTS:
   fileprefix - Use all files in the current directory matching this string;
                default to 'a*.spc'
   outfile    - Name of output FIST file; default 'kurucz_stds_raw_v5.fits'

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The input ASCII files were generated by Christy Tremonti using
   Kurucz' code.  The file name is assumed to encode the stellar
   parameters of metallicity (FEH), effective temperature (TEFF)
   and gravity (G).  For example, the file 'am05k2_5000_4.0.spc'
   is interpreted to have FEH=-0.5, TEFF=5000, G=4.0.  I don't know
   what the &quot;k2&quot; in the filename means.

   HDU#0 of the output file has the fluxes.
   HDU#1 of the output file is a FITS binary table with the stellar parameters.

 EXAMPLES:

 PROCEDURES CALLED:
   mwrfits
   sxpaddpar

 REVISION HISTORY:
   18-Jan-2003  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/kurucz_fitsfile.pro)</strong></p>
<hr />
<h3 id="KURUCZ_RESTORE">KURUCZ_RESTORE</h3>
<p><a href="#KURUCZ_FITSFILE">[Previous Routine]</a></p>
<p><a href="#LEDFLAT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   kurucz_restore

 PURPOSE:
   Read back Kurucz models from FITS and apply an empirical correction

 CALLING SEQUENCE:
   kurucz_restore, kwave, kflux, nkflux=, hdr=, kindx=, smoothpix=

 INPUTS:
 
 OPTIONAL INPUTS:
   smoothpix - smooth models by this number of pixels -- useful for 
               comparisons to non-SDSS data
   
 OUTPUT:
   kwave - wavelength in Angstroms of Kurucz models (binning is in log-10 A)
           [npix]
   kflux - flux of Kuruz models [npix, nmodel]

 OPTIONAL OUTPUTS:
   nkflux - normalized model flux [npix, nmodel]
   hdr    - header of FITS file 
   kindx  - structure containing info on each model (Teff, logg, [Fe/H], mags)

 COMMENTS:
   The model file called &quot;kurucz_stds_v5.fit' is assumed to be in 
   $IDLSPEC2D_DIR/etc.  The models have been produced by the SPECTRUM code 
   (R.0. Gray &amp; C. J. Corbally, 1994, AJ, 107, 742) using the latest Kurucz
   model atmospheres.  The 0th HDU contains the flux in ergs/s/cm^2/A -- 
   the absolute value of the flux is arbitrary.  The spectra have been 
   convolved to SDSS resolution (approximately) and rebinned to dloglam 
   = 1e-4.  The 1st HDU contains information about each model such as 
   effective temperature, surface gravity, and metallicity.  The wavelength 
   information is in the header.  The second HDU contains information about
   an empirical correction which should be applied to the models.

 BUGS:
   The empirical correction which is applied is derived from comparing 
   hot DA white dwarfs in SDSS to models.  This only corrects the low order 
   shape of the spectra.  A different correction is probably needed for each 
   T_eff and [Fe/H].

 EXAMPLES:
   kurucz_restore, kwave, kflux
   plot, kwave, kflux[*, 5]

 PROCEDURES CALLED:
   filter_thru()
   mrdfits()
   rectify
   sxpar()
   traceset2xy

 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   12-Aug-2003  Created by C. Tremonti, Steward Observatory

</pre>
<p><strong>(See pro/fluxfix/kurucz_restore.pro)</strong></p>
<hr />
<h3 id="LEDFLAT">LEDFLAT</h3>
<p><a href="#KURUCZ_RESTORE">[Previous Routine]</a></p>
<p><a href="#LINEBACKFIT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   ledflat

 PURPOSE:
   Compute pixel-flats from LED flat-field images

 CALLING SEQUENCE:
   ledflat, expnum, [ docams=, indir=, threshrms=, threshlo=, nuse= ]

 INPUTS:
   expnum     - Exposure number(s)

 OPTIONAL KEYWORDS:
   docams     - Cameras to analyze; default to ['b1','b2','r1','r2'].
   indir      - Input directory for files; default to searching for
                files in $BOSS_SPECTRO_DATA/*.  If $BOSS_SPECTRO_DATA is not set,
                then it is assumed to be /data/spectro.
   threshrms  - Threshold for masking pixels whose fractional RMS (after
                outlier-rejection) is larger than this value; default 0.05
   threshlo   - Threshold for low pixels compared to local median;
                default to 0.05
   nuse       - Maximum number of images to use in computing statistics
                at each pixel; default to 5 or the number of exposures,
                whichever is smaller

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Output file names are pixflat-$DOCAMS-$MJD.fits, where the MJD
   is from the first input file header.

   This algorithm is designed to work best if there are several LED
   flats observed with the LED moved around such that it is not always
   illuminating the same way.  For any given pixel, the flat value
   is determined from the image that has the lowest variance near that pix.

 EXAMPLES:
   Solve for pixel flats from LED images using data from both
   MJD 55141 and MJD 55142.  Select only those images with mean &gt;5000 e-.
   &gt; ledflat, [103045+lindgen(5),103075+lindgen(3)], docams=['b1','b2']
   &gt; ledflat, [103070+lindgen(8)], docams=['r1','r2']

 BUGS:
   Images should be bias-subtracted first???
   Non-linearities should be applied first ???
   Requires commenting-out the masking of the top+bottom of images in SDSSPROC!
   Low-flux images should get automatically discarded.

   This implementation has Poisson noise at the level of a single image.
   A better implementation would perhaps first combine the exposures
   from the same MJD or MJD+exptime first to beat down the Poisson noise.

 REVISION HISTORY:
   18-Mar-2010  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/specflat/ledflat.pro)</strong></p>
<hr />
<h3 id="LINEBACKFIT">LINEBACKFIT</h3>
<p><a href="#LEDFLAT">[Previous Routine]</a></p>
<p><a href="#LISTCHI">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   linebackfit

 PURPOSE:
   Fit emission lines and background terms to a spectrum.

 CALLING SEQUENCE:
   result = linebackfit(lambda, loglam, flux, invvar=, $
    linename=, zindex=, windex=, findex=, fvalue=, zlimits=, siglimits=, $
    background=, contrange=, zguess=, sigguess=, backguess=, $
    yfit=, bfit=, bterms=, /silent )

 INPUTS:
   lambda     - Rest-frame vacuum wavelength of lines to fit in Ang [NLINE]
   loglam     - Wavelengths for spectrum in vacuum log-10 Angstroms [NPIX]
   flux       - Flux for spectrum [NPIX]
   invvar     - Inverse variance for spectrum [NPIX]

 OPTIONAL INPUTS:
   linename   - String name(s) of line(s) to be copied to output structure.
   zindex     - Lines with the same ZINDEX are constrained to have the
                same redshift; default to a unique list of indices [NLINE].
   windex     - Lines with the same WINDEX are constrained to have the
                same width [NLINE]; default to a unique list of indices.
   findex     - Lines with the same FINDEX are constrained to have the
                same flux ratio as input in FVALUE; defult to a unique
                list of indices [NLINE].
   fvalue     - If FINDEX is specified, then constrain the lines to have
                the same flux ratios as in FVALUE [NLINE]; default to
                all values of 1.  These values are also used as the
                initial guesses for the line strengths.
   zlimits    - Optional limits in velocity, either as a 2-elements array
                for the low/high limit of every line, or as a [2,NLINE] array
                with different limits for each line [km/s]
   siglimits  - Optional limits in sigma, either as a 2-elements array
                for the low/high limit of every line, or as a [2,NLINE] array
                with different limits for each line [km/s]
   background - Background vector(s) to fit simultaneously with the lines,
                where the scaling of each vector is fit [NPIX,NBACK].
                The redshift of these background vectors is not fit, but
                rather we maintain the one-to-one correspondence of each
                BACKGROUND pixel to each FLUX pixel.  The initial guess
                for the scaling of each background vector is unity.
   contrange  - Continuum-level fitting range.  If not set or set to zero,
                then use the background level at the line center.
                Or set as 2-element array for fitting ranges on either side
                of the line center in km/s.  A mean (unweighted) continuum
                is evaluated in the blueward and redward bands, and then
                the average of those two bands.
   zguess     - Initial guess for redshifts of all lines (scalar or vector
                with one entry per line); default to 0.
   sigguess   - Initial guess for sigmas of all lines in log-10 Angstroms
                (scalar or vector with one entry per line); default to 1.5d-4
                (105 km/sec).
   backguess  - Initial guess for background term coefficients [NBACK];
                default to 1 for all coefficients
   silent     - If set, then make no print statements with SPLOG

 OUTPUTS:
   result     - Output structure with result of line fits [NLINE].
                The elements are as follows:
                LINENAME        - String name of line copied from input
                                  parameter by the same name, or else
                                  constructed from the rounded-down wavelength
                                  of each line in air (not vacuum)
                LINEWAVE        - Rest-frame wavelength in vacuum [Ang]
                                  (copy of LAMBDA)
                LINEZ           - Redshift [dimensionless]
                LINEZ_ERR       - Error in above
                LINESIGMA       - Sigma of gaussian [km/s]
                LINESIGMA_ERR   - Error in above
                LINEAREA        - Area of line [flux-units * Ang]
                LINEAREA_ERR    - Error in above
                LINEEW          - Line equivalent width [Ang]; or 0 if the
                                  background level is &lt;= 0.
                LINEEW_ERR      - Error in above; or -1L if the background
                                  level is &lt;= 0.  We approximate this error
                                  as sqrt((LINEAREA_ERR/LINEAREA)^2
                                         +(LINECONTLEVEL_ERR/LINECONTLEVEL)^2) * LINEEW
                LINECONTLEVEL   - Continuum level at line center [flux-units];
                                  if the line center is outside the wavelength
                                  range, then return the nearest value (either
                                  the first or last value)
                LINECONTLEVEL_ERR - Error in above, or -1L if the line center
                                  is outside the wavelength range.
                LINENPIXLEFT    - Number of pixels from the line center to
                                  -3 sigma that have INVVAR &gt; 0.
                LINENPIXRIGHT   - Number of pixels from the line center to
                                  +3 sigma that have INVVAR &gt; 0.
                LINEDOF         - LINENPIXLEFT+LINENPIXRIGHT minus the number
                                  of terms fit for that line, which could be
                                  fractional (if one parameter is fixed between
                                  N lines, then we say only 1/N-th of that
                                  parameter is fit in each of those lines).
                                  This can be zero or negative.
                LINECHI2       -  Chi^2 for all points within +/- 3 sigma of
                                  the line center; -1L if no such points.

 OPTIONAL OUTPUTS:
   yfit       - Fit spectrum including lines and background terms [NPIX].
   bfit       - Fit spectrum including only background terms [NPIX].
   bterms     - Coefficients for background terms [NBACK].

 COMMENTS:
   If a line was dropped from the fit (for example, no points to fit),
   then set the LINEAREA to 0 and the LINEAREA_ERR to -1L.

   Also, if LINENPIX=0 for a line, then remove that line from the fit.

 EXAMPLES:

 BUGS:
   Do not use lines with no points to fit in the computation of
   degrees of freedom for other lines.

 DATA FILES:

 PROCEDURES CALLED:
   create_linestruct()
   mpfitfun

 INTERNAL SUPPORT ROUTINES:
   onegauss()
   manygauss()

 REVISION HISTORY:
   05-Feb-2002  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/linebackfit.pro)</strong></p>
<hr />
<h3 id="LISTCHI">LISTCHI</h3>
<p><a href="#LINEBACKFIT">[Previous Routine]</a></p>
<p><a href="#LISTEXPTIME">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   listchi

 PURPOSE:
   List the extraction chi of all individual spectro frames

 CALLING SEQUENCE:
   listchi

 INPUTS:

 OPTIONAL INPUTS:

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The exposure times of all files $BOSS_SPECTRO_REDUX/????/spFrame-??-????????.fits
   are logged to the file 'listchi.log'.  Also, a save-set is written
   to the file 'listchi.ss'.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   headfits()
   splog

 REVISION HISTORY:
   03-Sep-2003  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/plan/listchi.pro)</strong></p>
<hr />
<h3 id="LISTEXPTIME">LISTEXPTIME</h3>
<p><a href="#LISTCHI">[Previous Routine]</a></p>
<p><a href="#LOCATESKYLINES">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   listexptime

 PURPOSE:
   List the exposure times of all (reduced) spectroscopic frames.

 CALLING SEQUENCE:
   listexptime

 INPUTS:

 OPTIONAL INPUTS:

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The exposure times of all files $BOSS_SPECTRO_REDUX/????/spFrame-b1-????????.fits
   are logged to the file 'listexp.log'.
   This proc just looks at the b1 exposures to save time.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   headfits()
   splog

 REVISION HISTORY:
   03-Sep-2003  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/plan/listexptime.pro)</strong></p>
<hr />
<h3 id="LOCATESKYLINES">LOCATESKYLINES</h3>
<p><a href="#LISTEXPTIME">[Previous Routine]</a></p>
<p><a href="#LOGSHEET">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   locateskylines

 PURPOSE:
   Compute shifts for arc lines used in wavelength calibration.

 CALLING SEQUENCE:
   locateskylines, skylinefile, fimage, ivar, wset, xarc, arcshift=arcshift,
    [ xsky=, ysky=, skywaves=, skyshift= ]

 INPUTS:
   skylinefile - Name of skyline file (with air wavelengths in Angstroms)
   fimage      - Flattened image containing skylines [NPIX,NFIBER]
   ivar        - Inverse variance of FIMAGE
   wset        - Wavelength solution traceset (pix -&gt; lambda)
   xarc        - Arc line positions from arc frame [pix]

 OUTPUTS:
   arcshift    - Shifts to apply to arc lines in pix [NROW,NTRACE]

 OPTIONAL OUTPUTS:
   xsky        - Pixel position of sky lines [NFIBER,NLINE]
   skywaves    - Wavelengths of sky lines used for computing shifts (Ang)
   skyshift    - Shifts to apply to sky lines in pix [NROW,NTRACE]

 COMMENTS:
   The wavelength as a function of fiber number is only allowed to
   vary quadratically.  The scale 

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_iterstat
   fitmeanx()
   trace_fweight()
   trace_gweight()
   traceset2pix()
   traceset2xy
   xy2traceset

 REVISION HISTORY:
   15-Oct-1999  Written by S. Burles, D. Finkbeiner, &amp; D. Schlegel, APO
   18-Nov-1999  Moved skyline QA to fit_skyset (SMB)
</pre>
<p><strong>(See pro/spec2d/locateskylines.pro)</strong></p>
<hr />
<h3 id="LOGSHEET">LOGSHEET</h3>
<p><a href="#LOCATESKYLINES">[Previous Routine]</a></p>
<p><a href="#LRGMODEL_ERRORS">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   logsheet

 PURPOSE:
   Make a summary of header keywords in a directory of raw SDSS spectro files.

 CALLING SEQUENCE:
   logsheet, [mjd=, camera=, /collimator, outfile=]

 INPUTS:

 OPTIONAL INPUTS:
   mjd        - Directory name; default to largest numbered MJD
                matching the directory &quot;$BOSS_SPECTRO_DATA/?????&quot;.
   camera     - Camera name of files to list; '??' for all cameras;
                default to 'b1'
   collimator - Include collimator positions
   outfile    - Output file

 OUTPUTS:

 COMMENTS:
   First look at files matching &quot;sdR*.fit.gz&quot; in the directory
   $BOSS_SPECTRO_DATA/$MJD, and if none found then look for files
   matching &quot;sdR*.fit&quot;.

 EXAMPLES:
   Print a log sheet of the most recent MJD:
     IDL&gt; logsheet

   Print a log sheet of the most recent MJD, but only for the 'b1' camera:
     IDL&gt; logsheet, camera='b1'

   Print a log sheet of the spectroscopic data from MJD=52000 (if it
   still exists on disk), and write to the file 'junk.log'.
     IDL&gt; logsheet, mjd=52000, outfile='junk.log'

 PROCEDURES CALLED:
   djs_filepath()
   sdsshead()
   sxpar()

 REVISION HISTORY:
   06-Oct-1999  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/spec2d/logsheet.pro)</strong></p>
<hr />
<h3 id="LRGMODEL_ERRORS">LRGMODEL_ERRORS</h3>
<p><a href="#LOGSHEET">[Previous Routine]</a></p>
<p><a href="#LRGMODEL_PHOTOZ">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   lrgmodel_errors

 PURPOSE:
   Make plots of photo-z's where we increase the errors.

 CALLING SEQUENCE:
   lrgmodel_errors

 INPUTS:

 OPTIONAL INPUTS:

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   dfpsclose
   dfpsplot
   djs_oplot
   djs_plot
   hogg_scatterplot
   lrgmodel_photoz()

 REVISION HISTORY:
   22-Dec-2003  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/photoz/lrgmodel_errors.pro)</strong></p>
<hr />
<h3 id="LRGMODEL_PHOTOZ">LRGMODEL_PHOTOZ</h3>
<p><a href="#LRGMODEL_ERRORS">[Previous Routine]</a></p>
<p><a href="#LRGMODEL_PLOTS">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   lrgmodel_photoz

 PURPOSE:
   Simple photo-z finder for LRGs using Bruzual-Charlot models.

 CALLING SEQUENCE:
   zfit = lrgmodel_photoz(pflux, pflux_ivar, [ /abcorrect, extinction=, $
    abfudge=, ageburst=, zmetal=, filterlist=, adderr=, $
    zsplinearr=, synfluxarr=, z_err=, chi2=, fitflux=, plotfile= ] )

 INPUTS:
   pflux          - Object fluxes in the 5 SDSS filters [5,NOBJ]; if not set,
                    then simply return with the optional ZSPLINEARR,SYNFLUXARR.
   pflux_ivar     - Inverse variances for FLUX [5,NOBJ]

 OPTIONAL INPUTS:
   abcorrect      - If set, then convert the input fluxes from the 2.5-m
                    natural system to AB fluxes
   extinction     - If set, then apply these extinction corrections [5,NOBJ]
   abfudge        - Additional AB &quot;fudge factors&quot;; default to adding
                    [0,0,0,0,0] mag to input magnitudes, where a positive
                    value makes that flux fainter
   ageburst       - Age of the Universe at the single-burst; default
                    to value from previous call, or 2.5 Gyr
   zmetal         - Metallicity at the single-burst; default
                    to value from previous call, or Z=0.018
                    (where Z=0.02 is solar)
   filterlist     - List of filter indices to use in fits; default to
                    using all five filters [0,1,2,3,4]
   adderr         - Fractional error to add in quadrature; default to 0.03
   plotfile       - If set, then send debugging plots to this file

 OUTPUTS:
   zfit           - Best-fit redshift [NOBJ]

 OPTIONAL OUTPUTS:
   zsplinearr     - Array of test redshifts used in the fits [NTEST]
   synfluxarr     - Array of the fluxes vs. redshift from the models [5,NTEST]
   z_err          - Redshift error, or a negative value if an error
                    occurred in the quadratic minimization estimate [NOBJ]
   chi2           - Best-fit chi^2 [NOBJ]
   fitflux        - Fluxes for the best-fit model, useful for knowing the
                    colors of the best-fit model

 COMMENTS:
   The fluxes should be AB fluxes, or SDSS 2.5-m natural system fluxes
   if /ABCORRECT is set.
   The fluxes should already be extinction-corrected, unless
   the EXTINCTION keyword is passed.

 EXAMPLES:

 BUGS:
   Note that I allow the Bruzual-Charlot models to be extrapolated
   beyond the ages and metallicities that they provide.  This is done
   via linear interpolation in log(age)-log(metals)-log(flux) spec.
   This may not be valid.

 PROCEDURES CALLED:
   computechi2()
   filter_thru()
   find_nminima()
   readcol
   sdssflux2ab
   sxpar()

 REVISION HISTORY:
   09-Dec-2003  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/photoz/lrgmodel_photoz.pro)</strong></p>
<hr />
<h3 id="LRGMODEL_PLOTS">LRGMODEL_PLOTS</h3>
<p><a href="#LRGMODEL_PHOTOZ">[Previous Routine]</a></p>
<p><a href="#LRGMODEL_TRAIN">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   lrgmodel_plots

 PURPOSE:
   Generate goodness-of-fit plots from the LRG model photo-z fits.

 CALLING SEQUENCE:
   lrgmodel_plots, [ suffix, public=, /recalibrate, /colorcut, $
    subsamp=, _EXTRA= ]

 INPUTS:

 OPTIONAL INPUTS:
   suffix         - Suffix name for plot names, which is 'photoz'+SUFFIX+'.ps'
   public         - Select public data; this keyword is passed
                    to LRGMODEL_READ_SPALL()
   recalibrate    - Recalibrate the photometry using SDSS_RECALIBRATE
   colorcut       - If set, then make Nikhil's color-cuts on the 2dF data
   subsamp        - Subsample the spAll galaxies by this factor; default to 4
   _EXTRA         - Additional keywords to pass to LRGMODEL_PHOTOZ(),

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   This routine reads both the SDSS spectra from spAll, and the SDSS-2dF
   redshifts.

   Some of the plots are replicated with the SDSS-2dF points in color.
   The SDSS-2dF 2003A objects are in green, and the 2003B objects are in blue.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   dfpsclose
   dfpsplot
   djs_oplot
   djs_plot
   hogg_scatterplot
   lrgmodel_append_twodf()
   lrgmodel_read_spall()
   plothist
   sdss_recalibrate

 REVISION HISTORY:
   18-Dec-2003  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/photoz/lrgmodel_plots.pro)</strong></p>
<hr />
<h3 id="LRGMODEL_TRAIN">LRGMODEL_TRAIN</h3>
<p><a href="#LRGMODEL_PLOTS">[Previous Routine]</a></p>
<p><a href="#LRGMODEL_TWEAK_TEMPLATE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   lrgmodel_train

 PURPOSE:
   Calling script for LRGMODEL_TWEAK_TEMPLATE for training the Bruzual-
   Charlot models for use with photo-z's.

 CALLING SEQUENCE:
   lrgmodel_train, [ public=, /regenerate, twodf=, zrange=, dzweight=, $
    /absdev, _EXTRA=]

 INPUTS:

 OPTIONAL INPUTS:
   public         - If set, then use the requested version of the spAll
                    file rather than all objects; for example, 'EDR', 'DR1',
                    'DR2', or simply /PUBLIC to select all public data.
   regenerate     - If set, then regenerate the trimmed spAll file.
   twodf          - Suffix for which 2dF files to use; default to the two
                    set of files specified by ['2003A', '2003B']
   zrange         - Trim to objects in this redshift range; default [0.1,1.0].
   dzweight       - Re-weight the galaxies such that all objects within each
                    redshift interval DZWEIGHT share unit weight; default
                    to 0.02; set to 0 to disable this re-weighting.
   absdev         - If set, then minimize the absolute value of the redshift
                    deviations, rather than the more conventional square of
                    those deviations.  This should be more robust.
   _EXTRA         - Keywords for LRGMODEL_PHOTOZ(), such as ABCORRECT,
                    EXTINCTION, ABFUDGE, ADDERR, FILTERLIST.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   This routine minimizes the parameters used for the Bruzual-Charlot
   models in computing photometric redshifts.  There are two parameters
   on which we minimize:
      AGEBURST - age of the Universe at the burst [Gyr]
      ZMETAL   - metallicity of the burst

   This routine first tries a coarse grid of AGEBURST,ZMETAL.
   The best-fit from that grid is used for the initial guess
   that's passed to MPFIT() for a full minimization.

 BUGS:
   Note that the reported chi^2 values are really just sums of the
   squares of redshift errors (multiplied by the weights).

 DATA FILES:
   Both SDSS redshifts and 2dF redshifts are used, reading the files:
      $BOSS_SPECTRO_REDUX/spAll.fits
      $BOSS_SPECTRO_REDUX/spAll-$PUBLIC.fits (if PUBLIC is specified)
      $SDSS_2DF/data/calibObj-2003A.fits
      $SDSS_2DF/data/calibObj-2003B.fits
      $SDSS_2DF/data/catalogue2003A.fits
      $SDSS_2DF/data/catalogue2003B.fits

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   hogg_mrdfits()
   lrgmodel_photoz()
   lrgmodel_tweak_template()
   mrdfits()
   splog

 REVISION HISTORY:
   18-Dec-2003  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/photoz/lrgmodel_train.pro)</strong></p>
<hr />
<h3 id="LRGMODEL_TWEAK_TEMPLATE">LRGMODEL_TWEAK_TEMPLATE</h3>
<p><a href="#LRGMODEL_TRAIN">[Previous Routine]</a></p>
<p><a href="#LRG_PHOTOZ">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   lrgmodel_tweak_template

 PURPOSE:
   Compute the corrections to the input LRG template used for LRG_PHOTOZ().

 CALLING SEQUENCE:
   lrgmodel_tweak_template, pflux, pflux_ivar, zz, [ weights=, $
    maxiter=, ageguess=, metalguess=, agerange=, metalrange=, /absdev, $
     coeff=, _EXTRA= ]

 INPUTS:
   pflux          - Object fluxes in the 5 SDSS filters [5,NOBJ]
   pflux_ivar     - Inverse variances for FLUX [5,NOBJ]
   zz             - Spectroscopic redshifts [NOBJ]

 OPTIONAL INPUTS:
   weights        - Weights for each object in the minimization
                    (this is multiplied by the chi^2 of each point)
   maxiter        - Maximum number of iterations; default to 40
   ageguess       - Starting guess for AGEBURST; default to 2.5 Gyr
   metalguess     - Starting guess for ZMETAL; default to Z=0.2
   agerange       - Range of possible values for AGEBURST; default
                    to [0.0, 6.0] Gyr
   metalrange     - Range of possible values for ZMETAL; default
                    to [0.008, 0.05]
   absdev         - If set, then minimize the absolute value of the redshift
                    deviations, rather than the more conventional square of
                    those deviations.  This should be more robust.
   _EXTRA         - Keywords for LRGMODEL_PHOTOZ(), such as ABCORRECT,
                    EXTINCTION, ABFUDGE, ADDERR, FILTERLIST

 OUTPUTS:
   coeff          - Best-fit coefficients for tweaking input LRG template

 OPTIONAL OUTPUTS:

 COMMENTS:
   This routine minimizes the parameters used for the Bruzual-Charlot
   models in computing photometric redshifts.  There are two parameters
   on which we minimize:
      AGEBURST - age of the Universe at the burst [Gyr]
      ZMETAL   - metallicity of the burst

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   lrgmodel_photoz()
   mpfit()
   splog

 INTERNAL SUPPORT ROUTINES:
  lrgmodel_tweak_fn()

 REVISION HISTORY:
   10-Dec-2003  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/photoz/lrgmodel_tweak_template.pro)</strong></p>
<hr />
<h3 id="LRG_PHOTOZ">LRG_PHOTOZ</h3>
<p><a href="#LRGMODEL_TWEAK_TEMPLATE">[Previous Routine]</a></p>
<p><a href="#LRG_TWEAK_TEMPLATE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   lrg_photoz

 PURPOSE:
   Very simple photo-z finder for LRGs using a single template.

 CALLING SEQUENCE:
   zfit = lrg_photoz(pflux, pflux_ivar, [ /abcorrect, extinction=, $
    abfudge=, filterlist=, adderr=, z_err=, chi2= ] )

 INPUTS:
   pflux          - Object fluxes in the 5 SDSS filters [5,NOBJ]
   pflux_ivar     - Inverse variances for FLUX [5,NOBJ]

 OPTIONAL INPUTS:
   abcorrect      - If set, then convert the input fluxes from the 2.5-m
                    natural system to AB fluxes
   extinction     - If set, then apply these extinction corrections [5,NOBJ]
   abfudge        - Additional AB &quot;fudge factors&quot;; default to adding
                    [0,-0.03,0,0,0] mag to input magnitudes, where a positive
                    value makes that flux fainter
   filterlist     - List of filter indices to use in fits; default to
                    using all five filters [0,1,2,3,4]
   adderr         - Fractional error to add in quadrature; default to 0.03

 OUTPUTS:
   zfit           - Best-fit redshift [NOBJ]

 OPTIONAL OUTPUTS:
   z_err          - Redshift error, or a negative value if an error
                    occurred in the quadratic minimization estimate [NOBJ]
   chi2           - Best-fit chi^2 [NOBJ]

 COMMENTS:
   The fluxes should be AB fluxes, or SDSS 2.5-m natural system fluxes
   if /ABCORRECT is set.
   The fluxes should already be extinction-corrected, unless
   the EXTINCTION keyword is passed.

 EXAMPLES:

 BUGS:
   The LRG template is not quite correct.  I have modified the spectrum
   on large scales by multiplying by an empirically-determined function.
   Also, I've extrapolated the two ends of the spectrum
   to be essentially flat in f_lambda.
   The 3-sigma-clipped scatter appears to be 0.023 at z&gt;0.1.

 PROCEDURES CALLED:
   computechi2()
   filter_thru()
   find_nminima()
   mrdfits()
   sdssflux2ab
   sxpar()

 REVISION HISTORY:
   15-Oct-2003  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/photoz/lrg_photoz.pro)</strong></p>
<hr />
<h3 id="LRG_TWEAK_TEMPLATE">LRG_TWEAK_TEMPLATE</h3>
<p><a href="#LRG_PHOTOZ">[Previous Routine]</a></p>
<p><a href="#MAKE_REGRESS1D">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   lrg_tweak_template

 PURPOSE:
   Compute the corrections to the input LRG template used for LRG_PHOTOZ().

 CALLING SEQUENCE:
   lrg_tweak_template, pflux, pflux_ivar, zz, $
    [ /abcorrect, extinction=, abfudge=, filterlist=, adderr=, $
    maxiter=, coeff= ]

 INPUTS:
   pflux          - Object fluxes in the 5 SDSS filters [5,NOBJ]
   pflux_ivar     - Inverse variances for FLUX [5,NOBJ]
   zz             - Spectroscopic redshifts [NOBJ]

 OPTIONAL INPUTS:
   abcorrect      - If set, then convert the input fluxes from the 2.5-m
                    natural system to AB fluxes
   extinction     - If set, then apply these extinction corrections [5,NOBJ]
   abfudge        - Additional AB &quot;fudge factors&quot;; default to adding
                    [0,-0.03,0,0,0] mag to input magnitudes, where a positive
                    value makes that flux fainter
   filterlist     - List of filter indices to use in fits; default to
                    using all five filters [0,1,2,3,4]
   adderr         - Fractional error to add in quadrature; default to 0.03
   maxiter        - Maximum number of iterations; default to 40

 OUTPUTS:
   coeff          - Best-fit coefficients for tweaking input LRG template

 OPTIONAL OUTPUTS:

 COMMENTS:
   This routine computes the modifications to an input LRG spectrum
   that gives a better total chi^2 when computing photometric redshifts.
   The form of the transformation is:
      Flux = Flux * Wave^COEFF[0] * (1 + COEFF[1] * z * Wave)

   The fluxes should be AB fluxes, or SDSS 2.5-m natural system fluxes
   if /ABCORRECT is set.
   The fluxes should already be extinction-corrected, unless
   the EXTINCTION keyword is passed.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   computechi2()
   filter_thru()
   mrdfits()
   sdssflux2ab
   sxpar()

 REVISION HISTORY:
   21-Oct-2003  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/photoz/lrg_tweak_template.pro)</strong></p>
<hr />
<h3 id="MAKE_REGRESS1D">MAKE_REGRESS1D</h3>
<p><a href="#LRG_TWEAK_TEMPLATE">[Previous Routine]</a></p>
<p><a href="#MAKE_SKYINVVAR">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   make_regress1d

 PURPOSE:
   Generate a regression table from spectro 1-D from Chicago-1D outputs files.

 CALLING SEQUENCE:
   make_regress1d, [listfile, indir=, outfile= ]

 INPUTS:

 OPTIONAL INPUTS:
   listfile   - List with plate number and MJD (one such pair per line)
                for plates to use.  Default to the file
                $IDLSPEC2D_DIR/etc/regress1d_all.plates, which lists plates
                300 to 309.
   indir      - Input directory for the Chicago-1D output files, of the
                format 'spDiag1d-'+mjd+'-'+plate+'.par, i.e.
                'spDiag1d-51666-0300.par'; default to '.'
   outfile    - Name of output file; default to

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   An ASCII file with minimal object information and redshifts is tabulated
   from the Chicago-1D outputs.

   The Chicago outputs are changed in some special cases that are assumed
   to be missing or wrong.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_readcol

 INTERNAL SUPPORT ROUTINES:
   create_zregress()

 DATA FILES:
   $IDLSPEC2D_DIR/etc/regress1d_all.plates

 REVISION HISTORY:
   27-Jun-2000  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/make_regress1d.pro)</strong></p>
<hr />
<h3 id="MAKE_SKYINVVAR">MAKE_SKYINVVAR</h3>
<p><a href="#MAKE_REGRESS1D">[Previous Routine]</a></p>
<p><a href="#MATCH_TRACE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   make_skyinvvar

 PURPOSE:
   To reconstruct the contribution of the sky and detector background
    to the total variance.  Use spPlate*fits files.

 CALLING SEQUENCE:
   skyinvvar = make_skyinvvar(filename)

 INPUTS:
   filename   - Input spPlate file name 
                     i.e. 'spPlate-0858-52316.fits'

 OPTIONAL INPUTS:

 OUTPUT:
   skyinnvar  - Inverse variance as derived from a polynomial fit of 
                 variance vs. flux (size [npix])

 OPTIONAL OUTPUTS:

 COMMENTS:
   Return 0's on failure

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:

 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   18-Jun-2002   Written by Scott Burles, MIT
</pre>
<p><strong>(See pro/spec2d/make_skyinvvar.pro)</strong></p>
<hr />
<h3 id="MATCH_TRACE">MATCH_TRACE</h3>
<p><a href="#MAKE_SKYINVVAR">[Previous Routine]</a></p>
<p><a href="#MJD_MATCH">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   match_trace

 PURPOSE:
   Tweak flat field trace to match object trace
    with a 2d continuous surface fit to low order

 CALLING SEQUENCE:
   xnow = match_trace(image, invvar, xtrace, [xpoly=, ypoly=, $
       first=, maxiter= ])

 INPUTS:
   image      - two-dimensional object image
   invvar     - associated inverse variance image
   xtrace     - array of best fit flat-field traces [nrow, nfiber]

 OPTIONAL KEYWORDS:
   xpoly      - Order of chebyshev polynomial in first dimension (default 3)
   ypoly      - Order of chebyshev polynomial in second dimension (default 3)
   first      - Final fweight centroids of object image
   maxiter    - Maximum number of rejection iterations for 2d surface fit (default 10)

 OUTPUTS:
   xnow       - Best fit trace positions when tweaked to match image

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:
   xnow = match_trace(image, invvar, xtrace)
   bestlag = median(xnow-xtrace)
   splog, 'Shifting traces by match_trace ', bestlag

 BUGS:

 PROCEDURES CALLED:
   djs_reject()
   fchebyshev()
   trace_fweight()

 REVISION HISTORY:
   16-Oct-2000  Written by S. Burles, FNAL
   25-Feb-2002  Added radius keyword, radius=2 is much better when wings of
                     bright neighboring fibers affects centroiding
</pre>
<p><strong>(See pro/spec2d/match_trace.pro)</strong></p>
<hr />
<h3 id="MJD_MATCH">MJD_MATCH</h3>
<p><a href="#MATCH_TRACE">[Previous Routine]</a></p>
<p><a href="#MLPCA_CVSTAR">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   mjd_match

 PURPOSE:
   Decide if any of these MJD's are within the bounds specified by
   MJD,MJSTART,MJEND.

 CALLING SEQUENCE:
   qmjd = mjd_match(mjdlist, [mjd=, mjstart=, mjend=])

 INPUTS:
   mjdlist    - One MJD or an array of MJD's.

 OPTIONAL INPUTS:
   mjd        - Match against these specific MJD's.
   mjstart    - Starting MJD.
   mjend      - Ending MJD.

 OUTPUT:
   qmjd       - Set to 1 if any of the MJD's in MJDLIST are within
                the bounds specified by MJD,MJSTART,MJEND.
                Otherwise, set to 0.

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:

 REVISION HISTORY:
   22-Aug-2001  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/spec2d/mjd_match.pro)</strong></p>
<hr />
<h3 id="MLPCA_CVSTAR">MLPCA_CVSTAR</h3>
<p><a href="#MJD_MATCH">[Previous Routine]</a></p>
<p><a href="#MLPCA_STAR">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>

 NAME: mlpca_cvstar

 PURPOSE:
  Generate ML-PCA templates for CV stars

 bolton@utah 2010may

</pre>
<p><strong>(See pro/templates/mlpca_cvstar.pro)</strong></p>
<hr />
<h3 id="MLPCA_STAR">MLPCA_STAR</h3>
<p><a href="#MLPCA_CVSTAR">[Previous Routine]</a></p>
<p><a href="#MULTISYNTHSPEC">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>

 NAME: mlpca_star

 PURPOSE:
  Generate ML-PCA templates for stars

 bolton@utah 2010may

</pre>
<p><strong>(See pro/templates/mlpca_star.pro)</strong></p>
<hr />
<h3 id="MULTISYNTHSPEC">MULTISYNTHSPEC</h3>
<p><a href="#MLPCA_STAR">[Previous Routine]</a></p>
<p><a href="#MYSQL_WRITE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   multisynthspec

 PURPOSE:
   Construct synthetic spectrum from eigen-templates.

 CALLING SEQUENCE:
   synflux = multisynthspec(zans, [ loglam=, hdr=, eigendir= ])

 INPUTS:
   zans       - Structure(s) with redshift-fit information (from SPREDUCE1D).

 OPTIONAL KEYWORDS:
   loglam     - Log-10 wavelengths at which to synthesize the spectrum;
                this can either be a single vector if all spectra have
                the same wavelength mapping, or an array of [NPIX,NOBJ].
   hdr        - If specified, then use this header to construct LOGLAM.
                Either LOGLAM or HDR must be specified.
   eigendir   - Directory for EIGENFILE; default to $IDLSPEC2D/templates.

 OUTPUTS:
   synflux    - Synthetic spectra

 COMMENTS:
   This routine is meant to be faster than SYNTHSPEC when generating
   many spectra that share the same templates.  This works by generating
   the B-spline coefficients only once per template, then evaluating
   these B-splines at the exact wavelengths of each output spectrum.
   This will NOT be exactly the same as the results from SYNTHSPEC,
   because the individual eigen-spectra are spline-shifted before adding
   them up, rather than adding them up then spline-shifting (as SYNTHSPEC
   does).

 EXAMPLES:

 BUGS:

 DATA FILES:
   $IDLSPEC2D_DIR/etc/TEMPLATEFILES

 PROCEDURES CALLED:
   combine1fiber
   concat_dir()
   poly_array()
   readfits()
   sxpar()

 REVISION HISTORY:
   20-Aug-2000  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/multisynthspec.pro)</strong></p>
<hr />
<h3 id="MYSQL_WRITE">MYSQL_WRITE</h3>
<p><a href="#MULTISYNTHSPEC">[Previous Routine]</a></p>
<p><a href="#NEWSPCOMBINE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   mysql_write

 PURPOSE:
   Write an IDL structure to a MySQL-readable file

 CALLING SEQUENCE:
   mysql_write, filename, pdata, [table=, delim=, modifiers=, /append, $
    scriptfile= ]

 INPUTS:
   filename   - Output file name
   pdata      - Structure to write

 OPTIONAL INPUTS:
   table      - Name of table; default to the structure name or 'anonymous'
   delim      - MySQL delimiter; default to the tab character
   modifiers  - Modifiers for all variables, such as 'not null';
                default to ''
   append     - If set, then append to an existing file
   scriptfile - Name of file for writing MySQL importing script

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Unsupported IDL variable types: COMPLEX, DCOMPLEX.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:

 REVISION HISTORY:
   22-Apr-2000  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/specdb/mysql_write.pro)</strong></p>
<hr />
<h3 id="NEWSPCOMBINE">NEWSPCOMBINE</h3>
<p><a href="#MYSQL_WRITE">[Previous Routine]</a></p>
<p><a href="#OPFIBER_GENERATE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   newspcombine

 PURPOSE:
   Flux calibrates and combines exposures with a common plugmap.
   (Calling script for SPCOADD_FLUXED_FRAMES.)

 CALLING SEQUENCE:
   newspcombine, [ planfile, docams=, adderr=, /xdisplay, minsn2=, $
     best_exposure= ]

 INPUTS:

 OPTIONAL INPUTS:
   planfile   - Name(s) of output plan file; default to reducing all
                plan files matching 'spPlancomb*.par'
   docams     - Cameras to combine; default to ['b1', 'b2', 'r1', 'r2']
   adderr     - Additional error to add to the formal errors, as a
                fraction of the flux; default to 0.03 (3 per cent).
   xdisplay   - Send plots to X display rather than to plot file
   minsn2     - Minimum S/N^2 to include science frame in coadd (default 0.2)
   best_exposure - string containing the exposure ID of the &quot;best&quot; exposure.
                This is the exposure which all exposures will be scaled to
                match before the images are coadded.  If this is not set, the
                exposure with the best S/N and spectrophotometry is chosen.

 OUTPUT:
   spPlate-PPPP-MMMMM.fits file
   Diganostic plots in spDiagcomb-PPPP-MMMMM.ps, spSN2d-PPPP-MMMMM.ps

 COMMENTS:

 EXAMPLES:

 BUGS:
   This routine spawns the Unix command 'mkdir'.
   For a given exposure to be combined data from all 4 cameras must be
   present

 PROCEDURES CALLED:
   djs_filepath()
   cpbackup
   idlspec2d_version()
   idlutils_version()
   lookforgzip()
   spcoadd_fluxed_frames
   splog
   yanny_free
   yanny_par()
   yanny_read

 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   12-Aug-2003  Adapted from spcombine by C. Tremonti, Steward Observatory
</pre>
<p><strong>(See pro/fluxfix/newspcombine.pro)</strong></p>
<hr />
<h3 id="OPFIBER_GENERATE">OPFIBER_GENERATE</h3>
<p><a href="#NEWSPCOMBINE">[Previous Routine]</a></p>
<p><a href="#PCA_FLUX_STANDARD">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   opfiber_generate

 PURPOSE:
   Generate or append entries to the opFibers.par file

 CALLING SEQUENCE:
   opfiber_generate, plate, mjd=, [ camname=, expnum= ]

 INPUTS:
   plate      - Plate number(s)
   mjd        - MJD(s) for plate

 OPTIONAL INPUTS:
   camname    - Camera name; default to all 4 cameras
   expnum     - Exposure number (do not use if PLATE is an array);
                default to first science exposure for this plate+MJD

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Append entries in the opFibers.par file, or create the file if it
   does not yet exist.  This file used to establish the search parameters
   for the trace-finding in TRACE320CRUDE.

  The MJD for each entry is set to the observation, but should be changed
  by hand to the earliest MJD for which the solution would be valid.

 EXAMPLES:

 BUGS:

 DATA FILES:
   $IDLSPEC2D_DIR/opfiles/opFibers.par

 PROCEDURES CALLED:
   spframe_read
   splog
   yanny_readone
   yanny_write

 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   27-Oct-2010  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/plan/opfiber_generate.pro)</strong></p>
<hr />
<h3 id="PCA_FLUX_STANDARD">PCA_FLUX_STANDARD</h3>
<p><a href="#OPFIBER_GENERATE">[Previous Routine]</a></p>
<p><a href="#PCA_GAL">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
  pca_flux_standard

 PURPOSE:
   Solve for the mean flux-calibration vector of one camera + spectrograph
   using data from all available exposures. This is accomplished by matching 
   the normalized standard star spectra to Kurucz models and then ratioing 
   the spectrum (in counts) to the best fitting model (in units of 
   ergs/s/cm^2/A) scaled to match the photo fiber mag.  Because the individual
   exposures were taken under different conditions, the zeropoint of the
   flux calibration vectors from different exposures will be different.  To
   eliminate this problem all of the vectors are normalized between
   5700-6300 A. (The red/blue cameras sample different parts of this
   wavelength region.)  The average flux correction vector is the first 
   PCA eigenspectrum.

 CALLING SEQUENCE:
   pca_flux_standard, loglam, stdflux, stdivar, stdmask, stdinfo, [camid=, $
     corvector=, corvivar=, cormed=, fcor=, fsig=, noplot=] 

 INPUTS:
   loglam   - wavelength in log10(Angstroms) of the input spectra [npix]
   stdflux  - array of standard star spectra [npix, nstar*nexp]
   stdivar  - inverse variance of standard star spectra [npix, nstar*nexp]
   stdmask  - or mask of the standard star spectra [npix, nstar*exp]
   stdinfo  - structure containing info about the best model fit produced by 
              &quot;stype_standard&quot;

 OPTIONAL INPUTS:
   camid        - string giving the camera id for plot titles -- i.e. 'b1'
   noplot       - toggle plotting

 OUTPUT:  
   A structure containing the coefficients of a spline fit the average
   flux correction vector (normalized at 5700-6300 A).

   Diagnostic plots are also produced.  The flux correction vector produced
   from each high S/N standard is plotted in black; the mean of all the 
   fluxcor vectors in green; and the bspline of the mean vector in red.

 OPTIONAL OUTPUTS:
   corvector    - flux calibrations derived from the individual standard
                  stars [npix, nstar*nexp]
   corvivar     - inverse variance of flux calib vectors [npix, nstar*nexp]
   fcor         - final flux correction vector [npix] (not spline fit) 
   fsig         - standard deviation of the flux calibration derived from
                  individual stars about the final answer (scalar)

 COMMENTS:  

 EXAMPLES:

 BUGS: 
   The Kurucz models we are using have not been fully tested.  Do they 
   yield reliable broad band fluxes at all T_eff &amp; [Fe/H]??

   The mean flux calib vector produced by the PCA sometimes shows abrupt
   jumps in flux -- this is somewhat mitigated by the spline fit.

 PROCEDURES CALLED:
   bspline_bkpts()
   bspline_iterfit()
   bspline_valu()
   djs_iterstat()
   djs_median()
   pca_solve
   skymask()
   spdata2model_ratio

 INTERNAL SUPPORT ROUTINES

 REVISION HISTORY:
   12-Aug-2003  Split off corvector creation into &quot;spdata2model&quot;
   22-Sep-2002  Revised to use Kurucz models by C. Tremonti, JHU
   08-Sep-2000  Formerly newfluxcalib Written by D. Schlegel &amp; S. Burles
</pre>
<p><strong>(See pro/fluxfix/pca_flux_standard.pro)</strong></p>
<hr />
<h3 id="PCA_GAL">PCA_GAL</h3>
<p><a href="#PCA_FLUX_STANDARD">[Previous Routine]</a></p>
<p><a href="#PCA_GAL_DEV">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   pca_gal

 PURPOSE:
   Wrapper on pca_solve.pro

 CALLING SEQUENCE:
   pca_gal, [inputfile=inputfile], [wavemin=wavemin], [wavemax=wavemax], $
            [binsz=binsz], [niter=niter], [savefile=savefile], [/flux]

 INPUTS:
   None

 OPTIONAL INPUTS:
   inputfile - File containing plate, mjd, fiber, redshift.  If not
               specified, it will read eigeninput_gal.dat from
               $IDLSPEC2D_DIR/templates
   wavemin   - minimum wavelength, default 1850 A.
   wavemax   - maximum wavelength, default 9300 A.
   binsz     - Override the bin size of the final wavelength mapping.
   flux      - Plot redshift-shifted spectra.
   niter     - Number of iterations to pass to pca_solve, default 10.
   savefile  - Save the input spectra to a named file for debugging.

 OUTPUTS:
   None, but creates the files spEigenGal-MJD.fits &amp; spEigenGal-MJD.ps

 DATA FILES:
   $IDLSPEC2D_DIR/templates/eigeninput_gal.dat

 PROCEDURES CALLED:
   get_juldate
   dfpsplot
   djs_readcol
   readspec
   skymask()
   wavevector()
   pca_solve()
   djs_median()
   djs_plot
   djs_oplot
   djs_xyouts
   sxaddpar
   mwrfits
   dfpsclose

 REVISION HISTORY:
   Written a long time ago.
   Updated for BOSS inputs by B. A. Weaver, NYU

 VERSION:
   $Id: pca_gal.pro 124695 2011-05-26 18:56:10Z weaver $

</pre>
<p><strong>(See pro/spec1d/pca_gal.pro)</strong></p>
<hr />
<h3 id="PCA_GAL_DEV">PCA_GAL_DEV</h3>
<p><a href="#PCA_GAL">[Previous Routine]</a></p>
<p><a href="#PCA_LRGTEST">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>

 NAME: pca_gal_dev

 PURPOSE: Developmental PCA of BOSS Galaxies

 WRITTEN: bolton@utah 2010may

</pre>
<p><strong>(See pro/templates/pca_gal_dev.pro)</strong></p>
<hr />
<h3 id="PCA_LRGTEST">PCA_LRGTEST</h3>
<p><a href="#PCA_GAL_DEV">[Previous Routine]</a></p>
<p><a href="#PCA_QSO">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   pca_lrgtest

 PURPOSE:
   Build PCA templates for LRGs within a specified redshift range.

 CALLING SEQUENCE:
   pca_lrgtest, [ platenums, nkeep=, zrange= ]

 INPUTS:

 OPTIONAL INPUTS:
   platenums  - Plate number(s) from which to select the LRGs; if not set,
                then select all 'main' survey plates with QSURVEY=1
                in the plate list file (which are required to be unique
                tiles with good quality observations)
   nkeep      - Number of PCA templates to keep (and to use for
                noisy data replacement); default to 2.
   zrange     - 2-element array with redshift range for fitting; if not set,
                then call this routine iteratively with redshift ranges
                starting at [0,0.05] and extending to [0.45,0.50], spaced
                every 0.05 in redshift.

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The output are written to FITS files named &quot;spLRG_xxx_yyy.fits&quot; where
   &quot;xxx&quot; is the starting redshift times 100, and &quot;yyy&quot; is the ending
   redshift times ten.

 EXAMPLES:
   Create a set of PCA templates for LRGs from plates 400 through 409:
     IDL&gt; pca_lrgtest, 400+lindgen(10)

 BUGS:

 PROCEDURES CALLED:
   djs_maskinterp()
   djs_median
   mwrfits
   pca_solve()
   platelist
   readspec
   splog
   skymask()
   sxaddhist
   sxaddpar
   wavevector()

 REVISION HISTORY:
   23-Mar-2001  Written by David Schlegel, Princeton.
   17-Sep-2003  Modified for N. Padmanabhan
</pre>
<p><strong>(See pro/spec1d/pca_lrgtest.pro)</strong></p>
<hr />
<h3 id="PCA_QSO">PCA_QSO</h3>
<p><a href="#PCA_LRGTEST">[Previous Routine]</a></p>
<p><a href="#PCA_QSO_DEV">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   pca_qso

 PURPOSE:
   Wrapper on pca_solve.pro

 CALLING SEQUENCE:
   pca_qso, [inputfile=inputfile], [wavemin=wavemin], [wavemax=wavemax], $
            [binsz=binsz], [niter=niter], [savefile=savefile], [/flux], $
            [/qso]

 INPUTS:
   None

 OPTIONAL INPUTS:
   inputfile - File containing plate, mjd, fiber, redshift.  If not
               specified, it will read eigeninput_qso.dat from
               $IDLSPEC2D_DIR/templates
   wavemin   - minimum wavelength, default 460 A.
   wavemax   - maximum wavelength, default 10000 A.
   binsz     - Override the bin size of the final wavelength mapping.
   flux      - Plot redshift-shifted spectra.
   niter     - Number of iterations to pass to pca_solve, default 200.
   savefile  - Save the input spectra to a named file for debugging.
   qso       - Solve for components one at a time, instead of all at once.

 OUTPUTS:
   None, but creates the files spEigenQSO-MJD.fits &amp; spEigenQSO-MJD.ps

 DATA FILES:
   $IDLSPEC2D_DIR/templates/eigeninput_qso.dat

 PROCEDURES CALLED:
   get_juldate
   dfpsplot
   djs_readcol
   readspec
   skymask()
   wavevector()
   pca_solve()
   djs_median()
   djs_plot
   djs_oplot
   djs_xyouts
   sxaddpar
   mwrfits
   dfpsclose

 REVISION HISTORY:
   Written a long time ago.
   Updated for BOSS inputs by B. A. Weaver, NYU

 VERSION:
   $Id: pca_qso.pro 124695 2011-05-26 18:56:10Z weaver $

</pre>
<p><strong>(See pro/spec1d/pca_qso.pro)</strong></p>
<hr />
<h3 id="PCA_QSO_DEV">PCA_QSO_DEV</h3>
<p><a href="#PCA_QSO">[Previous Routine]</a></p>
<p><a href="#PCA_SOLVE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>

 NAME: pca_qso_dev

 PURPOSE: Developmental PCA routine for BOSS QSOs

 WRITTEN: bolton@utah 2010may

</pre>
<p><strong>(See pro/templates/pca_qso_dev.pro)</strong></p>
<hr />
<h3 id="PCA_SOLVE">PCA_SOLVE</h3>
<p><a href="#PCA_QSO_DEV">[Previous Routine]</a></p>
<p><a href="#PHOTO_LOADER">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   pca_solve

 PURPOSE:
   Iteratively find PCA solution for noisy or gappy spectra.

 CALLING SEQUENCE:
   res = pca_solve( objflux, objivar, objloglam, [ zfit, $
    wavemin=, wavemax=, newloglam=, $
    maxiter=, niter=, nkeep=, nreturn=, eigenval=, acoeff=, outmask=, $
    usemask=, /quiet, _EXTRA= ] )

 INPUTS:
   objflux        - Object fluxes [NPIX,NSPEC]
   objivar        - Object inverse variances [NPIX,NSPEC]

 OPTIONAL INPUTS:
   objloglam      - Object wavelengths in log10(Angstroms)
                    [NPIX] if the same wavelength mapping for all spectra,
                    or [NPIX,NSPEC] if the wavelength mappings are different.
   zfit           - Redshifts of each input spectrum [NSPEC]; if set, then
                    each input spectrum is de-redshifted to z=0.
   wavemin        - Minimum wavelength to use in PCA solution, in Angstroms;
                    default to the minimum (de-redshifted) input wavelength.
   wavemax        - Maximum wavelength to use in PCA solution, in Angstroms
                    default to the minimum (de-redshifted) input wavelength.
   newloglam      - PCA wavelength sampling in log-10(Angstroms) [NNEWPIX]
   maxiter        - Number of rejection iterations; default to 0 (no rejection)
   niter          - Number of PCA iterations; default to 10.
   nkeep          - Number of PCA components to keep in each iteration
                    and use in replacing noisy or missing data; default to 3.
   nreturn        - Number of PCA components to return; default to the same as
                    NKEEP.
   quiet          - Minimal output to splog
   _EXTRA         - Keywords for DJS_REJECT().

 OUTPUTS:
   res            - PCA spectra in rest-frame [NNEWPIX,NKEEP]

 OPTIONAL OUTPUTS:
   newloglam      - PCA wavelength sampling in log-10(Angstroms) [NNEWPIX]
   newflux        - Rebinned OBJFLUX on the wavelength-mapping NEWLOGLAM.
   newivar        - Rebinned OBJIVAR on the wavelength-mapping NEWLOGLAM.
   eigenval       - Eigenvalue for each output eigenspectra [NRETURN]
   acoeff         - PCA coefficients [NRETURN,NOBJ]
   outmask        - Output mask from DJS_REJECT() [NNEWPIX,NOBJ]
   usemask        - Number of unmasked spectra used for each pixel, so these
                    are integers in the range 0 to NSPEC [NNEWPIX]; this is
                    equivalent to TOTAL(OUTMASK,2).

 COMMENTS:
   The best-fit eigenspectra for each of the input spectra can be determined
   for object number IOBJ by ACOEFF[*,IOBJ] # RES.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   combine1fiber
   computechi2()
   djs_mean()
   djs_reject()
   splog
   wavevector()

 REVISION HISTORY:
   10-Oct-2000  Written by D. Schlegel, Princeton
   07-Jul-2003  added quiet keyword - C. Tremonti

 VERSION:
   $Id: pca_solve.pro 114103 2010-06-03 17:46:50Z kushner $

</pre>
<p><strong>(See pro/spec1d/pca_solve.pro)</strong></p>
<hr />
<h3 id="PHOTO_LOADER">PHOTO_LOADER</h3>
<p><a href="#PCA_SOLVE">[Previous Routine]</a></p>
<p><a href="#PIXELMASK_BITS">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   photo_loader

 PURPOSE:
   Write PHOTO outputs from SDSS_READOBJ() to an ASCII stream for direct input
   into Postgres

 CALLING SEQUENCE:
   photo_loader, runnum, camcol, rerun=, [ table=, /create, /clobber ]

 INPUTS:
   runnum     - Run number
   camcol     - Camera column
   rerun      - Rerun name

 OPTIONAL INPUTS:
   table      - Database table name; default to &quot;photo&quot;
   create     - If set, then assume that the database definition
                does not exist and create it
   clobber    - If set, then clobber any existing table by this name

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Unsupported IDL variable types: UINT, ULONG, ULONG64, COMPLEX, DCOMPLEX.
   IDL type BYTE is converted to a 2-byte integer.

 EXAMPLES:
   echo &quot;photo_loader,3511,1,rerun=131,/create&quot; | idl | psql foo

 BUGS:

 PROCEDURES CALLED:
   sdss_readobj()

 REVISION HISTORY:
   02-May-2003  Written by D. Schlegel and D. Hogg, Princeton.
</pre>
<p><strong>(See pro/specdb/photo_loader.pro)</strong></p>
<hr />
<h3 id="PIXELMASK_BITS">PIXELMASK_BITS</h3>
<p><a href="#PHOTO_LOADER">[Previous Routine]</a></p>
<p><a href="#PLATECEN_TEST">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   pixelmask_bits

 PURPOSE:
   Return mask value corresponding to a mask condition for either FIBERMASK
   or PIXELMASK.

 CALLING SEQUENCE:
   mask = pixelmask_bits(label)

 INPUTS:
   label      - String name specifying bit

 OUTPUTS:
   mask       - Signed long set to 2^BIT, with BIT specified by LABEL.

 OPTIONAL OUTPUTS:

 COMMENTS:
   This routine is also called by FIBERMASK_BITS().

 EXAMPLES:
   mask = pixelmask_bits('FULLREJECT') 

 BUGS:

 PROCEDURES CALLED:
   sdss_flagval()

 DATA FILES:

 REVISION HISTORY:
   23-Jan-2000 Written by S. Burles, Chicago
   27-Jan-2000 Changed from signed int to signed long.
   14-Jul-2000 Combine with FIBERMASK_BITS(), and use data file in /etc
               subdirectory (DJS).
   02-Apr-2002 Now use the even more generalized call to SDSS_FLAGVAL().
</pre>
<p><strong>(See pro/spec2d/pixelmask_bits.pro)</strong></p>
<hr />
<h3 id="PLATECEN_TEST">PLATECEN_TEST</h3>
<p><a href="#PIXELMASK_BITS">[Previous Routine]</a></p>
<p><a href="#PLATECOMPARE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   platecen_test

 PURPOSE:
   Find where RA,DEC and RADEG,DECDEG disagree in the spPlate headers.

 CALLING SEQUENCE:
   platecen_test

 INPUTS:

 OPTIONAL INPUTS:

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Find all the files matching '$BOSS_SPECTRO_REDUX/*/spPlate*.fits', and test
   whether the RA,DEC positions disagree by more than 0.1 degrees from
   RADEC,DECDEG.  This would indicate some inconsistency in the header
   info that should be fixed.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   headfits()
   splog
   sxpar()

 REVISION HISTORY:
   19-Dec-2001  Written by David Schlegel, Princeton (not checked in then)
</pre>
<p><strong>(See pro/plan/platecen_test.pro)</strong></p>
<hr />
<h3 id="PLATECOMPARE">PLATECOMPARE</h3>
<p><a href="#PLATECEN_TEST">[Previous Routine]</a></p>
<p><a href="#PLATELINKS">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   platecompare

 PURPOSE:
   Interactive comparison of descrepant redshifts for the same objects.

 CALLING SEQUENCE:
   platecompare, plate, [mjd=, run2d=, run1d=, psfile= ]

 INPUTS:
   plate       - Plate number(s)

 OPTIONAL INPUTS:
   mjd        - MJD for each plate number.  If specified, then this
                must have one MJD per plate number.  If not specified,
                then all MJD's associated with each plate are read.
                That list of MJD's comes from the PLATELIST command.
   run2d      - Names of 2D reductions if comparing different versions
                of the same data.
   run1d      - Names of 1D redutions if comparing different versions
                of the same data; must have same number of elements as RUN2D;
                if not set, then default to the same versions as RUN2D
   psfile     - If set, then send plot to a PostScript file instead of
                to the SPLOT interactive widget.  The PostScript file name
                can be set explicitly, e.g. with PSFILE='test.ps'.  Or if
                you simply set this as a flag, e.g. with /PSFILE, then the
                default file name is platecompare-pppp.ps,
                where pppp is the first plate number.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Duplicate objects are found by matching positions to within 1 arcsec.

   Plot any objects that show a descrepency in redshifts between any
   of the observations, or any objects that have ZWARNING set to zero
   in one observation and non-zero in another.

 EXAMPLES:
   Compare data from different pluggings of the same plate:
   IDL&gt; platecompare, [406,406,406], mjd=[51817,51869,51876]

   Compare date from two plates, 360 and 362, which are actually the
   same tile on the sky:
   IDL&gt; platecompare, [360,360,362], mjd=[51780,51816,51999]

   Compare different reductions of the same data, in this case plate 401/51788:
   IDL&gt; platecompare, 401, mjd=51788, run2d=['v5_4_14','v5_4_30'], $
    run1d=['v5_4_14','v5_4_30']

 BUGS:

 PROCEDURES CALLED:
   dfpsclose
   dfpsplot
   djs_angle_group
   djs_icolor()
   djs_oplot
   djs_plot
   platelist
   readspec
   sdss_flagname()
   struct_append()

 REVISION HISTORY:
   14-Aug-2001  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/platecompare.pro)</strong></p>
<hr />
<h3 id="PLATELINKS">PLATELINKS</h3>
<p><a href="#PLATECOMPARE">[Previous Routine]</a></p>
<p><a href="#PLATELIST">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   platelinks

 PURPOSE:
   Build links from another directory to the spectroscopic output files.

 CALLING SEQUENCE:
   platelinks, outdir, [ public= ]

 INPUTS:

 OPTIONAL INPUTS:
   outdir      - Directory in which to build all links.  These links are
                 built to the files in $BOSS_SPECTRO_REDUX.
   public      - If set with /PUBLIC, then build links to any files with
                 anything in the PUBLIC field of the plate list.
                 If set to a string, then select those plates that contain
                 the substring PUBLIC within their PUBLIC field.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:
   IDL&gt; platelinks, '/u/schlegel/spectro_EDR', public='EDR'

 BUGS:

 DATA FILES:

 PROCEDURES CALLED:
   djs_filepath()
   fileandpath()
   platelist
   splog

 REVISION HISTORY:
   21-Jan-2003  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/platelinks.pro)</strong></p>
<hr />
<h3 id="PLATELIST">PLATELIST</h3>
<p><a href="#PLATELINKS">[Previous Routine]</a></p>
<p><a href="#PLATEMERGE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   platelist

 PURPOSE:
   Make list of reduced plates

 CALLING SEQUENCE:
   platelist, [ /create, topdir=, outdir=, run2d=, run1d=, $
    /purge2d, /purge1d, /killpartial, skipcart=, /rawsn2, plist= ]

 INPUTS:

 OPTIONAL INPUTS:
   create      - If set, then re-generate the &quot;platelist.fits&quot; file;
                 if not set, then simply read this file from a previous call.
   topdir      - Optional override value for the environment
                 variable $BOSS_SPECTRO_REDUX.
   outdir      - Optional override of both topdir and $BOSS_SPECTRO_REDUX
                 for output directory location
   run2d       - Optional RUN2D subdirectories to include in outputs;
                 set to '' to not search subdirectories; default to '*'
   run1d       - Optional RUN1D subdirectories to include in outputs
                 set to '' to not search subdirectories; default to '*'
   purge2d     - If set, then delete all log files for plates that are
                 considered to be 'RUNNING', but not those that are 'Done',
                 'Pending' or 'FAILED'.  Those plates are then listed as
                 'Pending'.  Setting /PURGE2D also sets /CREATE.
                 Deleting these log files will cause the next invocation
                 of BATCH2D to re-reduce those plates.
   purge1d     - If set, then delete all log files for plates that are
                 considered to be 'RUNNING', but not those that are 'Done',
                 'Pending' or 'FAILED'.  Those plates are then listed as
                 'Pending'.  Setting /PURGE1D also sets /CREATE.
                 Deleting these log files will cause the next invocation
                 of BATCH1D to re-reduce those plates.
   killpartial - If set, then delete all files associated with a combine
                 of only some nights of a multi-night plate.  Such files
                 can be produced by the Spectro-Robot when it fully reduces
                 data from one night, but then more data is obtained for
                 that plugging of the same plate on a later date.  This
                 deletes spPlate and spZ files and their logs files.
   skipcart    - cart number or list of cart numbers to drop from platelist
   rawsn2      - If set, output original raw SN2 numbers in html and text
                 files; otherwise use dereddened (dust extinction corrected)
                 values.  Both are always written to the FITS file output.

 OUTPUTS:

 OPTIONAL OUTPUTS:
   plist       - Output structure with information for each plate.

 COMMENTS:
   The following files are generated:
     $BOSS_SPECTRO_REDUX/platelist.fits
     $BOSS_SPECTRO_REDUX/platelist.txt
     $BOSS_SPECTRO_REDUX/platelist.html
     $BOSS_SPECTRO_REDUX/platelist-mjdsort.txt
     $BOSS_SPECTRO_REDUX/platelist-mjdsort.html
     $BOSS_SPECTRO_REDUX/platequality.txt
     $BOSS_SPECTRO_REDUX/platequality.html
     $BOSS_SPECTRO_REDUX/platequality-mjdsort.txt
     $BOSS_SPECTRO_REDUX/platequalitymjdsort.html

   If INFILE is a list of plan files, i.e.
     spPlancomb-0306-51690.par
   then look for the following files for the 2D reductions:
     spPlancomb-0306-51690.par
     spDiagcomb-0306-51690.log
     spPlan2d-0306-51690.par (as specified by 'planfile2d' in spPlancomb)
     spDiag2d-0306-51690.log
     spPlate-0306-51690.fits (as specified by 'combinefile' in spPlancomb)
   and look for the following files for the 1D reductions:
     spPlan1d-0306-51690.par
     spZbest-0306-51690.fits
     spDiag1d-0306-51690.log

   PLATESN2 is set to the minimum of the 4 cameras.
   DEREDSN2 like PLATESN2, but with dereddened SN2 values
   PLATEQUALITY defaults to 'good'.
   PLATEQUALITY is set to 'bad'      if MINSN2(B) &lt; 10.0 or MINSN2(R) &lt; 22.0
                                     --&gt; previously if MINSN2 &lt; 13.0
   PLATEQUALITY is set to 'bad'      if FBADPIX &gt; 0.10
   PLATEQUALITY is set to 'bad'      if min(NEXP_*) &lt; 3

   Decide which plates constitute unique tiles with the required S/N,
   then set QSURVEY=1.  Require PLATEQUALITY='good'.
   Also require PROGNAME='main'.

 EXAMPLES:

 BUGS:
   Spawns the Unix commands 'tail' and 'grep', which is very slow.
   If the spPlate file is missing, it doesn't try to figure out which
        cart it really is and thus ignores skipcart

 DATA FILES:
   $PLATELIST_DIR/platePlans.par
   $SPECLOG_DIR/opfiles/spPlateList.par

 PROCEDURES CALLED:
   apo_checklimits()
   chunkinfo()
   copy_struct_inx
   djs_diff_angle()
   djs_filepath()
   fileandpath()
   headfits()
   mrdfits()
   repstr()
   rmfile
   splog
   struct_print
   sxpar()
   tai2airmass()
   yanny_free
   yanny_par()
   yanny_read
   yanny_readone()

 INTERNAL SUPPORT ROUTINES:
   platelist_write

 REVISION HISTORY:
   29-Oct-2000  Written by D. Schlegel, Princeton
   11-Jan-2011  Stephen Bailey, LBNL
     * Updated (S/N)^2 thresholds for &quot;bad&quot;
     * Added get_lastline to be faster than spawn tail -1
</pre>
<p><strong>(See pro/spec1d/platelist.pro)</strong></p>
<hr />
<h3 id="PLATEMERGE">PLATEMERGE</h3>
<p><a href="#PLATELIST">[Previous Routine]</a></p>
<p><a href="#PLATESN">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   platemerge

 PURPOSE:
   Merge all Spectro-1D outputs with photoPosPlate,spInspect files

 CALLING SEQUENCE:
   platemerge, [ plate=, mjd=, except_tags=, indir=, outroot=, $
    run2d=, /include_bad, /calc_noqso, /skip_line ]

 INPUTS:

 OPTIONAL INPUTS:
   plate       - Plates to include; default to all files
                 specified by the PLATELIST routine.
   mjd         - Optional MJDs corresponding to the specified PLATEs;
                 if specified, then PLATE and MJD should have the same
                 number of elements.
   except_tags - Tag names to exclude; default to '*COVAR'.
   indir       - Input directory with platelist.fits file; passed to
                 platelist topir option which defaults to $BOSS_SPECTRO_REDUX
   outroot     - Root name for output files; default to
                 $BOSS_SPECTRO_REDUX/$RUN2D/spAll; the files are then
                 spAll-$RUN2D.fits, spAll-$RUN2D.dat, spAllLine-$RUN2D.dat.
   run2d       - List of RUN2D subdirectories to merge, one set of output
                 files per name in $RUN2D; default to all values of RUN2D
                 returned by PLATELIST.
   include_bad  - If set, then include bad plates
   calc_noqso  - If set, then also include redshift info for best non-QSO
                 redshift fits.  Defaults to being set.
   skip_line    - If set, skip the generation of spAllLine.fits


 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Depends upon the platelist.fits file written by PLATELIST.
   Trims to only 'good' plates, or those in a public data release.

   The SPECPRIMARY output element is used to select a unique set of
   objects in the case of duplicate observations.  Any objects observed
   multiple times will have SPECPRIMARY=1 for one instance only, and =0
   for all other instances.  The criteria (in order of importance) are
   as follows:
     1) Prefer observations with positive SN_MEDIAN in r-band
     2) Prefer PLATEQUALITY='good' over any other plate quality
     3) Prefer observations with ZWARNING=0
     4) Prefer objects with larger SN_MEDIAN in r-band

   Temporary files are created first, such as 'spAll.fits.tmp', which
   are renamed at the end of the routine to 'spAll.fits', etc.

 EXAMPLES:

 BUGS:

 DATA FILES:

 PROCEDURES CALLED:
   copy_struct
   copy_struct_inx
   djs_filepath()
   headfits()
   hogg_mrdfits()
   mrdfits()
   mwrfits_chunks
   platelist
   readspec
   repstr
   spheregroup
   splog
   struct_print
   sxaddpar
   sxpar()

 REVISION HISTORY:
   30-Oct-2000  Written by D. Schlegel, Princeton
   29-Jul-2010  Added EXCLUDE_CLASS and SKIP_LINE, A. Bolton, Utah
   17-Mar-2011  Changed EXCLUDE_CLASS behavior, A. Bolton, Utah
   30-Jun-2011  Changed EXCLUDE_CLASS to more specific and correct
                CALC_NOQSO, including proper rchi2diff, A. Bolton, Utah
</pre>
<p><strong>(See pro/spec1d/platemerge.pro)</strong></p>
<hr />
<h3 id="PLATESN">PLATESN</h3>
<p><a href="#PLATEMERGE">[Previous Routine]</a></p>
<p><a href="#PLATE_NEWCENTER">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   platesn

 PURPOSE:
   Generate S/N plots for an entire plate.

 CALLING SEQUENCE:
   platesn, [ objflux, objivar, andmask, plugmap, loglam, $
    filtsz=, hdr=, platefile=, plotfile=, snvec=, synthmag= ]

 INPUTS:

 OPTIONAL KEYWORDS:
   objflux    - 
   objivar    - 
   andmask    - 
   plugmap    - 
   loglam     - 
   filtsz     - Filter size for median-filtering the S/N values within
                a spectrum; default to 25 pix.
   hdr        - FITS header; if specified, then keywords are added.
                The PLATE and MJD for the plot title are from this header.
   platefile  - If set, then read OBJFLUX and all the other inputs from
                this spPlate file instead of using those inputs;
                also, generate PostScript plots using the PLATESN procedure.
   plotfile   - If set, then write PostScript plot to this file.

 OUTPUTS:

 OPTIONAL OUTPUTS:
   hdr            - [Modified]
   snvec          - S/N vector for g,r,i bands
   synthmag       - Synthetic magnitudes from convolution with fiducial
                    filter curves 

 COMMENTS:
   
 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_iterstat
   djs_mean()
   djs_median()
   filter_thru()
   pixelmask_bits()
   plotsn
   sdss_flagval()
   sdss_flagname()
   splog
   sxaddpar
   sxpar()

 REVISION HISTORY:
   06-Oct-2000  Written by S. Burles &amp; D. Schlegel
   20-Oct-2002  C. Tremonti added header keywords to access spectrophotometry
</pre>
<p><strong>(See pro/spec2d/platesn.pro)</strong></p>
<hr />
<h3 id="PLATE_NEWCENTER">PLATE_NEWCENTER</h3>
<p><a href="#PLATESN">[Previous Routine]</a></p>
<p><a href="#PLATE_ROTATE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   plate_newcenter

 PURPOSE:
   Find the new plate center when trying to put an object at the same
   position relative to the center.

 CALLING SEQUENCE:
   plate_rotate, racen1, deccen1, racen2, deccen2, ra1, dec1, ra2, dec2, $
    [maxerr= ]

 INPUTS:
   racen1, deccen1  - Center of pointing 1
   ra1, dec1        - positions on plate 1
   ra2, dec2        - positions on plate 2

 OPTIONAL INPUTS:
   maxerr           - Maximum error in arcsec; default to 0.01 arcsec

 OUTPUTS:
   racen2, deccen2  - Center of pointing 2

 COMMENTS:
   This routine is complementary to PLATE_ROTATE, solving for a
   different unknown (the 2nd plate center).

 BUGS:

 REVISION HISTORY:
   2001-Nov-27  Written by D. Schlegel, Princeton.
</pre>
<p><strong>(See pro/plate/plate_newcenter.pro)</strong></p>
<hr />
<h3 id="PLATE_ROTATE">PLATE_ROTATE</h3>
<p><a href="#PLATE_NEWCENTER">[Previous Routine]</a></p>
<p><a href="#PLATE_SPEC_IMAGE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   plate_rotate

 PURPOSE:
   Rotate (RA, dec) positions for one plate center to another plate center

 CALLING SEQUENCE:
   plate_rotate, racen1, deccen1, racen2, deccen2, ra1, dec1, ra2, dec2

 INPUTS:
   racen1, deccen1  - Center of pointing 1
   racen2, deccen2  - Center of pointing 2
   ra1, dec1        - positions on plate 1

 OUTPUTS:
   ra2, dec2        - positions on plate 2

 COMMENTS:
   This routine determines the rotation that maps (racen1, deccen1)
    onto (racen2, deccen2), and applies it to (ra1, dec1) (which may
    be vectors.  By convention, North is &quot;up&quot; on both plates 1 &amp; 2. 

   This routine is useful for the bright stars survey, where one must
    drill holes for several pointings in the same plate. 

 BUGS:

 REVISION HISTORY:
   2001-Sep-07  Written by D. Finkbeiner, Princeton.

</pre>
<p><strong>(See pro/plate/plate_rotate.pro)</strong></p>
<hr />
<h3 id="PLATE_SPEC_IMAGE">PLATE_SPEC_IMAGE</h3>
<p><a href="#PLATE_ROTATE">[Previous Routine]</a></p>
<p><a href="#PLOTSIGNAL">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   plate_spec_image
 PURPOSE:
   Create spectroscopic images for a plate
 CALLING SEQUENCE:
   plate_spec_image, plate, mjd=, run2d=, run1d=, topdir=
 INPUTS
  plate - plate #
  mjd - MJD of observation
 OPTIONAL INPUTS:
  run1d - 1d rerun number ('' by default)
  run2d - 2d rerun number ('' by default)
  topdir - directory to use instead of $BOSS_SPECTRO_REDUX
  xra - [2] wavelength range to plot (Ang)
 COMMENTS:
  Creates files in:
     $BOSS_SPECTRO_REDUX/images/[run2d]/[run1d]/[plate4]-[mjd]
  with the naming convention:
     spec-image-[plate4]-[mjd]-[fiber4].png
     spec-image-[plate4]-[mjd]-[fiber4].thumb.png
  Also creates an index.html file which is just a table of
  the thumbnails.
 REVISION HISTORY:
   15-May-2009  by M. Blanton, NYU
 VERSION:
   $Id: plate_spec_image.pro 128066 2011-10-31 18:33:22Z boss $
</pre>
<p><strong>(See pro/spec1d/plate_spec_image.pro)</strong></p>
<hr />
<h3 id="PLOTSIGNAL">PLOTSIGNAL</h3>
<p><a href="#PLATE_SPEC_IMAGE">[Previous Routine]</a></p>
<p><a href="#PLOTSN">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   plotsignal

 PURPOSE:
   Plot the signal (not S/N) seen on each plate+exposure+CCD.

 CALLING SEQUENCE:
   plotsignal, plate, [ expnum, camname=, /addsky ]

 INPUTS:
   plate      - Plate number

 OPTIONAL INPUTS:
   expnum     - Exposure number(s); default to all exposures that have
                an spFrame-b1 file on disk
   camname    - Camera name(s); default to ['b2','r2','b1','r1']
   addsky     - If set, then add the sky signal back in, rather than
                using the sky-subtracted signal

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Most of our diagnostic plots show the S/N of the spectrographs.
   These plots show the signal, and provide plots for each exposure.

   One PostScript file is produced, with one page with one page per
   exposure number.  The file names are:
     spSignal-$PLATE.ps
     spSignal-$PLATE-addsky.ps -- If /ADDSKY is specified

   The spectro magnitudes are scaled to the 1st exposure on each
   plate+MJD+camera combination.  There is a simple scaling for the
   exposure time, but otherwise more-cloudy exposures will show as
   negative (red) residuals.

   This plots the signal after sky-subtraction, unless /ADDSKY is set.

 EXAMPLES:
   Plot the signal seen on all exposures for plate 1489:
     IDL&gt; plotsignal, 1489

 BUGS:

 PROCEDURES CALLED:
   bspline_valu()
   dfpsclose
   dfpsplot
   djs_filepath()
   djs_oplot
   djs_plot
   djs_xyouts
   filter_thru()
   mrdfits()
   splog
   sxpar()
   traceset2xy

 REVISION HISTORY:
   30-Dec-2003  Written by D. Schlegel, Princeton.
</pre>
<p><strong>(See pro/spec2d/plotsignal.pro)</strong></p>
<hr />
<h3 id="PLOTSN">PLOTSN</h3>
<p><a href="#PLOTSIGNAL">[Previous Routine]</a></p>
<p><a href="#PLOTSPEC">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   plotsn

 PURPOSE:
   Plot S/N and residuals in up to 3 bands

 CALLING SEQUENCE:
   plotsn, snvec, plugmap, [ filter=, plotmag=, plottitle=, snmin=, $
    plotfile=, synthmag=, snplate=, dered_snplate=, specsnlimit=, _EXTRA= ]

 INPUTS:
   snvec      - S/N array [NBAND,NFIBER]
   plugmap    - Plugmap structure [NFIBER]

 OPTIONAL KEYWORDS:
   filter     - Filter names; default to 'g','r','i'
   plotmag    - Magnitude range for plotting; default to [16,23], but
                extend the range to include FITMAG if necessary.
   snmin      - Minimum S/N value to use in fits; default to 0.5
   plottitle  - Title for top of plot
   plotfile   - Optional plot file
   synthmag   - Vector of synthetic magnitudes dimensionsed [5,NFIBER];
                if set, then make more than the first page of plots
   _EXTRA     - Keywords for FITSN, such as SNCODE

 OUTPUTS:

 OPTIONAL OUTPUTS:
   snplate    - Best fit (S/N)^2 at fiducial magnitude(s); array of [2,NBAND]
                to give the number in each spectrograph and each filter
   dered_snplate - Best fit (S/N)^2 extinction corrected like SOS pipeline
   specsnlimit- Returned from FITSN

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_arrow
   djs_icolor()
   djs_iterstat
   djs_oplot
   djs_plot
   djs_xyouts
   fitsn()
   splog

 INTERNAL SUPPORT ROUTINES:
   plotsn_good()
   plotsn1

 REVISION HISTORY:
   28-Jan-2003  Add E(B-V) keyword to allow for spectra which have 
                foreground reddening removed
   20-Oct-2002  Plot range on synthmag vs fiber mag plot changed by C. Tremonti
   15-Apr-2000  Written by S. Burles, FNAL
</pre>
<p><strong>(See pro/spec2d/plotsn.pro)</strong></p>
<hr />
<h3 id="PLOTSPEC">PLOTSPEC</h3>
<p><a href="#PLOTSN">[Previous Routine]</a></p>
<p><a href="#PLOTSPECQA">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   plotspec

 PURPOSE:
   Routine for plotting spectra from Princeton-1D spectro outputs.

 CALLING SEQUENCE:
   plotspec, plate, [ fiberid, mjd=, znum=, zmanual=, $
    nsmooth=, /zline, /nosyn, /noerr, $
    /sky, /ormask, /andmask, psfile=, /restframe, /netimage, $
    /zwarning, /allexp, _EXTRA= ]

 INPUTS:
   plate      - Plate number(s)

 OPTIONAL INPUTS:
   fiberid    - Fiber number(s); if not set, then plot all fibers for
                each plate specified.
   mjd        - MJD number(s); if not set, then select the most recent
                data for each plate (largest MJD).
   znum       - If set, then return not the best-fit redshift, but the
                ZUM-th best-fit; e.g., set ZNUM=2 for second-best fit.
   zmanual    - If set, then do an on-the-fly fit to either a galaxy
                template (if ZMANUAL[0]&lt;1) or QSO (if ZMANUAL[0]&gt;=1),
                overriding ZNUM.  If this is a 2-element array, then fit
                between all redshifts in the range [ZMANUAL[0],ZMANUAL[1]].
                Do not include any polynomial terms with the PCA templates.
   nsmooth    - If set, then boxcar smooth both the object and synthetic
                spectra with a width equal to NSMOOTH.
   zline      - If set, then overplot the emission line fits.
   nosyn      - If set, then do not overplot the synthetic fit spectrum (blue).
   noerr      - If set, then do not overplot the error vector (red).
   sky        - If set, then overplot the sky spectrum (green).
   ormask     - If set, then plot the OR-mask bits in yellow crosses.
   andmask    - If set, then plot the AND-mask bits in red squares.
   psfile     - If set, then send plot to a PostScript file instead of
                to the SPLOT interactive widget.  The PostScript file name
                can be set explicitly, e.g. with PSFILE='test.ps'.  Or if
                you simply set this as a flag, e.g. with /PSFILE, then the
                default file name is &quot;spec-pppp-mmmmm-fff.ps&quot;,
                where pppp=plate number, mmmmm=MJD, fff=fiber ID.
                If FIBERID is specified, then put all plots in a single file
                named &quot;spec-pppp-mmmmm.ps&quot;.
   restframe  - If set, then plot the wavelengths in the rest frame,
                e.g. divide the wavelengths by (1+z).
   netimage   - If set, then launch a Netscape browser with the object
                image from Steve Kent's web site.  This only works if
                Netscape is running and has permissions at the site
                &quot;http://sdssmosaic.fnal.gov:8015&quot;. ???
                This is disabled if PSFILE is set.
   zwarning   - If set, then only select those non-sky fibers where the
                ZWARNING flag has been set; can be used with or without
                specifying fiber numbers with FIBERID.
   allexp     - If set, then plot all the individual exposure spectra,
                rather than the co-added spectrum.
   _EXTRA     - Keywords for SPLOT and XYOUTS, such as XRANGE, YRANGE, THICK,
                or keywords for READSPEC and READONESPEC such as TOPDIR,
                RUN2D, RUN1D.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The data are read with READSPEC.  See the documentation for that
   routine to see how to set environment variables that describe where
   the data files are.

 EXAMPLES:
   Plot the spectrum of plate 401, fiber #100 using the SPLOT plotting tool:
     IDL&gt; plotspec, 401, 100

   The spectrum is shown in white, the errors in red (except masked points
   are set to zero), and the best-fit eigenspectrum in blue. The mouse
   buttons will zoom in (left), recenter (center), or zoom out (right).
   The frame can be saved as a PostScript file by selecting File-&gt;WriteEPS
   from the left-hand corner. 

   Make the same plot, but boxcar-smooth the spectrum and limit the
   wavelength range to [4000,5000] Angstroms:
     IDL&gt; plotspec, 401, 100, nsmooth=10, xrange=[5000,6000]

   Some plates are observed on multiple nights. To select one of the two
   observations of plate 306: 
     IDL&gt; plotspec, 306, 20, mjd=51690

   Loop through all the spectra for plate 401, interactively:
     IDL&gt; plotspec, 401

   Plot all the spectra from plate 401 to a single PostScript file:
     IDL&gt; plotspec, 401, /psfile

   Plot all the spectra from plate 401 to 640 individual PostScript files:
     IDL&gt; plotspec, 401, lindgen(640)+1, /psfile

   Plot a list of 3 objects, each with its own plate, MJD, and fiberid:
     IDL&gt; plate = [400,400,401]
     IDL&gt; mjd = [51820,51820,51788]
     IDL&gt; fiberid = [10,11,20]
     IDL&gt; plotspec, plate, mjd=mjd, fiberid

 BUGS:
   If the user interactively rescales in Y, then the labels for ORMASK
   and ANDMASK are no longer lined up vertically with the bit mask plot.

 PROCEDURES CALLED:
   dfpsclose
   dfpsplot
   djs_icolor()
   djs_oplot
   djs_plot
   djs_xyouts
   plotspec_image
   readspec
   soplot
   splot
   sdss_flagname()
   sxyouts
   synthspec()
   textoidl()

 INTERNAL SUPPORT ROUTINES:
   plotspec_mask
   plotspec1

 REVISION HISTORY:
   01-Sep-2000  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/plotspec.pro)</strong></p>
<hr />
<h3 id="PLOTSPECQA">PLOTSPECQA</h3>
<p><a href="#PLOTSPEC">[Previous Routine]</a></p>
<p><a href="#PLOTSPEC_IMAGE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   plotspecqa

 PURPOSE:
   Wrapper for PLOTSPEC to plot standard stars and/or sky spectra.

 CALLING SEQUENCE:
   plotspecqa, [ /standards, /skies, _EXTRA= ]

 INPUTS:
   plate      - Plate number(s)

 OPTIONAL INPUTS:
   standards  - Select standard stars for plotting
   skies      - Select sky spectra for plotting
   _EXTRA     - Kewords for PLOTSPEC

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   plotspec
   readspec
   splog

 REVISION HISTORY:
   15-Mar-2006  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/plotspecqa.pro)</strong></p>
<hr />
<h3 id="PLOTSPEC_IMAGE">PLOTSPEC_IMAGE</h3>
<p><a href="#PLOTSPECQA">[Previous Routine]</a></p>
<p><a href="#PLUG2TSOBJ">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   plotspec_image

 PURPOSE:
   Procedure to display an image, launched from PLOTSPEC

 CALLING SEQUENCE:
   plotspec_image, ra, dec, [ _EXTRA= ]

 INPUTS:
   ra         - Right ascension (degrees)
   dec        - Declination (degrees)

 OPTIONAL INPUTS:
   _EXTRA     - Keywords to pass to FPBIN_TO_FRAME

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   atv
   fpbin_to_frame()

 REVISION HISTORY:
   30-Sep-2005  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/plotspec_image.pro)</strong></p>
<hr />
<h3 id="PLUG2TSOBJ">PLUG2TSOBJ</h3>
<p><a href="#PLOTSPEC_IMAGE">[Previous Routine]</a></p>
<p><a href="#PLUGFILE_DIFF">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   plug2tsobj

 PURPOSE:
   Read photoPosPlate structure of imaging data for a plate

 CALLING SEQUENCE:
   tsobj = plug2tsobj(plateid, [ra, dec, mjd=, indir=, $
    dmin=, /silent ])

 INPUTS:
   plateid    - Plate number (scalar)

 OPTIONAL INPUTS:
   ra         - Array of right ascension (degrees)
   dec        - Array of declination (degrees)
   mjd        - MJD of observation; if set and there is a photoPosPlate file
                for that plate+MJD, then no coordinates need be specified
                with RA, DEC
   indir      - Input directory name for file; default to
                $BOSS_SPECTRO_REDUX/$RUN2D/$PLATE
   dmin       - Minimum separation between input position and position
                of the closest match using MATCHRA,MATCHDEC in the calibObj
                files; default to 2.0 arcsec.

 OUTPUTS:
   tsobj      - tsObj structure; return 0 if no photoPosPlate files found

 OPTIONAL OUTPUTS:
   silent     - Make the call to MRDFITS silent, but still log warning
                messages if the calibObj file is not found or is empty.

 COMMENTS:
   Prefer file
    $BOSS_SPECTRO_REDUX/$RUN2D/$PLATE/$RESOLVE_DIR/photoPosPlate-$PLATE-$MJD.fits
   If not found, then search for file
    $BOSS_SPECTRO_REDUX/calibobj/calibPlateP-$PLATE.fits
   The calibPlateP files must be resorted.

   Print a warning message for non-matched objects only if they are not skies,
   according to the PLUGMAP structure.

 EXAMPLES:
   Read the plug-map for plate 3690 MJD 55182:
   &gt; tsobj = plug2tsobj(3690, mjd=55182)

 BUGS:

 PROCEDURES CALLED:
   djs_diff_angle()
   fits_read
   mrdfits
   splog

 REVISION HISTORY:
   25-Jun-2000  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/spec1d/plug2tsobj.pro)</strong></p>
<hr />
<h3 id="PLUGFILE_DIFF">PLUGFILE_DIFF</h3>
<p><a href="#PLUG2TSOBJ">[Previous Routine]</a></p>
<p><a href="#PLUGFILE_RELABEL">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   plugfile_diff

 PURPOSE:
   Find instances where the plPlugMapM file in the speclog file differs
   from what was used in the reductions.

 CALLING SEQUENCE:
   plugfile_diff, [ run2d=, run1d= ]

 INPUTS:

 OPTIONAL INPUTS:
   run2d       - Limit the platelist to this version of the 2D reductions

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Only plates that completed reductions are considered.
   Generate a FITS file 'plugfile_diff.fits' containing all of objects
   that have had their plugging changed.  File contains:
     HDU #1 - ZANS structure for those objects
     HDU #2 - PLUGMAP info used for reductions
     HDU #3 - PLUGMAP info currently in speclog product

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   platelist
   readspec
   splog

 REVISION HISTORY:
   21-Apr-2011  Written by David Schlegel, LBL
</pre>
<p><strong>(See pro/plan/plugfile_diff.pro)</strong></p>
<hr />
<h3 id="PLUGFILE_RELABEL">PLUGFILE_RELABEL</h3>
<p><a href="#PLUGFILE_DIFF">[Previous Routine]</a></p>
<p><a href="#PLUGFILE_UNMAPPED">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   plugfile_relabel

 PURPOSE:
   Relabel the OBJTYPE's for specified objects in all plPlugMapM files.

 CALLING SEQUENCE:
   plufile_relabel, [ infile, objtype= ]

 INPUTS:

 OPTIONAL INPUTS:
   infile     - ASCII file with plate, mjd, fiberid, as written
                by BADFSTARS (for example); default to 'badfstars.log'
   objtype    - New OBJTYPE for these objects; default to 'SERENDIPITY_MANUAL'

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   This procedure was written to get rid of objects from the plPlugMapM
   files that were incorrectly being used as F star calibrators
   (either SPECTROPHOTO_STD or REDDEN_STD targets).  For a specified list
   of objects, this proc changes the OBJTYPE to 'SERENDIPITY_MANUAL'.
   Note that the target flags are not changed, since they are not used
   anyway by Spectro-2D.  This means that we will still have the 2 or 32
   values set in SECTARGET.

   For the input list of objects, I use READSPEC to find the coordinates
   of the object, and then the object is changed in all the plPlugMapM
   files for that plate.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_diff_angle()
   readspec
   splog
   yanny_read
   yanny_write

 REVISION HISTORY:
   06-Feb-2004  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/plan/plugfile_relabel.pro)</strong></p>
<hr />
<h3 id="PLUGFILE_UNMAPPED">PLUGFILE_UNMAPPED</h3>
<p><a href="#PLUGFILE_RELABEL">[Previous Routine]</a></p>
<p><a href="#PLUGHISTORY">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   plugfile_unmapped

 PURPOSE:
   List which fibers in a plPlugMapM file are unmapped, and the info
   that might help decide where those fibers should be.

 CALLING SEQUENCE:
   plugfile_unmapped, filename

 INPUTS:
   filename    - Look for a plPlugMapM file in the speclog directory
                 matching $SPECLOG_DIR/?????/FILENAME.

 OPTIONAL INPUTS:

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:
   There are two lists of information provided: First, the list of fiber
   numbers that are not plugged, and the RA,DEC ranges of the other 19 fibers
   in that bundle on this plate.  Second, a list of the object information
   for the unplugged objects, including their RA,DEC position and the fiber
   numbers of the nearest plugged fibers.

   Presumably, those unplugged objects will be plugged by one of the fibers
   whose neighboring fiber numbers are nearby.  This isn't necessarily true,
   for example if the pluggers simply skipped one fiber entirely while
   plugging, and the unplugged object is in a completely un-reachable
   position elsewhere on the plate.

   A companion procedure to this is FIND_UNPLUGGED.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_diff_angle()
   splog
   yanny_readone()

 REVISION HISTORY:
   10-Sep-2003  Written by David Schlegel, Princeton (not checked in then)
</pre>
<p><strong>(See pro/plan/plugfile_unmapped.pro)</strong></p>
<hr />
<h3 id="PLUGHISTORY">PLUGHISTORY</h3>
<p><a href="#PLUGFILE_UNMAPPED">[Previous Routine]</a></p>
<p><a href="#PLUGMAP_REPLACE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   plughistory

 PURPOSE:
   Plot the history of unplugged fibers based upon plPlugMapM files.

 CALLING SEQUENCE:
   plughistory, [ mjdrange= ]

 INPUTS:

 OPTIONAL INPUTS:
   mjdrange   - 2-element vector of plotting range in MJD; default to
                using all MJDs.

 OUTPUT:

 COMMENTS:
   A single PostScript file is created &quot;Plughistory-$MJDSTART-$MJDEND.ps&quot;,
   with one page per cartridge.  The top panel shows the number of fibers
   plugged as a function of MJD.  The bottom panel shows the fraction
   of times each fiber is plugged, with &lt; 90%-plugged fibers labelled
   with their fiber number.

 EXAMPLES:
   Make plots of history of unplugged fibers for all time:
     IDL&gt; plughistory

   Make plots of history of unplugged fibers between MJD 52000 and MJD 52100:
     IDL&gt; plughistory, mjdrange=[52000,52100]

 BUGS:

 PROCEDURES CALLED:
   dfpsclose
   dfpsplot
   fileandpath()
   yanhy_free
   yanny_par()
   yanny_read

 REVISION HISTORY:
   27-Feb-2002  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/apo2d/plughistory.pro)</strong></p>
<hr />
<h3 id="PLUGMAP_REPLACE">PLUGMAP_REPLACE</h3>
<p><a href="#PLUGHISTORY">[Previous Routine]</a></p>
<p><a href="#PLUGMAP_TYCHO">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   plugmap_replace

 PURPOSE:
   Replace plPlugMapM files in the speclog product with new files
   if any of the FIBERID's differ.

 CALLING SEQUENCE:
   plugmap_replace, [ mjd=, mjstart=, mjend= ]

 INPUTS:

 OPTIONAL INPUTS:
   mjd          - MJDs in the speclog product to inspect+replace
   mjstart      - Start MJD in the speclog product to inspect+replace
   mjend        - End MJD in the speclog product to inspect+replace

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Consider all files $SPECLOG_DIR/$MJD/plPlugMapM-*.par .
   Replace if pluggings differ using files in $ASTROLOG_DIR/* .

 EXAMPLES:
   Start with modified versions of the plPlugMapM files in a temp
   directory (scan2), and copy into the speclog product:
     setenv,'ASTROLOG_DIR=/home/schlegel/scan2'
     setenv,'SPECLOG_DIR=/home/schlegel/products/NULL/speclog/trunk'
     plugmap_replace
   After the above, the changed files need to be &quot;svn commit&quot; from $SPECLOG_DIR

 BUGS:

 PROCEDURES CALLED:
   yanny_free
   yanny_par()
   yanny_readone()
   yanny_write

 REVISION HISTORY:
   31-Mar-2011  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/plan/plugmap_replace.pro)</strong></p>
<hr />
<h3 id="PLUGMAP_TYCHO">PLUGMAP_TYCHO</h3>
<p><a href="#PLUGMAP_REPLACE">[Previous Routine]</a></p>
<p><a href="#PLUGMAP_VERIFY">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   plugmap_tycho

 PURPOSE:
   Plot bright Tycho stars on a plate

 CALLING SEQUENCE:
   plugmap_tycho, plugfile, [ matchdist=, mlimit= ]

 INPUTS:
   plugfile   - Name of plugmap file (either plPlugMapP or plPlugMapM)

 OPTIONAL INPUTS:
   matchdist  - Match distance for Tycho stars; default to 5./3600 degrees
   mlimit     - Magnitude limit for Tycho stars in VTMAG; default to 15.0

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Plot bright Tycho stars on plates, for the purpose of having these
   fibers not be plugged at APO.  In particular, this procedure was
   written to deal with the two SEGUE plates 2333 and 2338, as per
   discussion in the mailing lists on 31 Oct 2005.

 EXAMPLES:
   IDL&gt; plugmap_tycho, 'plPlugMapP-2333.par', mlimit=10.5
   IDL&gt; plugmap_tycho, 'plPlugMapP-2338.par', mlimit=11.5

 BUGS:

 DATA FILES:

 PROCEDURES CALLED:
   djs_oplot
   djs_plot
   splog
   tycho_read()
   yanny_par()
   yanny_readone()

 INTERNAL SUPPORT ROUTINES:
   tycho_plot_unplugged

 REVISION HISTORY:
   31-Oct-2005  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/apo2d/plugmap_tycho.pro)</strong></p>
<hr />
<h3 id="PLUGMAP_VERIFY">PLUGMAP_VERIFY</h3>
<p><a href="#PLUGMAP_TYCHO">[Previous Routine]</a></p>
<p><a href="#POSTGRES_WRITE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   plugmap_verify

 PURPOSE:
   Sanity checks for BOSS plPlugMapP files

 CALLING SEQUENCE:
   plugmap_verify, files

 INPUTS:
   files     - File name(s), which can contain wildcards

 OPTIONAL KEYWORDS:

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Do a number of sanity checks on the format and objects in
   plPlugMapP files for BOSS.

 EXAMPLES:

 BUGS:
   No tests are performed on whether the objects are good SDSS targets.

 PROCEDURES CALLED:
   djs_filepath()
   splog
   yanny_par()
   yanny_read
   yanny_readone()

 INTERNAL PROCEDURES:
   plugmap_warn
   plugmap_verify1

 REVISION HISTORY:
   09-Oct-2009  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/plate/plugmap_verify.pro)</strong></p>
<hr />
<h3 id="POSTGRES_WRITE">POSTGRES_WRITE</h3>
<p><a href="#PLUGMAP_VERIFY">[Previous Routine]</a></p>
<p><a href="#QAPLOT_ARCLINE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   postgres_write

 PURPOSE:
   Write an IDL structure to a Postgres-readable file

 CALLING SEQUENCE:
   postgres_write, filename, pdata, [table=, delim=, /append, $
    scriptfile= ]

 INPUTS:
   filename   - Output file name
   pdata      - Structure to write

 OPTIONAL INPUTS:
   table      - Name of table; default to the structure name or 'anonymous'
   delim      - Postgres delimiter; default to the tab character
   append     - If set, then append to an existing file
   scriptfile - Name of file for writing Postgres importing script

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Unsupported IDL variable types: UINT, ULONG, ULONG64, COMPLEX, DCOMPLEX.
   IDL type BYTE is converted to a 2-byte integer.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:

 REVISION HISTORY:
   06-Apr-2000  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/specdb/postgres_write.pro)</strong></p>
<hr />
<h3 id="QAPLOT_ARCLINE">QAPLOT_ARCLINE</h3>
<p><a href="#POSTGRES_WRITE">[Previous Routine]</a></p>
<p><a href="#QAPLOT_FCALIBVEC">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   qaplot_arcline

 PURPOSE:
   Generate QA plot for arcline fits

 CALLING SEQUENCE:
   qaplot_arcline, xdif, lambda, [rejline=, color=, fibermask=, title=]

 INPUTS:
   xdif       - Deviations in arc line fits in pixels, array [NFIBER, NLAMP]
   lambda     - Wavelength for each lamp in Angstroms, vector [NLAMP]
   rejline    - String set to nonzero for any rejected arc line (plot in red)

 OPTIONAL KEYWORDS:
   color      - Specify 'blue' or 'red' to fix plotting limits
   fibermask  - Fiber status bits, set nonzero for bad status [NFIBER]
   title      - TITLE of plot

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Skip over bad fibers in plots.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_iterstat
   djs_oplot
   djs_plot
   errplot
   fibermask_bits()
   traceset2xy
   splog

 REVISION HISTORY:
   15-Oct-1999  Written by D. Finkbeiner, APO
   23-Nov-1999  Modified by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/qaplot_arcline.pro)</strong></p>
<hr />
<h3 id="QAPLOT_FCALIBVEC">QAPLOT_FCALIBVEC</h3>
<p><a href="#QAPLOT_ARCLINE">[Previous Routine]</a></p>
<p><a href="#QAPLOT_FFLAT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   qaplot_fcalibvec

 PURPOSE:
   Generate QA plot: apparent flux-calibration errors

 CALLING SEQUENCE:
   qaplot_fcalibvec, loglam, objflux, objivar, synflux, plugmap, zans, $
    [plottitle= ]

 INPUTS:
   loglam     - Wavelengths in log-10(Angstroms) [NPIX]
   objflux    - Object flux [NPIX,NOBJ]
   objivar    - Object inverse variance [NPIX,NOBJ]
   synflux    - Best-fit model flux [NPIX,NOBJ]
   plugmap    - Plug-map structure [NOBJ]
   zans       - Structure with redshift-fit information [NOBJ]

 OPTIONAL KEYWORDS:
   plottitle  - TITLE of plot

 OUTPUTS:
   Output plots only

 OPTIONAL OUTPUTS:

 COMMENTS:
   Plot the ratio of the observed spectra divided by the best-fit
   model spectra as a function of observed wavelength.  Deviations
   from unity are an empirical measure of the flux-calibration errors.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_maskinterp()
   djs_oplot
   djs_xyouts

 REVISION HISTORY:
   26-Feb-2002 Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/qaplot_fcalibvec.pro)</strong></p>
<hr />
<h3 id="QAPLOT_FFLAT">QAPLOT_FFLAT</h3>
<p><a href="#QAPLOT_FCALIBVEC">[Previous Routine]</a></p>
<p><a href="#QAPLOT_SCATLIGHT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   qaplot_fflat

 PURPOSE:
   Generate QA plot for fiber-flats

 CALLING SEQUENCE:
   qaplot_fflat, fflat, wset, [ fibermask=, dx=, title= ]

 INPUTS:
   fflat      - Array of flat-field flat-field vectors for each fiber
                that remove relative flat-field variations as a function
                of wavelength between fibers [Nrow, Ntrace]
   wset       - Wavelength solution

 OPTIONAL KEYWORDS:
   fibermask  - Fiber status bits, set nonzero for bad status [NFIBER]
   dx         - Bin log-lambda by this number; default to 1.e-3 (about 10 pix)
   title      - TITLE of plot

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Do not plot bad fibers or masked pixels in good fibers.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_oplot
   djs_plot
   fibermask_bits()
   traceset2xy

 REVISION HISTORY:
   23-Nov-1999  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/qaplot_fflat.pro)</strong></p>
<hr />
<h3 id="QAPLOT_SCATLIGHT">QAPLOT_SCATLIGHT</h3>
<p><a href="#QAPLOT_FFLAT">[Previous Routine]</a></p>
<p><a href="#QAPLOT_SKYDEV">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   qaplot_scatlight

 PURPOSE:
   Generate QA plots for scattered light

 CALLING SEQUENCE:
   qaplot_scatlight, scatfit, yrow, wset=, xcen=, [ fibermask=, title= ]

 INPUTS:
   scatfit    - Scattered light image after fitting [NX,NY/8]
   yrow       - extracted rows in scatfit 

 REQUIRED KEYWORDS:
   wset       - Wavelength solution
   xcen       - X positions corresponding to the extracted wavelength sol'n
                [NY,NTRACE]

 OPTIONAL KEYWORDS:
   fibermask  - Fiber status bits, set nonzero for bad status [NFIBER]
   title      - TITLE of plot

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_median()
   djs_oploterr
   djs_plot
   traceset2xy

 REVISION HISTORY:
   13-Dec-1999  Written by D. Schlegel, Princeton
   22-Jan-2000  Trying to speed up, S. Burles
</pre>
<p><strong>(See pro/spec2d/qaplot_scatlight.pro)</strong></p>
<hr />
<h3 id="QAPLOT_SKYDEV">QAPLOT_SKYDEV</h3>
<p><a href="#QAPLOT_SCATLIGHT">[Previous Routine]</a></p>
<p><a href="#QAPLOT_SKYLINE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   qaplot_skydev

 PURPOSE:
   Generate QA plot: scatter in sky line positions

 CALLING SEQUENCE:
   qaplot_skydev, flux, fluxivar, vacset, plugsort, color, $
    [fibermask=, title=]

 INPUTS:
   flux       - Pre-skysubtracted flux array [Nrow, Ntrace]
   fluxivar   - Associated inverse variance
   vacset     - Vacuum Wavelength solution
   plugsort   - Plugmap struct [Ntrace]
   color      - string specifying 'red' or 'blue' spectra

 OPTIONAL KEYWORDS:
   fibermask  - Fiber status bits, set nonzero for bad status [NFIBER]
   title      - TITLE of plot

 OUTPUTS:
   Output plots only

 OPTIONAL OUTPUTS:

 COMMENTS:
   This code has been deprecated in favor of QAPLOT_SKYSHIFT.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_oplot
   djs_plot
   trace_gweight
   traceset2xy
   traceset2pix
   djs_median

 REVISION HISTORY:
   22-Jan-2000 Written by S. Burles, Chicago
</pre>
<p><strong>(See pro/spec2d/qaplot_skydev.pro)</strong></p>
<hr />
<h3 id="QAPLOT_SKYLINE">QAPLOT_SKYLINE</h3>
<p><a href="#QAPLOT_SKYDEV">[Previous Routine]</a></p>
<p><a href="#QAPLOT_SKYSHIFT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   qaplot_skyline

 PURPOSE:
   Generate QA plots for flux in particular skylines

 CALLING SEQUENCE:
   qaplot_skyline, lwave, obj, objivar, objsub, objsubivar, plugsort, wset, $
    tai=, [fibermask=, dwave=, title= ]

 INPUTS:
   lwave      -
   obj        - Image
   objivar    - Inverse variance for OBJ
   objsub     - Image after sky-subtraction
   objsubivar - Inverse variance for image after sky-subtraction
   plugsort   - Plugmap structure trimmed to one element per fiber
   wset       - Wavelength solution
   tai        - TAI time for computing airmass or elevation for each fiber

 OPTIONAL KEYWORDS:
   fibermask  - Fiber status bits, set nonzero for bad status [NFIBER]
   dwave      - Half-width about LWAVE for fitting sky line;
                default to 5.0 Ang
   titel      - File name to use for TITLE of plot

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_iterstat
   djs_median
   djs_oplot
   splog
   tai2airmass()
   traceset2xy

 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   01-Jan-2000  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/qaplot_skyline.pro)</strong></p>
<hr />
<h3 id="QAPLOT_SKYSHIFT">QAPLOT_SKYSHIFT</h3>
<p><a href="#QAPLOT_SKYLINE">[Previous Routine]</a></p>
<p><a href="#QAPLOT_SKYSUB">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   qaplot_skyshift

 PURPOSE:
   Generate QA plot: scatter in sky line positions

 CALLING SEQUENCE:
   qaplot_skyshift, wset, xsky, skywaves, skyshift, [title= ]

 INPUTS:
   wset       - Wavelength solution from arc line spectra
   xsky       - Pixel position of sky lines [NFIBER,NLINE]
   skywaves   - Wavelengths of sky lines used for computing shifts (Ang)
   skyshift   - Shifts to apply to sky lines in pix [NROW,NTRACE]

 OPTIONAL KEYWORDS:
   title      - TITLE of plot

 OUTPUTS:
   Output plots only

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_laxisgen()
   djs_oplot
   djs_plot
   traceset2pix

 REVISION HISTORY:
   11-Apr-2000 Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/qaplot_skyshift.pro)</strong></p>
<hr />
<h3 id="QAPLOT_SKYSUB">QAPLOT_SKYSUB</h3>
<p><a href="#QAPLOT_SKYSHIFT">[Previous Routine]</a></p>
<p><a href="#QUICKEXTRACT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   qaplot_skysub

 PURPOSE:
   Generate QA plots for sky-subtraction

 CALLING SEQUENCE:
   qaplot_skysub, obj, objivar, objsub, objsubivar, wset, $
    iskies, [title= ]

 INPUTS:
   obj        - Image
   objivar    - Inverse variance for OBJ
   objsub     - Image after sky-subtraction
   objsubivar - Inverse variance for image after sky-subtraction
   wset       - Wavelength solution
   iskies     - List of good sky fibers

 OPTIONAL KEYWORDS:
   title      - TITLE of plot

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_median
   djs_oplot
   djs_oploterr
   djs_plot
   splog
   traceset2xy

 INTERNAL SUPPORT ROUTINES:
   skyplot

 REVISION HISTORY:
   30-Dec-1999  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/qaplot_skysub.pro)</strong></p>
<hr />
<h3 id="QUICKEXTRACT">QUICKEXTRACT</h3>
<p><a href="#QAPLOT_SKYSUB">[Previous Routine]</a></p>
<p><a href="#QUICKTRACE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   quickextract

 PURPOSE:
   Science frame extraction with scattered light removal and sky subtraction.
   S/N is estimated and output for HTML generation.

 CALLING SEQUENCE:
   rstruct = quickextract(tsetfile, wsetfile, fflatfile, rawfile, outsci, $
    [ radius=, filtsz=, /do_lock ])

 INPUTS:
   tsetfile   - Name of fits file which contains matched trace
   wsetfile   - Name of fits file which contains matched wavelengths
   fflatfile  - Name of fits file which containes flat field vectors
   rawfile    - Name of SDSS science frame to extract
   outsci     - Name of fits file to store workings of quickextract

 OPTIONAL INPUTS:
   radius     - Radius for boxcar extraction (default 3)
   filtsz     - Median filter size to apply before average S/N is calculated;
                default to 25 pixels.
   do_lock    - Keyword for SDSSPROC

 OUTPUT:
   rstruct    - Results to be added html file upon completion

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   apo_checklimits()
   calcscatimage
   divideflat
   djs_mean()
   djs_median()
   extract_image
   extract_boxcar()
   fibermask_bits()
   fileandpath()
   find_whopping()
   fitflatwidth()
   fitsn()
   match_trace()
   quickboxcar()
   mrdfits()
   mwrfits
   sdssproc
   skysubtract()
   splog
   sxpar()
   traceset2xy

 REVISION HISTORY:
   3-Apr-2000  Written by S. Burles &amp; D. Schlegel, APO
</pre>
<p><strong>(See pro/apo2d/quickextract.pro)</strong></p>
<hr />
<h3 id="QUICKTRACE">QUICKTRACE</h3>
<p><a href="#QUICKEXTRACT">[Previous Routine]</a></p>
<p><a href="#QUICKWAVE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   quicktrace

 PURPOSE:
   Trace and boxcar extract an SDSS flat field image

 CALLING SEQUENCE:
   rstruct = quicktrace (filename, tsetfile, plugmapfile, [ nbin=, $
    /do_lock ] )

 INPUTS:
   filename   - Flat-field filename
   tsetfile   - Output FITS file
   plugmapfile- Yanny parameter file with plugmap data, copied to an HDU
                in the output TSETFILE for use by other routines.

 OPTIONAL INPUTS:
   nbin       - Sub-sampling of row numbers for measuring the spatial
                profile widths; default to 16 for every 16-th row.
   do_lock    - Optional keyword for SDSSPROC

 OUTPUT:
   rstruct    - Results to be added html file upon completion

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   apo_checklimits()
   extract_image
   fileandpath()
   findfile()
   fitflatwidth()
   mwrfits
   quickboxcar()
   readplugmap()
   reject_flat()
   rmfile
   sdssproc
   sortplugmap()
   splog
   trace320crude
   traceset2xy
   xy2traceset

 REVISION HISTORY:
   3-Apr-2000  Written by S. Burles &amp; D. Schlegel, APO
  28-Feb-2002  Modified to do full tracing, speed difference is critical
  26-Jul-2009  Added keyword for nfibers, KD
</pre>
<p><strong>(See pro/apo2d/quicktrace.pro)</strong></p>
<hr />
<h3 id="QUICKWAVE">QUICKWAVE</h3>
<p><a href="#QUICKTRACE">[Previous Routine]</a></p>
<p><a href="#RADEC_TO_XYFOCAL">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   quickwave

 PURPOSE:
   Perform full wavelength calibration with boxcar extraction
    requires trace from a previously output tsetfile

 CALLING SEQUENCE:
   rstruct = quickwave( arcname, tsetfile, wsetfile, fflatfile, $
     [ radius=, /doplot, /do_lock ] )

 INPUTS:
   arcname    - Raw SDSS Arclamp image to be processed
   tsetfile   - Name of fits file which contains matched trace
   wsetfile   - Name of fits file which will contain wavelength solution
   fflatfile  - Name of fits file which will contain flat field vectors

 OPTIONAL INPUTS:
   radius     - Radius for boxcar extraction (default 3)
   doplot     - Used for debugging purposes
   do_lock    - Optional keyword for SDSSPROC

 OUTPUT:
   rstruct    - Results to be added html file upon completion

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   apo_checklimits()
   extract_boxcar()
   fiberflat()
   fileandpath()
   findfile()
   fitarcimage
   fitdispersion()
   qbadarc
   mrdfits()
   mwrfits
   reject_arc()
   rmfile
   sdssproc
   traceset2xy

 REVISION HISTORY:
   3-Apr-2000  Written by S. Burles &amp; D. Schlegel, APO
</pre>
<p><strong>(See pro/apo2d/quickwave.pro)</strong></p>
<hr />
<h3 id="RADEC_TO_XYFOCAL">RADEC_TO_XYFOCAL</h3>
<p><a href="#QUICKWAVE">[Previous Routine]</a></p>
<p><a href="#RANDOM_DECOLLIDE[1]">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   radec_to_xyfocal
 PURPOSE:
   Take RA and DEC values and return XFOCAL and YFOCAL for a plate
 CALLING SEQUENCE:
   radec_to_xyfocal, ra, dec, xfocal, yfocal, racen=racen, $
     deccen=deccen, airtemp=airtemp, mjd=mjd
 INPUTS:
   ra,dec     - [N] arrays of locations (J2000 deg)
   racen      - RA center for tile (J2000 deg)
   deccen     - DEC center for tile (J2000 deg)
 OPTIONAL INPUTS:
   lst        - LST of observation (defaults to racen)
   airtemp    - Design temperature (in C, default to 5)
 OUTPUTS:
   xfocal, yfocal - [N] arrays of focal plane positions
 COMMENTS:
   Designed for the SDSS 2.5m at APO
   PA=0 ALWAYS
 BUGS:
   ALIGNMENT FIBERS HAVE OFFSET?????
 REVISION HISTORY:
   26-Oct-2006  Written by MRB, NYU
</pre>
<p><strong>(See pro/plate/radec_to_xyfocal.pro)</strong></p>
<hr />
<h3 id="RANDOM_DECOLLIDE[1]">RANDOM_DECOLLIDE[1]</h3>
<p><a href="#RADEC_TO_XYFOCAL">[Previous Routine]</a></p>
<p><a href="#RANDOM_DECOLLIDE[2]">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   random_decollide
 PURPOSE:
   Take a set of RAs and DECs and find a random, decollided set
 CALLING SEQUENCE:
   random_decollide, 
 INPUTS:
 REVISION HISTORY:
   26-Oct-2006  Written by MRB, NYU
</pre>
<p><strong>(See pro/plate/decollide.pro)</strong></p>
<hr />
<h3 id="RANDOM_DECOLLIDE[2]">RANDOM_DECOLLIDE[2]</h3>
<p><a href="#RANDOM_DECOLLIDE[1]">[Previous Routine]</a></p>
<p><a href="#RDNOISE_HISTORY">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   random_decollide
 PURPOSE:
   Take a set of RAs and DECs and find a random, decollided set
 CALLING SEQUENCE:
   random_decollide, 
 INPUTS:
 REVISION HISTORY:
   26-Oct-2006  Written by MRB, NYU
</pre>
<p><strong>(See pro/plate/random_decollide.pro)</strong></p>
<hr />
<h3 id="RDNOISE_HISTORY">RDNOISE_HISTORY</h3>
<p><a href="#RANDOM_DECOLLIDE[2]">[Previous Routine]</a></p>
<p><a href="#READONESPEC">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   rdnoise_history

 PURPOSE:
   Compute the noise history for the BOSS CCDs

 CALLING SEQUENCE:
   rdnoise_history, [docams=, mjd= ]

 INPUTS:

 REQUIRED KEYWORDS:

 OPTIONAL KEYWORDS:
   docams     - Camera(s); default to ['b1','b2','r1','r2']
   mjd        - Search for all files in $BOSS_SPECTRO_DATA/MJD;
                default to '55???'

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Output files with 12 columns: file name, MJD, TAI, exposure time (seconds),
   read noise in DN in each of the 4 quadrants, standard deviation of the
   bias drift in DN (row-to-row) in each of the 4 quadrants.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_avsigclip()
   djsig()
   fileandpath()
   sdssproc
   splog

 REVISION HISTORY:
   21-Oct-2009  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/plan/rdnoise_history.pro)</strong></p>
<hr />
<h3 id="READONESPEC">READONESPEC</h3>
<p><a href="#RDNOISE_HISTORY">[Previous Routine]</a></p>
<p><a href="#READPLUGMAP">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   readonespec

 PURPOSE:
   Routine for reading single exposure spectra from Spectro-2D outputs

 CALLING SEQUENCE:
   readonespec, plate, fiber, [mjd=, cameras=, flux=, flerr=, invvar=, $
    mask=, disp=, sky=, loglam=, wave=, ximg=, synflux=, lineflux=, $
    objhdr=, framehdr=, expnum=, topdir=, path=, run2d=, run1d=, /silent ]

 INPUTS:
   plate      - Plate number (scalar)
   fiber      - Fiber number (scalar)

 OPTIONAL INPUTS:
   mjd        - MJD number; if not set, then select the most recent
                data for this plate (largest MJD).
   cameras    - If specified, then only match to either the blue ('b')
                or red ('r')
   topdir     - Optional override value for the environment
                variable $BOSS_SPECTRO_REDUX.
   path       - Override all path information with this directory name.
   run2d ???
   run1d ???
   silent     - If set, then call MRDFITS with /SILENT.

 OUTPUTS:

 OPTIONAL OUTPUTS:
   mjd        - If not specified, then this is returned
   flux       - Flux [NPIXEL,NFILE]
   flerr      - Flux error [NPIXEL,NFILE]
   invvar     - Inverse variance [NPIXEL,NFILE]
   mask       - AND-mask [NPIXEL,NFILE]
   disp       - Wavelength dispersion [NPIXEL,NFILE]
   sky        - Sky flux [NPIXEL,NFILE]
   loglam     - Log10-wavelength in log10-Angstroms [NPIXEL,NFILE]
   wave       - Wavelength in Angstroms [NPIXEL,NFIBER]
   ximg       - X position on the CCD [NPIXEL,NFIBER]
   synflux    - Best-fit synthetic eigen-spectrum [NPIXEL,NFILE];
                return vectors of zeros if the Spectro-1D files
                cannot be found
   lineflux   - Best-fit emission lines fits + background terms [NPIXEL,NFILE];
                return vectors of zeros if the Spectro-1D files
                cannot be found
   objhdr     - The FITS header from the spPlate file
   framehdr   - Pointer array to the FITS headers from all the spCFrame files
   expnum     - Exposure number for each NFILE spectra

 COMMENTS:
   The environment variable BOSS_SPECTRO_REDUX must be set to tell this routine
   where to find the data.  The list of spCFrame files to read are determined
   from the EXPID header keywords in the spPlate file.

 EXAMPLES:

 BUGS:

 DATA FILES:
   $BOSS_SPECTRO_REDUX/$PLATE/spPlate-$PLATE-$MJD.fits
   $BOSS_SPECTRO_REDUX/$PLATE/spCFrame-$CAMERA-$EXPOSURE.fits*

 PROCEDURES CALLED:
   combine1fiber()
   readspec
   spframe_read
   splog

 REVISION HISTORY:
   10-Feb-2004  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/spec1d/readonespec.pro)</strong></p>
<hr />
<h3 id="READPLUGMAP">READPLUGMAP</h3>
<p><a href="#READONESPEC">[Previous Routine]</a></p>
<p><a href="#READSPEC">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   readplugmap

 PURPOSE:
   Read plugmap file and append tags as requested

 CALLING SEQUENCE:
   plugmap = readplugmap( plugfile, [ spectrographid, plugdir=, $
    /apotags, /deredden, /calibobj, exptime=, hdr=, fibermask=, _EXTRA= ] )

 INPUTS:
   plugfile  - Name of Yanny-parameter plugmap file

 OPTIONAL INPUTS:
   spectrographid  - The spectrograph number, either 1 or 2;
                     if not set (or 0), then return all object fibers
   plugdir   - Directory for PLUGFILE
   apotags   - If set, then add a number of tags to the output structure
               constructed from the Yanny header.  These tags are:
               CARTID, PLATEID, TILEID, RAPLATE, DECPLATE, REDDEN_MED.
               Also add the tags FIBERSN[3], SYTHMAG[3] which are used
               by the on-the-mountain reductions.
   deredden  - If set, then deredden the MAG fields using the median
               reddening value for the entire plate as found in the
               Yanny header of the plugmap file; this is done for the
               on-the-mountain reductions.
   exptime   - Default exposure time SCI_EXPTIME to add to the output;
               if there are multiple pointings and EXPTIME is set, then
               the exposure time in each pointing is scaled such that
               their sum is EXPTIME.
   calibobj  - If set, then add a CALIBFLUX,CALIBFLUX_IVAR entries based upon
               the calibObj (deprecated) or photoPlate files.
               For stellar objects, this contains the
               PSF fluxes in nMgy.  For galaxies, it contains the fiber fluxes
               multiplied by the median (PSF/fiber) flux ratio for stars.
               The MAG fields are left unchanged.
               For objects with no calibObj entry, simply set these fields as:
                 CALIBFLUX = 22.5 - 2.5*alog10(MAG), CALIBFLUX_IVAR = 0.
               We apply the putative AB corrections to these fluxes
               (but not to the MAG values).
               Also add the SFD reddening values as SFD_EBV.
   _EXTRA    - Keywords for PLUG2TSOBJ(), such as MJD,INDIR

 OUTPUTS:
   plugmap   - Plugmap structure

 OPTIONAL OUTPUTS:
   hdr       - Header from Yanny-formatted plugmap file
   fibermask - Byte array with bits set for unknown fibers

 COMMENTS:
   Do not use the calibObj structure if more than 10% of the non-sky
   objects do not have fluxes.

 EXAMPLES:

 BUGS:
   The AB corrections are hard-wired to be the same as in the photoop
   product as of 18 Feb 2004.

 PROCEDURES CALLED:
   djs_filepath()
   dust_getval()
   euler
   plug2tsobj()
   sdss_flagval()
   splog
   struct_addtags()
   yanny_par()
   yanny_read

 REVISION HISTORY:
   29-Jan-2001  Written by S. Burles, FNAL
</pre>
<p><strong>(See pro/spec2d/readplugmap.pro)</strong></p>
<hr />
<h3 id="READSPEC">READSPEC</h3>
<p><a href="#READPLUGMAP">[Previous Routine]</a></p>
<p><a href="#READSPEC_FOOTPRINT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   readspec

 PURPOSE:
   Routine for reading SDSS/BOSS Spectro-2D and Spectro-1D files

 CALLING SEQUENCE:
   readspec, plate, fiber, [mjd=, znum=, flux=, flerr=, invvar=, $
    andmask=, ormask=, disp=, sky=, plugmap=, loglam=, wave=, tsobj=, $
    zans=, zmanual=, zline=, synflux=, lineflux=, objhdr=, zhdr=, nfiber=, $
    topdir=, path=, /align, /silent ]

 INPUTS:
   plate      - Plate number(s)

 OPTIONAL INPUTS:
   fiber      - Fiber number(s), 1-indexed; if not set, or zero, then
                read all fibers for each plate.
   mjd        - MJD number(s); if not set, then select the most recent
                data for this plate (largest MJD).
   znum       - If set, then return not the best-fit redshift, but the
                ZNUM-th best-fit; e.g., set ZNUM=2 for second-best fit.
   topdir     - Optional override value for the environment
                variable $BOSS_SPECTRO_REDUX.
   path       - Override all path information with this directory name.
   align      - If set, then align all the spectra in wavelength.
                Also, LOGLAM and WAVE will be output as single vectors
                (since they are all the same) rather than as one per object.
   silent     - If set, then call MRDFITS with /SILENT.

 OUTPUTS:

 OPTIONAL OUTPUTS:
   mjd        - If not specified, then this is returned as an array of one
                MJD per object.
   flux       - Flux [NPIXEL,NFIBER]
   flerr      - Flux error [NPIXEL,NFIBER]
   invvar     - Inverse variance [NPIXEL,NFIBER]
   andmask    - AND-mask [NPIXEL,NFIBER]
   ormask     - OR-mask [NPIXEL,NFIBER]
   disp       - Wavelength dispersion [NPIXEL,NFIBER]
   sky        - Sky flux [NPIXEL,NFIBER]
   plugmap    - Plug-map entries [NFIBER]
   loglam     - Log10-wavelength in log10-Angstroms [NPIXEL,NFIBER],
                or the vector [NPIXEL] if /ALIGN is set
   wave       - Wavelength in Angstroms [NPIXEL,NFIBER],
                or the vector [NPIXEL] if /ALIGN is set
   tsobj      - tsObj-structure output [NFIBER]
   zans       - Redshift output structure [NFIBER]
   zmanual    - Manual inspection structure [NFIBER]
   zline      - Line-fit output structure [NFIBER,NLINE]
   synflux    - Best-fit synthetic eigen-spectrum [NPIXEL,NFIBER]
   lineflux   - Best-fit emission line fits + background terms  [NPIXEL,NFIBER]
   objhdr     - The FITS header from the first object spPlate file read.
                If spectra from multiple plates are read, then it is
                indeterminant which header this will be.
   zhdr       - The FITS header from the first object spZ file read.
                If spectra from multiple plates are read, then it is
                indeterminant which header this will be.
   nfiber     - Number of fibers per plate [NFIBER]

 COMMENTS:
   One can input PLATE and FIBER as vectors, in which case there must
   be a one-to-one correspondence between them.  Or, one can input FIBER
   numbers as a vector, in which case the same PLATE is used for all.
   Or, one can input PLATE as a vector, in which case the same FIBER is
   read for all.

   The environment variable BOSS_SPECTRO_REDUX must be set to tell this routine
   where to find the data.  The reduced spectro data files are assumed to
   be $BOSS_SPECTRO_REDUX/$RUN2D/pppp/spPlate-pppp-mmmmm.fits,
   where pppp=plate number and mmmm=MJD.

   The tsObj files are assumed to be in the directory $BOSS_SPECTRO_REDUX/plates.

 EXAMPLES:

 BUGS:

 DATA FILES:
   $BOSS_SPECTRO_REDUX/$RUN2D/$PLATE/spPlate-$PLATE-$MJD.fits
   $BOSS_SPECTRO_REDUX/$RUN2D/$PLATE/$RUN1D/spZbest-$PLATE-$MJD.fits
   $BOSS_SPECTRO_REDUX/$RUN2D/$PLATE/$RUN1D/spZall-$PLATE-$MJD.fits
   $BOSS_SPECTRO_REDUX/$RUN2D/$PLATE/$RUN1D/spZline-$PLATE-$MJD.fits
   $BOSS_SPECTRO_REDUX/plates/tsObj*-$PLATE.fit
   $IDLSPEC2D_DIR/templates/TEMPLATEFILES

 PROCEDURES CALLED:
   copy_struct_inx
   headfits()
   lookforgzip()
   mrdfits
   plug2tsobj()
   spec_append
   struct_append()
   synthspec()

 INTERNAL SUPPORT ROUTINES:
   rspec_mrdfits()
   rspec_zline_append()
   readspec1

 REVISION HISTORY:
   25-Jun-2000  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/spec1d/readspec.pro)</strong></p>
<hr />
<h3 id="READSPEC_FOOTPRINT">READSPEC_FOOTPRINT</h3>
<p><a href="#READSPEC">[Previous Routine]</a></p>
<p><a href="#RECTIFY">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   readspec_footprint

 PURPOSE:
   Routine for reading 1D spectro outputs on a given plate footprint

 CALLING SEQUENCE:
   readspec, plate, [mjd=, topdir=, /best, /silent, $
    zans=, plugmap=, tsobj= ]

 INPUTS:
   plate      - Plate number

 OPTIONAL INPUTS:
   mjd        - MJD number(s); if not set, then select the most recent
                data for this plate (largest MJD).
   best       - If set, then select the best observation of each object,
                using the same algorithm to choose the primary observation
                in the PLATEMERGE routine (for spAll files).
   silent     - If set, then call MRDFITS with /SILENT.
   topdir     - Top-level directory for data; default to the environment
                variable $BOSS_SPECTRO_REDUX.

 OUTPUTS:

 OPTIONAL OUTPUTS:
   mjd        - If not specified, then this returns the MJD of PLATE
   zans       - Redshift output structure [NFIBER]
   plugmap    - Plug-map entries [NFIBER]
   tsobj      - tsObj-structure output [NFIBER]

 COMMENTS:
   Read all of the SDSS spectroscopic observations within 1.49 degrees
   of the center of the specified plate.  If /BEST is set, then trim
   to the best observation of each object.

 EXAMPLES:
   Read all the SDSS spectroscopic observations on the SDSS-3 test
   plate 2634, trimming to the best observations of each object:
     IDL&gt; readspec_footprint, 2634, zans=zans, /best

 BUGS:

 PROCEDURES CALLED:
   djs_diff_angle()
   platelist
   readspec
   spheregroup()
   sxpar()

 REVISION HISTORY:
   24-Apr-2007  Written by David Schlegel, LBL
</pre>
<p><strong>(See pro/spec1d/readspec_footprint.pro)</strong></p>
<hr />
<h3 id="RECTIFY">RECTIFY</h3>
<p><a href="#READSPEC_FOOTPRINT">[Previous Routine]</a></p>
<p><a href="#REDMONSTER">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   rectify

 PURPOSE:
   Rectify spectra using a sliding median

 CALLING SEQUENCE:
   normflux = rectify(flux, [ivar, nivar=, mask=, wave=])

 INPUTS:
   flux -  flux vector [npix, nspec]

 OPTIONAL INPUTS:
   ivar -  inverse variance -- needed if &quot;nivar&quot; is returned [npix, nspec]
   mask - if set then mask strong optical absorption feature before doing
          sliding median.  (To do this &quot;wave&quot; must also be supplied.)
          On exit this keyword will hold a copy of the flux array with 
          masked pixels set to NaN
   wave - wavelength vector in Angstroms -- only needed if &quot;mask&quot; is set

 OUTPUT:
   Rectified flux vector [npix, nspec]
 
 OPTIONAL OUTPUT:
   nivar - inverse variance of rectified flux [npix, nspec]
   
 COMMENTS:
   If mask is set 16 pixels around the folling lines are masked:      
   H-delta, Ca_K, Ca_H, G-band, H-gamma H-beta, Mgb, H-alpha

 BUGS:
   Medianing is done in pixel space not wavelength space -- so for two spectra
   to be rectified in the same manner they must have identical wavelength
   sampling.

 EXAMPLES:

 PROCEDURES CALLED:
   djs_median()

 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   12-Aug-2003  Created by C. Tremonti, Steward Observatory
</pre>
<p><strong>(See pro/fluxfix/rectify.pro)</strong></p>
<hr />
<h3 id="REDMONSTER">REDMONSTER</h3>
<p><a href="#RECTIFY">[Previous Routine]</a></p>
<p><a href="#REJECT_ARC">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   redmonster

 PURPOSE:
   Search for the Red Monster (contiguous region of bad sky residuals),
   and set a pixelmask bit.

 CALLING SEQUENCE:
   redmonster, relloglam, relchi2, [ objloglam, filtsz=, thresh=, pixelmask= ]

 INPUTS:
   relloglam  - Log10(Angstroms) for RELCHI2 vector
   relchi2    - Relative chi^2 vector from sky fiber residuals

 OPTIONAL INPUTS:
   objlogam   - Log10(Angstroms) image for object frame [NPIX,NFIBER];
                required input for modifying PIXELMASK
   filtsz     - Filter size for looking for Red Monster; default to 25 pix,
                but not more than the number of pixels in RELLOGLAM
   thresh     - Treshold in relative chi^2 for identifying REDMONSTER;
                in the pixel mask; default to 4.0.
   pixelmask  - If this and OBJLOGLAM are specified, then add the REDMONSTER
                bit to this mask [NPIX,NFIBER]

 OUTPUTS:
   pixelmask  - (Modified.)

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   pixelmask_bits()
   splog

 REVISION HISTORY:
   14-Mar-2001  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/redmonster.pro)</strong></p>
<hr />
<h3 id="REJECT_ARC">REJECT_ARC</h3>
<p><a href="#REDMONSTER">[Previous Routine]</a></p>
<p><a href="#REJECT_FLAT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   reject_arc

 PURPOSE:
   Decide whether an arc is bad.

 CALLING SEQUENCE:
   qbad = reject_arc(img, [ hdr, nsatrow=, fbadpix= ] )

 INPUTS:
   img        - Raw arc image

 OPTIONAL INPUTS:
   hdr        - Header for image
   nsatrow    - Returned from SDSSPROC()
   fbadpix    - Returned from SDSSPROC()

 OUTPUTS:
   qbad       - Return 1 if a arc is bad, 0 if good.

 OPTIONAL OUTPUTS:

 COMMENTS:
   Decide if this arc is bad:
     Reject if more than 2% of the pixels are marked as bad.
     Reject if more than 100 rows are saturated.
     Reject if the flat-field screens are not closed, which should appear
       as FFS = '1 1 1 1 1 1 1 1' in the header.
     Reject if the arc lamps are not turned on, which should appear
       as NE = '1 1 1 1' and HGCD = '1 1 1 1' in the header.
       Accept if either set of lamps is properly turned on.

   Note that the FFS, FF, NE and HGCD keywords only appear at MJD &gt;= 51629.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:

 REVISION HISTORY:
   25-Jan-2001  Written by D. Schlegel, Princeton.
                This code is copied out of SPCALIB.
</pre>
<p><strong>(See pro/spec2d/reject_arc.pro)</strong></p>
<hr />
<h3 id="REJECT_FLAT">REJECT_FLAT</h3>
<p><a href="#REJECT_ARC">[Previous Routine]</a></p>
<p><a href="#REJECT_SCIENCE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   reject_flat

 PURPOSE:
   Decide whether a flat is bad.

 CALLING SEQUENCE:
   qbad = reject_flat(img, [ hdr, nsatrow=, fbadpix=, percent80thresh= ] )

 INPUTS:
   img        - Raw flat-field image

 OPTIONAL INPUTS:
   hdr        - Header for image
   nsatrow    - Returned from SDSSPROC()
   fbadpix    - Returned from SDSSPROC()
                percent80thresh - threshold for the number of pixels
                                  that can fall below 80% flux

 OUTPUTS:
   qbad       - Return 1 if a flat is bad, 0 if good.

 OPTIONAL OUTPUTS:

 COMMENTS:
   Decide if this flat is bad:
     Reject if more than 2% of the pixels are marked as bad.
     Reject if more than 100 rows are saturated.
     Reject if the 80-th percentile is less than 1000 electrons.
     Reject if the flat-field screens are not closed, which should appear
       as FFS = '1 1 1 1 1 1 1 1' in the header.
     Reject if the flat-field lamps are not turned on, which should appear
       as FF = '1 1 1 1' in the header.

   Note that the FFS, FF, NE and HGCD keywords only appear at MJD &gt;= 51629.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:

 REVISION HISTORY:
   25-Jan-2001  Written by D. Schlegel, Princeton.
                This code is copied out of SPCALIB.
</pre>
<p><strong>(See pro/spec2d/reject_flat.pro)</strong></p>
<hr />
<h3 id="REJECT_SCIENCE">REJECT_SCIENCE</h3>
<p><a href="#REJECT_FLAT">[Previous Routine]</a></p>
<p><a href="#REMOVE2REDO">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   reject_science

 PURPOSE:
   Decide whether a science exposure is bad.

 CALLING SEQUENCE:
   qbad = reject_science(img, [ hdr, nsatrow=, fbadpix= ] )

 INPUTS:
   img        - Raw science image

 OPTIONAL INPUTS:
   hdr        - Header for image
   nsatrow    - Returned from SDSSPROC()
   fbadpix    - Returned from SDSSPROC()

 OUTPUTS:
   qbad       - Return 1 if a science exposure is bad, 0 if good.

 OPTIONAL OUTPUTS:

 COMMENTS:
   Decide if this science exposure is bad:
     Reject if more than 10% of the pixels are marked as bad.
     Reject if more than 100 rows are saturated.
     Reject if the 25-th percentile is more than 1000 electrons.
       This percentile should be very low (of order 10 electrons), since
       it will be the counts between fibers.
     Reject if any of the flat-field screens are closed.  If the FFS keyword
       is in the header, it should be FFS = '0 0 0 0 0 0 0 0'
     Reject if any of the flat-field lamps are turned on.  If the FF keyword
       is in the header, it should be FF = '0 0 0 0'
     Reject if any of the neon arc lamps are turned on.  If the NE keyword
       is in the header, it should be NE = '0 0 0 0'
     Reject if any of the HgCd arc lamps are turned on.  If the HGCD keyword
       is in the header, it should be HGCD = '0 0 0 0'

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:

 REVISION HISTORY:
   15-Jun-2001  Written by D. Schlegel, Princeton.
</pre>
<p><strong>(See pro/spec2d/reject_science.pro)</strong></p>
<hr />
<h3 id="REMOVE2REDO">REMOVE2REDO</h3>
<p><a href="#REJECT_SCIENCE">[Previous Routine]</a></p>
<p><a href="#RLINE_FINDPEAKS">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   remove2redo

 PURPOSE:
   Removed specified exposures from the SOS log files and re-reduce them.

 CALLING SEQUENCE:
   remove2redo, [ mjd=, plate=, expnum=, /not_sos ]

 INPUTS:

 OPTIONAL INPUTS:
   mjd        - MJD number; if not set, then select the most recent MJD
                in the $SPECTROLOG_DIR directory.
   plate      - If specified, then search for all sdR files for this plate
                that were not successfully reduced.  They are assumed to
                have been successfully reduced if they have an entry in
                HDU #1, 2, or 3 in the SOS log file.
   expnum     - If specified, then force the re-reduction of this exposure
                number(s) even if they have already been successfully reduced.
                Do not specify both PLATE and EXPNUM.
   not_sos    - This keyword can be set to run this proc on a machine
                that is not named &quot;sos&quot;.  This would only be done for
                testing purposes, or if Son-of-Spectro has been moved
                to another machine.

 OUTPUT:

 COMMENTS:
   The way this procedure works is to actually remove the sdR*.fit files
   from /data/spectro.  The Son-of-Spectro cron jobs will then re-copy
   and re-reduce those files.  It does not look for or remove sdR*.fit.gz
   files, which SOS currently makes too.  If the raw data no longer exists
   on sdsshost.apo, then the data will not be re-reduced.

   If $SPECTROLOG_DIR is not set, then it is assumed to be
     /data/spectro/spectrologs
   When using the PLATE keyword, never re-reduce the very last exposure
   number on disk.  If the last exposure is not for the specified plate,
   then we can try re-reducing any exposures for that plate.

 EXAMPLES:

 BUGS:
   Currently, either EXPNUM or PLATE must be specified.  Probably nothing
   happens if neither is set.

 PROCEDURES CALLED:
   apo_log2html
   djs_filename()
   djs_lockfile()
   djs_modfits
   djs_unlockfile
   sdsshead()

 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   03-April-2001  Written by Scott Burles, FNAL
</pre>
<p><strong>(See pro/apo2d/remove2redo.pro)</strong></p>
<hr />
<h3 id="RLINE_FINDPEAKS">RLINE_FINDPEAKS</h3>
<p><a href="#REMOVE2REDO">[Previous Routine]</a></p>
<p><a href="#RUN_SDSSPROC">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   rline_findpeaks

 PURPOSE:
  Given a two dimensional array for Equivalent Width (EW) and
  weights (EW inverse variance), this function returns a structure
  containing peak positions, heights, and significance level (SN).
  
  Only postive peaks are detected, so transform the array is negative
  peaks are sought.

 CALLING SEQUENCE:
   peak_list = rline_findpeaks(ew, ewinv, npeak=, threshold=, minsep=)

 INPUTS:
   ew          - Positive equivalent width array
   ewinv       - Associated inverse variance

 OPTIONAL INPUTS:
   npeak       - Maximum number of peaks to locate   (default 20)
   threshold   - Minimum significance level (sigma) to return (default 5.0)
   minsep      - Minimum pixel separation to between peaks   (default 2.5)

 OPTIONAL KEYWORDS:

 OUTPUTS:
   peak_list   - Array of structures with peak information 

 COMMENTS:

 EXAMPLES:

 PROCEDURES CALLED:
   find_npeaks

 DATA FILES:

 REVISION HISTORY:
  05-Jan-2001  Written by S. Burles, Fermiland
  17-Dec-2001  Commented, updated to work with new find_npeaks.pro
</pre>
<p><strong>(See pro/spec1d/rline_findpeaks.pro)</strong></p>
<hr />
<h3 id="RUN_SDSSPROC">RUN_SDSSPROC</h3>
<p><a href="#RLINE_FINDPEAKS">[Previous Routine]</a></p>
<p><a href="#SDSSGUIDE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>

 NAME:
  run_sdssproc

 PURPOSE:
  run SDSSPROC over many raw sdR files and write image and invvar files.

 USAGE:
  run_sdssproc [, indir=indir, outdir=outdir, mjdlist=mjdlist, $
   clobber=clobber, gzip=gzip, minflat=minflat, maxflat=maxflat, $
   pbsnodes=pbsnodes, pbs_ppn=pbs_ppn, pbs_a=pbs_a, $
   pbs_walltime=pbs_walltime, pbs_scratch=pbs_scratch, ember=ember]

 ARGUMENTS:
  indir: raw data directory, defaulting to $BOSS_SPECTRO_DATA
  outdir: top directory to write processed files, defaulting
          to $PROCDATA_DIR if set, otherwise working dir ('.')
  mjdlist: list of MJDs to process, defaulting to all MJDs
           found under indir
  clobber: set this to foce clobbering of existing image and invvar files.
  gzip: set this to cause output files to be gzipped (default is no gzip)
  minflat: sdssproc &quot;minflat&quot; keyword, default to 0.8
  maxflat: sdssproc &quot;maxflat&quot; keyword, default to 1.2
  pbs_nodes  - If set, collect the pbs qsub commands into pbs_nodes script files
                in order to run on clusters without node sharing (ie Utah).
                default to node sharing, and keep the pbs qsub commands in the
                individual plate-mjd SCRIPT files.
   pbs_ppn    - If set, use #PBS -l nodes=1:ppn=pbs_ppn, otherwise
                default to #PBS -l nodes=1
   pbs_a      - If set, use #PBS -A pbs_a, otherwise
                default to none
   pbs_walltime   - If set, use #PBS -l walltime=pbs_walltime, otherwise
                default to none
   pbs_scratch- If set, then write to the pbs_scratch  before rsync'ing with
                the plate-mjd output directories in $BOSS_SPECTRO_REDUX,
                default to none
   ember      - If set, then setup the defaults for the University of Utah:
                pbs_nodes = 8 (for 8 nodes, without node sharing) 
                pbs_ppn = 12 (12 processors per node)
                pbs_a = 'bolton-em' (Bolton's account, limited to 8 nodes: ember253 - ember260)
                pbs_walltime='48:00:00'
                pbs_scratch = $PBS_SCRATCH/userID/procdata/'  if $PBS_SCRATCH is set, otherwise /scratch/local/userID/procdata/


 WRITTEN:
  bolton@utah 2011jan
   10-Jan-2011  modified  by Joel R. Brownstein, University of Utah, 
                to generalize to cluster computers by writing PBS commands to bundled pbs batch files,
                which source job files containing the calls to sdssproc,
                via the keywords pbs_nodes, pbs_ppn, pbs_a
                and with University of Utah defaults preset via the
                keyword ember.
   14-jan-2011 bolton fix of non-pbs bug.
   14-Jan-2011 Brownstein added pbs_scratch
</pre>
<p><strong>(See pro/spec2d/run_sdssproc.pro)</strong></p>
<hr />
<h3 id="SDSSGUIDE">SDSSGUIDE</h3>
<p><a href="#RUN_SDSSPROC">[Previous Routine]</a></p>
<p><a href="#SDSSHEAD">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   sdssguide

 PURPOSE:
   Sloan telescope guider code

 CALLING SEQUENCE:
   sdssguide, [ plugdir=, guidedir= ]

 INPUTS:

 OPTIONAL INPUTS:
   plugdir    - Directory containing plPlugMapM files;
                default to '/data/plugMapM'
   guidedir   - Top-level directory containing guider images, with the
                largest MJD subdirectory chosen;
                default to '/data/gcam'

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The guide camera must already be in an independent loop taking images.
   Pausing the guider does not pause whatever routine is independently
     generating guider images.  When the guider is re-started, it will
     begin by analyzing the most recent image, which may mean never
     analyzing some older images.
   Stars are fit to a symmetric Gaussian.

 EXAMPLES:

 BUGS:
   Implement GUI interface with IDL widgets.
   Send TCC offset commands.
   If we can communicate with the TCC, then verify cartridge ID is mounted.
   Decide upon gain for telescope offsets, and whether to apply rotation
     and scale offsets (perhaps only once they become significantly bad).
   Reject outlier stars in telescope offset fits.
   Subtract dark frames, and mask bad pixels.
   Should write the SOP-like guider output file.
   Apply flat-fielding.
   Add S/N ceiling to images.
   Compute expected throughput, given the plugmap magnitudes.
   Store history of all previous guider info, for use in any
      more complex telescope offset decisions.
   Line plot with history of offsets, FWHM, throughput.
   Figure out how to change the ATV stretch levels dynamically, or use DS9.
   Offset guiding option.
   Need replacement script for spiralpattern when lost on the sky.

 DATA FILES:
   $IDLSPEC2D_DIR/examples/cartridgeInfo.par

 PROCEDURES CALLED:

 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   24-Aug-2008  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/guider/sdssguide.pro)</strong></p>
<hr />
<h3 id="SDSSHEAD">SDSSHEAD</h3>
<p><a href="#SDSSGUIDE">[Previous Routine]</a></p>
<p><a href="#SDSSPROC">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   sdsshead

 PURPOSE:
   Read in header from raw SDSS file.

 CALLING SEQUENCE:
   hdr = sdsshead(infile, [ indir= ] )

 INPUTS:
   infile     - Raw SDSS file name

 OPTIONAL KEYWORDS:
   indir      - Input directory for INFILE
   do_lock    - Keyword passed to SDSSPROC

 OUTPUTS:
   hdr        - Processed FITS header

 COMMENTS:

 BUGS:

 PROCEDURES CALLED:
   sdssproc

 REVISION HISTORY:
   27-May-2000  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/sdsshead.pro)</strong></p>
<hr />
<h3 id="SDSSPROC">SDSSPROC</h3>
<p><a href="#SDSSHEAD">[Previous Routine]</a></p>
<p><a href="#SDSS_PLATE_SORT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   sdssproc

 PURPOSE:
   Read in raw SDSS files, and process with opConfig, opECalib, opBC par files.

 CALLING SEQUENCE:
   sdssproc, infile, [image, invvar, indir=, $
    outfile=, nsatrow=, fbadpix=, $
    hdr=hdr, configfile=, ecalibfile=, bcfile=, $
    /applybias, /applypixflat, /silent, /do_lock, minflat=, maxflat=, $
    spectrographid=, color=, camname=, /applycrosstalk, ccdmask= ]

 INPUTS:
   infile     - Raw SDSS file name

 OPTIONAL KEYWORDS:
   indir      - Input directory for INFILE
   outfile    - Calibrated 2D frame, HDU#0 is the image and #1 is invvar;
                if set as /OUTFILE, then default name is constructed from
                INFILE as sdProc-XX-XXXXXXXX.fits, excluding any path info
   nsatrow    - Number of saturated rows, assuming that a row is saturated
                if at least 20 of its pixels are above saturation level
   fbadpix    - Fraction of bad pixels, not including bad columns
   configfile - Default to &quot;opConfig*par&quot;, selecting the file with the
                appropriate MJD.
   ecalibfile - Default to &quot;opECalib*par&quot;, selecting the file with the
                appropriate MJD.
   bcfile     - Default to &quot;opBC*par&quot;, selecting the file with the
                appropriate MJD.
   applybias  - Apply 2-D bias image.
   applypixflat- Apply 2-D pixel-to-pixel flat (after subtracting bias).
   silent     - If set, then don't output any text.
   do_lock    - If set, then lock the &quot;sdHdrFix-$MJD.par&quot; file
                using DJS_LOCKFILE().
   minflat    - Minimum values allowed for pixflat; pixels with the
                flat out of range are masked; default to 0.
   maxflat    - Maximum values allowed for pixflat; pixels with the
                flat out of range are masked; default to 1e10.
   applycrosstalk - choose whether or not to apply crosstalk correction

 OUTPUTS:

 OPTIONAL OUTPUTS:
   image      - Processed 2d image
   invvar     - Associated inverse variance
   hdr        - Processed FITS header
   spectrographid - Return spectrograph ID (1 or 2)
   color      - Return spectrograph color ('red' or 'blue')
   camname    - Return camera name: 'b1', 'r1', 'b2', or 'r2'
   ccdmask    - Image with 'NODATA' bit set for parts of BOSS data

 COMMENTS:
   Only the header is read from the image if IMAGE, INVVAR, OUTFILE and
   VARFILE are all not set.

   Required header keywords: EXPTIME.

   The returned image is in electrons, not ADU.

   The signal-to-noise is limited to never exceed 100, by adding 1.e-4
   times the flux squared to the variance term.

   Change the CAMERAS keyword to the camera as specified by the file name.

   Rename 'target' to 'science', and 'calibration' to 'arc' in the
   header keyword FLAVOR.

   Determine the exposure number from the file name itself.

 BUGS:
   The open-shutter correction SMEARIMG will include smeared data from
   any cosmic rays, which is wrong.  At the minimum, I could interpolate
   over A/D saturations (in ADMASK) before constructing SMEARIMG.

 PROCEDURES CALLED:
   djs_filepath()
   djs_iterstat
   fileandpath()
   findopfile()
   fits_purge_nans
   fits_wait()
   headfits()
   idlspec2d_version()
   idlutils_version()
   lookforgzip()
   mwrfits
   rdss_fits()
   sphdrfix
   splog
   sxaddpar
   sxpar()
   yanny_free
   yanny_read

 INTERNAL SUPPORT ROUTINES:
   make_badcolumn_mask()

 DATA FILES:
   $IDLSPEC2D_DIR/examples/opConfig*par
   $IDLSPEC2D_DIR/examples/opECalib*par
   $IDLSPEC2D_DIR/examples/opBC*par
   $SPECFLAT_DIR/biases/pixbias*.fits*
   $SPECFLAT_DIR/flats/pixflat*.fits*

 REVISION HISTORY:
   13-May-1999  Written by Scott Burles &amp; David Schlegel, Apache Point.
   08-Sep-1999  Modified to read Yanny param files instead of FITS
                versions of the same (DJS).
   01-Dec-1999  Added version stamping (DJS).
   07-Dec-1999  Mask neighbors of pixels that saturated the A/D converter.
                Identify blead trails and mask from that row up (DJS).
   10-Dec-1999  Test if the shutter was open during readout, and try
                to correct the light for that (DJS).
   04-Feb-2000  Declare that the shutter was open if it is a &gt;640 sec
                exposure taken before MJD=51570 (DJS).
   26-Jul-2000  Added fix for &quot;dropped pixel&quot; problem for data on or after
                MJD=51688 (23 May 2000).  Should disable this code for later
                MJD's once this problem is fixed in the electronics.
   26-Jul-2000  Added fix for more severe &quot;shifted row&quot; electronics problem
                for data taken on MJD=51578 to 51580 (3 to 5 Feb 2000).
   26-Aug-2000  Horrible kludge for this night MJD=51779 (22/23 Aug 2000).
                Add a noise term of 100 ADU to the left amplifier of r2.
                That amplifier had random bits being set incorrectly,
                in particular the 32 bit and 256 bit.
   04-Nov-2000  Measure the bias values using DJS_ITERSTAT instead of MEDIAN,
                since the median is always only an integer value.
   31-Jan-2001  Determine the exposure number from the file name itself,
                since the counting got off by one on MJD=51882.
   08-Aug-2011: Changing bias-subtraction recipe for BOSS (A. Bolton, Utah)
</pre>
<p><strong>(See pro/spec2d/sdssproc.pro)</strong></p>
<hr />
<h3 id="SDSS_PLATE_SORT">SDSS_PLATE_SORT</h3>
<p><a href="#SDSSPROC">[Previous Routine]</a></p>
<p><a href="#SDSS_SPEC_BLOCK">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   sdss_plate_sort

 PURPOSE:
   Resort the photoPlate files to the fiber numbering of a plugmap

 CALLING SEQUENCE:
   sdss_plate_sort, [ planfile ]

 INPUTS:

 OPTIONAL INPUTS:
   planfile   - Name(s) of output plan file; default to looping through
                all plan files matching 'spPlan2d*.par'

 OUTPUT:

 COMMENTS:
   The following files are input:
     $PHOTOPLATE_DIR/$PLATE/photoMatchPlate-$PLATE.fits
     $PHOTOPLATE_DIR/$PLATE/photoPlate-$PLATE.fits
     $PHOTOPLATE_DIR/$PLATE/photoPosPlate-$PLATE.fits
   The following files are output in the same directories as
   the plan files:
     photoMatchPlate-$PLATE-$MJD.fits
     photoPlate-$PLATE-$MJD.fits
     photoPosPlate-$PLATE-$MJD.fits

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:

 REVISION HISTORY:
   12-Apr-2010  Written by David Schlegel, LBL
</pre>
<p><strong>(See pro/spec2d/sdss_plate_sort.pro)</strong></p>
<hr />
<h3 id="SDSS_SPEC_BLOCK">SDSS_SPEC_BLOCK</h3>
<p><a href="#SDSS_PLATE_SORT">[Previous Routine]</a></p>
<p><a href="#SDSS_SPEC_IMAGE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   sdss_spec_block
 PURPOSE:
   take a set of sdss spectra and output as a big block
 CALLING SEQUENCE:
   sdss_spec_block
 INPUTS:
   plate - [N] list of plates
   fiberid - [N] list of fibers
   mjd - [N] list of mjds
 OPTIONAL INPUTS:
   avloglam - [nl] wavelength grid
   vdisp - try to get everything to this velocity dispersion (in km/s)
 OPTIONAL KEYWORDS:
   deextinct - apply corrections for galactic extinction
 OUTPUTS:
   block_flux - [nl, N] list of fluxes (as output by readspec)
   block_ivar - [nl, N] list of inverse variances
   block_lamba - [nl] output wavelengths (angstroms)
 DEPENDENCIES:
   idlutils
   idlspec2d
 BUGS:
   Input and output wavelength grids MUST be logarithmically spaced.
   ivar is unchanged when vdisp is used
   revision history wrong
 COMMENTS:
   Units are in 10^{-17} ergs/cm^2/s/A 
   Bolometric flux is kept constant in deredshifting step
    (ie. lambda -&gt; lambda/(1+z), flux -&gt; flux*(1+z), ivar -&gt;
    ivar/(1+z)^2)
 REVISION HISTORY:
   2001-11-17  written - Hogg (NYU)
</pre>
<p><strong>(See pro/science/sdss_spec_block.pro)</strong></p>
<hr />
<h3 id="SDSS_SPEC_IMAGE">SDSS_SPEC_IMAGE</h3>
<p><a href="#SDSS_SPEC_BLOCK">[Previous Routine]</a></p>
<p><a href="#SELECT_ARC">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
  sdss_spec_image
 PURPOSE:
  Create an image of a spectrum
 CALLING SEQUENCE:
  sdss_spec_image, outbase, plate, fiber, mjd=, xra=
 INPUTS:
  outbase - output file base
  plate - plate #
  fiber - fiber #
  mjd - MJD of observation
 OPTIONAL INPUTS:
  xra - [2] wavelength limits to plot (Ang)
 COMMENTS:
  Creates the files:
     [outbase].jpg
     [outbase].thumb.jpg
  which have a picture of the specified spectrum,
  with some nice annotation.
 REVISION HISTORY:
  Written by MRB, NYU 14-05-2010
</pre>
<p><strong>(See pro/spec1d/sdss_spec_image.pro)</strong></p>
<hr />
<h3 id="SELECT_ARC">SELECT_ARC</h3>
<p><a href="#SDSS_SPEC_IMAGE">[Previous Routine]</a></p>
<p><a href="#SELECT_FLAT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   select_arc

 PURPOSE:
   Select best arc from an arc structure produced with SPCALIB.

 CALLING SEQUENCE:
   bestarc = select_arc ( arcstruct )

 INPUTS:
   arcstruct  - Structure array with extracted arc calibration information

 OPTIONAL KEYWORDS:

 OUTPUTS:
   bestarc    - Structure with extracted arc calibration information
                for that arc selected from ARCSTRUCT

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djsig()

 REVISION HISTORY:
   25-Jan-2000  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/select_arc.pro)</strong></p>
<hr />
<h3 id="SELECT_FLAT">SELECT_FLAT</h3>
<p><a href="#SELECT_ARC">[Previous Routine]</a></p>
<p><a href="#SIMPLE_PLATE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   select_flat

 PURPOSE:
   Select best flat from a flat-field structure produced with SPCALIB.

 CALLING SEQUENCE:
   bestflat = select_flat( flatstruct, tai )

 INPUTS:
   flatstruct - Structure array with extracted flat calibration information
   tai        - Time of observation for object frame (from header card)

 OPTIONAL KEYWORDS:

 OUTPUTS:
   bestflat   - Structure array with extracted flat calibration information
                for best flat selected for the time specified by TAI.

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:

 REVISION HISTORY:
   25-Jan-2000  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/select_flat.pro)</strong></p>
<hr />
<h3 id="SIMPLE_PLATE">SIMPLE_PLATE</h3>
<p><a href="#SELECT_FLAT">[Previous Routine]</a></p>
<p><a href="#SKYLINE_DISPERSION">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   simple_plate

 PURPOSE:
   Routine to design a single plate.

 CALLING SEQUENCE:
   simple_plate, stardata, [ racen=, deccen=, tilenum=, platenum=, $
    airtemp=, nstd=, nminsky=, ngtarg=, /southern ]

 INPUTS:
   stardata   - Structure with data for each star; must contain the
                fields RA, DEC, MAG[5], HOLETYPE, OBJTYPE.
                HOLETYPE should be either 'OBJECT' or 'GUIDE'.
                Special values of OBJTYPE are 'SKY', 'REDDEN_STD' and 'SPECTROPHOTO_STD'.
                Other elements in the structure (such as PRIMTARGET,...)
                will be copied into the output plug-map files.
   racen      - RA center for tile
   deccen     - DEC center for tile

 OPTIONAL INPUTS:
   tilenum    - Tile number; default to 1.
   platenum   - Plate number; default to the same as TILENUMS.
   airtemp    - Design temperature for APO; default to 5 deg C.
 COMMENTS:
   All objects will be put on the plate. It will not choose STDs or
   SKY on its own, leaving those to makePlates. 

   If non-SKY and non-SPECTROPHOTO/REDDEN_STD objects collide with one
   another at all (are &lt; 55'' apart) this routine will halt and
   report an error.

   This script generates the following files:
     plObs.par
     plPlan.par
     plPlugMapT-$TILE.par
     plPlugMapP-$PLATE.par
   The commands from the SDSS &quot;plate&quot; product generate the following files:
     makePlates - Generate plPlugMapP-$PLATE.par
     fiberPlates - Generate plOverlay-$PLATE.par, and **overwrite**
                   the file plPlugMapP-$PLATE.par
     makeFanuc - Generate plFanuc-$PLATE.par
     makeDrillPos - Generate plMeas-$PLATE.par, plDrillPos-$PLATE.par
     use_cs3 - Generates no files.  Simply reports fiber collisions.
     makePlots - Generate plOverlay-$PLATE.ps

   When there is a problem, the &quot;fiberPlates&quot; script outputs error
   messages like:
     collision at 554 = {307 125 6 160 47} OBJECT with...
     collision at 565 = {307 125 2 168 4015} COHERENT_SKY with...

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   concat_dir()
   current_mjd()
   djs_diff_angle()
   splog
   yanny_readone()
   yanny_write

 INTERNAL SUPPORT ROUTINES:
   approx_radec_to_xyfocal
   design_append()

 REVISION HISTORY:
   14-Jan-2002  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/plate/simple_plate.pro)</strong></p>
<hr />
<h3 id="SKYLINE_DISPERSION">SKYLINE_DISPERSION</h3>
<p><a href="#SIMPLE_PLATE">[Previous Routine]</a></p>
<p><a href="#SKYMASK">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   skyline_dispersion

 PURPOSE:
   Measure and apply broadening to dispersion solution from an arc traceset
   to agree with widths of sky lines, which may be broader due to flexure.

 CALLING SEQUENCE:
   skydispset = skyline_dispersion(flux, fluxivar, xcen, iskies, dispset)

 INPUTS:
   flux        - Object extracted flux [NPIX,NTRACE]
   fluxivar    - Corresponding inverse variance [NPIX,NTRACE]
   xcen        - xpeaks of sky lines [NTRACE,NLINES]
   iskies      - Fiber indices corresponding to good sky fibers;
                 default to using all fibers if this is not set.
   dispset     - Original arcline solution for resolution vs. pixel
                 (typically measured in native pixels)

 OPTIONAL KEYWORDS:

 OUTPUTS:
   skydispset  - Modified version of DISPSET with dispersions broadened
                 to agree with the sky line widths.

 OPTIONAL OUTPUTS:

 COMMENTS:
   The pixel dispersion can be broadened, but never made smaller.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_iterstat
   extract_image
   splog
   traceset2xy
   xy2traceset

 REVISION HISTORY:
   20-Feb-2002  Written by S. Burles, MIT (Adapted from fitdispersion)
</pre>
<p><strong>(See pro/spec2d/skyline_dispersion.pro)</strong></p>
<hr />
<h3 id="SKYMASK">SKYMASK</h3>
<p><a href="#SKYLINE_DISPERSION">[Previous Routine]</a></p>
<p><a href="#SKYSPEC_PARANAL">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   skymask

 PURPOSE:
   Mask regions in spectra where sky-subtraction errors are expected to
   dominate.

 CALLING SEQUENCE:
   newivar = skymask(objivar, andmask, [ormask, ngrow= ])

 INPUTS:
   objivar    - Inverse variance array [NPIX,NOBJ]
   andmask    - Mask from spectro-2D outputs, usually the AND-mask [NPIX,NOBJ]

 OPTIONAL INPUTS:
   ormask     - Optional OR-mask [NPIX,NOBJ]; if specified, then also mask
                wherever the REDMONSTER bit is set in this mask.
   ngrow      - Numbers of pixels neighboring masked pixels to reject along
                each spectrum; default to 2.

 OUTPUTS:
   newivar    - Modified OBJIVAR, where masked pixels are set to zero
                [NPIX,NOBJ]

 COMMENTS:
   Grow the mask by 2 pixels in each direction for each spectrum.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   pixelmask_bits()

 REVISION HISTORY:
   12-Oct-2000  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/skymask.pro)</strong></p>
<hr />
<h3 id="SKYSPEC_PARANAL">SKYSPEC_PARANAL</h3>
<p><a href="#SKYMASK">[Previous Routine]</a></p>
<p><a href="#SKYSUBTRACT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   skyspec_paranal

 PURPOSE:
   Return the sky spectrum at Paranal

 CALLING SEQUENCE:
   skyflux = skyspec_paranal(loglam, [ disp= ] )

 INPUTS:
   loglam     - Log10 of wavelengths [vacuum Ang]; need not be uniformly
                spaced

 OPTIONAL INPUTS:
   disp       - Sigma of the intrumental response (dispersion) in units
                of the LOGLAM pixels, either as a scalar, or as a vector
                with the same number of elements as LOGLAM.
                If not set, then the returned sky spectrum is at the
                resolution of the Paranal data files, and will be
                undersampled for any resolution worse than about 100,000.

 OUTPUTS:
   skyflux    - Sky spectrum in units of e-17 erg/s/cm^2/Ang/asec^2

 OPTIONAL OUTPUTS:

 COMMENTS:
   The lowest sky level is on plate 1292/52736 taken at airmass=1.04.
   A representative low sky level is plate 406/51817.
   A high sky level is plate 298/51955.

 EXAMPLES:

 BUGS:
   The Paranal sky spectra are missing data from 8550-8610 Ang.
   There are a few regions where their spectra are not in agreement
   with the lower-resolution SDSS sky spectra such as at 7600-7650 Ang,
   probably because the SDSS spectra &quot;correct up&quot; the sky level for
   the telluric absorption.  Also, the Paranal sky is higher than SDSS
   by about a factor of 2 blueward of 4800 Ang.

 DATA FILES:
   $IDLSPEC2D_DIR/templates/fluxed_sky_346.fits
   $IDLSPEC2D_DIR/templates/fluxed_sky_580L.fits
   $IDLSPEC2D_DIR/templates/fluxed_sky_860L.fits
   $IDLSPEC2D_DIR/templates/fluxed_sky_437.fits
   $IDLSPEC2D_DIR/templates/fluxed_sky_580U.fits
   $IDLSPEC2D_DIR/templates/fluxed_sky_860U.fits
   $IDLSPEC2D_DIR/templates/fluxed_sky_564U.fits
   $IDLSPEC2D_DIR/templates/fluxed_sky_800U.fits

 PROCEDURES CALLED:
   djs_maskinterp()
   mrdfits()
   populate_image
   sxpar()

 REVISION HISTORY:
   20-Mar-2006  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/photoz/skyspec_paranal.pro)</strong></p>
<hr />
<h3 id="SKYSUBTRACT">SKYSUBTRACT</h3>
<p><a href="#SKYSPEC_PARANAL">[Previous Routine]</a></p>
<p><a href="#SLITHISTORY">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   skysubtract

 PURPOSE:
   Sky-subtract an image and modify the variance

 CALLING SEQUENCE:
   skystruct = skysubtract(objflux, objivar, plugsort, wset, objsub, objsubivar, $
    [ iskies= , fibermask=, nord=, upper=, lower=, maxiter=, pixelmask=, $
    dispset=, /novariance, relchi2set=, npoly=, tai=, newmask=, sset= ])

 INPUTS:
   objflux    - Image flux [NPIX,NFIBER]
   objivar    - Inverse variance for OBJFLUX [NPIX,NFIBER]
   plugsort   - Plugmap structure trimmed to one element per fiber [NFIBER]
   wset       - Structure with traceset of wavelength solution

 OPTIONAL KEYWORDS:
   fibermask  - Fiber status bits, set nonzero for bad status [NFIBER]
   pixelmask  - Mask of 0 for good pixels [NPIX,NFIBER]
   thresh     - Treshold in relative chi^2 for identifying BADSKYCHI in;
                the pixel mask.  Default to 4.0, and pass this value to
                the REDMONSTER function.
   novariance - Set keyword to prevent variance correction for sky residuals
   relchi2set - Structure containing information of chi^2 fitting;
                only call REDMONSTER to set those mask bits if this
                keyword is passed.
   npoly      - Polynomial order of 2d fit for dependence on fiber number.
   tai        - TAI of plate exposure, if supplied a linear airmass correction
                  is applied
   nbkpt      - Number of bkpts to use for full sky spectrum fit.
                This gives us the freedom to use less points for the
                blue side.

 DISABLED LEGACY KEYWORDS:
   dispset    - Dispersion trace-set; if present, then solve for the
                super-sky vector using a variable PSF described by this
                structure.  (Superseded by NPOLY and fiber number)

 PARAMETERS FOR SLATEC_SPLINEFIT (for supersky fit):
   nord       - Order of B-spline; default set in BSPLINE_ITERFIT()
   upper      - Low rejection sigma; default to 10
   lower      - High rejection sigma; default to 10
   maxiter    - Maximum number of iterations for reject loop; default to 5

 OUTPUTS:
   skystruct  - structure containing sorted sky wavelengths,flux,fluxivar
                      +  bkpts and coeffs from fitting
   objsub     - Image (OBJFLUX) after sky-subtraction
   objsubivar - Inverse variance (OBJIVAR) after sky-subtraction

 OPTIONAL OUTPUTS:
   iskies     - Indices of good sky fibers
   newmask    - Modified version of PIXELMASK,
   sset       - B-spline structure for supersky.

 COMMENTS:
   Construct a &quot;supersky&quot; spectrum by spline-fitting the (good) sky fibers,
   resampling this at every wavelength in the extracted image, then
   subtracting.  We then measure the variance of the sky-subtracted sky
   fibers in terms of chi^2.  Wherever chi^2 &gt; 1, we increase the variance
   of all fibers such that chi^2=1 in the sky fibers.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   bspline_iterfit()
   bspline_valu()
   gauss_kernel()
   pixelmask_bits()
   redmonster
   splog
   tai2airmass()
   traceset2xy

 REVISION HISTORY:
   16-Sep-1999  Written by S. Burles, APO
   30-Dec-1999  Modified by D. Schlegel, Princeton
    4-Oct-2000  Changed to bspline_iterfit 
   26-Jul-2001  Implemented Higher-order fits, if dispset is set it fits
                  against fiber number (I know this doesn't make sense)
                Also upped the tolerance on rejection by 5 times!
                Too many pixels were masked for high order fit!
</pre>
<p><strong>(See pro/spec2d/skysubtract.pro)</strong></p>
<hr />
<h3 id="SLITHISTORY">SLITHISTORY</h3>
<p><a href="#SKYSUBTRACT">[Previous Routine]</a></p>
<p><a href="#SMALLCOLLIMATE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   slithistory

 PURPOSE:
   Plot the history of spectro slit-head positions based upon plSlitpos files.

 CALLING SEQUENCE:
   slithistory, [ mjdrange= ]

 INPUTS:

 OPTIONAL INPUTS:
   mjdrange   - 2-element vector of plotting range in MJD; default to
                using all MJDs.

 OUTPUT:

 COMMENTS:
   A single PostScript file is created &quot;Slithistory-$MJDSTART-$MJDEND.ps&quot;,
   with one page per cartridge.  The fiber bundle spacing is plotted
   in units of the fiber-mapper stepper motor steps.

 EXAMPLES:
   Make plots of history of slit-head positions for all time:
     IDL&gt; slithistory

   Make plots of history of slit-head positions between MJD 52000 and MJD 52020:
     IDL&gt; setenv, 'SPECLOG_DIR=/scr/spectro1/spectro/scan'
     IDL&gt; slithistory, mjdrange=[52000,52020]

 BUGS:

 PROCEDURES CALLED:
   dfpsclose
   dfpsplot
   fileandpath()
   yanhy_free
   yanny_par()
   yanny_read

 REVISION HISTORY:
   19-Nov-2002  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/apo2d/slithistory.pro)</strong></p>
<hr />
<h3 id="SMALLCOLLIMATE">SMALLCOLLIMATE</h3>
<p><a href="#SLITHISTORY">[Previous Routine]</a></p>
<p><a href="#SMEARTIMES">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   smallcollimate

 PURPOSE:
   Compute the spectrograph collimation focus from Hartmann mask exposures.

 CALLING SEQUENCE:
   smallcollimate, expnum1, [ expnum2, docams=, indir=, nregx=, nregy=, $
    maxshift=, /nocheck, /debug, /simple ]

 INPUTS:
   expnum1    - First exposure number of raw sdR file.

 OPTIONAL KEYWORDS:
   expnum2    - Second exposure number; default to EXPNUM1+1.
   docams     - Cameras to analyze; default to ['b1','b2','r1','r2'].
   indir      - Input directory for files; default to searching for
                files in $BOSS_SPECTRO_DATA/*.  If $BOSS_SPECTRO_DATA is not set,
                then it is assumed to be /data/spectro.
   nregx      - Number of sub-regions in the X dimension; default to 8.
   nregy      - Number of sub-regions in the Y dimension; default to 8.
   maxshift   - Maximum pixel shift to search in both X and Y; default to 3.
   nocheck    - If set, then assume that the 1st exposure is Hartmann-l,
                and the 2nd exposure is Hartmann-r, rather than looking at
                the OBSCOMM header keyword.  This correct keywords are
                added by the SOP goSpecFocus command, but will not be if
                you simply move the collimator and shutters yourself.
                (Deprecated to never do this check, since BOSS has
                no header keywords.)
   debug      - flag to remove hardwired subregions and fits and instead
                process all of the data in the array.  Much slower than the
                nominal routine but informative for tests of focus variation
                across full illuminated area
   simple      - generate simpler output, for the benefit of external programs.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The focus of the collimator is measured by comparing two Hartmann
   exposures of arc lamps, and looking for shifts in the arc line positions.
   A linear correlation coefficient is computed independently in NREGX
   by NREGY regions on each CCD as a function of pixel shifts of the 2nd
   image in both X and Y.  The best-focus value is found in each region
   by maximizing the linear correlation in the Y (wavelength) direction.
   
   The following files are output for each camera:
     Collimate-$MJD-$CAMERA-$EXPNUM1.log
     Collimate-$MJD-$CAMERA-$EXPNUM1.ps

   The position of the Hartmann shutters is read from the OBSCOMM header
   keywords for SDSS-I.  It is expected to be '{focus, hartmann l}'
   for one exposure and '{focus, hartmann r}' for the other (in either
   order).  For BOSS, the HARTMANN keyword is read and must be either
   'Left' or 'Right'.
   It is assumed that the collimator position is identical for both exposures.

   The sense of the pixel shifts reported is what one would have to shift
   the Hartmann-r exposure by in Y to agree with the Hartmann-l exposure.

 EXAMPLES:
   Solve for the focus of all 4 CCD's from exposures 10812+10813
   on MJD 52161 (assuming the files exist in /data/spectro/52161):
     IDL&gt; collimate, 10812

 BUGS:

 PROCEDURES CALLED:
   dfpsclose
   dfpsplot
   djs_filepath()
   djs_icolor()
   sdssproc
   splog
   sxpar()

 INTERNAL SUPPORT ROUTINES:
   collimate_obscomm()
   collimate_bad_hdr()

 REVISION HISTORY:
   28-Mar-2002  Written by D. Schlegel, Princeton
   01-Sep-2009  K. Dawson, Utah
</pre>
<p><strong>(See pro/apo2d/smallcollimate.pro)</strong></p>
<hr />
<h3 id="SMEARTIMES">SMEARTIMES</h3>
<p><a href="#SMALLCOLLIMATE">[Previous Routine]</a></p>
<p><a href="#SMEAR_COMPARE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   smeartimes

 PURPOSE:
   List the TAI timestamps of 'smear' exposures in a log file.

 CALLING SEQUENCE:
   smeartimes

 INPUTS:

 OPTIONAL INPUTS:

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:
   All raw spectro files (sdR files) have their headers read and
   their start and end time stamps computed.  The purpose of this
   is to get an exact list of times and determine from the TPM logs
   whether the telescope moved in the way that it was supposed to
   during these 'smear' exposures.

   The file names and their timestamps are written to the following files.
     timestamps-all.log
     timestamps-smear.log

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   sdssproc
   splog
   struct_print

 REVISION HISTORY:
   10-Dec-2002  Written by David Schlegel, Princeton (not checked in then)
</pre>
<p><strong>(See pro/plan/smeartimes.pro)</strong></p>
<hr />
<h3 id="SMEAR_COMPARE">SMEAR_COMPARE</h3>
<p><a href="#SMEARTIMES">[Previous Routine]</a></p>
<p><a href="#SMOOTH_HALO[1]">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   smear_compare

 PURPOSE:
   Ratio calibrated smear and science spectra and fit with a 3rd order 
   polynomial.

 CALLING SEQUENCE:
   smearset = smear_compare(smearname, sciloglam, sciflux, sciivar, $
     best_exp_str, plate_str, mjd_str, [camnames=, combinedir=, $
     tsobjname=, nord=nord, adderr=, noplot=])

 INPUTS:
   smearname - list of smear exposure names [nsmear * nexp]
   sciloglam - wavelength (log10 (A)) of calibrated science image [npix]
   sciflux   - flux of fully calibrated science image [npix,nfiber]
   sciivar   - inverse variance of calibrated science image [npix,nfiber]
   best_exp_str - string containing the exposure ID of the best science image.
                  The fluxcalib vector from this image takes the place of the
                  PCA average vector for the smear.
   plate_str - plate id -- used to reconstruct standard star FITS filename
   mjd_str - MJD -- used to reconstruct standard star FITS filename

 OUTPUT:
   A structure containing the median smear and science S/N and the 
   Legendere coeff of the smear/sci flux ratio for each fiber is returned

 KEYWORDS:
   camnames   - defaults to ['b1', 'b2', 'r1', 'r2']
   combinedir - optional output directory
   tsobjname  - full path name of tsobjfile 
   nord       - order of spline fit when combining exposures (defaults to 3)
   adderr     - additional error to add to formal error 
   noplot     - toggle some of the plotting

 COMMENTS:
   The smear images are calibrated in a manner nearly identical to the 
   calibration of the science images.  The smear and science image are
   coarsely binned with locally deviant points rejected.  The ratio 
   (smear/sci) is fit with a 3rd order Legendre polynomial.  The structure
   which is returned contains the Legendre coeff as well as the median S/N
   of the binned smear and science frames.  The smear/sci ratio is probably
   meaningless for object with a S/N &lt; 3 in the science image or &lt; 1 in the
   smear.
   
 BUGS:
   The smear/science flux ratio is only meaningful for high S/N point 
   sources!!!!
   
 EXAMPLES:
   To turn the coeff back into vectors do:
  
   smear_hdu = mrdfits('spPlate-0503-51999.fits', 8) 
   smearset = {func: 'legendre', xmin: alog10(3800.0), xmax: alog10(9200.0), $
               coeff: dblarr(3,640)}
   smearset.coeff = smear_hdu.legendre_coeff
   readspec, 503, mjd=51999, wave=wave
   traceset2xy, smearset, alog10(wave), sratio
   ok = where(smear_hdu.smear_sn gt 1 and smear_hdu.sci_sn gt 3)
   plot, wave[*,ok], sratio[*,ok], psym=3

 PROCEDURES CALLED:
   bspline_valu
   combine1fiber
   divideflat
   djs_filepath
   djs_icolor
   djs_oplot
   djs_plot
   legend
   sphoto_calib
   splog
   spmedian_rebin
   spread_frames
   traceset2xy
   xy2traceset

 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   12-Aug-2003  Created by C. Tremonti, Steward Observatory
</pre>
<p><strong>(See pro/fluxfix/smear_compare.pro)</strong></p>
<hr />
<h3 id="SMOOTH_HALO[1]">SMOOTH_HALO[1]</h3>
<p><a href="#SMEAR_COMPARE">[Previous Routine]</a></p>
<p><a href="#SMOOTH_HALO[2]">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   smooth_halo

 PURPOSE:
   Given a model image of the CCD, smooth and return a halo image

 CALLING SEQUENCE:
   smooth  = smooth_halo2d ( image, wset, [kernel_size= ] )

 INPUTS:
   image   - Image to smooth, this should be something like ymodel
                 form extract_image
   wset    - Wavelength solution 

 OPTIONAL KEYWORDS:
   kernel_size - size of box relative to r0, default = 3.
                  a value of 5 or higher may be safer.

 OUTPUTS:
   smooth  - Smoothed halo image, same size as image

 OPTIONAL OUTPUTS:

 COMMENTS:
    2d version with surface brightness function given by J Gunn

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   traceset2xy

 REVISION HISTORY:
   29-Sep-2000  Original Written by S. Burles, FNAL
    3-Feb-2005  Finally attempted 2-d convolution, not too slow...
</pre>
<p><strong>(See pro/spec2d/smooth_halo2d.pro)</strong></p>
<hr />
<h3 id="SMOOTH_HALO[2]">SMOOTH_HALO[2]</h3>
<p><a href="#SMOOTH_HALO[1]">[Previous Routine]</a></p>
<p><a href="#SMOOTH_SUPERFLAT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   smooth_halo

 PURPOSE:
   Given a model image of the CCD, smooth and return a halo image

 CALLING SEQUENCE:
   smooth  = smooth_halo ( image, wset )

 INPUTS:
   image   - Image to smooth, this should be something like ymodel
                 form extract_image
   west    - Wavelength solution 

 OPTIONAL KEYWORDS:

 OUTPUTS:
   smooth  - Smoothed halo image, same size as image

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:
   Only does a 1d halo correction, does not spread the halo scattering
    in the dispersion correction.  
   Parameters for halo term are hardwired and only qualitatively tested
    on a few frames.

 PROCEDURES CALLED:
   traceset2xy

 REVISION HISTORY:
   29-Sep-2000  Written by S. Burles, FNAL
</pre>
<p><strong>(See pro/spec2d/smooth_halo.pro)</strong></p>
<hr />
<h3 id="SMOOTH_SUPERFLAT">SMOOTH_SUPERFLAT</h3>
<p><a href="#SMOOTH_HALO[2]">[Previous Routine]</a></p>
<p><a href="#SN_MEDIAN">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   smooth_superflat

 PURPOSE:
   Take the superflat fit and target wavelengths and filter superflat
    to be sure to remove spurious features

 CALLING SEQUENCE:
   smooth_fit = smooth_superflat( superflatset, airset )

 INPUTS:
   superflatset - Superflat bsplineset returned from &quot;superflat&quot;
   airset       - Wavelength solution (preferably shifted to match skylines)

 OPTIONAL KEYWORDS:

 OUTPUTS:
   smooth_fit   - Filtered superflat fit smoothed over about 4 pixels

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   bspline_iterfit()
   bspline_valu()
   djs_oplot
   djs_plot
   traceset2xy

 REVISION HISTORY:
   27-Jul-2001  Written by S. Burles, FNAL
</pre>
<p><strong>(See pro/spec2d/smooth_superflat.pro)</strong></p>
<hr />
<h3 id="SN_MEDIAN">SN_MEDIAN</h3>
<p><a href="#SMOOTH_SUPERFLAT">[Previous Routine]</a></p>
<p><a href="#SOLVEFILTER">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   sn_median

 PURPOSE:
   Compute median spectroscopic S/N in the SDSS filters

 CALLING SEQUENCE:
   snmed = sn_median(loglam, objflux, objivar)

 INPUTS:
   loglam     - Log10 wavelength [NPIX]
   objflux    - Flux [NPIX,NOBJ]
   objivar    - Inverse variance in same units as OBJFLUX [NPIX,NOBJ]

 OPTIONAL KEYWORDS:

 OUTPUTS:
   snmed      - Median S/N in each of the SDSS filters per pix [5,NOBJ]

 OPTIONAL OUTPUTS:

 COMMENTS:
   The median S/N is computed for only good data points that fall
   within some hard-wired wavelength ranges defined by those
   wavelengths at which the SDSS filters have half the transmission
   of the mean transmission between those wavelengths.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:

 REVISION HISTORY:
   16-Feb-2011  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/spec2d/sn_median.pro)</strong></p>
<hr />
<h3 id="SOLVEFILTER">SOLVEFILTER</h3>
<p><a href="#SN_MEDIAN">[Previous Routine]</a></p>
<p><a href="#SPADD_GUIDERINFO">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   solvefilter

 PURPOSE:
   Solve for the 2.5-m imaging filter curves by using the spectra.

 CALLING SEQUENCE:
   solvefilter, [ filttype=, filternum=, plate=, mjd=, $
    starerr=, qsoerr=, wavemin=, wavemax=, magrej=, sncut=, maxiter=, $
    fluxpath=, value=, fixed= ]

 INPUTS:

 OPTIONAL INPUTS:
   filttype   - Type of functional form for the filter curve.  Options are:
                  'sdss': Modified SDSS filter curve (default).  3 params.
                  'tanh': Function with tanh() shape at edges. 5 params.
   filternum  - Filter number, 1=g, 2=r, 3=i; default to 3.
   plate      - Plate number(s); if not specified, then select all DR1 plates
                with number &gt; 431.
   mjd        - MJD for each PLATE.
   starerr    - Fractional error to add in quadrature to photometric errors
                for stars; default to 0.05; if &lt;=0, then do not use stars.
   qsoerr     - Fractional error to add in quadrature to photometric errors
                for QSOs; default to 0.15; if &lt;=0, then do not use QSOs.
   wavemin    - Minimum wavelength for spectra during computation;
                default to 3800 Ang.
   wavemax    - Maximum wavelength for spectra during computation;
                default to 9300 Ang.
   magrej     - Reject any objects where the raw photo vs. spectro magnitude
                difference is more than MAGREJ from the median difference
                for that plate.  This will reject wild outliers, which are
                often objects where there is a bright blend but the PHOTO
                flux is only for a fainter child.  Default value is 0.5 mag.
                Or, QSOs that have varied.
   sncut      - Minimum SN_MEDIAN (median S/N per pixel) for spectroscopic
                objects used in sample; default to 2.0
   maxiter    - Maximum number of iterations in call to MPFIT(); default to 200
   fluxpath   - Path name for spPlate files used for reading the spectra.
                The spZ files are still read from $BOSS_SPECTRO_REDUX/$PLATE
                regardless of this keyword.
   value      - Initial guess values for the fit parameters.  The default
                values are chosen to closely match the Gunn Jun-2001 curves.
   fixed      - A vector of elements set to 0 for each parameter to be fit,
                and 1 for each parameter value to fix.  Default to fitting
                all parameters.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   For FILTTYPE='tanh', the following function response(loglam) is fit:
     m = (a[4] - 1) / (a[1] - a[0])
     b = 1 - m * a[0]
     Filter = tahn((loglam - a[0])*a[2]) + 1)
            * tahn((a[1] - loglam)*a[3]) + 1)
            * (m * loglam + b)
   There are a total of five a[] parameters above.
   The default initial-guess values for g-band are:
     a = [alog10(3950), alog10(5325), 100, 140, 2.0]
   The default initial-guess values for r-band are:
     a = [alog10(5580), alog10(6750), 130, 160, 1.2]
   The default initial-guess values for i-band are:
     a = [alog10(6915), alog10(8210), 150, 220, 0.55]

   For FILTTYPE='sdss', we fit a modified version of the Gunn Jun-2001
   filter curves.  The wavelength scale is remapped with a shift and
   rescaling, which has the effect of moving the filter edges.  The
   filter shape is also multiplied by a function that is linear in
   log-wavelength, which has the effect of changing the broad-band
   slope of the filter.  Given a filter curve Gunnfilt(loglam), it is
   re-mapped as follows:
     slopeterm = (loglam - 3.5)^theta[2]
     Filter(loglam) = Gunnfilt((loglam + a[1]) * a[0]) * slopeterm
   The default initial-guess values for the three a[] parameters are always:
     a = [0, 1.0, 0.01]
   The effect of a positive a[2] makes the filter slope more upwards
   with wavelength, and a negative a[2] makes it slope more downwards.

   Iteratively solve for the SDSS 2.5-m filter curves, using one of
   the several possible parameterizations as specified by FILTTYPE.
   For each possible filter curve, we regress the spectroscopic magnitude
   vs. the photometric magnitude.  In order to not be sensitive to
   photometric calibration errors, each group of objects (same RUN, RERUN,
   CAMCOL, PLATE, SPECTROGRAPHID) is allowed to have a floating zero-point
   offset.  These offsets are plotted as MAGOFFSET in one of the final plots.

   We only use spectroscopically-confirmed stars and QSOs, not any galaxies.
   Anything targetted as a galaxy is rejected.  Any blended objects are
   rejected.  Anything with the following bits set is rejected:
   OBJECT2_SATUR_CENTER, OBJECT2_INTERP_CENTER, OBJECT2_PSF_FLUX_INTERP.
   These last cuts remove stars with CRs in the core on the i-band images
   that were targetted as QSOs -- this was actually due to a bug in PHOTO
   that called stars CRs when the seeing was too good, then the incorrect
   CR-removal made the i-band 2 mags fainter, and these things were targetted
   as QSOs.

   All calculations are done in vacuum wavelengths, but then converted
   to air wavelengths at the end.

 EXAMPLES:
   Solve for the i-band filter using Tremonti's re-reductions of the spectra:
     IDL&gt; solvefilter, filternum=3, fluxpath='/scr/wire50/cat/recalib/kurucz'

 BUGS:
   I should average together more telluric spectra for better S/N.
   I should use the extinction coeff for each imaging night.
   Do Christy's flux-calibrations improve things?
   Do any objects argue for light leaks?
   Should we more heavily weight the QSOs?

 DATA FILES:
   $IDLUTILS/data/filters/sdss_jun2001_$FILTER_atm.dat
   $BOSS_SPECTRO_REDUX/0432/spFrame-r2-00007466.fits*  (for telluric-correction)
   $BOSS_SPECTRO_REDUX/$PLATE/spPlate-$PLATE-$MJD.fits
   $BOSS_SPECTRO_REDUX/$PLATE/spZbest-$PLATE-$MJD.fits
   $BOSS_SPECTRO_REDUX/plates/tsObj*-$PLATE.fit

 PROCEDURES CALLED:
   dfpsclose
   dfpsplot
   djs_int2bin()
   djs_maskinterp()
   djs_oplot
   djs_plot
   djs_xyouts
   headfits()
   idlspec2d_version()
   mpfit()
   mrdfits()
   readcol
   readspec
   sdss_run2mu()  (in photoop product)
   skymask()
   splog
   tai2airmass()
   traceset2xy
   wavevector()

 INTERNAL SUPPORT ROUTINES:
   solvefiltshape()
   solvefiltfn()

 REVISION HISTORY:
   05-Nov-2002  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/spec1d/solvefilter.pro)</strong></p>
<hr />
<h3 id="SPADD_GUIDERINFO">SPADD_GUIDERINFO</h3>
<p><a href="#SOLVEFILTER">[Previous Routine]</a></p>
<p><a href="#SPALLFLAT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spadd_guiderinfo

 PURPOSE:
   Add seeing and RMS offset header cards by parsing guiderMon-$MJD.par

 CALLING SEQUENCE:
   spadd_guiderinfo, hdr

 INPUTS:
   hdr        - FITS header

 OPTIONAL INPUTS:

 OUTPUTS:
   hdr        - FITS header (modified)

 COMMENTS:
   This routine recalls the beginning and ending exposure time-stamps
   and collects all seeing and guider offsets available from the 
   speclog file: guiderMon-mmmmm.par (where mmmmm is MJD).

   It reports the 20,50,80% seeing and RMS guiding deviations
   (closely resembles -1,0,+1 sigma for normal distributions).
   The following keywords are added: RMSOFF20, RMSOFF50, RMSOFF80,
   SEEING20, SEEING50, SEEING80.
   All quantities are quoted in arcseconds.
   
   Results of 0.0 mean entries do not exist or are ill-defined.

 EXAMPLES:
   filename = 'sdR-b2-00003976.fit'
   hdr = headfits(filename)
   spadd_guiderinfo, hdr

 BUGS:

 PROCEDURES CALLED:
   concat_dir()
   fileandpath()
   get_tai
   splog
   sxaddpar
   sxpar()
   yanny_free
   yanny_read

 INTERNAL SUPPORT ROUTINES

 DATA FILES:
   $SPECLOG_DIR/$MJD/guiderMon-$MJD.par

 REVISION HISTORY:
   28-Jan-2002  Written by S. Burles, MIT
</pre>
<p><strong>(See pro/spec2d/spadd_guiderinfo.pro)</strong></p>
<hr />
<h3 id="SPALLFLAT">SPALLFLAT</h3>
<p><a href="#SPADD_GUIDERINFO">[Previous Routine]</a></p>
<p><a href="#SPBIASAVE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spallflat

 PURPOSE:
   Calling script for SPFLATTEN that generates pixel flats as specified in
   a plan file.

 CALLING SEQUENCE:
   spallflat, planfile=planfile

 INPUTS:

 OPTIONAL INPUTS:
   planfile   - Name of output plan file; default to 'spPlanFlat.par'

 OUTPUT:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   spflatten
   yanny_par()
   yanny_read

 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   02-Nov-1999  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/spec2d/spallflat.pro)</strong></p>
<hr />
<h3 id="SPBIASAVE">SPBIASAVE</h3>
<p><a href="#SPALLFLAT">[Previous Routine]</a></p>
<p><a href="#SPBIASGEN">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spbiasave

 PURPOSE:
   Average together a set (or all!) 2D pixel biases.

 CALLING SEQUENCE:
   spbiasave, [ mjd=, mjstart=, mjend=, mjout=, indir=, outdir=, docam= ]

 INPUTS:

 OPTIONAL INPUTS:
   mjd        - Valid MJD's for input pixel biases.
   mjstart    - Valid starting MJD for input pixel biases.
   mjend      - Valid ending MJD for input pixel biases.
   mjout      - MJD for name of output average pixel bias; default to 0,
                resulting in file names like 'pixbiasave-00000-b1.fits'.
   indir      - Input directory; default to current directory.
   outdir     - Output directory; default to same as INDIR.
   docam      - Camera names; default to all cameras: ['b1', 'b2', 'r1', 'r2']

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Some sigma-clipping is done before combining each pixel, clipping
   at 2-sigma if more than 7 frames, and a lower sigma for fewer frames.

   The output file has two HDU's, the first being the average bias,
   the second being the standard deviation at each pixel.
     --&gt; Comment this out for the time being!!???

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_filepath()
   djs_iterstat
   fileandpath()
   headfits()
   mrdfits()
   splog
   sxaddpar
   sxpar()
   writefits

 REVISION HISTORY:
   26-Feb-2002  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/spbiasave.pro)</strong></p>
<hr />
<h3 id="SPBIASGEN">SPBIASGEN</h3>
<p><a href="#SPBIASAVE">[Previous Routine]</a></p>
<p><a href="#SPCALIB">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spbiasgen

 PURPOSE:
   Routine to generate mean biases for a night.

 CALLING SEQUENCE:
   spbiasgen, [ mjd=, expnum=, expstart=, expend=, timesep=, $
    indir=, outdir=, docam=, sigrej=, maxiter=, /noproc ]

 INPUTS:

 OPTIONAL INPUTS:
   mjd        - If INDIR not set, then look for files in $BOSS_SPECTRO_DATA/MJD.
   expnum     - If set, then use these exposure numbers
   expstart   - If set, then only use exposure numbers &gt;= EXPSTART
   expend     - If set, then only use exposure numbers &gt;= EXPEND
   timesep    - Discard any bias that isn't within TIMESEP after another bias;
                default to 300 sec.  The time is obtained from TAI-BEG in the
                FITS header.  Note that this always discards the first bias in
                any sequence.
   indir      - Look for input files in this directory; default to current
                directory if neither MJD or INDIR are set.
   outdir     - Output directory; default to same as INDIR.
   docam      - Camera names; default to all cameras: ['b1', 'b2', 'r1', 'r2']
   sigrej     - Sigma rejection level; default to 1, 1, 1.1, 1.3, 1.6 or 1.9
                for 1,2,3,4,5 or 6 flats.  For more then 6 flats, default
                to 2.0.
   maxiter    - Number of rejection iterations; default to 3.
   noproc     - If set, then use MRDFITS to process images, otherwise use
                SDSSPROC and remove the overscan regions

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   This routine looks for biases in a given night that are logged as such.
   Discard the first bias in any sequence, and generate a mean bias from
   all the others for each camera.  There must be at least 3 frames.
   A sigma-clipped mean is computed for each pixel.

   Trigger a failure if there are more than 25 biases for a given camera,
   since that is probably too many to load into memory.

   Four FITS files are produced, one for each camera:
     pixbias-MJD-CAMERA.fits
   where MJD is the 5-digit modified Julian date, and CAMERA
   is 'b1', 'b2', 'r1', and 'r2'.

   The header contains the number of files used in each camera (NEXP),
   and an identifier for each of those files (EXPID*).  Those identifiers
   contain the camera name, MJD, and exposure number, all dash-separated.

 EXAMPLES:
   The following SDSS-I nights probably contain a bias sequence:
     51686 51781 51809 51852 51893 51950 51978 52010 52038 52069
     52245 52276 52305 52333 52363 52392 52423 52454 52514 52551
     52573 52602 52633 52655 52689 52718 52747 (&lt;- should declare some bad!)
     52808 52868 52899 52956 52983 53014 53044 53073 53100 53132
     53162 53220 53257 ...???
     53610 53633
   (Those are the nights with a pixel flat sequence.)  There are other
   nights with many biases that may be useful, but may have been done
   for other testing purposes:
     52084 52085 52121 52229 52294 52550 52572 52601 52629
     52657 52660 52661 52717 52807 52863 52864 52865 52926
   Generate one of these sets of biases with:
     spbiasgen, mjd=51893, expstart=7607, expend=7616, outdir='.'

   For BOSS:
     spbiasgen,mjd=55268,expstart=111620,expend=111645,outdir='.'
     spbiasgen,mjd=55271,expstart=111881,expend=111905,outdir='.'

 BUGS:

 PROCEDURES CALLED:
   djs_avsigclip()
   djs_filepath()
   fileandpath()
   get_tai
   sdsshead()
   sdssproc
   splog
   sxaddpar
   sxpar()
   writefits

 INTERNAL SUPPORT ROUTINES:
   spbiasgen1

 REVISION HISTORY:
   30-Aug-2001  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/spbiasgen.pro)</strong></p>
<hr />
<h3 id="SPCALIB">SPCALIB</h3>
<p><a href="#SPBIASGEN">[Previous Routine]</a></p>
<p><a href="#SPCOADD_FLUXED_FRAMES">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spcalib

 PURPOSE:
   Extract calibration frames.

 CALLING SEQUENCE:
   spcalib, flatname, arcname, fibermask=, $
    lampfile=, indir=, timesep=, ecalibfile=, plottitle=, $
    minflat=, maxflat=, arcinfoname=, flatinfoname=, $
    arcstruct=, flatstruct=, writeflatmodel=, /bbspec]

 INPUTS:
   flatname   - Name(s) of flat-field SDSS image(s)
   arcname    - Name(s) of arc SDSS image(s)

 OPTIONAL KEYWORDS:
   fibermask  - Fiber status bits, set nonzero for bad status [NFIBER].
                Note this is not modified, but modified copies appear
                in the returned structures ARCSTRUCT and FLATSTRUCT.
   lampfile   - Name of file describing arc lamp lines, which would
                over-ride the default file read by FITARCIMAGE.
   indir      - Input directory for FLATNAME, ARCNAME, OBJNAME;
                default to '.'
   timesep    - Maximum time separation between flats and arcs to pair them;
                set to zero to disable this test; default to 7200 sec.
   ecalibfile - opECalib file to pass to SDSSPROC
   plottitle  - Prefix for titles in QA plots.
   minflat    - Parameter for SDSSPROC for pixel flats; default to 0.8
   maxflat    - Parameter for SDSSPROC for pixel flats; default to 1.2
   arcinfoname- File name (with path) to output arc extraction and fitting
                information
   flatinfoname-File name (with path) to output flat field extraction and
                fitting information
 writeflatmodel-Set this keyword to write flat data image, ivar, and
                final extraction model image to a file.  Will only
                work if &quot;flatinfoname&quot; is present also (ASB).
 writearcmodel- Set this keyword to write arc data image, ivar, and
                final extraction model image to a file.  Will only
                work if &quot;arcinfoname&quot; is present also (ASB).
   bbspec         - use bbspec extraction code

 OUTPUTS:
   arcstruct  - Structure array with extracted arc calibration information
   flatstruct - Structure array with extracted flat calibration information

 OPTIONAL OUTPUTS:

 COMMENTS:
   Always pair arcs to the nearest good flat, and flats to the nearest good arc
   (nearest in time, as defined by the TAI-BEG keyword in the FITS headers).

   Also store SUPERFLATSET from fiberflat, since we need this to remove
   small scale features present in all spectra

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   extract_image
   fiberflat()
   fitarcimage
   fitdispersion
   fitflatwidth()
   get_tai
   reject_arc()
   reject_flat()
   sdssproc
   splog
   trace320crude()
   traceset2xy
   xy2traceset

 INTERNAL SUPPORT ROUTINES:
   create_arcstruct()
   create_flatstruct()

 REVISION HISTORY:
   24-Jan-2000  Written by D. Schlegel, Princeton
   27-Nov-2000  Changed to proftype 3, added minflat, maxflat keywords
    8-Jan-2001  And now back to proftype 1, more robust against bad columns
   26-Jan-2001  And now let's check both 1&amp;3, and use the better fit
      Apr-2010  Added &quot;write[flat,arc]model&quot; option (A. Bolton, Utah)
   25-Jan-2011  Added &quot;twophase&quot; test and switching, A. Bolton, Utah
   29-Mar-2011  Switched to bundle-wise pure IDL extraction, A. Bolton, Utah

</pre>
<p><strong>(See pro/spec2d/spcalib.pro)</strong></p>
<hr />
<h3 id="SPCOADD_FLUXED_FRAMES">SPCOADD_FLUXED_FRAMES</h3>
<p><a href="#SPCALIB">[Previous Routine]</a></p>
<p><a href="#SPCOADD_V5">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spcoadd_fluxed_frames

 PURPOSE:
   Combine reduced frames with the same plugmap and spectrophotometrically
   calibrate the output

 CALLING SEQUENCE:
   spcoadd_fluxed_frames, spframes, outputname, fcalibprefix=, [mjd=, $
     binsz=, zeropoint=, nord=, wavemin=, window=, adderr=, docams=, $
     plotsnfile=, combinedir=, tsobjname=, smearname=, best_exposure=]

 INPUTS:
   spframes       - Names of files to combine (written by SPREDUCE)
   outputname     - Output file name of the form spPlate-pppp-mmmmm.fits
                    where pppp=plateid, mmmmm=MJD.  

 REQUIRED KEYWORDS:
   fcalibprefix   - Prefix for flux-calibration files.

 OPTIONAL KEYWORDS:
   mjd            - The MJD to put in the output header
   binsz          - Bin size (in log-10 wavelength) in output spectra;
                    default to 1d-4, which corresponds to 69.02977415 km/s.
   zeropoint      - Log10(lambda) zero-point of the output spectra;
                    the output wavelength bins are chosen such that
                    one bin falls exactly on this value;
                    default to 3.5D, which corresponds to 3162.27766 Ang.
   nord           - Order for spline fit; default to 3 (cubic spline).
   wavemin        - Log-10 wavelength of first pixel in output spectra;
                    default to the nearest bin to the smallest wavelength
                    of the input spectra.
   window         - Window size for apodizing the errors of the spectrum
                    from each individual frame; default to 100 pixels 
                    apodization on each end of the spectrum.
   adderr         - Additional error to add to the formal errors, as a
                    fraction of the flux.
   combinedir     - Optional output directory
   docams         - Cameras to combine; default to ['b1', 'b2', 'r1', 'r2']
   plotsnfile     - File which will contain diagnostics of the final S/N 
                    and spectrophotometric quality
   tsobjname      - Name of tsObj file. Fibermags used in setting spectrophoto
                    zeropoints -- if tsObj not available fibermags are  
                    taken from the plugmap
   smearname      - Names of frames containing data observed in &quot;smear&quot; mode.
                    Polynomials describing the ratio of the calibrated smear
                    and science image are written the the 8th HDU. 
   best_exposure  - Exposure ID of the exposure which all other exposures
                    should be matched to. (string). If not set the &quot;best&quot; 
                    exposure is determined from the S/N and a measure of the 
                    spectrophotometric quality
   noxytweak      - Allow correction for residual spectrophotometry errors
                    as a funtion of plate xy position to be turned off

 OUTPUTS: 
   A fully calibrated &quot;spPlate&quot; file is produced.  The HDU's are as follows
   HDU #0: flux [npix, nfiber]
   HDU #1: inverse variance [npix, nfiber]
   HDU #2: and mask [npix, nfiber]
   HDU #3: or mask  [npix, nfiber]
   HDU #4: dispersion [npix, nfiber]
   HDU #5: plugmap - structure [nfiber] 
   HDU #6: S/N in g, r, i  [3, nfiber]
   HDU #7: synthetic g, r, i mag [3, nfiber]
   HDU #8: smear coeffs -- structure [nfiber]
 
 OPTIONAL OUTPUTS:
   Diagnostic plots in &quot;spDiagcomb-&quot; and &quot;spSN2d-&quot; files

 COMMENTS:
   This routine can combine data from a single plug maps.
   All input files must have the same number of pixels per spectrum,
   i.e. 2048 wavelength samplings, although those wavelengths can
   be different.  The spectrophotometry is now tied to Kurucz models.
   Two new structure tags are added to the plugmap &quot;tsobj_mag&quot; and &quot;tsobjid&quot;
   to track the tsobj info used in the reductions.
      
 EXAMPLES:

 BUGS:
   Should only apodize starting with the first/last good pixel of a spectrum.
   Probably will not work without data for all 4 cameras 
   Mask bits should be looked at more carefully

 PROCEDURES CALLED:
   atmdisp_cor
   bspline_valu
   combine1fiber
   divideflat
   djs_diff_angle()
   djs_filepath()
   fibermask_bits
   frame_flux_calib
   frame_flux_tweak
   mkhdr
   modfits
   mrdfits()
   mwrfits
   pixelmask_bits()
   platesn
   smear_compare
   spdata2model_ratio
   sphoto_calib
   splog
   sxaddpar
   sxpar()
   traceset2xy
   writefits

 INTERNAL SUPPORT PROCEDURES:
   add_iraf_keywords
   qgoodfiber

 REVISION HISTORY:
   12-Aug-2003  modified from &quot;spcoadd_frames&quot; by C. Tremonti, Steward Obs.
   02-Jan-2000  spcoadd_frames written by D. Schlegel
</pre>
<p><strong>(See pro/fluxfix/spcoadd_fluxed_frames.pro)</strong></p>
<hr />
<h3 id="SPCOADD_V5">SPCOADD_V5</h3>
<p><a href="#SPCOADD_FLUXED_FRAMES">[Previous Routine]</a></p>
<p><a href="#SPCOMBINE_V5">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spcoadd_v5

 PURPOSE:
   Combine several reduced frames of the same objects

 CALLING SEQUENCE:
   spcoadd_v5, spframes, outputname, $
    [ mjd=, binsz=, zeropoint=, nord=, wavemin=, $
    bkptbin=, window=, maxsep=, adderr=, plotsnfile=, $
    combinedir=, bestexpnum= ]

 INPUTS:
   spframes       - Name(s) of spFrame files (written by SPREDUCE)
   outputname     - Output file name
   plotsnfile     - Name of output plot file

 OPTIONAL KEYWORDS:
   mjd            - The MJD to put in the output header
   binsz          - Bin size (in log-10 wavelength) in output spectra;
                    default to 1d-4, which corresponds to 69.02977415 km/s.
   zeropoint      - Log10(lambda) zero-point of the output spectra;
                    the output wavelength bins are chosen such that
                    one bin falls exactly on this value;
                    default to 3.5D, which corresponds to 3162.27766 Ang.
   nord           - Order for spline fit; default to 3 (cubic spline).
   wavemin        - Log-10 wavelength of first pixel in output spectra;
                    default to the nearest bin to the smallest wavelength
                    of the input spectra.
   bkptbin        - Parameter for COMBINE1FIBER
   window         - Window size for apodizing the errors of the spectrum
                    from each individual frame;
                    default to 100 pixels apodization on each end of the
                    spectra.
   maxsep         - Parameter for COMBINE1FIBER
   adderr         - Additional error to add to the formal errors, as a
                    fraction of the flux.
   combinedir     - Optional output directory
   bestexpnum     - Exposure number for best exposure, to which all other
                    exposures are tied; this is only used in this procedure
                    for logging in the FITS header

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   All input files must have the same number of pixels per spectrum,
   i.e. 2048 wavelength samplings, although those wavelengths can
   be different.

   Flux-correction files are also read in, where they are assumed to
   have the name spFluxcorr-EEEEEEEE-S.fits, where EEEEEEEE is the exposure
   number and S is the spectrograph ID (1 or 2).

 EXAMPLES:

 BUGS:
   This routine used to combine data from multiple (different) plug maps.
   Objects are matched based upon their positions agreeing to 2 arc sec.
   This is *not* true any longer, especially when applying the
   flux-distortion solutions.

 PROCEDURES CALLED:
   combine1fiber
   correct_dlam
   divideflat
   djs_diff_angle()
   fcalib_default()
   fiber_rollcall
   flux_distortion()
   idlspec2d_version()
   mkhdr
   mrdfits()
   mwrfits
   pixelmask_bits()
   platesn
   splog
   spframe_read
   sxaddpar
   sxdelpar
   sxpar()
   traceset2xy

 INTERNAL SUPPORT PROCEDURES:
   makelabel()
   add_iraf_keywords

 REVISION HISTORY:
   02-Jan-2000  Written by D. Schlegel; modified from COMBINE2DOUT
</pre>
<p><strong>(See pro/spec2d/spcoadd_v5.pro)</strong></p>
<hr />
<h3 id="SPCOMBINE_V5">SPCOMBINE_V5</h3>
<p><a href="#SPCOADD_V5">[Previous Routine]</a></p>
<p><a href="#SPDATA2MODEL_RATIO">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spcombine_v5

 PURPOSE:
   Calling script for SPCOADD_FRAMES.

 CALLING SEQUENCE:
   spcombine_v5, [ planfile, docams=, adderr=, /xdisplay, minsn2= ]

 INPUTS:

 OPTIONAL INPUTS:
   planfile   - Name(s) of output plan file; default to reducing all
                plan files matching 'spPlancomb*.par'
   docams     - Cameras to combine; default to ['b1', 'b2', 'r1', 'r2']
   adderr     - Additional error to add to the formal errors, as a
                fraction of the flux; default to 0.03 (3 per cent).
   xdisplay   - Send plots to X display rather than to plot file
   minsn2     - Minimum S/N^2 to include science frame in coadd; default
                to 0 to only include those with S/N &gt; 0.
                Note that all exposures with a score less than 0.2 times
                the score of the best exposure are discarded; for those
                purposes, the score used is the worst of all 4 cameras.

 OUTPUT:

 COMMENTS:

 EXAMPLES:

 BUGS:
   We currently hard-wire the rejection of all smears and
   any with (S/N)^2 less than 20% of the best exposure.

 PROCEDURES CALLED:
   cpbackup
   dfpsclose
   dfpsplot
   headfits
   idlspec2d_version()
   idlutils_version()
   spcoadd_frames
   spflux_v5
   spfluxcorr_v5
   splog
   sxpar()
   yanny_free
   yanny_par()
   yanny_read

 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   06-Jul-2000  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/spec2d/spcombine_v5.pro)</strong></p>
<hr />
<h3 id="SPDATA2MODEL_RATIO">SPDATA2MODEL_RATIO</h3>
<p><a href="#SPCOMBINE_V5">[Previous Routine]</a></p>
<p><a href="#SPECDB_CREATE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spdata2model_ratio

 PURPOSE:
   Construct flux correction vectors by ratioing the observed spectra of
   standard stars to Kurucz models of the appropriate spectral type and
   smoothing the result.

 CALLING SEQUENCE:
    corvector = spdata2model_ratio(loglam, stdflux, stdivar, stdmask, 
      stdinfo, corvivar=, cormed=, /norm)

 INPUTS:
   loglam  -- wavelength array in log10(Angstroms) [npix]
   stdflux -- array of standard star fluxes [npix, nstd]
   stdivar -- inverse variance of standard star fluxes [npix, nstd]
   stdmask -- ormask of standard star spectra [npix, nstd] 
              (used to mask sky residuals)
   stdinfo -- structure containing information about which Kurucz model
              is to be used with each standard star [nstd]. (This is the
              output of &quot;stype_standard&quot;.)
 
 OPTIONAL INPUT:
   norm   --  normalize the vectors before returning them (between 
              5700 - 6300 A -- avoiding the last 200 pixels before the
              dichroic)

 OUTPUT:
   Vectors which represent the smoothed ratio of (data/model) for each
   standard star.  [npix, nstd]

 OPTIONAL OUTPUT:
   corvivar - inverse variance corresponding to each flux correction vector.  
              [npix, nstd]
   cormed   - median of each flux correction vector between 5700 and 6300 A
              (but avoiding the 200 pixels nearest the dichroic) [nstd]

 COMMENTS:
   For each standard star the best fit Kurucz model (as determined by 
   &quot;stype_standard&quot;) is restored, redshifted, and linearly interpolated to 
   match the wavelength grid of the data.  Each model is then reddened
   using the SDF reddening at the RA/DEC of the standard star and the 
   extinction curve used by SFD (O'donnell).  

 BUGS:

 EXAMPLES:

 PROCEDURES CALLED:
   divideflat
   djs_maskinterp
   djs_median()
   ext_odonnell
   filter_thru()
   kurucz_restore
   linterp
   skymask() 
 
 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   12-Aug-2003  Create by C. Tremonti, Steward Observatory
</pre>
<p><strong>(See pro/fluxfix/spdata2model_ratio.pro)</strong></p>
<hr />
<h3 id="SPECDB_CREATE">SPECDB_CREATE</h3>
<p><a href="#SPDATA2MODEL_RATIO">[Previous Routine]</a></p>
<p><a href="#SPECHEADERS">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   specdb_create

 PURPOSE:
   Create spectro database.

 CALLING SEQUENCE:
   specdb_create, [ topdir, astrolog= ]

 INPUTS:

 OPTIONAL INPUTS:
   topdir     - Search for reduced data files in TOPDIR/MJD/*.
                This should be an absolute file path, and we default to
                '/home/data/2d_test'.
   astrolog   - Search for plug-map files in PLUGDIR/MJD/*.
                If not specified, then look for these files in the same
                place as the reduced data.

 OUTPUT:

 COMMENTS:
   Look for the input files in:
     $TOPDIR/MJD/2d/spSpec2d-b1-*.fits    - pppp=plate
     $SPECLOG/MJD/plPlugMapM-pppp-mmmmm-aa.par - Plug map files, aa=mapper

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   headfits()
   mrdfits()
   yanny_read

 INTERNAL SUPPORT ROUTINES:
   spsummary_create()

 REVISION HISTORY:
   27-Mar-2000  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/specdb/specdb_create.pro)</strong></p>
<hr />
<h3 id="SPECHEADERS">SPECHEADERS</h3>
<p><a href="#SPECDB_CREATE">[Previous Routine]</a></p>
<p><a href="#SPECLINEFIT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   specheaders

 PURPOSE:
   Consolodate all of the raw spectro files headers into a single FITS file

 CALLING SEQUENCE:
   specheaders

 INPUTS:

 OPTIONAL INPUTS:

 OUTPUT:

 OPTIONAL OUTPUTS:

 COMMENTS:
   All raw spectro files (sdR files) have their headers read and
   consolodates into a single FITS binary table file 'specheaders.fits'.
   A specific file is chosen as the template file, and only header cards
   that match that file are used.
   Header keywords with '-' are replaced with '_'.
   Repeat instances of the same keyword in the same file are ignored.
   The 'END' card is ignored.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   fileandpath()
   headfits()
   sxpar()

 REVISION HISTORY:
   02-Sep-2009  Written by David Schlegel, LBL
</pre>
<p><strong>(See pro/plan/specheaders.pro)</strong></p>
<hr />
<h3 id="SPECLINEFIT">SPECLINEFIT</h3>
<p><a href="#SPECHEADERS">[Previous Routine]</a></p>
<p><a href="#SPEC_PARAM_STR">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   speclinefit

 PURPOSE:
   Line-fitting calling script for entire plate(s)

 CALLING SEQUENCE:
   speclinefit, [ platefile, fiberid=, $
    hdr=, objflux=, objivar=, $
    zhdr=, zans=, synflux=, dispflux=, $
    outfile=, zline=, yfit=, /doplot, /debug ]

 INPUTS:

 OPTIONAL INPUTS:
   platefile  - Plate file(s) from spectro-2D; default to all files
                matching 'spPlate*.fits' if neither PLATEFILE nor OBJFLUX
                are set.
                If specified, then all inputs are read from this file
                and its corresponding spZbest file.  The following inputs
                are ignored: HDR,OBJFLUX,OBJIVAR,ZHDR,ZANS,SYNFLUX,DISPFLUX.
                If set, then an output FITS file and a log file are created,
                as is a PostScript plot file if /DOPLOT is set.
   fiberid    - If specified, then only reduce these fiber numbers;
                this must be a vector with unique values between 1 and
                the number of rows in the plate file (typically 640).
                This keyword must be set to only those fibers that exist
                in the spZbest file if FIBERID was specified when
                running SPREDUCE1D.
   hdr        - Header from plate file.  The fields COEFF0,COEFF1 are
                used for the wavelength mapping.
   objflux    - Object spectra [NPIX,NOBJ]
   objivar    - Object inverse variance [NPIX,NOBJ]
   zhdr       - Optional header for output file.
   zans       - Output structure from SPREDUCE1D.  The following fields
                are used in this procedure: PLATE,MJD,FIBERID,CLASS,Z.
   synflux    - Best-fit synthetic spectra; used for STAR background terms.
   dispflux   - Best-fit dispersion spectra; used for GALAXY background terms.
   outfile    - Name of output file (the name is generated from PLATEFILE
                if that is set).
   doplot     - If set, then generate plots.  Send plots to a PostScript
                file if PLATEFILE is set and /DEBUG is not set.
   debug      - If set, then send plots to the X display and wait for
                a keystroke after each plot; setting /DEBUG forces /DOPLOT.

 OUTPUTS:

 OPTIONAL OUTPUTS:
   zline      - Output structure with line fits [NLINE,NOBJ].
                Entries are blank where nothing was measured.
   yfit       - Best-fit background terms + line fits [NPIX,NOBJ]

 COMMENTS:
   If PLATEFILE is set, then names of other input/output files are derived
   from that name.  For example, if PLATEFILE='spPlate-0306-51690.fits', then
     ZBESTFILE = 'spZbest-0306-51690.fits'   (input file)
     ZLINEFILE = 'spZline-0306-51690.fits'   (input file)
     LOGFILE   = 'spDiagLine-0306-51690.log' (output file)
     PLOTFILE  = 'spDiagLine-0306-51690.ps'  (output file)
   An output file is written only if PLATEFILE or OUTFILE are set.

   The first background term is simply the best-fit dispersion template
   for galaxies, nothing for QSOs, or the synthetic spectrum for other
   types of objects.
   At any wavelengths where this background model does not exist (at the
   line center), then fit another term that is a linear term
   with a width of 0.030 in log-wavelength (300 pix) for QSOs, or a
   linear term with a width of 0.005 (50 pix) for other types of objects.

   The initial guess for the dispersion is 2000 km/sec for QSO's
   (ZGUESS=0.0030), and 105 kms/sec for all other objects (ZGUESS=0.00015).

   The continuum level is evaluated at the line center for QSOs,
   and otherwise is set to [300,600] km/s on either side of the line center.

 EXAMPLES:

 BUGS:

 DATA FILES:
   $IDLSPEC2D_DIR/etc/emlines.par

 PROCEDURES CALLED:
   cpbackup
   create_linestruct()
   dfpsclose
   dfpsplot
   djs_filepath()
   fileandpath()
   headfits()
   linebackfit()
   mrdfits()
   mwrfits
   poly_array()
   splog
   skymask()
   sxaddpar
   sxpar()

 REVISION HISTORY:
   12-Feb-2002  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/speclinefit.pro)</strong></p>
<hr />
<h3 id="SPEC_PARAM_STR">SPEC_PARAM_STR</h3>
<p><a href="#SPECLINEFIT">[Previous Routine]</a></p>
<p><a href="#SPFLATAVE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spec_param_str
 PURPOSE:
   Build structure SPEC_PARAM for parameters derived from analysis of
     galaxy spectra.
 CALLING SEQUENCE:
   str= spec_param_str(N)
 INPUTS:
   tsObjfile  - tsObj file name
   ver1Ddir  - 1D directory name (including version number)
 OPTIONAL INPUTS:
 KEYWORDS
 OUTPUTS:
   str     - array of structures of type &quot;SPEC_PARAM&quot; with N elements
 COMMENTS:
 BUGS: 
   heliocentric correction will have to be removed when the 2D bug is fixed
 REVISION HISTORY:
   2000-Sep-07  written by Mariangela Bernardi
</pre>
<p><strong>(See pro/science/spec_param_str.pro)</strong></p>
<hr />
<h3 id="SPFLATAVE">SPFLATAVE</h3>
<p><a href="#SPEC_PARAM_STR">[Previous Routine]</a></p>
<p><a href="#SPFLATGEN">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spflatave

 PURPOSE:
   Average together a set (or all!) 2D pixel flats.

 CALLING SEQUENCE:
   spflatave, [ mjd=, mjstart=, mjend=, mjout=, indir=, outdir=, docam= ]

 INPUTS:

 OPTIONAL INPUTS:
   mjd        - Valid MJD's for input pixel flats.
   mjstart    - Valid starting MJD for input pixel flats.
   mjend      - Valid ending MJD for input pixel flats.
   mjout      - MJD for name of output average pixel flat; default to 0,
                resulting in file names like 'pixflatave-00000-b1.fits'.
   indir      - Input directory; default to current directory.
   outdir     - Output directory; default to same as INDIR.
   docam      - Camera names; default to all cameras: ['b1', 'b2', 'r1', 'r2']

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Some sigma-clipping is done before combining each pixel, clipping
   at 2-sigma if more than 7 frames, and a lower sigma for fewer frames.

   The output file has two HDU's, the first being the average flat,
   the second being the standard deviation at each pixel.
     --&gt; Comment this out for the time being!!???

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_filepath()
   djs_iterstat
   fileandpath()
   headfits()
   mrdfits()
   splog
   sxaddpar
   sxpar()
   writefits

 REVISION HISTORY:
   17-Jul-2001  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/spflatave.pro)</strong></p>
<hr />
<h3 id="SPFLATGEN">SPFLATGEN</h3>
<p><a href="#SPFLATAVE">[Previous Routine]</a></p>
<p><a href="#SPFLATTEN">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spflatgen

 PURPOSE:
   Wrapper for SPFLATTEN2 for generating pixel-to-pixel flat-fields.

 CALLING SEQUENCE:
   spflatgen, [ mjd=, expnum=, expstart=, expend=, $
    indir=, outdir=, docam= ]

 INPUTS:

 OPTIONAL INPUTS:
   mjd        - If INDIR not set, then look for files in $BOSS_SPECTRO_DATA/MJD.
   expnum     - If set, then use these exposure numbers
   expstart   - If set, then only use exposure numbers &gt;= EXPSTART
   expend     - If set, then only use exposure numbers &gt;= EXPEND
   indir      - Look for input files in this directory; default to current
                directory if neither MJD or INDIR are set.
   outdir     - Output directory; default to same as INDIR.
   docam      - Camera names; default to all cameras: ['b1', 'b2', 'r1', 'r2']

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   This routine looks for flats and arcs in a given night that are logged
   (according to the headers) to be spectroscopic pixel flats.  We expect
   at least 7 flats in a sequence plus one or more arcs.  If this is not
   true for a given camera, then no pixel flats are generated for that camera.

   Trigger a failure if there are more than 25 biases for a given camera,
   since that is probably too many to load into memory.

   Four FITS files are produced, one for each camera:
     pixflat-MJD-CAMERA.fits
   where MJD is the 5-digit modified Julian date, and CAMERA
   is 'b1', 'b2', 'r1', and 'r2'.

   The header contains the number of files used in each camera (NEXP),
   and an identifier for each of those files (EXPID*).  Those identifiers
   contain the camera name, MJD, flat exposure number, and arc exposure 
   number, all dash-separated.

 EXAMPLES:
   The following nights look like they contain a flat sequence:
     51686 51781 51809 51852 51893 51950 51978 52010 52038 52069
     52161 62193 52216 52245 52276 52304 52333 52363 52392 52423
     52454 52514 52551 52573 52602 52633 52655 52689 52719 52747
     52777 52808 52868 52899 52956 52983 53014 53044 53073 53100
     53132 53162 53220 53257 ...???
     53610 53633
     53649 (15 dithers)
     53651 (15 dithers)
   Generate one of these sets of flats with:
     spflatgen, mjd=51781, outdir='.'

   The initial set of pixel flats were generated using six of the
   flats taken on MJD=51441 from three different plates: exposure
   numbers 1351,1352,1362,1363,1372,1373 with exp #1350 as the
   fiducial flat and #1347 as the arc.

 BUGS:

 PROCEDURES CALLED:
   djs_filepath()
   sdsshead()
   spflatten2
   splog
   sxpar()

 REVISION HISTORY:
   06-Jul-2001  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/spflatgen.pro)</strong></p>
<hr />
<h3 id="SPFLATTEN">SPFLATTEN</h3>
<p><a href="#SPFLATGEN">[Previous Routine]</a></p>
<p><a href="#SPFLATTEN2">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spflatten

 PURPOSE:
   Create pixel-to-pixel flat-field from a stack of SDSS spectral flats.

 CALLING SEQUENCE:
   spflatten, flatname, [ pixflat, sigrej=, maxiter=, $
    outfile=, indir=, outdir=, tmpdir=, $
    bkspace=, nord=, lower=, upper= ]

 INPUTS:
   flatname   - Name(s) of raw SDSS flat-field image(s).
                Note that many flats from many nights can be combined.

 OPTIONAL INPUTS:
   sigrej     - Sigma rejection level; default to 1, 1, 1.1, 1.3, 1.6 or 1.9
                for 1,2,3,4,5 or 6 flats.  For more then 6 flats, default
                to 2.0.
   maxiter    - Number of rejection iterations; default to 2.
   outfile    - Write the image PIXFLAT to this file.
   indir      - Input directory for FLATNAME; default to './'
   outdir     - Output directory for OUTFILE; default to './'
   tmpdir     - Directory for temporary files; default to same as OUTDIR

 PARAMETERS FOR SLATEC_SPLINEFIT:
   bkspace
   nord
   lower
   upper

 OUTPUTS:

 OPTIONAL OUTPUTS:
   pixflat    - Image containing all the information about pixel-to-pixel
                variations.  Illumination variations are removed.

 COMMENTS:
   This program writes 2*nflat temporary files to disk to save internal memory.
   But it still creates an two arrays (FLATARR (float) and OUTMASK (byte))
   that is as large as all of the input flats.
   Thus, if you are using ten 16 MB flat images,
   that array will be 10*(16+4)=200 MB (in addition to a few other images).

 EXAMPLES:

 BUGS:
   Not sure what to do if exactly 2 frames are passed.

 PROCEDURES CALLED:
   djs_avsigclip()
   extract_image
   readfits()
   slatec_bvalu()
   slatec_splinefit()
   sdssproc
   writefits

 REVISION HISTORY:
   13-Oct-1999  Written by D. Schlegel, APO
</pre>
<p><strong>(See pro/spec2d/spflatten.pro)</strong></p>
<hr />
<h3 id="SPFLATTEN2">SPFLATTEN2</h3>
<p><a href="#SPFLATTEN">[Previous Routine]</a></p>
<p><a href="#SPFLUXCORR_V5">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spflatten2

 PURPOSE:
   Create pixel-to-pixel flat-field from a stack of SDSS spectral flats.

 CALLING SEQUENCE:
   spflatten2, flatname, arcname, allflats, [ pixflat, sigrej=, maxiter=, $
    oldflat=, outfile=, indir=, outdir=, tmpdir=, $
    pixspace=, nord=, lower=, upper=, mincounts=, /nodelete ]

 INPUTS:
   flatname   - Name of flat image for tracing arc
   arcname    - Name of arc image
   allflats   - Name(s) of raw SDSS flat-field image(s).
                Note that many flats from many nights can be combined.

 OPTIONAL INPUTS:
   sigrej     - Sigma rejection level; default to 1, 1, 1.1, 1.3, 1.6 or 1.9
                for 1,2,3,4,5 or 6 flats.  For more then 6 flats, default
                to 2.0.
   maxiter    - Number of rejection iterations; default to 2.
   oldflat    - Name of old flat-field from which to select pixels to mask;
                if not set, then read the masks in this source distribution.
   outfile    - Write the image PIXFLAT to this file.
   indir      - Input directory for FLATNAME; default to current directory
   outdir     - Output directory for OUTFILE; default to current directory
   tmpdir     - Directory for temporary files; default to current directory
   pixspace   - Approximate spacing in pixels for break points in the
                spline fits to individual fibers; default to 50 pixels.
                Note that this spacing need be small enough to fit out
                the flux variations of multiple fibers crossing a single
                column, but it need not fit out the actual flat-field
                variations.
   mincounts  - The summed model image must have a minimum of this many counts
                at each pixel, or the output flat is set to zero for that
                pixel; default to 100 counts.
   nodelete   - If set, then do not delete temporary files.

 PARAMETERS FOR SLATEC_SPLINEFIT:
   nord       - Default to 4
   lower      - Default to 2
   upper      - Default to 2

 OUTPUTS:

 OPTIONAL OUTPUTS:
   pixflat    - Image containing all the information about pixel-to-pixel
                variations.  Illumination variations are removed.

 COMMENTS:
   This program writes 2*nflat temporary files to disk to save internal memory.
   But it still creates an two arrays (FLATARR (float) and OUTMASK (byte))
   that is as large as all of the input flats.
   Thus, if you are using ten 16 MB flat images,
   that array will be 10*(16+4)=200 MB (in addition to a few other images).

   The header contains the number of files used in each camera (NEXP),
   and an identifier for each of those files (EXPID*).  Those identifiers
   contain the camera name, MJD, flat exposure number, and arc exposure
   number, all dash-separated.

 EXAMPLES:

 BUGS:
   Not sure what to do if exactly 2 frames are passed.
   Pass UPPER and LOWER.
   Look for bad fibers or outlier fibers to exclude from superflat.
   Right now, we can get bad spline fits across the large hole in the
     b1 flat-field if the break points fall too close to the edges of
     that hole.  Try to keep more data points between the last break point
     and the beginning of the hole, or do a linear interpolation across
     the hole.

 PROCEDURES CALLED:
   bspline_iterfit()
   bspline_valu()
   calcscatimage()
   djs_avsigclip()
   djs_filepath()
   extract_image
   fileandpath()
   genflatmask()
   readfits()
   repstr()
   rmfile
   sdssproc
   sxaddpar
   sxpar()
   superflat()
   trace320crude()
   traceset2xy
   writefits
   xy2traceset

 REVISION HISTORY:
   13-Oct-1999  Written by D. Schlegel, APO
</pre>
<p><strong>(See pro/spec2d/spflatten2.pro)</strong></p>
<hr />
<h3 id="SPFLUXCORR_V5">SPFLUXCORR_V5</h3>
<p><a href="#SPFLATTEN2">[Previous Routine]</a></p>
<p><a href="#SPFLUX_READ_KURUCZ">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spfluxcorr_v5

 PURPOSE:
   Compute flux-correction vectors for each CCD+exposure

 CALLING SEQUENCE:
   spfluxcorr_v5, objname, [ adderr=, combinedir=, bestexpnum= ]

 INPUTS:
   objname    - File names (including path) for spFrame files, all from
                either spectro-1 or spectro-2, but not both!
   bestexpnum - Exposure number for best exposure, to which all other
                exposures are tied.

 OPTIONAL INPUTS:
   adderr     - Additional error to add to the formal errors, as a
                fraction of the flux; default to 0.03 (3 per cent).
   combinedir - Directory for output files

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 DATA FILES:

 PROCEDURES CALLED:
   djs_filepath()
   djs_reject()
   fcalib_default()
   mrdfits()
   mwrfits
   solve_poly_ratio
   splog
   soplot
   splot

 INTERNAL SUPPORT ROUTINES:
   fcorr_goodvector()

 REVISION HISTORY:
   05-Feb-2004  Written by D. Schlegel, Princeton
   11-Aug-2009  Edited by A. Kim: b and r spectra don't necessarily have the same dimension
</pre>
<p><strong>(See pro/spec2d/spfluxcorr_v5.pro)</strong></p>
<hr />
<h3 id="SPFLUX_READ_KURUCZ">SPFLUX_READ_KURUCZ</h3>
<p><a href="#SPFLUXCORR_V5">[Previous Routine]</a></p>
<p><a href="#SPFLUX_V5">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spflux_read_kurucz

 PURPOSE:
   Read the Kurucz models at the specified log-lambda and resolution

 CALLING SEQUENCE:
   spflux_read_kurucz
   modelflux = spflux_read_kurucz( loglam, dispimg, [ iselect=, $
    kindx_return= ] )

 INPUTS:
   loglam     - Log10 wavelengths (vacuum Angstroms) [NPIX]
   dispimg    - Dispersion image, in units of pixels [NPIX]

 OPTIONAL INPUTS:
   iselect    - If set, then only return these model numbers; default to
                returning all models

 OUTPUTS:
   modelflux  - Model fluxes [NPIX,NMODEL]

 OPTIONAL OUTPUTS:
   kindx_return- Structure with model parameters for each model

 COMMENTS:
   Note that this function allocates a ridiculous amount of memory
   for caching the oversampled spectra at many dispersions in GRIDFLUX.

 EXAMPLES:

 BUGS:

 DATA FILES:
   $IDLSPEC2D_DIR/templates/kurucz_stds_raw_v5.fits

 PROCEDURES CALLED:
   mrdfits()
   rebin_spectrum()
   splog
   sxpar()

 REVISION HISTORY:
   05-Feb-2004  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/spflux_read_kurucz.pro)</strong></p>
<hr />
<h3 id="SPFLUX_V5">SPFLUX_V5</h3>
<p><a href="#SPFLUX_READ_KURUCZ">[Previous Routine]</a></p>
<p><a href="#SPFRAME_READ">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spflux_v5

 PURPOSE:
   Compute flux-calibration vectors for each CCD+exposure from std stars

 CALLING SEQUENCE:
   spflux_v5, objname, [ adderr=, combinedir=, minfracthresh= ]

 INPUTS:
   objname    - File names (including path) for spFrame files, all from
                either spectro-1 or spectro-2, but not both!

 OPTIONAL INPUTS:
   adderr     - Additional error to add to the formal errors, as a
                fraction of the flux; default to 0.03 (3 per cent)
   combinedir - Directory for output files
   minfracthresh - the threshold for the minimum number of good pixels

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   One output file is written for every input file OBJNAME,
   prefixed with spFluxcalib.  It containts the following:
     HDU #0: Calibration image
     HDU #1: Trace-set used to construct the former
     HDU #2: Structure with info on each standard star

 EXAMPLES:

 BUGS:

 DATA FILES:

 PROCEDURES CALLED:
   airtovac
   bspline_bkpts()
   bspline_iterfit()
   bspline_valu()
   combine1fiber
   computechi2()
   correct_dlam
   djs_filepath()
   djs_maskinterp()
   djs_median()
   djs_oplot
   djs_plot
   djs_xyouts
   euler
   ext_odonnell
   fileandpath()
   filter_thru()
   find_nminima()
   get_tai
   mrdfits()
   mwrfits
   pixelmask_bits()
   rebin_spectrum()
   spframe_read
   skymask()
   spflux_read_kurucz()
   splog
   tai2airmass()
   wavevector()

 INTERNAL SUPPORT ROUTINES:
   spflux_masklines()
   spflux_medianfilt()
   spflux_bestmodel()
   spflux_goodfiber()
   spflux_bspline()
   spflux_mratio_flatten()
   spflux_plotcalib
   sxaddpar
   sxpar()

 REVISION HISTORY:
   05-Feb-2004  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/spflux_v5.pro)</strong></p>
<hr />
<h3 id="SPFRAME_READ">SPFRAME_READ</h3>
<p><a href="#SPFLUX_V5">[Previous Routine]</a></p>
<p><a href="#SPGAIN">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spframe_read

 PURPOSE:
   Read data from either an spFrame or spCFrame file.

 CALLING SEQUENCE:
   spframe_read, filename, [ indx, objflux=, objivar=, mask=, $
    wset=, loglam=, dispset=, dispimg=, ximg=, $
    plugmap=, skyflux=, superflat=, hdr=, adderr= ]

 INPUTS:
   filename   - Input file name

 OPTIONAL INPUTS:
   indx       - Optional 0-indexed row numbers; default to all
   adderr     - Additional error to add to the formal errors, as a
                fraction of the flux; default to none

 OUTPUTS:

 OPTIONAL OUTPUTS:
   objflux    - Object flux
   objivar    - Object inverse variance (units of 1/OBJFLUX^2)
   mask       - Pixel bit mask
   wset       - Trace-set for wavelength solution
   loglam     - Wavelength image (vacuum log-10 Ang)
   dispset    - Trace-set for dispersion solution
   dispimg    - Dispersion image (per native pixel)
   ximg       - X position on CCD image
   skyflux    - Sky flux (same units as OBJFLUX)
   superflat  - Superflat vector from quartz lamps
   hdr        - FITS header for HDU#0

 COMMENTS:
   The spFrame and spCFrame files contain nearly identical HDUs,
   except for HDU #3 and #4 which are trace-sets in spFrame, and
   more easily-interpreted 2-dimensional images in spCFrame:

            spFrame   spCFrame
   HDU #0:  Flux      Flux
   HDU #1:  Invvar    Invvar
   HDU #2:  mask      mask
   HDU #3:  wset      loglam
   HDU #4:  dispset   dispimg
   HDU #5:  plugmap   plugmap
   HDU #6:  sky       sky
   HDU #7:  ximg      ximg
   HDU #8:  superflat
   HDU #9:  skystruct

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   fileandpath()
   headfits()
   lookforgzip()
   mrdfits()
   traceset2xy
   traceset_trim()

 REVISION HISTORY:
   05-Feb-2004  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/spframe_read.pro)</strong></p>
<hr />
<h3 id="SPGAIN">SPGAIN</h3>
<p><a href="#SPFRAME_READ">[Previous Routine]</a></p>
<p><a href="#SPHDRFIX">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spgain

 PURPOSE:
   Measure the gain + read noise for SDSS spectroscopic images

 CALLING SEQUENCE:
   spgain, flatfile1, flatfile2, [ biasfile1, biasfile2, indir=, $
    xskip=, yskip=, /simulate, gain=, rnoise=]

 INPUTS:
   flatfile1  - File name for flat #1
   flatfile2  - File name for flat #2
   biasfile1  - File name for bias #1
   biasfile2  - File name for bias #2

 OPTIONAL KEYWORDS:
   indir      - Input directory for all files
   xskip      - Number of columns to ignore at beginning and end of each
                amplifier; default to 50
   yskip      - Number of rows to ignore at beginning and end of each
                amplifier; default to 5
   simulate   - If set, then replace the images with simulated images with
                a gain of 1.3 e-/ADU and read noise of 3.5 ADU.

 OUTPUTS:
   gain       - Gain in electrons/ADU for each amplifier (array)
   rnoise     - Read noise in electrons for each amplifier (array)

 COMMENTS:

 EXAMPLES:
   Compute the read nosie and gain using the bias frames and flats
   taken for this very purpose on MJD 53114 (18/19 April 2004).
   For the b1 CCD:
     IDL&gt; spgain, 'sdR-r2-00026145.fit.gz', 'sdR-r2-00026146.fit.gz', $
          'sdR-r2-00026147.fit.gz', 'sdR-r2-00026148.fit.gz'

 BUGS:

 PROCEDURES CALLED:
   djs_iterstat
   sdssproc

 REVISION HISTORY:
   21-Nov-1999  Written by D. Schlegel, Princeton.
</pre>
<p><strong>(See pro/spec2d/spgain.pro)</strong></p>
<hr />
<h3 id="SPHDRFIX">SPHDRFIX</h3>
<p><a href="#SPGAIN">[Previous Routine]</a></p>
<p><a href="#SPHOTO_CALIB">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   sphdrfix

 PURPOSE:
   Fix header cards in raw SDSS spectroscopic data.

 CALLING SEQUENCE:
   sphdrfix, filename, hdr, [ silent, /do_lock ]

 INPUTS:
   filename   - Name of raw FITS file
   hdr        - FITS header

 OPTIONAL INPUTS:
   silent     - If set, then don't output any text.
   do_lock    - If set, then lock the &quot;sdHdrFix-$MJD.par&quot; file
                using DJS_LOCKFILE().

 OUTPUTS:
   hdr        - FITS header (modified)

 COMMENTS:
   This routine implements &quot;hand edits&quot; of the raw FITS headers for
   SDSS spectroscopic images.  The list of edits to make can be stored
   in two possible Yanny parameter file, the static &quot;opHdrFix.par&quot; file
   in the IDLSPEC2D product, and in the &quot;sdHdrFix-$MJD.par&quot; file for
   the relevant night.

   This proc only works in IDL version 5.3 and later, because it
   uses STRMATCH().

 EXAMPLES:
   filename = 'sdR-b2-00003976.fit'
   hdr = headfits(filename)
   sphdrfix, filename, hdr

 BUGS:
   This will fail if the MJD needs hand-editing in the sdHdrFix file,
   since we need the MJD to find the sdHdrFix file in the first place!

 PROCEDURES CALLED:
   djs_lockfile()
   djs_unlockfile
   fileandpath()
   splog
   sxaddpar
   yanny_free
   yanny_read

 INTERNAL SUPPORT ROUTINES
   sphdrfix1

 DATA FILES:
   $IDLSPEC2D_DIR/examples/opHdrFix.par
   $SPECLOG_DIR/$MJD/sdHdrFix-$MJD.par

 REVISION HISTORY:
   29-Dec-2009  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/sphdrfix.pro)</strong></p>
<hr />
<h3 id="SPHOTO_CALIB">SPHOTO_CALIB</h3>
<p><a href="#SPHDRFIX">[Previous Routine]</a></p>
<p><a href="#SPLOT_TILES">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   sphoto_calib

 PURPOSE:
   Derive spectrophotometric calibration for a group of exposures from 
   one camera + spectrograph

 CALLING SEQUENCE:
   sphoto_calib, wave, flux, invvar, mask, plugtag, fcalfile, $
     stdstarfile, [/stype, input_calibset=, /noplot]

 INPUTS:
   wave        -  wavelength array in log10(ang) [npix, nstd*nexp]
   flux        -  flux array of standard stars [npix, nstd*nexp]
   invvar      -  inverse variance of standard stars [npix, nstd*nexp]
   mask        -  pixel masks of standard stars [npix, nstd*nexp]
   plugtag     -  structure containing plugmap info + exposure identification
   fcalfile    -  vector of names for flux calibration FITS files [nexp]
                  Traditionally spFluxcalib-cc-eeeeeeee.fits where cc is the 
                  camera id (b1,b2,r1,r2) and eeeeeeee is the exposure number
   stdstarfile -  name of FITS file containing standard star info -- if 
                  &quot;stype&quot; is set, this is created.  Traditionally the names
                  are spStd-pppp-mmmmm-s.fits where pppp=plateid, 
                  mmmmmm=MJD, and s = spectrograph ID [1/2]

 OPTIONAL INPUT:
   stype          - if set spectral type the standard stars (for this to
                    work the frames must be blue!!)
   input_calibset - use this as the average flux correction (instead of
                    using PCA to determine the average)  This is typically
                    done done for the smear exposures since their S/N is low.
   noplot         - toggle plotting of flux correction residuals -- the
                    PCA average is always shown

 OUTPUT:
   The bspline coefficients of the average flux calibration vectors 
   of each exposure are written out as FITS files (using the names in 
   fcalfile).  If &quot;stype&quot; is set, info about the standard stars (Teff, 
   [Fe/H], velocity, etc) is saved as a binary FITS structure in the 
   file given by &quot;stdstarfile&quot;.

 OPTIONAL OUTPUT:
 
 COMMENTS:
   Frames from the blue camera should be processed first, because the 
   spectral typing requires blue wavelengths.
 
 BUGS:
   The PCA code is run (and plots are made) even if the output is not used.

 EXAMPLES:

 PROCEDURES CALLED:
   bspline_iterfit
   bspline_valu
   combine1fiber
   djs_maskinterp
   djs_median
   frame_flux_calib
   mrdfits 
   pca_flux_standard
   rectify
   skymask
   stype_standard
   splog

 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   12-Aug-2003  Created by C. Tremonti, Steward Observatory
</pre>
<p><strong>(See pro/fluxfix/sphoto_calib.pro)</strong></p>
<hr />
<h3 id="SPLOT_TILES">SPLOT_TILES</h3>
<p><a href="#SPHOTO_CALIB">[Previous Routine]</a></p>
<p><a href="#SPMANUAL">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   splot_tiles
 PURPOSE:
   plot circular tiles from a given file
 CALLING SEQUENCE:
   splot_tiles, filename
 INPUTS:
   filename - name of Yanny .par file
 REVISION HISTORY:
   26-Oct-2006  Written by MRB, NYU
</pre>
<p><strong>(See pro/plate/splot_tiles.pro)</strong></p>
<hr />
<h3 id="SPMANUAL">SPMANUAL</h3>
<p><a href="#SPLOT_TILES">[Previous Routine]</a></p>
<p><a href="#SPMEDIAN_REBIN">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spmanual

 PURPOSE:
   Read manual inspection files (spInspect) for redshifts

 CALLING SEQUENCE:
   zmanual = spmanual(plateid, mjd= )

 INPUTS:
   plateid    - Plate number (scalar)
   mjd        - MJD of observation

 OPTIONAL INPUTS:

 OUTPUTS:
   zmanual    - Structure with manual inspection data, with one entry
                per fiber even if the manual file is incomplete

 OPTIONAL OUTPUTS:

 COMMENTS:
   Read manual inspection files in:
    $SPINSPECT_DIR/data/*/spInspect-$PLATE-$MJD.par

 EXAMPLES:

 BUGS:
   Currently only reads the French Participation Group (fpg) files.
   Output structure will contain whatever the input files contain.

 PROCEDURES CALLED:

 REVISION HISTORY:
   09-Feb-2010  Written by David Schlegel, LBL
</pre>
<p><strong>(See pro/spec1d/spmanual.pro)</strong></p>
<hr />
<h3 id="SPMEDIAN_REBIN">SPMEDIAN_REBIN</h3>
<p><a href="#SPMANUAL">[Previous Routine]</a></p>
<p><a href="#SPPLAN1D">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spmedian_rebin

 PURPOSE:
   Coarsely rebin the data using medians to reject outliers

 CALLING SEQUENCE:
    medflux = spmedian_rebin(loglam, flux, ivar, color, mask=, sigrej=, $
      outwave=, sn=, quality=)

 INPUTS:
   loglam - wavelength array in log10(Angstroms) [npix, nfiber]
   flux   - flux array [npix, nfiber]
   ivar   - inverse variance [npix, nfiber]
   color  - choices are 'r' (data from red camera) 'b' (data from blue camera)
            or 'full' (data from both cameras combined -- for use with smears)
   
 OPTIONAL KEYWORDS:
   sigrej - threshold for masking of data (scalar)

 OUTPUTS:   
   A rebinned version of the input flux spectrum is returned. [nnewpix, nfiber]

 OPTIONAL OUTPUTS:
   mask     - The approximate inverse variance of the output spectrum (set 
              to zero for bad pix).  [nnewpix, nfiber]
   outwave  - output wavelength scale in log10(Angstroms) [nnewpix] 
   sn       - median S/N prior to rebinning [nfiber]
   quality  - flag set to zero for good data, one if bad trace/arc/flat, etc
              [nfiber]

 COMMENTS:
   Used when division of low S/N spectra is necessary.  See &quot;frame_flux_tweak&quot;
   and &quot;smear_compare&quot;. 

 EXAMPLES:
   plot, 10.0^loglam[*,0], flux[*,0]
   medflux = spmedian_rebin(loglam, flux, ivar, 'full', outwave=outwave)
   oplot, 10.0^outwave, medflux[*,0]

 BUGS:

 PROCEDURES CALLED:
   djs_iterstat()
   djs_median()
   fibermaks_bits()

 REVISION HISTORY:
   12-Aug-2003  Split into stand-alone function by C. Tremonti
   17-Oct-2000  Formerly part of fluxcorr_new -- written by S. Burles
</pre>
<p><strong>(See pro/fluxfix/spmedian_rebin.pro)</strong></p>
<hr />
<h3 id="SPPLAN1D">SPPLAN1D</h3>
<p><a href="#SPMEDIAN_REBIN">[Previous Routine]</a></p>
<p><a href="#SPPLAN2D">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spplan1d

 PURPOSE:
   Create plan file(s) for combining Spectro-2D outputs into one plate.

 CALLING SEQUENCE:
   spplan1d, [ topdir=, run2d=, mjd=, mjstart=, mjend=, $
    platenum=, platestart=, plateend=, /clobber ]

 INPUTS:

 OPTIONAL INPUTS:
   topdir     - Optional override value for the environment
                variable $BOSS_SPECTRO_REDUX.
   run2d      - Optional override value for the environment variable $RUN2D
   mjd        - Use data from these MJD's.
   mjstart    - Starting MJD.
   mjend      - Ending MJD.
   platenum   - Look for input data files in TOPINDIR/PLATENUM; default to
                search all subdirectories.  Note that this need not be
                integer-valued, but could be for example '0306_test'.
   platestart - Starting plate number.
   plateend   - Ending plate number.
   clobber    - If set, then over-write conflicting plan files; default to
                not over-write files.

 OUTPUT:

 COMMENTS:

 EXAMPLES:

 BUGS:
   This routine spawns the Unix command 'mkdir'.
   The use of CONCAT_DIR may not be valid for non-Unix OS's.

 PROCEDURES CALLED:
   concat_dir()
   fileandpath()
   get_mjd_dir()
   idlspec2d_version()
   idlutils_version()
   mjd_match()
   splog
   sdsshead()
   sxpar()
   yanny_free
   yanny_par()
   yanny_read
   yanny_write

 REVISION HISTORY:
   04-Jul-2000  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/spec2d/spplan1d.pro)</strong></p>
<hr />
<h3 id="SPPLAN2D">SPPLAN2D</h3>
<p><a href="#SPPLAN1D">[Previous Routine]</a></p>
<p><a href="#SPREAD_FRAMES">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spplan2d

 PURPOSE:
   Create plan file(s) for running the Spectro-2D pipeline.

 CALLING SEQUENCE:
   spplan2d, [ topdir=, run2d=, mjd=, mjstart=, mjend=, minexp=, $
    /clobber ]

 INPUTS:

 OPTIONAL INPUTS:
   topdir     - Optional override value for the environment
                variable $BOSS_SPECTRO_REDUX.
   run2d      - Optional override value for the environment variable $RUN2D
   mjd        - Look for raw data files in BOSS_SPECTRO_DATA/MJD; default to
                search all subdirectories.  Note that this need not be
                integer-valued, but could be for example '51441_test'.
   mjstart    - Starting MJD.
   mjend      - Ending MJD.
   minexp     - Minimum exposure time for science frames; default to 1 sec.
   clobber    - If set, then over-write conflicting plan files; default to
                not over-write files.

 OUTPUT:

 COMMENTS:
   The environment variables SPECLOG_DIR and BOSS_SPECTRO_DATA must be set.

   Look for the raw FITS data files in:
     BOSS_SPECTRO_DATA/MJD/sdR-cs-eeeeeeee.fit
   where c=color, s=spectrograph number, eeeeeeee=exposure number.

   The output 2D plan files created are:
     TOPOUTDIR/PLATE/spPlan2d-pppp-mmmmm.par
   where pppp=plate number, mmmmm=MJD.

   For the earliest data (before MJD=51455), then NAME keyword in the FITS
   files did not properly describe the plug-map name.  In those cases,
   look for the actual plug-map files in SPECLOG_DIR/MJD.

   Exclude all files where the QUALITY header keyword is not 'excellent'.

 EXAMPLES:
   Create the plan file(s) for reducing the data for MJD=51441, with that
   top level directory set to '/u/schlegel/2d_test'
   &gt; spplan2d, '/u/schlegel/2d_test', mjd=51441

 BUGS:
   This routine spawns the Unix command 'mkdir'.
   The use of CONCAT_DIR may not be valid for non-Unix OS's.

 PROCEDURES CALLED:
   concat_dir()
   fileandpath()
   get_mjd_dir()
   idlspec2d_version()
   idlutils_version()
   splog
   sdsshead()
   spplan_findrawdata
   spplan_create_spexp
   sxpar()
   yanny_write

 REVISION HISTORY:
   02-Nov-1999  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/spec2d/spplan2d.pro)</strong></p>
<hr />
<h3 id="SPREAD_FRAMES">SPREAD_FRAMES</h3>
<p><a href="#SPPLAN2D">[Previous Routine]</a></p>
<p><a href="#SPREDUCE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spread_frames

 PURPOSE:
   Read in multiple frame files produced by spectro2d and pass back arrays
   of the various quantities.

 CALLING SEQUENCE:
   spread_frames, spframes, [window=, binsz =,  adderr=, camnames=, $
     tsobjname=, flux=, ivar=, loglam=, dispersion=,  pixelmask=, plugmap=, $
     plugtag=, camerasvec=, filenum=,  expid=, sn2=, hdrarr=, merged_hdr=]

 INPUTS:
   spframes -

 OPTIONAL INPUT KEYWORDS:
   window   -  window size for apodizing the errors of the spectrum from each
               individual frame -- default to 100 pixels on each end of the 
               spectrum
   binsz    -  bin size (in log10(ang) of the output spectra; default to 
               1d-4 which is 69 km/s
   adderr   -  additional error to add to the formal errors as a fraction 
               of the flux
   camnames  - camera names to combine -- default to ['b1', 'b2', 'r1', 'r2']
  
   tsobjname - full path name to tsobjfile if one is available. It is 
               assumed that the target info is in HDU#1 and the latest 
               photo re-run is in HDU#2

 OUTPUT:

 OPTIONAL OUTPUT:
   flux       - flux array from all frames [npix, nfiber*nfames] 
   ivar       - inverse variance array from all frames [npix, nfiber*nframes] 
   loglam     - wavelength array (log10(Ang)) [npix, nfiber*nframes] 
   dispersion - instrumental resolution array [npix, nfiber*nfrmes]
   pixelmask  - mask array [npix, nfiber*nframes]
   plugmap    - array of structures containing plugmap [nfiber*nframes]
   plugtag    - like plugmap but with newer tsObj info if available and with
                exposure ID info included (useful for bookkeeping)
   camerasvec - vector of camera IDs (b1,b2,r1,r2) [nframes]
   filenum    - file number of frame (used in bookkeeping) [nfiber*nframes]
   expid      - exposure ID number [nframes]  
   sn2        - signal-to-noise squared of each frame [nframes]
   hdrarr     - array of pointers to header files from each frame [nframes]
   merged_hdr - header to be used for combined frames (some quantities 
                keywords contain averages of the keywords in the frames)

 COMMENTS:

 BUGS:

 EXAMPLES:

 PROCEDURES CALLED:
   correct_dlam
   djs_diff_angle
   mrdfits
   pixelmask_bits()
   splog
   sxaddpar
   sxcombinepar
   sxdelpar
   traceset2xy
   idlspec2d_version
   
 INTERNAL SUPPORT ROUTINES:
   makelabel()

 REVISION HISTORY:
   12-Aug-2003  Made into a stand-alone routine by C. Tremonti, Steward Obs.
   02-Jan-2000  Written as part of &quot;spcoadd_frames&quot; by D. Schlegel, Princeton

</pre>
<p><strong>(See pro/fluxfix/spread_frames.pro)</strong></p>
<hr />
<h3 id="SPREDUCE">SPREDUCE</h3>
<p><a href="#SPREAD_FRAMES">[Previous Routine]</a></p>
<p><a href="#SPREDUCE1D">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spreduce

 PURPOSE:
   Extract, wavelength-calibrate, and flatten SDSS spectral frame(s).

 CALLING SEQUENCE:
   spreduce, flatname, arcname, objname, [ run2d=, $
    plugfile=, lampfile=, indir=, plugdir=, outdir=, $
    ecalibfile=, plottitle=, /do_telluric, writeflatmodel=, writearcmodel=, $
    /bbspec ]

 INPUTS:
   flatname   - Name(s) of flat-field SDSS image(s)
   arcname    - Name(s) of arc SDSS image(s)
   objname    - Name(s) of object SDSS image(s)

 REQUIRED KEYWORDS:
   plugfile   - Name of plugmap file (Yanny parameter file)

 OPTIONAL KEYWORDS:
   run2d      - 2D reduction name, to include in output headers
   lampfile   - Name of file describing arc lamp lines;
                default to the file 'lamphgcdne.dat' in $IDLSPEC2D_DIR/etc.
   indir      - Input directory for FLATNAME, ARCNAME, OBJNAME;
                default to '.'
   plugdir    - Input directory for PLUGFILE; default to '.'
   outdir     - Directory for output files; default to '.'
   ecalibfile - opECalib.par file for SDSSPROC
   plottitle  - Prefix for titles in QA plots.
   do_telluric- Passed to EXTRACT_OBJECT
   writeflatmodel - passed to SPCALIB to write out flat image
                    model info to file
   writearcmodel  - passed to SPCALIB to write out arc image
                    model info to file
   bbspec         - use bbspec extraction code
   splitsky       - split sky model between spatial halves

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:
   Should test that arcs and flats are valid images with CHECKFLAVOR.

 PROCEDURES CALLED:
   extract_object
   fibermask_bits()
   get_tai
   qaplot_arcline
   qaplot_fflat
   readplugmap()
   reject_science()
   select_arc()
   select_flat()
   sortplugmap
   sdssproc
   spcalib
   splog
   sxaddpar
   sxpar()

 DATA FILES:
   $IDLSPEC2D_DIR/etc/skylines.dat

 REVISION HISTORY:
   12-Oct-1999  Written by D. Schlegel &amp; S. Burles, APO
      Apr-2010  Added &quot;write[flat,arc]model&quot; pass-through (A. Bolton, Utah)
</pre>
<p><strong>(See pro/spec2d/spreduce.pro)</strong></p>
<hr />
<h3 id="SPREDUCE1D">SPREDUCE1D</h3>
<p><a href="#SPREDUCE">[Previous Routine]</a></p>
<p><a href="#SPREDUCE2D">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spreduce1d

 PURPOSE:
   1-D reduction of spectra from 1 plate

 CALLING SEQUENCE:
   spreduce1d, [ platefile, fiberid=, run1d=, /doplot, /debug, chop_data= ]

 INPUTS:

 OPTIONAL INPUTS:
   platefile  - Plate file(s) from spectro-2D; default to all files
                matching 'spPlate*.fits'
   fiberid    - If specified, then only reduce these fiber numbers;
                this must be a vector with unique values between 1 and
                the number of fibers in the plate file
   run1d      - Optional override value for the environment variable $RUN1D
   doplot     - If set, then generate plots.  Send plots to a PostScript
                file spDiagDebug1d-$PLATE-$MJD.ps unless /DEBUG is set.
   debug      - If set, then send plots to the X display and wait for
                a keystroke after each plot; setting /DEBUG forces /DOPLOT.
   chop_data  - If set, then trim wavelength range to the specified range
                in vacuum Ang (if a 2-element array), or to a default
                trim range of [3600,10400] Ang.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   Input files are read from the current directory.
   Output files are written to the subdirectory $RUN1D.

   Names of output files are derived from PLATEFILE.
   For example, if PLATEFILE='spPlate-0306-51690.fits', then
     ZALLFILE = 'spZall-0306-51690.fits'
     ZBESTFILE = 'spZbest-0306-51690.fits'
     ZLINEFILE = 'spZline-0306-51690.fits'

 EXAMPLES:

 BUGS:

 DATA FILES:
   $IDLSPEC2D_DIR/templates/TEMPLATEFILES

 PROCEDURES CALLED:
   cpbackup
   dfpsclose
   dfpsplot
   djs_filepath()
   elodie_best()
   fileandpath()
   filter_thru()
   mrdfits()
   mwrfits
   qaplot_fcalibvec
   splog
   skymask()
   speclinefit
   star_dvelocity()
   struct_addtags()
   sxaddpar
   sxdelpar
   sxpar()
   synthspec()
   vdispfit
   zfind()
   zrefind()

 REVISION HISTORY:
   28-Jun-2000  Written by D. Schlegel, Princeton
   2010-2011: various template-related tweaks and Z_NOQSO, A. Bolton, Utah
</pre>
<p><strong>(See pro/spec1d/spreduce1d.pro)</strong></p>
<hr />
<h3 id="SPREDUCE2D">SPREDUCE2D</h3>
<p><a href="#SPREDUCE1D">[Previous Routine]</a></p>
<p><a href="#SPTEMPLATE_REBIN">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spreduce2d

 PURPOSE:
   Calling script for SPREDUCE that reduces a night of data according
   to a plan file.

 CALLING SEQUENCE:
   spreduce2d, [ planfile, docams=, /do_telluric, /xdisplay, $
    /writeflatmodel, /writearcmodel, /bbspec ]

 INPUTS:

 OPTIONAL INPUTS:
   planfile   - Name(s) of output plan file; default to reducing all
                plan files matching 'spPlan2d*.par'
   docams     - Cameras to reduce; default to ['b1', 'b2', 'r1', 'r2']
   do_telluric- Passed to EXTRACT_OBJECT
   xdisplay   - Send plots to X display rather than to plot file
   writeflatmodel - passed to SPCALIB via SPREDUCE to trigger writing
                    out of flat model info to file.
   writearcmodel  - passed to SPCALIB via SPREDUCE to trigger writing
                    out of arc model info to file.
   bbspec         - use bbspec extraction code

 OUTPUT:

 COMMENTS:
   The following environment variables must be set:
      BOSS_SPECTRO_DATA
      SPECLOG_DIR
      SPECFLAT_DIR
   Look for raw FITS data files in BOSS_SPECTRO_DATA/MJD.
   Look for plug map files in SPECLOG_DIR/MJD.
   Look for spectroscopic flat files in SPECFLAT_DIR.

 EXAMPLES:

 BUGS:
   This routine spawns the Unix command 'mkdir'.

 PROCEDURES CALLED:
   cpbackup
   idlspec2d_version()
   idlutils_version()
   splog
   spreduce
   yanny_free
   yanny_par()
   yanny_read

 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   02-Nov-1999  Written by David Schlegel, Princeton.
      Apr-2010  Added &quot;write[flat,arc]model&quot; pass-through (A. Bolton, Utah)
   15-Aug-2011  Added pass-through for spatial split of sky model (A. Bolton, Utah)
</pre>
<p><strong>(See pro/spec2d/spreduce2d.pro)</strong></p>
<hr />
<h3 id="SPTEMPLATE_REBIN">SPTEMPLATE_REBIN</h3>
<p><a href="#SPREDUCE2D">[Previous Routine]</a></p>
<p><a href="#SPTHROUGHPUT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   sptemplate_rebin

 PURPOSE:
   Read and optionally rebin spectral templates

 CALLING SEQUENCE:
   starflux = sptemplate_rebin([ loglam, dloglam=, eigenfile=, eigendir=, $
    columns=, npoly=, starloglam= ])

 INPUTS:

 OPTIONAL INPUTS:
   loglam     - Log10 of wavelengths [vacuum Ang]; need not be uniformly
                spaced; if not specified, then templates are returned in
                their native wavelength scale as defined by OUTLOGLAM
   dloglam    - If one specifies DLOGLAM instead of LOGLAM, then the
                output wavelengths will span those in the template file
                but spaced by this amount in log-wavelength
   eigenfile  - Input FITS file with an [NPIXSTAR,NSTAR] image with
                either templates or eigenspectra.  If a wildcard appears
                in the file name, then the file that appears last in a sort
                is used.
                The header keywords COEFF0, COEFF1 are used to specify
                the wavelength mapping in log-10 Angstroms.
                Default to 'spEigenGal-*.fits'.
   eigendir   - Directory for EIGENFILE; default to $IDLSPEC2D/templates.
   columns    - Column numbers of the eigenspectra image to use in the
                PCA fit; default to all columns.
   npoly      - Number of polynomial terms to append to eigenspectra;
                default to none.

 OUTPUTS:
   starflux   - Output template spectra, typically in units of
                erg/s/cm^2/Ang regardless of the wavelength spacing

 OPTIONAL OUTPUTS:
   starloglam - Log10 of output wavelengths [vacuum Ang]; if LOGLAM is
                specified, then this is the same

 COMMENTS:
   There are two methods for rebinning the spectra.  If the output
   wavelength scale is coarser than the input, then the flux is dumped
   into pixels using CIC assignment.  Otherwise, BSPLINE_ITERFIT is used
   to resample the spectra.

 EXAMPLES:

 BUGS:

 DATA FILES:
   $IDLSPEC2D_DIR/templates/*.fits

 PROCEDURES CALLED:
   combine1fiber
   djs_filepath()
   readfits()
   poly_array()
   populate_image
   sxpar()

 REVISION HISTORY:
   21-Mar-2006  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/photoz/sptemplate_rebin.pro)</strong></p>
<hr />
<h3 id="SPTHROUGHPUT">SPTHROUGHPUT</h3>
<p><a href="#SPTEMPLATE_REBIN">[Previous Routine]</a></p>
<p><a href="#SSHIFTVEC">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   spthroughput

 PURPOSE:
   Return the throughput and efficiency for a given plate+camera+exposure

 CALLING SEQUENCE:
  photons_per_flux_per_sec = spthroughput( plate, [ indx ], camname=, $
   expnum=, [ loglam=, exptime=, airmass=, efficiency=, /median ]

 INPUTS:
   plate      - Plate number
   camname    - Camera name, 'b1', 'b2', 'r1', or 'r2'
   expnum     - Exposure number

 OPTIONAL INPUTS:
   indx       - Fiber index number(s) 0-indexed; default to [0,N-1]
                where N is the number of fibers in one spectrograph
   loglam     - Wavelengths in vacuum log10-Angstroms; if specified, then this
                is a vector of the same wavelengths for all fibers
   median     - If set, and LOGLAM is input, then median-filter all
                of the fibers at each wavelength

 OUTPUTS:
   photons_per_flux_per_sec - Calibration vector(s) of photons per
                (10^-17 erg/s/cm^2/Ang); return 0 if the flux-calibration
                failed for this camera and default values were used

 OPTIONAL OUTPUTS:
   loglam     - Wavelength scale in vacuum log-10-Angstroms for the native
                pixel scale, if LOGLAM is not specified; this is an
                array with the same dimensions as PHOTONS_PER_FLUX_PER_SEC
   exptime    - Exposure time (seconds)
   airmass    - Airmass for this exposure
   efficiency - Fractional efficiency using the parameters of the SDSS
                telescope mirror sizes; return 0 if the flux-calibration
                failed for this camera and default values were used

 COMMENTS:

 EXAMPLES:

 BUGS:
   The fiber flats (FFLAT) should also be included.

 DATA FILES:

 PROCEDURES CALLED:
   correct_dlam
   djs_filepath()
   mrdfits()
   spframe_read
   sxpar()

 REVISION HISTORY:
   29-Mar-2006  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/spec2d/spthroughput.pro)</strong></p>
<hr />
<h3 id="SSHIFTVEC">SSHIFTVEC</h3>
<p><a href="#SPTHROUGHPUT">[Previous Routine]</a></p>
<p><a href="#STAR_DVELOCITY">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   sshiftvec

 PURPOSE:
   Shift vector or image (line-at-a-time) using a damped sinc function.

 CALLING SEQUENCE:
   simage = sshiftvec( fimage, shift, [ sincrad=sincrad, dampfac=dampfac, $
    eps=eps ] )

 INPUTS:
   fimage     - Input vector (1D) or image (2D)
   shift      - Distance to shift

 OPTIONAL KEYWORDS:
   sincrad    - Half-width of sinc convolution kernal; default to 10 pixels
   dampfac    - Damping factor for gaussian; default to 3.25
   eps        - Smallest fractional shift allowed; default to 1.0e-5

 OUTPUTS:
   simage     - Shifted image

 OPTIONAL OUTPUTS:

 COMMENTS:
   This routine is based upon the IDL routine SSHIFT from Marc Buie,
   which in turn is based upon the Zodiac routine shiftc/sshift.

 EXAMPLES:

 PROCEDURES CALLED:
   Dynamic link to sshiftvec.c

 REVISION HISTORY:
   14-Apr-1999  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/spec2d/sshiftvec.pro)</strong></p>
<hr />
<h3 id="STAR_DVELOCITY">STAR_DVELOCITY</h3>
<p><a href="#SSHIFTVEC">[Previous Routine]</a></p>
<p><a href="#STYPE_STANDARD">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   star_dvelocity

 PURPOSE:
   Solve for velocity shifts between multiple exposures.

 CALLING SEQUENCE:
   res = star_dvelocity(plate, mjd=, [ vmin=, vmax=, fiberid=, path= ] )

 INPUTS:
   plate      - Plate number
   mjd        - MJD for this plate

 OPTIONAL INPUTS:
   vmin       - Minimum velocity to consider; default to -700.
   vmax       - Maxmimum velocity to consider; default to 700.
   fiberid    - If set, then only fit for the objects specified by
                these 1-indexed fiber IDs.  Set to 0 to not
                fit any objects (but return empty 640-element output
                structures); default to fitting all.
   path       - Override all path information with this directory name
                (for reading the spCFrame files)

 OUTPUTS:
   res        - Output structure with result for each object [NOBJECT].
                The structure contains the following
                best-fit Elodie spectrum:
                  VELOCITY_TIME[10] - Timestamp for each exposure
                  VELOCITY[10]      - Velocity for each exposure [km/s]
                  VELOCITY_ERR[10]  - Error in velocity

 OPTIONAL OUTPUTS:

 COMMENTS:
   Velocities are computed relative to the first exposure.  Each exposure
   is compared to every other exposure, with no assumption about the kind
   of object.  The object need not be a star.

 EXAMPLES:
   Fit the velocity shifts for the white dwarf star in SDSS publication #535:
     IDL&gt; res=star_dvelocity(518,mjd=52282,fiberid=285)

 BUGS:

 PROCEDURES CALLED:

 INTERNAL SUPPORT ROUTINES:
   dvelocity_struct()
   dvelocity_fn()

 REVISION HISTORY:
   09-Jul-2005  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/spec1d/star_dvelocity.pro)</strong></p>
<hr />
<h3 id="STYPE_STANDARD">STYPE_STANDARD</h3>
<p><a href="#STAR_DVELOCITY">[Previous Routine]</a></p>
<p><a href="#SUPERFLAT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   stype_standard

 PURPOSE:
   Spectral type the standard stars and store the result as a structure.
   The normalized input spectra are compared to a grid of normalized
   Kurucz models produced by the SPECTRUM code (R.0. Gray &amp; C. J. Corbally,
   1994, AJ, 107, 742) and convolved to SDSS resolution. Since nearly all 
   of the interesting spectral features are in the blue, data from the 
   blue camera only can be used.

 CALLING SEQUENCE:
   std =  stype_standard(loglam, nflux, ninvvar, plugmap, outfile=, $
          nonsdss=, smoothpix=) 

 INPUTS:
   loglam  - Wavelength array of input spectra in log10(Angstroms) [npix]
   nflux   - Array of normalized standard star spectra [npix, nstar]
   ninvvar - Inverse variance of standard star spectra [npix,nstar]
   plugmap - Plugmap corresponding to the input standard stars [nstar]

 OUTPUT:
   A structure containing best fit model name, Teff, g, [Fe/H] and 
   magnitudes is returned.  Diagnostic plots are also produced.  Each 
   spectophoto standard is shown with the (normalized) best fit spectrum 
   plotted over top in red.  

 KEYWORDS:
   outfile   - Name of output FITS file. It must be of the from
               ?????-pppp-mmmm-s.fits where, pppp is the plateid, 
               mmmmm is the mjd and s is the spectrograph ID.
               e.g. spStd-0519-52283-1.fits 
   nonsdss   - Set to 1 for use with data which is not from the SDSS --
               the plugmap is not used in this case, and no reddening
               is applied.
   smoothpix - number of pixels to smooth Kurucz models by -- for use with
               data of lower resolution than the SDSS

 COMMENTS:  
   A file containing the Kurucz model data is required.  It is called 
   &quot;kurucz_stds_*.fit&quot; and it should reside in IDLSPEC2D_DIR/etc.  See 
   &quot;kurucz_restore.pro&quot; for a description of this file.

   The SFD dust maps are needed to estimate the foreground extinction 
   to add to the models.  To acomodate this a new environment variable 
   &quot;DUST_DIR&quot; is required.   

 BUGS:     
   Spectral typing is slightly sensitive to the method of normalization

 EXAMPLES:

 PROCEDURES CALLED:
   djs_icolor()
   djs_median()
   djs_oplot
   djs_plot
   dust_getval()
   ext_odonnell()
   filter_thru()
   glactc()
   kurucz_restore
   mwrfits
   splog
   zcompute()

 INTERNAL SUPPORT ROUTINES
   kurucz_match()

 REVISION HISTORY:
   28-Sep-2002  Written by C. Tremonti
   12-Aug-2003  Modified by C. Tremonti for use with Spectro2d
</pre>
<p><strong>(See pro/fluxfix/stype_standard.pro)</strong></p>
<hr />
<h3 id="SUPERFLAT">SUPERFLAT</h3>
<p><a href="#STYPE_STANDARD">[Previous Routine]</a></p>
<p><a href="#SYNTHSPEC">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   superflat

 PURPOSE:
   Create a &quot;superflat&quot; from an extracted flat-field image

 CALLING SEQUENCE:
   sset = superflat(flux, fluxivar, wset, fullbkpt, coeff, $
    [ fibermask=, minval=, medval=, title=, $
    x2=, nord=, npoly=, upper=, lower= ])

 INPUTS:
   flux       - Array of extracted flux from a flat-field image [Nrow,Ntrace]
   fluxivar   - Inverse variance map for FLUX.
   wset       - Wavelength solution

 OPTIONAL KEYWORDS:
   fibermask  - Fiber status bits, set nonzero for bad status [NFIBER]
   minval     - Minimum value to use in fits to flat-field vectors;
                default to 0.
   title      - TITLE of plot; if not set, then do not make this plot.

 OPTIONAL PARAMETERS FOR BSPLINE_ITERFIT:
   x2         - Orthogonal dependent variable for B-spline fit;
                this will typically be the X position on the CCD.
   nord       - Order of b-splines; default of 4 for cubic
   npoly      - Order of X2 polynomial fit; default to 0 for none
   lower      -
   upper      -

 OUTPUTS:
   sset       - Output structure describing spline fit to superflat.

 OPTIONAL OUTPUTS:
   medval     - Median value of each fiber [NFIBER]
   fibermask  - (Modified)

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_maskinterp()
   djs_mean()
   djs_oplot
   djs_plot
   bspline_valu()
   bspline_iterfit()
   traceset2xy

 REVISION HISTORY:
   02-Jan-2000  Excised code from SPFLATTEN2 (DJS).
</pre>
<p><strong>(See pro/spec2d/superflat.pro)</strong></p>
<hr />
<h3 id="SYNTHSPEC">SYNTHSPEC</h3>
<p><a href="#SUPERFLAT">[Previous Routine]</a></p>
<p><a href="#TELLURIC_CORR">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   synthspec

 PURPOSE:
   Construct synthetic spectrum from eigen-templates.

 CALLING SEQUENCE:
   synflux = synthspec(zans, [ loglam=, hdr=, eigendir= ])

 INPUTS:
   zans       - Structure(s) with redshift-fit information (from SPREDUCE1D).

 OPTIONAL KEYWORDS:
   loglam     - Log-10 wavelengths at which to synthesize the spectrum;
                this can either be a single vector if all spectra have
                the same wavelength mapping, or an array of [NPIX,NOBJ].
   hdr        - If specified, then use this header to construct LOGLAM.
                Either LOGLAM or HDR must be specified.
   eigendir   - Directory for EIGENFILE; default to $IDLSPEC2D/templates.

 OUTPUTS:
   synflux    - Synthetic spectra

 COMMENTS:
   The sub-pixel shifts are applied with the COMBINE1FIBER procedure.

 EXAMPLES:

 BUGS:

 DATA FILES:
   $IDLSPEC2D_DIR/etc/TEMPLATEFILES

 PROCEDURES CALLED:
   combine1fiber
   concat_dir()
   poly_array()
   readfits()
   sxpar()

 REVISION HISTORY:
   20-Aug-2000  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/synthspec.pro)</strong></p>
<hr />
<h3 id="TELLURIC_CORR">TELLURIC_CORR</h3>
<p><a href="#SYNTHSPEC">[Previous Routine]</a></p>
<p><a href="#THROUGHPUT_CALIB">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   telluric_corr

 PURPOSE:
   Use SPECTROPHOTO and REDDEN_STD's to fit telluric features.

 CALLING SEQUENCE:
   telluric_factor = telluric_corr(flux, fluxivar, wset, plugsort, $
    fibermask=, tellbands=, ncoeff=, pixspace=, /dospline, $
    nord=, upper=, lower=, plottitle=

 INPUTS:
   flux         - Sky-subtracted extracted spectra [NX,NTRACE]
   fluxivar     - Inverse variance for FLUX [NX,NTRACE]
   wset         - Wavelength coefficients as a trace set
   plugsort     - Plugmap entries

 OPTIONAL KEYWORDS:
   fibermask  - Fiber status bits, set nonzero for bad status [NFIBER]
   tellbands  - Structure array defining the telluric bands and the
                wavelengths used to fit the continuum.  If not set,
                then default values are used.  See the code for the
                definition of this structure.
   ncoeff     - Number of coefficients used in constructing continuum;
                default to 4.
   pixspace   - Approximate spacing in pixels for break points in the
                spline fits to individual fibers; default to 10 pixels.
   dospline   - If this keyword is set, then fit the continuum
                to splines (using PIXSPACE) rather than to a Legendre
                polynomial (using NCOEFF).
   plottitle  - Title for QA plot; if not set, then do not plot.

 PARAMETERS FOR SLATEC_SPLINEFIT:
   nord
   upper
   lower

 OUTPUTS:
   telluric_factor - Telluric correction for each pixel in flux array;
                     set to 1 where there is no correction.

 OPTIONAL OUTPUTS:

 COMMENTS:
   Objects that are SPECTROPHOTO_STD or REDDEN_STD (as listed in the plugmap
   structure) are selected for constructing the telluric-correction factor.

 EXAMPLES:

 BUGS:
   Other fainter telluric bands at [7178,7212], [8130,8206].

 PROCEDURES CALLED:
   djs_oplot
   djs_plot
   djs_reject()
   fibermask_bits()
   func_fit()
   bspline_valu()
   bspline_iterfit()
   splog
   traceset2xy

 REVISION HISTORY:
   19-Oct-1999  Written by S. Burles, Chicago
   15-Aug-2000  Major modifications by D. Schlegel to fit all telluric
                bands with one spline, and to do this fit on the spectra
                before flux-correction.
</pre>
<p><strong>(See pro/spec2d/telluric_corr.pro)</strong></p>
<hr />
<h3 id="THROUGHPUT_CALIB">THROUGHPUT_CALIB</h3>
<p><a href="#TELLURIC_CORR">[Previous Routine]</a></p>
<p><a href="#TRACE320CEN">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   throughput_calib

 PURPOSE:
   Calculate spectroscopic throughput with fluxcalib files 

 CALLING SEQUENCE:
  throughput = throughput_calib(file, loglam, $
    primary=primary, exposure=exposure, pixelsize=pixelsize

 INPUTS:
   file       - full name of fluxcalib fits file
   loglam     - optional, alog10 wavelengths.
                throughput is set to zero outside of the wavelength range
                 of both bspline set and the wavemin,wavemax header cards

 OPTIONAL KEYWORDS:
   primary    - effective primary aperature in cm^2 (default 40000)
   exposure   - effective exposure time of calibration exposure
   pixelsize  - physical CCD pixel size (guess alog10 1.0e-4)
                 this could also be passed as a keyword in the header

 OUTPUTS:
   throughput - percent throughput at each loglam position

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

   loglam = 3.57 + findgen(400)/1000.
   cd,getenv('BOSS_SPECTRO_REDUX')
   allfiles = findfile('0*/*calib*fits', count=nf)
   throughput = fltarr(400, nf)
   for i=0,nf-1 do throughput[*,i] = throughput_calib(allfiles[i],loglam)

 PROCEDURES CALLED:

 REVISION HISTORY:
   26-Jun-2001  Scott Burles (Paris)
</pre>
<p><strong>(See pro/spec2d/throughput_calib.pro)</strong></p>
<hr />
<h3 id="TRACE320CEN">TRACE320CEN</h3>
<p><a href="#THROUGHPUT_CALIB">[Previous Routine]</a></p>
<p><a href="#TRACE320CRUDE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   trace320cen

 PURPOSE:
   Find the 320 fiber positions for the central row of an image.

 CALLING SEQUENCE:
   xfiber = trace320cen( fimage, [mthresh=, ystart=, nmed=, xgood=, $
          bundlebreakrange=, nextpeakrange=, bundlegap=,
          numberFibersPerSide=, deltax=, mthreshfactor= ] )

 INPUTS:
   fimage     - Image

 OPTIONAL INPUTS:
   mthresh    - Threshold for peak-finding in convolved row; default to 0.5
                times the dispersion (found with djs_iterstat).
   ystart     - Y position in image to search for initial X centers; default
                to the central row
   nmed       - Number of rows to median filter around YSTART;
                default to 21
   bundlebreakrange - range in which the bundle break is expected in
                      units of deltax
   nextpeakrange - range in which the next peak is expected in
                      units of deltax
   bundlegap   - approximate gap between bundles
   numberFibersPerSide - default 320 if not set
   deltax      - the expected spacing between fibers in pixel units
   mtheshfactor      - noise factor for getting lines

 OUTPUTS:
   xfiber     - Vector of 320 X centers

 OPTIONAL OUTPUTS:
   xgood      - Set to 1 for fibers that were actually found, 0 otherwise

 COMMENTS:

 EXAMPLES:

 PROCEDURES CALLED:
   djs_iterstat

 REVISION HISTORY:
   13-Sep-1999  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/spec2d/trace320cen.pro)</strong></p>
<hr />
<h3 id="TRACE320CRUDE">TRACE320CRUDE</h3>
<p><a href="#TRACE320CEN">[Previous Routine]</a></p>
<p><a href="#TRACE_CEN">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   trace320crude

 PURPOSE:
   Calling script to return 320 full traces using TRACE_CRUDE.

 CALLING SEQUENCE:
   xset = trace320crude( fimage, invvar, [ ystart=, nmed=, $
    xmask=, yset=, maxerr=, maxshifte=, maxshift0=, xerr=, maxdev=, ngrow=, $
    fibermask=, flathdr=, padding=, plottitle= ] )

 INPUTS:
   fimage     - Image

 OPTIONAL INPUTS FOR TRACE320CEN:
   ystart     - Y position in image to search for initial X centers; default
                to the central row
   nmed       - Number of rows to median filter around YSTART; default to 21
   plottitle  -

 OPTIONAL INPUTS FOR TRACE_CRUDE:
   flathdr    - FITS header for determining CARTID and MJD
   invvar     - Inverse variance (weight) image
   radius     - Radius for centroiding; default to 3.0
   maxerr     - Maximum error in centroid allowed for valid recentering;
                default to 0.2
   maxshifte  - Maximum shift in centroid allowed for valid recentering;
                default to 0.1
   maxshift0  - Maximum shift in centroid allowed for initial row;
                default to 0.5
   padding    - number added to ndegree in loop to fix deviant centroids

 OPTIONAL INPUTS:
   maxdev     - Maximum deviation of X in pixels; default to rejecting any
                XPOS positions that deviate by more than 1.0 pixels from
                a polynomial remapping of the centroids from other rows.
   ngrow      - For each trace, replace all centroids within NGROW rows
                of a bad centroid with the predicted centroid locations.
                Default to 5.
   fibermask  - Fiber status bits, set nonzero for bad status [NFIBER]

 OUTPUTS:
   xset       - X centers for all traces

 OPTIONAL OUTPUTS:
   yset       - Y centers for all traces
   xerr       - Errors for XSET
   xmask      - Mask set to 1 for good fiber centers, 0 for bad;
                same dimensions as XSET.
   fibermask  - (Modified.)

 COMMENTS:
   Without djs_maskinterp, hot columns skew traces 

 EXAMPLES:

 PROCEDURES CALLED:
   djs_maskinterp()
   fibermask_bits()
   trace_crude()
   trace_fweight()
   trace320cen()

 REVISION HISTORY:
   13-Sep-1999  Written by David Schlegel, Princeton.
    8-Jul-2001  Added djs_maskinterp call
   05-Oct-2010  ASB added masking of rows with invvar all zero
</pre>
<p><strong>(See pro/spec2d/trace320crude.pro)</strong></p>
<hr />
<h3 id="TRACE_CEN">TRACE_CEN</h3>
<p><a href="#TRACE320CRUDE">[Previous Routine]</a></p>
<p><a href="#TRACE_FIX">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   trace_cen

 PURPOSE:
   Find the fiber positions for the central row of an image.

 CALLING SEQUENCE:
   xfiber = trace_cen( fimage, [ xstart=, ystart=, nmed=, nfiber=, nbundle=, $
    fiberspace=, bundlespace=, xgood=, flux=, plottitle= ] )

 INPUTS:
   fimage     - Image

 OPTIONAL INPUTS:
   xstart     - Initial guess for X position of first fiber; default to 0
   ystart     - Y position in image to search for initial X centers; default
                to the central row
   nmed       - Number of rows to median filter around YSTART;
                default to 21
   nfiber     - Number of fibers; default to 320
   nbundle    - Number of bundles; default to 16
   fiberspace - Fiber-to-fiber spacing in pix [NBUNDLE]
   bundlespace- Extra spacing between bundles in pix [NBUNDLE-1]
   plottitle  - If set, then create plot with this title

 OUTPUTS:
   xfiber     - Vector of 320 X centers

 OPTIONAL OUTPUTS:
   xgood      - Set to 1 for fibers that were actually found, 0 otherwise
   flux       - Flux of each fiber

 COMMENTS:

 EXAMPLES:

 PROCEDURES CALLED:
   djs_iterstat
   mpfit

 REVISION HISTORY:
   29-Aug-2009  Written by David Schlegel, LBL
</pre>
<p><strong>(See pro/spec2d/trace_cen.pro)</strong></p>
<hr />
<h3 id="TRACE_FIX">TRACE_FIX</h3>
<p><a href="#TRACE_CEN">[Previous Routine]</a></p>
<p><a href="#TRACE_SPARSE_CRUDE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   trace_fix

 PURPOSE:
   Fix a set of trace centers by replacing traces that converge.

 CALLING SEQUENCE:
   xnew = trace_fix( xcen, [minsep= , ngrow=, ycen=, xerr=])

 INPUTS:
   xcen       - X centers for all traces [ny,nTrace]

 OPTIONAL INPUTS:
   minsep     - Minimum separation between adjacent traces.  Smaller
                separations are regarded as bad traces.  Default to 5.5.
   ngrow      - Replace all pixels within MINSEP of its adjacent trace,
                plus NGROW of its neighboring pixels.  Default to 20.
   ycen       - Y centers corresponding to XCEN.
   xerr       - X errors corresponding to XCEN.

 OUTPUTS:
   xnew       - Modified XCEN; traces may be removed or shifted.
   ycen       - Modified YCEN; columns may be removed.
   xerr       - Modified XERR; columns may be removed.

 COMMENTS:

 EXAMPLES:

 PROCEDURES CALLED:

 INTERNAL PROCEDURES:
   remove_column

 REVISION HISTORY:
   13-Aug-1999  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/spec2d/trace_fix.pro)</strong></p>
<hr />
<h3 id="TRACE_SPARSE_CRUDE">TRACE_SPARSE_CRUDE</h3>
<p><a href="#TRACE_FIX">[Previous Routine]</a></p>
<p><a href="#TRIAL_LRG_CAT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>

 NAME: trace_sparse_crude

 PURPOSE:
  Semi-crude, semi-robust tracing of sparse flats.

 USAGE:
   trace_sparse_crude, image, xpos, ypos [, csize=csize, $
    maxpeaks=maxpeaks, pthresh=pthresh, fthresh=fthresh, $
    dxfit=dxfit, sigma_guess=sigma_guess, maxdev=maxdev, $
    ncoeff=ncoeff]

 ARGUMENTS:
   image: flatfield image array with traces running
     approx. vertically.  Best to * by (invvar gt 0.)
     to mask known artifacts/bad columns from SDSSPROC.

 OPTIONAL ARGUMENTS:
   csize: chunk size for dividing up image (def = 50)
   maxpeaks: max # of traces to find (def = 40)
   pthresh, fthresh: peaks must be fthresh times the
    pthresh quantile in the row x-sec'n to be detected.
    (def: pthresh = 0.975, fthresh = 1.0)
   dxfit: fit peak pos'n with +/- dxfit pixels data (def = 7)
   sigma_guess: Gaussian sigma guess (def = 1.)
   maxdev: maximum pixel deviation for tracefit (def = 0.1)
   ncoeff: poly order for tracefit (def = 5)

 WRITTEN:
  A. Bolton @ Utah 2010may

</pre>
<p><strong>(See pro/spec2d/trace_sparse_crude.pro)</strong></p>
<hr />
<h3 id="TRIAL_LRG_CAT">TRIAL_LRG_CAT</h3>
<p><a href="#TRACE_SPARSE_CRUDE">[Previous Routine]</a></p>
<p><a href="#TWEAKTRACE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   trial_lrg_cat
 PURPOSE:
   make trial LRG catalog for APO-LSS testing purposes
 CALLING SEQUENCE:
   trial_lrg_cat
 COMMENTS:
   uses model mags, not cmodel
 REVISION HISTORY:
   2006-Dec-18  Blanton, NYU
</pre>
<p><strong>(See pro/plate/trial_lrg_cat.pro)</strong></p>
<hr />
<h3 id="TWEAKTRACE">TWEAKTRACE</h3>
<p><a href="#TRIAL_LRG_CAT">[Previous Routine]</a></p>
<p><a href="#UPDATE_PLATELIST">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   tweaktrace

 PURPOSE:
   Use fitans to tweak trace and sigma
   This just perturbs the input values of xcen and sigma

 CALLING SEQUENCE:
   tweaktrace, x, sigma, centershift, sigmashift, maxshift=maxshift

 INPUTS:
   x            - the input trace positions
   sigma        - the input sigma widths of profiles
   centershift  - the pixel shift in x
   sigmashift   - the fractional change of sigma

 OPTIONAL KEYWORDS:
   maxshift     - the absolute allowed shift in x (default = 1.0)

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 PROCEDURES CALLED:

 REVISION HISTORY:
   19-Oct-1999  Written by S. Burles, Chicago
</pre>
<p><strong>(See pro/spec2d/tweaktrace.pro)</strong></p>
<hr />
<h3 id="UPDATE_PLATELIST">UPDATE_PLATELIST</h3>
<p><a href="#TWEAKTRACE">[Previous Routine]</a></p>
<p><a href="#UPDATE_PLATE_RELEASE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   update_platelist

 PURPOSE:
   Update the plate list file found in the speclog product.

 CALLING SEQUENCE:
   update_platelist, [ outfile ]

 INPUTS:
   outfile    - Name of output file; default to 'spPlateList.par' in the
                current directory.

 OPTIONAL KEYWORDS:

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The file in $SPECLOG_DIR/opfiles/spPlateList.par is read, and we
   merge in the list of plates returned by the PLATELIST procedure.
   Manual comments from the first file are retained.
   The auto-generated &quot;platequality&quot; is used for plates being added
   if they didn't already have a quality in the file.

 EXAMPLES:

 BUGS:

 DATA FILES:
   $SPECLOG_DIR/opfiles/spPlateList.par

 PROCEDURES CALLED:
   copy_struct_inx
   platelist
   yanny_read
   yanny_write

 REVISION HISTORY:
   04-Jun-2002  Written by D. Schlegel, Princeton (checked in later)
</pre>
<p><strong>(See pro/plan/update_platelist.pro)</strong></p>
<hr />
<h3 id="UPDATE_PLATE_RELEASE">UPDATE_PLATE_RELEASE</h3>
<p><a href="#UPDATE_PLATELIST">[Previous Routine]</a></p>
<p><a href="#UUBATCHPBS">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   update_plate_release

 PURPOSE:
   Update the plate list file found in this idlspec2d product
   with new data release notes.

 CALLING SEQUENCE:
   update_plate_release, [ release, rfile, outfile ]

 INPUTS:

 OPTIONAL INPUTS:
   release    - Data release name to put into plate list file;
                default to 'DR6'
   rfile      - Yanny param file with PLATEID,MJD,RELEASE columns,
                where the release names should appear in the RELEASE entries;
                default to &quot;$IDLSPEC2D_DIR/etc/dr2spectro.par&quot;,
   outfile    - Name of output file; default to 'spPlateList.par' in the
                current directory.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The file in $SPECLOG_DIR/opfiles/spPlateList.par is read, and we
   merge in the list of plates returned by the PLATELIST procedure.
   Manual comments from the first file are retained.

 EXAMPLES:

 BUGS:

 DATA FILES:
   $SPECLOG_DIR/opfiles/spPlateList.par

 PROCEDURES CALLED:
   yanny_readone()
   yanny_write

 REVISION HISTORY:
   04-Feb-2004  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/plan/update_plate_release.pro)</strong></p>
<hr />
<h3 id="UUBATCHPBS">UUBATCHPBS</h3>
<p><a href="#UPDATE_PLATE_RELEASE">[Previous Routine]</a></p>
<p><a href="#UUPLOTSPEC">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   uubatchpbs

 PURPOSE:
   Batch process Spectro-2D and Spectro-1D reductions based upon
   already-built plan files.
 ADAPTED FROM: batchpbs.pro
   To function on clusters without node sharing (e.g. University of Utah)

 CALLING SEQUENCE:
   uubatchpbs, [ platenums, topdir=, run2d=, run1d=, platestart=, plateend=, $
    mjd=, mjstart=, mjend=, upsvers2d=, upsvers1d=, /zcode, queue=, /skip2d, /clobber, $
    pbsnodes=pbsnodes, pbs_ppn=pbs_ppn, pbs_a=pbs_a, pbs_walltime=pbs_walltime, ember=ember]

 INPUTS:

 OPTIONAL INPUTS:
   platenums  - Plate numbers to reduce; default to '*'
   topdir     - Optional override value for the environment
                variable $BOSS_SPECTRO_REDUX.
   run2d      - Optional override value for the environment variable $RUN2D
   run1d      - Optional override value for the environment variable $RUN1D
   platestart - Starting plate number.
   plateend   - Ending plate number.
   mjd        - MJD dates to reduce; default to all.
                Select based upon the MJD of the combine plan file, and
                reduce data from all nights needed for that combined plate+MJD.
   mjstart    - Starting MJD dates to reduce.
   mjend      - Ending MJD dates to reduce.
   upsvers2d  - If set, then do a &quot;setup idlspec2d $UPSVERS2D&quot; on the
                remote machine before executing Spectro-2D.  This allows
                you to batch jobs using a version other than that which
                is declared current under UPS.
   upsvers1d  - If set, then do a &quot;setup idlspec2d $UPSVERS2D&quot; on the
                remote machine before executing Spectro-1D.  This allows
                you to batch jobs using a version other than that which
                is declared current under UPS.
   zcode      - If set, run Zcode in auto mode.
   queue      - If set, sets the submit queue.
   skip2d     - If set, then skip the Spectro-2D reductions.
   clobber    - If set, then reduce all specified plates.  The default is
                to not reduce plates where the script file already exists.
   pbs_nodes  - If set, collect the pbs qsub commands into pbs_nodes script files
                in order to run on clusters without node sharing (ie Utah).
                default to node sharing, and keep the pbs qsub commands in the
                individual plate-mjd SCRIPT files.
   pbs_ppn    - If set, use #PBS -l nodes=1:ppn=pbs_ppn, otherwise
                default to #PBS -l nodes=1
   pbs_a      - If set, use #PBS -A pbs_a, otherwise
                default to none
   pbs_walltime - If set, use #PBS -l walltime=pbs_walltime, otherwise
                default to none
   ember      - If set, then setup the defaults for the ember cluster at the University of Utah:
                pbs_nodes = 8 (for 8 nodes, without node sharing) 
                pbs_ppn = 12 (12 processors per node)
                pbs_a = 'bolton-em' (Bolton's account, limited to 8 nodes: ember253 - ember260)
                pbs_walltime='48:00:00'

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:
   This is currently written to batch all Spectro-2D and Spectro-1D
   reductions, without the option of doing only one or the other.

   Script files are generated for partial reductions of a plate,
   although those jobs are not submitted.  It would be less confusing
   to not make those script files.

 REVISION HISTORY:
   17-Jan-2010  Written by D. Schlegel, LBL
   01-Jan-2011  Adapted from batchpbs by Joel R. Brownstein, University of Utah, 
                to generalize to cluster computers that do not have pbs node sharing
                by relocating the PBS commands to bundled script files, 
                in general via the keywords pbs_nodes, pbs_ppn, pbs_a
                and with University of Utah defaults preset via the keyword ember.
</pre>
<p><strong>(See pro/spec2d/uubatchpbs.pro)</strong></p>
<hr />
<h3 id="UUPLOTSPEC">UUPLOTSPEC</h3>
<p><a href="#UUBATCHPBS">[Previous Routine]</a></p>
<p><a href="#VDISPFIT">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   uuplotspec

 PURPOSE:
   Based on D. Schlegel's plotspec routine for plotting spectra from Princeton-1D spectro outputs,
   a floating X-Window was added in order to provide a functional interface for navigation and control and
   to provide feedback to an online database at http://boss.astro.utah.edu


 CALLING SEQUENCE:
   uuplotspec, plate, [ fiberid, mjd=, znum=, zmanual=, $
    nsmooth=, /zline, /nosyn, /noerr, $
    /sky, /ormask, /andmask, psfile=, /restframe, $
    /zwarning, /allexp, topdir=, run1d=, run2d=, _EXTRA= ]

 INPUTS:
   plate      - Plate number(s)

 OPTIONAL INPUTS:
   fiberid    - Fiber number(s); if not set, then plot all fibers for
                each plate specified.
   mjd        - MJD number(s); if not set, then select the most recent
                data for each plate (largest MJD).
   znum       - If set, then return not the best-fit redshift, but the
                ZUM-th best-fit; e.g., set ZNUM=2 for second-best fit.
   zmanual    - If set, then do an on-the-fly fit to either a galaxy
                template (if ZMANUAL[0]&lt;1) or QSO (if ZMANUAL[0]&gt;=1),
                overriding ZNUM.  If this is a 2-element array, then fit
                between all redshifts in the range [ZMANUAL[0],ZMANUAL[1]].
                Do not include any polynomial terms with the PCA templates.
   nsmooth    - If set, then boxcar smooth both the object and synthetic
                spectra with a width equal to NSMOOTH.
   zline      - If set, then overplot the emission line fits.
   nosyn      - If set, then do not overplot the synthetic fit spectrum (blue).
   noerr      - If set, then do not overplot the error vector (red).
   sky        - If set, then overplot the sky spectrum (green).
   ormask     - If set, then plot the OR-mask bits in yellow crosses.
   andmask    - If set, then plot the AND-mask bits in red squares.
   psfile     - If set, then send plot to a PostScript file instead of
                to the SPLOT interactive widget.  The PostScript file name
                can be set explicitly, e.g. with PSFILE='test.ps'.  Or if
                you simply set this as a flag, e.g. with /PSFILE, then the
                default file name is &quot;spec-pppp-mmmmm-fff.ps&quot;,
                where pppp=plate number, mmmmm=MJD, fff=fiber ID.
                If FIBERID is specified, then put all plots in a single file
                named &quot;spec-pppp-mmmmm.ps&quot;.
   restframe  - If set, then plot the wavelengths in the rest frame,
                e.g. divide the wavelengths by (1+z).
   zwarning   - If set, then only select those non-sky fibers where the
                ZWARNING flag has been set; can be used with or without
                specifying fiber numbers with FIBERID.
   allexp     - If set, then plot all the individual exposure spectra,
                rather than the co-added spectrum.
   topdir     - TOPDIR; if not set, then default to BOSS_SPECTRO_REDUX
   run1d      - RUN1D; if not set, then default to RUN1D
   run2d      - RUN2D; if not set, then default to RUN2D
   _EXTRA     - Keywords for SPLOT and XYOUTS, such as XRANGE, YRANGE, THICK,
                or keywords for READSPEC and READONESPEC such as TOPDIR,
                RUN2D, RUN1D.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The data are read with READSPEC.  See the documentation for that
   routine to see how to set environment variables that describe where
   the data files are.

 EXAMPLES:
   Plot the spectrum of plate 401, fiber #100 using the SPLOT plotting tool:
     IDL&gt; uuplotspec, 401, 100

   The spectrum is shown in white, the errors in red (except masked points
   are set to zero), and the best-fit eigenspectrum in blue. The mouse
   buttons will zoom in (left), recenter (center), or zoom out (right).
   The frame can be saved as a PostScript file by selecting File-&gt;WriteEPS
   from the left-hand corner.

   Make the same plot, but boxcar-smooth the spectrum and limit the
   wavelength range to [4000,5000] Angstroms:
     IDL&gt; uuplotspec, 401, 100, nsmooth=10, xrange=[5000,6000]

   Some plates are observed on multiple nights. To select one of the two
   observations of plate 306:
     IDL&gt; uuplotspec, 306, 20, mjd=51690

   Loop through all the spectra for plate 401, interactively:
     IDL&gt; uuplotspec, 401

   Plot all the spectra from plate 401 to a single PostScript file:
     IDL&gt; uuplotspec, 401, /psfile

   Plot all the spectra from plate 401 to 640 individual PostScript files:
     IDL&gt; uuplotspec, 401, lindgen(640)+1, /psfile

   Plot a list of 3 objects, each with its own plate, MJD, and fiberid:
     IDL&gt; plate = [400,400,401]
     IDL&gt; mjd = [51820,51820,51788]
     IDL&gt; fiberid = [10,11,20]
     IDL&gt; uuplotspec, plate, mjd=mjd, topdir=topdir, run1d=run1d, run2d=run2d, fiberid

 BUGS:
   If the user interactively rescales in Y, then the labels for ORMASK
   and ANDMASK are no longer lined up vertically with the bit mask plot.

 PROCEDURES CALLED:
   dfpsclose
   dfpsplot
   djs_icolor()
   djs_oplot
   djs_plot
   djs_xyouts
   plotspec_image
   readspec
   soplot
   splot
   sdss_flagname()
   sxyouts
   synthspec()
   textoidl()

 INTERNAL SUPPORT ROUTINES (plotspec):
   plotspec_mask
   plotspec1

 REVISION HISTORY (plotspec):
   01-Sep-2000  Written by D. Schlegel, Princeton

 INTERNAL SUPPORT ROUTINES (uuplotspec):
   uuplotspec_mask
   uuplotspec1
   uuplotspec_init (modified from plotspec)
  FLOATING WINDOW BASE ROUTINES
   uuPlotspecBase
   uuPlotspecBase_event
   uuPlotspecBase_refresh
   uuLogin
   uuLogin_event
  DATABASE BRIDGE
   uuDatabase_webget
   uuDatabase_download
   uuDatabase_member
   uuDatabase_comment
   uuDatabase_recentcommentlist
   uuDatabase_make_yanny
   uuDatabase_post
   uuDatabase_select
  UTILITY FUNCTIONS
  is_numeric
  is_integer
  undefine

  REVISION HISTORY (uuplotspec):
   14-May-2010   Written by Joel R. Brownstein, University of Utah
</pre>
<p><strong>(See pro/spec1d/uuplotspec.pro)</strong></p>
<hr />
<h3 id="VDISPFIT">VDISPFIT</h3>
<p><a href="#UUPLOTSPEC">[Previous Routine]</a></p>
<p><a href="#VELDISP">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   vdispfit

 PURPOSE:
   Compute velocity dispersions for galaxy spectra.

 CALLING SEQUENCE:
   vdans = vdispfit(objflux, objivar, [ objloglam, hdr=, zobj=, npoly=, $
    eigenfile=, eigendir=, columns=, sigma=, sigerr=, yfit=, $
    plottitle=, dzpix=, z_err=, /return_chisq, /doplot, /debug ])

 INPUTS:
   objflux    - Galaxy spectrum (spectra); array of [NPIX,NGALAXY].
   objivar    - Galaxy inverse variance; array of [NPIX,NGALAXY].

 OPTIONAL INPUTS:
   objloglam  - Log-10 wavelengths; this can be either an NPIX vector
                if all the galaxy spectra have the same wavelength mapping,
                or an array with the same dimensions as OBJFLUX.
                Either OBJLOGLAM or HDR must be specified.
   hdr        - FITS header from which to read COEFF0, COEFF1 for the
                wavelength mapping.
                Either OBJLOGLAM or HDR must be specified.
   zobj       - Redshift for each galaxy; default to 0.
   npoly      - Number of polynomial terms to append to eigenspectra;
                default to 5.
   eigenfile  - File name for eigenvectors; default to 'spEigenVdisp*.fits'
   eigendir   - Directory name for EIGENFILE; default to
                '$IDLSPEC2D_DIR/templates'
   columns    - Column numbers of the eigenspectra image to use in the
                PCA fit; default to all columns.
   plottitle  - Title of plot (if /DOPLOT is set).
   doplot     - If set, then make plots.
   debug      - If set, then wait for keystroke after plot.
   dzpix      - If set, then marginalize over +/- dzpix pixels in
                redshift.  Works in conjunction with z_err (below).
                Probably needs more testing!  Also, makes the
                interpretation of chisq a bit more fuzzy...
   z_err      - Object redshift errors, used in redshift marginalization.
   return_chisq - If set, then append full chi^2 vector/map in vdans

 OUTPUTS:
   vdans      - Output structure [NGALAXY] with the following elements:
                vdisp : Velocity dispersion in km/sec.
                vdisp_err : Error for VDISP in km/sec.
                vdispchi2 : Minimum chi^2
                vdispnpix : Number of pixels overlapping the templates
                            and used in the fits
                vdispdof : Degrees of freedom = the number of pixels
                           overlapping the templates minus the number of
                           templates minus the number of polynomial terms
                           minus 1 (the last 1 is for the velocity dispersion)
                vdisptheta : Coefficients for each template, where the
                           first terms are for the stellar templates
                           followed by those for the polynomial terms

 OPTIONAL OUTPUTS:
   yfit       - Best-fit template (actually, the one with the closest
                velocity dispersion to the best-fit sigma); wavelengths
                outside of those available with the templates have their
                values set to zero [NPIX,NGALAXY]

 COMMENTS:
   Note that the wavelength spacing in the galaxy and stellar template spectra
   must be the same.

   We currently mask within +/- 280 km/sec of the following wavelengths
   that could have emission lines:
     linelist = [3725.94, 3727.24, 3970.072, 4101.73, 4340.46, $
      4861.3632, 4958.911, 5006.843, 6300.32, 6548.05, 6562.801, $
      6583.45, 6716.44, 6730.82]

   The constructed over-sampled and smoothed eigenspectra are stored
   in a common block between calls if the eigen-vector file is the same.

 EXAMPLES:

 BUGS:

 DATA FILES:
   $IDLSPEC2D_DIR/templates/spEigenVdisp*.fits

 PROCEDURES CALLED:
   airtovac
   combine1fiber
   computechi2()
   djs_filepath()
   find_nminima
   mrdfits()
   poly_array()
   splog
   sxpar()

 INTERNAL SUPPORT ROUTINES:
   create_vdans()
   vdisp_gconv()

 REVISION HISTORY:
   13-Mar-2001  Written by D. Schlegel, Princeton
   2010-11 Added redshift marginalization option, Bolton &amp; Shu, U. Utah
</pre>
<p><strong>(See pro/spec1d/vdispfit.pro)</strong></p>
<hr />
<h3 id="VELDISP">VELDISP</h3>
<p><a href="#VDISPFIT">[Previous Routine]</a></p>
<p><a href="#WARN_DAYTIME">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   veldisp

 PURPOSE:
   Fit a series of galaxy spectrum with a single stellar template.
    For each object, this procedure will first find the best redshift 
    between object and template.  The correlation function is formed
    in fitredshift, and the best redshift and width of the correlation
    peak is calculated (along with error estimates).  Next perform chi2
    fitting with fourier_difference and fourier_quotient methods

 CALLING SEQUENCE:
   veldisp, objflux, objivar, starflux, starivar, result, $
    klo_cut=, khi_cut=, maxsig=, sigmastep=, zoffset= ]

 INPUTS:
   objflux    - Array of object spectra [NPIX] or [NPIX,NOBJ]
   objivar    - Array of object inverse variance [NPIX] or [NPIX,NOBJ]
   starflux   - Template spectrum [nstarpix]
   starivar   - Template inverse variance [nstarpix]

 OPTIONAL KEYWORDS:
   klo_cut    - Low frequency cutoff for cross-correlation peak finding;
                default to 1/128.
   khi_cut    - High frequency cutoff for cross-correlation peak finding;
                default to 1/3.
   maxsig     - Maximum velocity dispersion to search for; default to 2 pix
   sigmastep  - Steps between each test sigma; default to 0.2 pix
   zoffset    - ???

 OUTPUTS:
   result     - Structure array with outputs

 OPTIONAL OUTPUTS:

 COMMENTS:

   We assume that objflux and star have the same zeropoint
   And that all spectra are binned log-linear in wavelength
   If there is a zeropoint difference between objects and star
   this needs to be included after veldisp has run.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
  bandpassfilter()
  djs_maskinterp()
  djs_mean()
  fft_apodize
  fitredshift
  fourier_difference()
  fourier_quotient()

 REVISION HISTORY:
   25-Mar-2000  Written by S. Burles, FNAL
   29-Mar-2000  Modified by D. Finkbeiner &amp; D. Schlegel, APO
   25-Jun-2000  Cleaned up and commented by D. Finkbeiner, APO
</pre>
<p><strong>(See pro/spec1d/veldisp.pro)</strong></p>
<hr />
<h3 id="WARN_DAYTIME">WARN_DAYTIME</h3>
<p><a href="#VELDISP">[Previous Routine]</a></p>
<p><a href="#WRITESPEC">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   warn_daytime

 PURPOSE:
   Print a warning if an excellent-quality exposure taken with the Sun up.

 CALLING SEQUENCE:
   warn_daytime, hdr

 INPUTS:
   hdr        - FITS header from SDSS spectroscopic exposure

 OPTIONAL KEYWORDS:

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The only output from this procedure is to print (using SPLOG) a
   warning message if an &quot;excellent&quot;-quality exposure for a flat, arc,
   or science was taken with the Sun above the horizon.  This should
   basically never happen -- those should almost always be test data.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   djs_diff_angle()
   get_tai
   splog
   sunpos
   sxpar()
   zenpos

 REVISION HISTORY:
   28-Apr-2003  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec2d/warn_daytime.pro)</strong></p>
<hr />
<h3 id="WRITESPEC">WRITESPEC</h3>
<p><a href="#WARN_DAYTIME">[Previous Routine]</a></p>
<p><a href="#WRITE_UROS">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   writespec

 PURPOSE:
   Routine for writing Princeton-1D spectro outputs to an ASCII file

 CALLING SEQUENCE:
   writespec, plate, fiberid, [ mjd=, filename= ]

 INPUTS:
   plate      - Plate number(s)
   fiber      - Fiber number(s), 1-indexed

 OPTIONAL INPUTS:
   mjd        - MJD number(s); if not set, then select the most recent
                data for this plate (largest MJD).

 OUTPUTS:

 OPTIONAL OUTPUTS:
   mjd        - If not specified, then this is returned as an array of one
                MJD per object.
   filename   - Output file name; default to spec-pppp-mmmmm-fff.dat,
                where pppp=plate number, mmmmm=MJD, fff=fiber ID.

 COMMENTS:
   The data are read with READSPEC.  See the documentation for that
   routine to see how to set environment variables that describe where
   the data files are.

 EXAMPLES:
   Write the spectrum of plate 401, fiber #100, to an ASCII file as follows: 
     IDL&gt; writespec, 401, 100
   The default file name will be &quot;spec-0401-51788-100.dat&quot;. This can be
   changed by setting the FILENAME keyword: 
     IDL&gt; writespec, 401, 100, filename='junk.dat'

 BUGS:

 PROCEDURES CALLED:
   readspec
   sdss_flagname()

 INTERNAL SUPPORT ROUTINES:

 REVISION HISTORY:
   25-Sep-2000  Written by David Schlegel, Princeton.
</pre>
<p><strong>(See pro/spec1d/writespec.pro)</strong></p>
<hr />
<h3 id="WRITE_UROS">WRITE_UROS</h3>
<p><a href="#WRITESPEC">[Previous Routine]</a></p>
<p><a href="#ZCOMPUTE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   write_uros

 PURPOSE:
   Generate ASCII files of individual exposures on spectra for Uros Seljak

 CALLING SEQUENCE:
   write_uros, plate, [ fiber, ] mjd=

 INPUTS:
   plate      - Plate number(s)

 REQUIRED KEYWORDS:
   mjd        - MJD number(s); if not set, then select the most recent
                data for this plate (largest MJD).

 OPTIONAL INPUTS:
   fiber      - Fiber number(s), 1-indexed; if not set, or zero, then
                read all fibers for each plate.  We assume that there
                are exactly 640 fibers.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:
   The following file is written for each individual (CCD) spectrum
   of each object:
     spUros-$PLATE-$MJD-$FIBER-$EXPNUM-$CAMERA.fits

   In general, there will be (3 exposures) x (2 cameras) = 6 spectra
   for each plate+MJD+fiber combination.

   Output the following for each individual spectrum of each object:
     log-Wave   : Log10(wavelength [Ang])
     Flux       : Flux in units of flat-fielded electrons
     InverseVar : Inverse variance for the above
     Sky        ; Sky
     Pixelmask  : Pixel mask
     Dispers    : Wavelength dispersion in the **native** pixel scale
                  (e.g., relative to the local wavelength spacing)
     Calibfac   : Flux-calibration vector for this plate+spectrograph
     Invercorr  : Flux-correction vector for this exposure relative
                  to the flux-calibrated (smear) exposure
     Flatvec    : Flat-field vector, relative to a quartz lamp, combined
                  with the atmospheric telluric correction (in the red)
     Rnois      : Read noise in electrons (or photons)

   The fluxes have already been divided by the fiber-to-fiber flats
   (superfit) and the telluric-correction vector (telluricfactor).
   Convert the fluxes back to photon number as follows:
     Flux_photons = Flux * Flatvec
     Sky_photons = Sky * Flatvec
     InverseVar_photons = InverseVar / Flatvec^2
   The read noise portion (Rnois) is already in units of electrons,
   or equivalently photons.

   Before combining multiple spectra, we re-normalize as follows:
     Flux_ergs = Flux / (Calibfac * Invercorr)
     InverseVar = InverseVar * (Calibfac * Invercorr)^2 * Window
   where Window is a linear apodization of the first 100 pixels
   of each spectrum (the blue/red overlap region, so the red side
   of the blue camera, and the blue side of the red camera).
   Once the flux has been normalized, it is in units of 10^(-17) erg/cm/s/Ang

 EXAMPLES:

 BUGS:

 DATA FILES:
   $BOSS_SPECTRO_REDUX/$PLATE/spFrame-$CAMERA-$EXPNUM.fits*
   $BOSS_SPECTRO_REDUX/$PLATE/spFluxcalib-$PLATE-$MJD-$CAMERA.fits
   $BOSS_SPECTRO_REDUX/$PLATE/spFluxcorr-$EXPNUM-$SPECID.fits
   $BOSS_SPECTRO_REDUX/$PLATE/spPlate-$PLATE-$MJD.fits

 PROCEDURES CALLED:
   bspline_valu()
   mrdfits()
   readspec
   sxpar()
   traceset2xy
   yanny_free
   yanny_read()

 INTERNAL SUPPORT ROUTINES:
   write_uros1

 REVISION HISTORY:
   14-Jun-2002  Written by David Schlegel, Princeton.
                This is based upon the code in SPCOADD_FRAMES.
</pre>
<p><strong>(See pro/spec2d/write_uros.pro)</strong></p>
<hr />
<h3 id="ZCOMPUTE">ZCOMPUTE</h3>
<p><a href="#WRITE_UROS">[Previous Routine]</a></p>
<p><a href="#ZCOMPUTE_QSO">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   zcompute

 PURPOSE:
   Compute relative redshift of object(s) vs. eigen-templates.

 CALLING SEQUENCE:
   zans = zcompute(objflux, objivar, starflux, [starmask, $
    fixed_template=, nfind=, $
    poffset=, pspace=, pmin=, pmax=, mindof=, width=, minsep=, $
    plottitle=, /doplot, /debug, /verbose, zans_fixed= ]

 INPUTS:
   objflux    - Object fluxes [NPIXOBJ,NOBJ]
   objivar    - Object inverse variances [NPIXOBJ,NOBJ]
   starflux   - Eigen-template fluxes [NPIXSTAR,NTEMPLATE]

 OPTIONAL INPUTS:
   starmask   - Eigen-template mask; 0=bad, 1=good [NPIXSTAR]
   fixed_template - If set, then these are templates that are fit
                simultaneoulsy with the STARFLUX templates, but without
                ever redshifting them [NPIXOBJ,NFIXED]
   nfind      - Number of solutions to find per object; default to 1.
   poffset    - Offset between all objects and templates, in pixels.
                A value of 10 indicates that STARFLUX begins ten pixels
                after OBJFLUX, i.e. OBJFLUX[i+10] = STARFLUX[i] for the
                case when the relative redshift should be zero.  If the
                wavelength coverage of the templates is larger, then the
                value of ZOFFSET will always be negative.
                [Scalar or vector of size NOBJ]
   pspace     - The spacing in redshifts to consider; default to 1 [pixels];
                [Scalar or vector of size NOBJ]
   pmin       - The smallest redshift to consider [pixels].
                [Scalar or vector of size NOBJ]
   pmax       - The largest redshift to consider [pixels].
                [Scalar or vector of size NOBJ]
   mindof     - Minimum number of degrees of freedom for a valid fit;
                default to 10.
   width      - Parameter for FIND_NMINIMA(); default to 3 * PSPACE.
   minsep     - Parameter for FIND_NMINIMA(); default to the same as WIDTH.
   plottitle  - Title of plot (if /DOPLOT is set).
   doplot     - If set, then make plots.
   debug      - If set, then wait for keystroke after plot.
   verbose    - If set, then log using SPLOG instead of PRINT.

 OUTPUTS:
   zans       - Output structure [NOBJECT,NFIND] with the following elements:
                z : The relative redshift.
                z_err : Error in the redshift, based upon the local quadratic
                        fit to the chi^2 minimum. 
                chi2 : Fit value for the best (minimum) chi^2
                dof : Number of degrees of freedom, equal to the number of
                      pixels in common between the object and templates
                      minus the number of templates.
                theta : Mixing angles [NTEMPLATE].  These are computed at the
                        nearest integral redshift, e.g. at ROUND(ZOFFSET).
                theta_covar : Covariance matrix for THETA
  zans_fixed - Structure with fit information for those templates
               fixed in redshift if FIXED_TEMPLATE is passed.


 COMMENTS:
   Fits are done to chi^2/DOF, not to chi^2.

 EXAMPLES:

 BUGS:

 DATA FILES:
   $IDLSPEC2D_DIR/etc/TEMPLATEFILES

 PROCEDURES CALLED:
   computechi2()
   find_nminima()
   splog

 INTERNAL SUPPORT ROUTINES:
   create_zans()

 REVISION HISTORY:
   10-Jul-2000  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/zcompute.pro)</strong></p>
<hr />
<h3 id="ZCOMPUTE_QSO">ZCOMPUTE_QSO</h3>
<p><a href="#ZCOMPUTE">[Previous Routine]</a></p>
<p><a href="#ZFIND">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   zcompute_qso

 PURPOSE:
   Compute relative redshift of object(s) vs. eigen-templates.

 CALLING SEQUENCE:
   zans = zcompute_qso(objflux, objivar, starset, starflux, [starmask, nfind=, $
    poffset=, pspace=, pmin=, pmax=, mindof=, width=, minsep=, $
    plottitle=, /doplot, /debug, /verbose ]

 INPUTS:
   objflux    - Object fluxes [NPIXOBJ,NOBJ]
   objivar    - Object inverse variances [NPIXOBJ,NOBJ]
   starset    - Eigen-template bspline-set [structure]
   starflux   - Eigen-template fluxes (polynomials are expected) [NPIXSTAR,NTEMPLATE]

 OPTIONAL INPUTS:
   starmask   - Eigen-template mask; 0=bad, 1=good [NPIXSTAR]
   nfind      - Number of solutions to find per object; default to 1.
   poffset    - Offset between all objects and templates, in pixels.
                A value of 10 indicates that STARFLUX begins ten pixels
                after OBJFLUX, i.e. OBJFLUX[i+10] = STARFLUX[i] for the
                case when the relative redshift should be zero.  If the
                wavelength coverage of the templates is larger, then the
                value of ZOFFSET will always be negative.
                [Scalar or vector of size NOBJ]
   pspace     - The spacing in redshifts to consider; default to 1 [pixels];
                [Scalar or vector of size NOBJ]
   pmin       - The smallest redshift to consider [pixels].
                [Scalar or vector of size NOBJ]
   pmax       - The largest redshift to consider [pixels].
                [Scalar or vector of size NOBJ]
   mindof     - Minimum number of degrees of freedom for a valid fit;
                default to 10.
   width      - Parameter for FIND_NMINIMA(); default to 3 * PSPACE.
   minsep     - Parameter for FIND_NMINIMA(); default to the same as WIDTH.
   plottitle  - Title of plot (if /DOPLOT is set).
   doplot     - If set, then make plots.
   debug      - If set, then wait for keystroke after plot.
   verbose    - If set, then log using SPLOG instead of PRINT.

 OUTPUTS:
   zans       - Output structure [NOBJECT,NFIND] with the following elements:
                z : The relative redshift.
                z_err : Error in the redshift, based upon the local quadratic
                        fit to the chi^2 minimum. 
                chi2 : Fit value for the best (minimum) chi^2
                dof : Number of degrees of freedom, equal to the number of
                      pixels in common between the object and templates
                      minus the number of templates.
                theta : Mixing angles [NTEMPLATE].  These are computed at the
                        nearest integral redshift, e.g. at ROUND(ZOFFSET).

 COMMENTS:
   Fits are done to chi^2/DOF, not to chi^2.

 EXAMPLES:

 BUGS:

 DATA FILES:
   $IDLSPEC2D_DIR/etc/TEMPLATEFILES

 PROCEDURES CALLED:
   computechi2()
   find_nminima()
   splog

 INTERNAL SUPPORT ROUTINES:
   create_zans()

 REVISION HISTORY:
   10-Jul-2000  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/zcompute_qso.pro)</strong></p>
<hr />
<h3 id="ZFIND">ZFIND</h3>
<p><a href="#ZCOMPUTE_QSO">[Previous Routine]</a></p>
<p><a href="#ZPLOT_PIE">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   zfind

 PURPOSE:
   Find possible redshift matches for a set of spectra using a set of
   eigen-templates.

 CALLING SEQUENCE:
   result = zfind( objflux, objivar, hdr=hdr, $
    [ starflux=, starloglam0=, stardloglam=, $
    eigenfile=, eigendir=, columns=, npoly=, $
    zmin=, zmax=, zguess=, pwidth=, nfind=, width=, $
    zans_fixed=, _EXTRA= ]

 INPUTS:
   objflux    - Object fluxes [NPIXOBJ,NOBJ]
   objivar    - Object inverse variances [NPIXOBJ,NOBJ]

 REQUIRED KEYWORDS:
   hdr        - FITS header for objects, used to construct the wavelengths
                from the following keywords: COEFF0, COEFF1.

 OPTIONAL KEYWORDS:
   starflux   - Eigenspectra [NPIXSTAR,NSTAR].
   starloglam0- Zero-point of log-10(Angstrom) wavelength mapping of STARFLUX.
   stardloglam- Wavelength spacing for STARFLUX in log-10(Angstroms)
   eigenfile  - Input FITS file with an [NPIXSTAR,NSTAR] image with
                either templates or eigenspectra.  If a wildcard appears
                in the file name, then the file that appears last in a sort
                is used.
                The header keywords COEFF0, COEFF1 are used to specify
                the wavelength mapping in log-10 Angstroms.
                This must be set if STARFLUX,STARLOGLAM0 are not set.
   eigendir   - Directory for EIGENFILE; default to $IDLSPEC2D/templates.
   columns    - Column numbers of the eigenspectra image to use in the
                PCA fit; default to all columns.
   npoly      - Number of polynomial terms to append to eigenspectra;
                default to none.
   zmin       - Minimum redshift to consider; default to no lower bound.
   zmax       - Maximum redshift to consider; default to no upper bound.
   zguess     - Initial guess for redshift; search for a solution about
                this value.  If specified with PWIDTH, then ZMIN and ZMAX
                are ignoreed.
   pwidth     - Search width in pixels about the intial guess redshift ZGUESS.
                If specified with ZGUESS, then ZMIN and ZMAX are ignored.
   nfind      - Keyword for ZCOMPUTE().
   width      - Keyword for ZCOMPUTE().
   _EXTRA     - Keywords for ZCOMPUTE(), such as PSPACE, DOPLOT, DEBUG, VERBOSE

 OUTPUTS:
   result     - Structure with redshift-fit information.  Structure
                elements are left blank if fewer than NFIND peaks are found.

 OPTIONAL OUTPUTS:
   zans_fixed - Structure with fit information for those templates
                fixed in redshift if FIXED_TEMPLATE is passed.

 COMMENTS:
   One can specify a search domain for the redshift with ZMIN and ZMAX, or
   with ZGUESS and PWIDTH.  If none of those parameters are set, then all
   possible redshifts that overlap the object and star (template) are tested.

   Mask any pixels on the templates where the first template contains zeros.
   This is useful, in particular, where the stellar templates have zeros
   at the beginning or end of the spectral range due lack of wavelength
   coverage.

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   concat_dir()
   djs_filepath()
   fileandpath()
   readfits()
   splog
   sxpar()
   zcompute()

 INTERNAL SUPPORT ROUTINES:
   sp1d_struct()

 REVISION HISTORY:
   28-Jun-2000  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/zfind.pro)</strong></p>
<hr />
<h3 id="ZPLOT_PIE">ZPLOT_PIE</h3>
<p><a href="#ZFIND">[Previous Routine]</a></p>
<p><a href="#ZREFIND">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   zplot_pie

 PURPOSE:
   Plot pie diagram

 CALLING SEQUENCE:
   zplot_pie, [ rarange=, decrange=, zmax=, deltaz=, plotfile ]

 INPUTS:

 OPTIONAL INPUTS:
   rarange    - RA range; default to [130.,250] deg
   decrange   - Declination range; default to [-0.5,0.5]
   zmax       - Maximum redshift; default to 0.15
   deltaz     - Spacing for labeling the redshift; default to 0.05
   plotfile   - Plot file; default to 'zplot.ps'

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:
   Plot the pie diagram for the Southern stripe (stripe 82):
     IDL&gt; zplot, rarange=[-45,50]

 BUGS:

 DATA FILES:

 PROCEDURES CALLED:
   dfpsclose
   dfpsplot
   platelist
   readspec

 REVISION HISTORY:
   14-May-2007  Written by D. Schlegel, LBL
</pre>
<p><strong>(See pro/spec1d/zplot_pie.pro)</strong></p>
<hr />
<h3 id="ZREFIND">ZREFIND</h3>
<p><a href="#ZPLOT_PIE">[Previous Routine]</a></p>
<p><a href="#ZTWEAK">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   zrefind

 PURPOSE:
   Re-fit redshifts from a previous call to ZFIND(), but doing a local
   fit around the previous answers.

 CALLING SEQUENCE:
   result = zrefind( objflux, objivar, pwidth=, pspace=, width=, zold= ]

 INPUTS:
   objflux    - Object fluxes [NPIXOBJ,NOBJ]
   objivar    - Object inverse variances [NPIXOBJ,NOBJ]

 REQUIRED KEYWORDS:
   zold       - Z structure from an initial call to ZFIND().

 OPTIONAL KEYWORDS:
   pwidth     - Search width in pixels about the intial redshift; default to 5
   pspace     - Keyword for ZCOMPUTE().
   width      - Keyword for ZCOMPUTE().

 OUTPUTS:
   result     - Structure with redshift-fit information, modified from ZOLD.

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 PROCEDURES CALLED:
   zfind()

 REVISION HISTORY:
   17-Aug-2000  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/zrefind.pro)</strong></p>
<hr />
<h3 id="ZTWEAK">ZTWEAK</h3>
<p><a href="#ZREFIND">[Previous Routine]</a></p>
<p><a href="#ZTWEAK2">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   ztweak

 PURPOSE:
   Tweak redshifts

 CALLING SEQUENCE:
   ztweak, platefile

 INPUTS:
   platefile  - Plate file from spectro-2D

 OPTIONAL INPUTS:

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 DATA FILES:
   $IDLSPEC2D_DIR/etc/TEMPLATEFILES

 PROCEDURES CALLED:
   spec_append
   struct_addtags()
   sxpar()
   veldisp

 REVISION HISTORY:
   19-Jul-2000  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/ztweak.pro)</strong></p>
<hr />
<h3 id="ZTWEAK2">ZTWEAK2</h3>
<p><a href="#ZTWEAK">[Previous Routine]</a></p>
<p><a href="#ZTWEAK_GAL">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   ztweak2

 PURPOSE:
   Tweak redshifts

 CALLING SEQUENCE:
   ztweak, platefile

 INPUTS:
   platefile  - Plate file from spectro-2D

 OPTIONAL INPUTS:

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:

 DATA FILES:
   $IDLSPEC2D_DIR/etc/TEMPLATEFILES

 PROCEDURES CALLED:
   spec_append
   struct_addtags()
   sxpar()
   veldisp

 REVISION HISTORY:
   19-Jul-2000  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/ztweak2.pro)</strong></p>
<hr />
<h3 id="ZTWEAK_GAL">ZTWEAK_GAL</h3>
<p><a href="#ZTWEAK2">[Previous Routine]</a></p>
<p><a href="#ZTWEAK_STAR">[Next Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   ztweak_gal

 PURPOSE:
   Tweak galaxy redshifts

 CALLING SEQUENCE:
   ztweak_gal, platefile, [subsamp= ]

 INPUTS:
   platefile  - Plate file from spectro-2D

 OPTIONAL INPUTS:
   subsamp    - ???

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:
  Make sure we use exactly the same object pixels for eadh test z ???
  Convovle the emission lines just like the stars - incl. instrumental
    response???

 DATA FILES:
   $IDLSPEC2D_DIR/etc/TEMPLATEFILES

 PROCEDURES CALLED:
   spec_append
   struct_addtags()
   sxpar()
   veldisp

 REVISION HISTORY:
   19-Jul-2000  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/ztweak_gal.pro)</strong></p>
<hr />
<h3 id="ZTWEAK_STAR">ZTWEAK_STAR</h3>
<p><a href="#ZTWEAK_GAL">[Previous Routine]</a></p>
<p><a href="#ROUTINELIST">[List of Routines]</a></p>
<pre>
 NAME:
   ztweak_star

 PURPOSE:
   Find the best-fit Elodie spectrum to a set of spectra.

 CALLING SEQUENCE:
   ztweak_star, [ filename, zmin=, zmax=, /overwrite ]

 INPUTS:

 OPTIONAL INPUTS:
   filename   - Yanny parameter file with at least the entries PLATE,
                MJD, FIBERID, and optionally CZ.
                Default to &quot;$IDLSPEC2D_DIR/templates/eigeninput_star.par&quot;.
   zmin       - Minimum redshift to consider; default to -0.00333
                (-1000 km/sec).
   zmax       - Minimum redshift to consider; default to +0.00333
                (+1000 km/sec).
   overwrite  - If set, then overwrite the input file with CZ replaced
                with the best-fit value.

 OUTPUTS:

 OPTIONAL OUTPUTS:

 COMMENTS:

 EXAMPLES:

 BUGS:
   No attempt is made to precisely match the instrumental dispersion
   of the SDSS spectra and the Elodie spectra.  The Elodie spectra are
   smoothed to an instrumental dispersion of 70 km/sec.

 PROCEDURES CALLED:
   elodie_best()
   readspec
   struct_addtags()
   yanny_free
   yanny_read

 REVISION HISTORY:
   03-Apr-2002  Written by D. Schlegel, Princeton
</pre>
<p><strong>(See pro/spec1d/ztweak_star.pro)</strong></p>
<hr />
</body>
</html>
